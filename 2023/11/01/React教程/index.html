

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#88cdd4">
  <meta name="author" content="lan720">
  <meta name="keywords" content="">
  
    <meta name="description" content="React官方中文文档：https:&#x2F;&#x2F;zh-hans.react.dev&#x2F;learn&#x2F;react-developer-tools 官方Github仓库：https:&#x2F;&#x2F;github.com&#x2F;reactjs&#x2F;zh-hans.react.dev 前端在线编辑器公开沙盒：https:&#x2F;&#x2F;codesandbox.io&#x2F;dashboard&#x2F;recent?workspace&#x3D;44913078-bd56-45">
<meta property="og:type" content="article">
<meta property="og:title" content="六.React教程">
<meta property="og:url" content="https://lan720.github.io/lan-blog/2023/11/01/React%E6%95%99%E7%A8%8B/index.html">
<meta property="og:site_name" content="兰lan">
<meta property="og:description" content="React官方中文文档：https:&#x2F;&#x2F;zh-hans.react.dev&#x2F;learn&#x2F;react-developer-tools 官方Github仓库：https:&#x2F;&#x2F;github.com&#x2F;reactjs&#x2F;zh-hans.react.dev 前端在线编辑器公开沙盒：https:&#x2F;&#x2F;codesandbox.io&#x2F;dashboard&#x2F;recent?workspace&#x3D;44913078-bd56-45">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://lan720.github.io/cover/React.png">
<meta property="article:published_time" content="2023-11-01T06:32:32.000Z">
<meta property="article:modified_time" content="2023-11-20T05:48:41.728Z">
<meta property="article:author" content="lan720">
<meta property="article:tag" content="React">
<meta property="article:tag" content="TypeScript">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://lan720.github.io/cover/React.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>六.React教程 - 兰lan</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="https://at.alicdn.com/t/c/font_4299901_uup67qklgo.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"lan720.github.io","root":"/","version":"1.9.5","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"left","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":1},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container" style="justify-content: space-around;">
    <a class="navbar-brand" href="/">
      <i class="iconfont icon-a-1f338"></i>
      <strong>兰&#39;s blog</strong>
    </a>
    <div style="display: flex;align-items: center;"> 
      <p style="margin-bottom:0;color: white;font-size: 17px;">
        2023年12月18日
      </p>
      <span class="weather-plugin">
        <div id="he-plugin-simple"></div>
      </span>
      <script>
        WIDGET = {
          "CONFIG": {
            "modules": "012",
            "background": "5",
            "tmpColor": "FFFFFF",
            "tmpSize": "16",
            "cityColor": "FFFFFF",
            "citySize": "16",
            "aqiColor": "FFFFFF",
            "aqiSize": "16",
            "weatherIconSize": "24",
            "alertIconSize": "18",
            // "padding": "10px 10px 10px 10px",
            "shadow": "0",
            "language": "auto",
            "borderRadius": "5",
            "fixed": "false",
            "vertical": "top",
            "horizontal": "left",
            "key": "9cf07a14c8a74c4198ee7f49b868e0c8"
          }
        }
      </script>
      <script src="https://widget.qweather.net/simple/static/js/he-simple-common.js?v=2.0"></script>
      <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
              data-target="#navbarSupportedContent"
              aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <div class="animated-icon"><span></span><span></span><span></span></div>
      </button>
    </div>
   

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-shouye"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-shuji"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-iconkuozhan_fenleipre"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-guanyuwomen"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-sousuo"></i>
              <span>搜索</span>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-EMOJI-99" id="color-toggle-icon"></i>
              <span>明暗</span>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>


  

<div id="banner" class="banner" parallax=true
     style="background: url('/cover/React.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="六.React教程" style="font-size: 30px;"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-calendar" aria-hidden="true"></i>
        <time datetime="2023-11-01 14:32" pubdate>
          2023年11月1日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-tongjitu"></i>
        
          264k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-labushijian"></i>
        
        
        
          2205 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-yanjingkeshi" aria-hidden="true" style="font-size: 1em;"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div
    class="row nomargin-x"
    style="
      display: flex;
      flex-direction: row;
      justify-content: flex-start;
      flex-wrap: nowrap;
    "
  >
    <!-- < class="side-col d-none d-lg-block col-lg-3"> -->
    <div style="width: 5rem">
  <aside class="sidebar"">
    <div id="toc">
  <p class="toc-header">
    <!-- <i class="iconfont icon-list"></i> -->
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>

</div>

    <div
      class="nopadding-x-md"
      style="padding-left: 0; padding-right: 0; flex: 1; width: 60%;"
    >
      <div class="container nopadding-x-md" id="board-ctn" style="margin-left:0;margin-right:5px;">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">六.React教程</h1>
            
            <p class="note note-info">
                本文最后更新于：2023年11月20日 13:48  
            </p>
             
            <div class="markdown-body">
               <p>React官方中文文档：<a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/react-developer-tools">https://zh-hans.react.dev/learn/react-developer-tools</a></p>
<p>官方Github仓库：<a target="_blank" rel="noopener" href="https://github.com/reactjs/zh-hans.react.dev">https://github.com/reactjs/zh-hans.react.dev</a></p>
<p>前端在线编辑器公开沙盒：<a target="_blank" rel="noopener" href="https://codesandbox.io/dashboard/recent?workspace=44913078-bd56-4551-abd7-4139b7ec6366">https://codesandbox.io/dashboard/recent?workspace=44913078-bd56-4551-abd7-4139b7ec6366</a></p>
<p>本地启动项目：</p>
<figure class="highlight bash"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-knkdhmlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-knkdhmlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm install -g yarn<br>yarn <br>yarn dev<br></code></pre></td></tr></table></div></figure>

<img src="image-20231030163722152.png" srcset="/img/loading.gif" lazyload alt="image-20231030163722152" style="zoom:50%;" />

<img src="image-20231030164520318.png" srcset="/img/loading.gif" lazyload alt="image-20231030164520318" style="zoom:50%;" />

<img src="image-20231030164705426.png" srcset="/img/loading.gif" lazyload alt="image-20231030164705426" style="zoom:50%;" />

<p>安装扩展ESLint【 JavaScript 代码检查工具】，Prettier</p>
<p>保存并自动格式化：</p>
<ol>
<li>按快捷键 <code>Ctrl/Cmd + Shift + P</code>.</li>
<li>输入 “settings”</li>
<li>按回车键</li>
<li>在搜索栏, 输入 “format on save”</li>
<li>确保勾选 “format on save” 选项</li>
</ol>
<p>Chrome插件：<code>React Developer Tools</code></p>
<img src="image-20231101175313970.png" srcset="/img/loading.gif" lazyload alt="image-20231101175313970" style="zoom:50%;" />

<img src="image-20231101175344676.png" srcset="/img/loading.gif" lazyload alt="image-20231101175344676" style="zoom:50%;" />

<h1 id="一-使用TypeScript"><a href="#一-使用TypeScript" class="headerlink" title="一.使用TypeScript"></a>一.使用TypeScript</h1><p>TypeScript官方文档：<a target="_blank" rel="noopener" href="https://www.typescriptlang.org/zh/docs/handbook/">https://www.typescriptlang.org/zh/docs/handbook/</a></p>
<p>TypeScript 是一种向 JavaScript 代码添加类型定义的常用方法。TypeScript 天然支持 JSX——只需在项目中添加 <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/@types/react"><code>@types/react</code></a> 和 <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/@types/react-dom"><code>@types/react-dom</code></a> 即可获得完整的 React Web 支持。</p>
<figure class="highlight bash"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-j6w3k7lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-j6w3k7lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm install @types/react @types/react-dom<br></code></pre></td></tr></table></div></figure>

<p>然后在 <code>tsconfig.json</code> 中设置以下编译器选项：</p>
<ol>
<li>必须在 <a target="_blank" rel="noopener" href="https://www.typescriptlang.org/tsconfig/#lib"><code>lib</code></a> 中包含 <code>dom</code>（注意：如果没有指定 <code>lib</code> 选项，默认情况下会包含 <code>dom</code>）。</li>
<li><a target="_blank" rel="noopener" href="https://www.typescriptlang.org/tsconfig/#jsx"><code>jsx</code></a> 必须设置为一个有效的选项。对于大多数应用程序，<code>preserve</code> 应该足够了。 如果你正在发布一个库，请查阅 <a target="_blank" rel="noopener" href="https://www.typescriptlang.org/tsconfig/#jsx"><code>jsx</code> 文档</a> 以选择合适的值。</li>
</ol>
<p>为按钮的 <code>title</code> 添加一个描述类型：</p>
<figure class="highlight tsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-7lzcpzlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-7lzcpzlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs tsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">MyButton</span>(<span class="hljs-params">&#123; title &#125;: &#123; title: <span class="hljs-built_in">string</span> &#125;</span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>&#123;title&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>这种内联语法是为组件提供类型的最简单方法，但是一旦你开始描述几个字段，它可能变得难以管理。相反，你可以使用 <code>interface</code> 或 <code>type</code> 来描述组件的 props：</p>
<figure class="highlight tsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-6f9wz6lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-6f9wz6lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs tsx"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">MyButtonProps</span> &#123;<br>  <span class="hljs-comment">/* 按钮文字 */</span><br>  <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>;<br>  <span class="hljs-comment">/* 按钮是否禁用 */</span><br>  <span class="hljs-attr">disabled</span>: <span class="hljs-built_in">boolean</span>;<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">MyButton</span>(<span class="hljs-params">&#123; title, disabled &#125;: MyButtonProps</span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">disabled</span>=<span class="hljs-string">&#123;disabled&#125;</span>&gt;</span>&#123;title&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">MyApp</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Welcome to my app<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">MyButton</span> <span class="hljs-attr">title</span>=<span class="hljs-string">&quot;我是一个禁用按钮&quot;</span> <span class="hljs-attr">disabled</span>=<span class="hljs-string">&#123;true&#125;/</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>为 state 显式提供一个类型，你可以通过为 <code>useState</code> 调用提供一个类型参数来实现：</p>
<figure class="highlight tsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-hotk50lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-hotk50lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs tsx"><span class="hljs-comment">// 显式设置类型为 &quot;boolean&quot;</span><br><span class="hljs-keyword">const</span> [enabled, setEnabled] = useState&lt;<span class="hljs-built_in">boolean</span>&gt;(<span class="hljs-literal">false</span>);<br></code></pre></td></tr></table></div></figure>

<p>在这种情况下，这并不是很有用，但是当你有一个联合类型时，你可能想要提供一个 <code>type</code>。例如，这里的 <code>status</code> 可以是几个不同的字符串之一：</p>
<figure class="highlight tsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-efoivilqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-efoivilqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs tsx"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Status</span> = <span class="hljs-string">&quot;idle&quot;</span> | <span class="hljs-string">&quot;loading&quot;</span> | <span class="hljs-string">&quot;success&quot;</span> | <span class="hljs-string">&quot;error&quot;</span>;<br><br><span class="hljs-keyword">const</span> [status, setStatus] = useState&lt;<span class="hljs-title class_">Status</span>&gt;(<span class="hljs-string">&quot;idle&quot;</span>);<br></code></pre></td></tr></table></div></figure>

<p>或者，如 <a target="_blank" rel="noopener" href="http://localhost:3000/learn/choosing-the-state-structure#principles-for-structuring-state">选择 state 结构原则</a> 中推荐的，你可以将相关的 state 作为一个对象分组，并通过对象类型描述不同的可能性：</p>
<figure class="highlight tsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-qgwi0klqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-qgwi0klqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs tsx"><span class="hljs-keyword">type</span> <span class="hljs-title class_">RequestState</span> =<br>  | &#123; <span class="hljs-attr">status</span>: <span class="hljs-string">&#x27;idle&#x27;</span> &#125;<br>  | &#123; <span class="hljs-attr">status</span>: <span class="hljs-string">&#x27;loading&#x27;</span> &#125;<br>  | &#123; <span class="hljs-attr">status</span>: <span class="hljs-string">&#x27;success&#x27;</span>, <span class="hljs-attr">data</span>: <span class="hljs-built_in">any</span> &#125;<br>  | &#123; <span class="hljs-attr">status</span>: <span class="hljs-string">&#x27;error&#x27;</span>, <span class="hljs-attr">error</span>: <span class="hljs-title class_">Error</span> &#125;;<br><br><span class="hljs-keyword">const</span> [requestState, setRequestState] = useState&lt;<span class="hljs-title class_">RequestState</span><br></code></pre></td></tr></table></div></figure>

<p><code>useReducer</code>接受一个 reducer 函数和一个初始 state 作为参数，并将从初始 state 推断出 reducer 函数的类型。你可以选择性地为 <code>useReducer</code> 提供类型参数以为 state 提供类型。但是更高的做法仍然是在初始 state 上添加类型：</p>
<figure class="highlight tsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-xn49yvlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-xn49yvlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs tsx"><span class="hljs-keyword">import</span> &#123;useReducer&#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">State</span> &#123;<br>   <span class="hljs-attr">count</span>: <span class="hljs-built_in">number</span> <br>&#125;;<br><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">CounterAction</span> =<br>  | &#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;reset&quot;</span> &#125;<br>  | &#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;setCount&quot;</span>; <span class="hljs-attr">value</span>: <span class="hljs-title class_">State</span>[<span class="hljs-string">&quot;count&quot;</span>] &#125;<br><br><span class="hljs-keyword">const</span> <span class="hljs-attr">initialState</span>: <span class="hljs-title class_">State</span> = &#123; <span class="hljs-attr">count</span>: <span class="hljs-number">0</span> &#125;;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">stateReducer</span>(<span class="hljs-params">state: State, action: CounterAction</span>): <span class="hljs-title class_">State</span> &#123;<br>  <span class="hljs-keyword">switch</span> (action.<span class="hljs-property">type</span>) &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;reset&quot;</span>:<br>      <span class="hljs-keyword">return</span> initialState;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;setCount&quot;</span>:<br>      <span class="hljs-keyword">return</span> &#123; ...state, <span class="hljs-attr">count</span>: action.<span class="hljs-property">value</span> &#125;;<br>    <span class="hljs-attr">default</span>:<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Unknown action&quot;</span>);<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [state, dispatch] = <span class="hljs-title function_">useReducer</span>(stateReducer, initialState);<br><br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">addFive</span> = (<span class="hljs-params"></span>) =&gt; <span class="hljs-title function_">dispatch</span>(&#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;setCount&quot;</span>, <span class="hljs-attr">value</span>: state.<span class="hljs-property">count</span> + <span class="hljs-number">5</span> &#125;);<br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">reset</span> = (<span class="hljs-params"></span>) =&gt; <span class="hljs-title function_">dispatch</span>(&#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;reset&quot;</span> &#125;);<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>欢迎来到我的计数器<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml"></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>计数： &#123;state.count&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;addFive&#125;</span>&gt;</span>加 5<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;reset&#125;</span>&gt;</span>重置<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<img src="image-20231101152507530.png" srcset="/img/loading.gif" lazyload alt="image-20231101152507530" style="zoom:50%;" />

<hr>
<p><a target="_blank" rel="noopener" href="http://localhost:3000/reference/react/useContext"><code>useContext</code></a> 是一种无需通过组件传递 props 而可以直接在组件树中传递数据的技术。它是通过创建 provider 组件使用，通常还会创建一个 hook 以在子组件中使用该值。</p>
<p>从传递给 <code>createContext</code> 调用的值推断 context 提供的值的类型：</p>
<figure class="highlight tsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-7lrb8mlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-7lrb8mlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs tsx"><span class="hljs-keyword">import</span> &#123; createContext, useContext, useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Theme</span> = <span class="hljs-string">&quot;light&quot;</span> | <span class="hljs-string">&quot;dark&quot;</span> | <span class="hljs-string">&quot;system&quot;</span>;<br><span class="hljs-keyword">const</span> <span class="hljs-title class_">ThemeContext</span> = createContext&lt;<span class="hljs-title class_">Theme</span>&gt;(<span class="hljs-string">&quot;system&quot;</span>);<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">useGetTheme</span> = (<span class="hljs-params"></span>) =&gt; <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">ThemeContext</span>);<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">MyApp</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [theme, setTheme] = useState&lt;<span class="hljs-title class_">Theme</span>&gt;(<span class="hljs-string">&#x27;light&#x27;</span>);<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ThemeContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;theme&#125;</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">MyComponent</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">ThemeContext.Provider</span>&gt;</span></span><br>  )<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">MyComponent</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> theme = <span class="hljs-title function_">useGetTheme</span>();<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>当前主题：&#123;theme&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  )<br>&#125;<br></code></pre></td></tr></table></div></figure>

<img src="image-20231101155923881.png" srcset="/img/loading.gif" lazyload alt="image-20231101155923881" style="zoom:50%;" />

<p>当你没有一个合理的默认值时，这种技术是有效的，而在这些情况下，<code>null</code> 作为默认值可能感觉是合理的。但是，为了让类型系统理解你的代码，你需要在 <code>createContext</code> 上显式设置 <code>ContextShape | null</code>。</p>
<p>这会导致一个问题，你需要在 context consumer 中消除 <code>| null</code> 的类型。我们建议让 hook 在运行时检查它的存在，并在不存在时抛出一个错误：</p>
<figure class="highlight tsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-i8iuq8lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-i8iuq8lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs tsx"><span class="hljs-keyword">import</span> &#123; createContext, useContext, useState, useMemo &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-comment">// 这是一个简单的示例，但你可以想象一个更复杂的对象</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">ComplexObject</span> = &#123;<br>  <span class="hljs-attr">kind</span>: <span class="hljs-built_in">string</span><br>&#125;;<br><br><span class="hljs-comment">// 上下文在类型中创建为 `| null`，以准确反映默认值。</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">Context</span> = createContext&lt;<span class="hljs-title class_">ComplexObject</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);<br><br><span class="hljs-comment">// 这个 hook 会在运行时检查 context 是否存在，并在不存在时抛出一个错误。</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">useGetComplexObject</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> <span class="hljs-built_in">object</span> = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">Context</span>);<br>  <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">object</span>) &#123; <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;useGetComplexObject must be used within a Provider&quot;</span>) &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">object</span>;<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">MyApp</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> <span class="hljs-built_in">object</span> = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> (&#123; <span class="hljs-attr">kind</span>: <span class="hljs-string">&quot;complex&quot;</span> &#125;), []);<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Context.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;object&#125;</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">MyComponent</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">Context.Provider</span>&gt;</span></span><br>  )<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">MyComponent</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> <span class="hljs-built_in">object</span> = <span class="hljs-title function_">useGetComplexObject</span>();<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Current object: &#123;object.kind&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  )<br>&#125;<br></code></pre></td></tr></table></div></figure>

<hr>
<p><a target="_blank" rel="noopener" href="http://localhost:3000/reference/react/useMemo"><code>useMemo</code></a> 会从函数调用中创建&#x2F;重新访问记忆化值，只有在第二个参数中传入的依赖项发生变化时，才会重新运行该函数。函数的类型是根据第一个参数中函数的返回值进行推断的，如果希望明确指定，可以为这个钩子提供一个类型参数以指定函数类型。</p>
<figure class="highlight tsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-utmvvclqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-utmvvclqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs tsx"><span class="hljs-comment">// 从 filterTodos 的返回值推断 visibleTodos 的类型</span><br><span class="hljs-keyword">const</span> visibleTodos = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">filterTodos</span>(todos, tab), <br></code></pre></td></tr></table></div></figure>

<hr>
<p><a target="_blank" rel="noopener" href="http://localhost:3000/reference/react/useCallback"><code>useCallback</code></a> 会在第二个参数中传入的依赖项保持不变的情况下，为函数提供相同的引用。与 <code>useMemo</code> 类似，函数的类型是根据第一个参数中函数的返回值进行推断的，如果希望明确指定，可以为这个钩子提供一个类型参数以指定函数类型。</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-rgjridlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-rgjridlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> handleClick = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-comment">// ...</span><br>&#125;, [todos]);<br></code></pre></td></tr></table></div></figure>

<p>当在 TypeScript 严格模式下，使用 <code>useCallback</code> 需要为回调函数中的参数添加类型注解。这是因为回调函数的类型是根据函数的返回值进行推断的——如果没有参数，那么类型就不能完全理解。</p>
<p>根据自身的代码风格偏好，你可以使用 React 类型中的 <code>*EventHandler</code> 函数以在定义回调函数的同时为事件处理程序提供类型注解：</p>
<figure class="highlight tsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-842h5glqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-842h5glqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs tsx"><span class="hljs-keyword">import</span> &#123; useState, useCallback &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Form</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [value, setValue] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&quot;Change me&quot;</span>);<br>  <span class="hljs-keyword">const</span> handleChange = useCallback&lt;<span class="hljs-title class_">React</span>.<span class="hljs-property">ChangeEventHandler</span>&lt;<span class="hljs-title class_">HTMLInputElement</span>&gt;&gt;(<span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> &#123;<br>    <span class="hljs-title function_">setValue</span>(event.<span class="hljs-property">currentTarget</span>.<span class="hljs-property">value</span>);<br><br>  &#125;, [setValue])<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;value&#125;</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;handleChange&#125;</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>值： &#123;value&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<hr>
<p>在 React 中处理 DOM 事件时，事件的类型通常可以从事件处理程序中推断出来。但是，当你想提取一个函数以传递给事件处理程序时，你需要明确设置事件的类型。</p>
<figure class="highlight tsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-a73dqblqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-a73dqblqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs tsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Form</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [value, setValue] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&quot;Change me&quot;</span>);<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleChange</span>(<span class="hljs-params">event: React.ChangeEvent&lt;HTMLInputElement&gt;</span>) &#123;<br>    <span class="hljs-title function_">setValue</span>(event.<span class="hljs-property">currentTarget</span>.<span class="hljs-property">value</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;value&#125;</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;handleChange&#125;</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>值： &#123;value&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<img src="image-20231101170008390.png" srcset="/img/loading.gif" lazyload alt="image-20231101170008390" style="zoom:50%;" />

<p>描述组件的子元素有两种常见方法。第一种是使用 <code>React.ReactNode</code> 类型，这是可以在 JSX 中作为子元素传递的所有可能类型的并集：</p>
<figure class="highlight ts"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-zof5s8lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-zof5s8lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">ModalRendererProps</span> &#123;<br>  <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>;<br>  <span class="hljs-attr">children</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">ReactNode</span>;<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>这是对子元素的一个非常宽泛的定义。第二种方法是使用 <code>React.ReactElement</code> 类型，它只包括 JSX 元素，而不包括 JavaScript 原始类型，如 string 或 number：</p>
<figure class="highlight ts"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-ssusgulqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-ssusgulqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">ModalRendererProps</span> &#123;<br>  <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>;<br>  <span class="hljs-attr">children</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">ReactElement</span>;<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>注意，你不能使用 TypeScript 来描述子元素是某种类型的 JSX 元素，所以你不能使用类型系统来描述一个只接受 <code>&lt;li&gt;</code> 子元素的组件。</p>
<p>当在 React 中使用内联样式时，你可以使用 <code>React.CSSProperties</code> 来描述传递给 <code>style</code> 属性的对象。这个类型是所有可能的 CSS 属性的并集，它能确保你传递给 <code>style</code> 属性的是有效的 CSS 属性，并且你能在编辑器中获得样式编码提示。</p>
<figure class="highlight ts"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-z2u6zclqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-z2u6zclqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">MyComponentProps</span> &#123;<br>  <span class="hljs-attr">style</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">CSSProperties</span>;<br>&#125;<br></code></pre></td></tr></table></div></figure>

<h1 id="二-入门"><a href="#二-入门" class="headerlink" title="二.入门"></a>二.入门</h1><p>React 应用程序是由 组件 组成的。一个组件是 UI（用户界面）的一部分，它拥有自己的逻辑和外观。组件可以小到一个按钮，也可以大到整个页面。</p>
<p><mark>React 组件是返回标签的 JavaScript 函数</mark>：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-kdw8a8lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-kdw8a8lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">MyButton</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>I&#x27;m a button<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>至此，你已经声明了 <code>MyButton</code>，现在把它嵌套到另一个组件中：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-aaua3elqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-aaua3elqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">MyApp</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Welcome to my app<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">MyButton</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p class="note note-success" style="border-left: 4px solid #42b983;padding: 10px 15px;color: #777;background-color: rgba(66, 185, 131, .1);">React 是常规的 JavaScript 函数，除了：<br />
1. 它们的名字总是以大写字母开头。<br />
2. 它们返回 JSX 标签。</p>

<p><mark>React 组件必须以大写字母开头，而 HTML 标签则必须是小写字母。</mark></p>
<p>所使用的标签语法被称为 <em>JSX</em>。</p>
<p>JSX 比 HTML 更加严格。你必须闭合标签，如 <code>&lt;br /&gt;</code>。你的组件也不能返回多个 JSX 标签。你必须将它们包裹到一个共享的父级中，比如 <code>&lt;div&gt;...&lt;/div&gt;</code> 或使用空的 <code>&lt;&gt;...&lt;/&gt;</code> 包裹：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-kts0fklqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-kts0fklqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">AboutPage</span>(<span class="hljs-params"></span>) &#123;<br> <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>About<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Hello there.<span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span>How do you do?<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>可以使用 <code>className</code> 来指定一个 CSS 的 class。它与 HTML 的 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTML/Global_attributes/class"><code>class</code></a> 属性的工作方式相同：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-zya9bjlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-zya9bjlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jsx">&lt;img className=<span class="hljs-string">&quot;avatar&quot;</span> /&gt;<br></code></pre></td></tr></table></div></figure>

<p>React 并没有规定你如何添加 CSS 文件。最简单的方式是使用 HTML 的 <code>&lt;link&gt;</code> 标签。</p>
<p class="note note-warning" style="border-left: 4px solid #f0ad4e;padding: 10px 15px;color: #777;background-color: #fdf8ea;">大括号是{}</p>

<p>JSX 会让你把标签放到 JavaScript 中。而大括号会让你 “回到” JavaScript 中，这样你就可以从你的代码中嵌入一些变量并展示给用户。例如，这将显示 <code>user.name</code>：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-4u27vzlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-4u27vzlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">return</span> (<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">    &#123;user.name&#125;</span><br><span class="language-xml">  <span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br>);<br></code></pre></td></tr></table></div></figure>

<p>你还可以将 JSX 属性 “转义到 JavaScript”，但你必须使用大括号 而非 引号。例如，<code>className=&quot;avatar&quot;</code> 是将 <code>&quot;avatar&quot;</code> 字符串传递给 <code>className</code>，作为 CSS 的 class。但 <code>src=&#123;user.imageUrl&#125;</code> 会读取 JavaScript 的 <code>user.imageUrl</code> 变量，然后将该值作为 <code>src</code> 属性传递：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-mkpag4lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-mkpag4lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">return</span> (<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">img</span></span></span><br><span class="hljs-tag"><span class="language-xml">    <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;avatar&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">    <span class="hljs-attr">src</span>=<span class="hljs-string">&#123;user.imageUrl&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">  /&gt;</span></span><br>);<br></code></pre></td></tr></table></div></figure>

<p>你也可以把更为复杂的表达式放入 JSX 的大括号内，例如 <a target="_blank" rel="noopener" href="https://javascript.info/operators#string-concatenation-with-binary">字符串拼接</a>：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-kmm7x1lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-kmm7x1lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> user = &#123;<br>  <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Hedy Lamarr&#x27;</span>,<br>  <span class="hljs-attr">imageUrl</span>: <span class="hljs-string">&#x27;https://i.imgur.com/yXOvdOSs.jpg&#x27;</span>,<br>  <span class="hljs-attr">imageSize</span>: <span class="hljs-number">90</span>,<br>&#125;;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Profile</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>&#123;user.name&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">img</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;avatar&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">src</span>=<span class="hljs-string">&#123;user.imageUrl&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">alt</span>=<span class="hljs-string">&#123;</span>&#x27;<span class="hljs-attr">Photo</span> <span class="hljs-attr">of</span> &#x27; + <span class="hljs-attr">user.name</span>&#125;</span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">style</span>=<span class="hljs-string">&#123;&#123;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">width:</span> <span class="hljs-attr">user.imageSize</span>,</span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">height:</span> <span class="hljs-attr">user.imageSize</span></span></span><br><span class="hljs-tag"><span class="language-xml">        &#125;&#125;</span></span><br><span class="hljs-tag"><span class="language-xml">      /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p><code>style=&#123;&#123;&#125;&#125;</code> 并不是一个特殊的语法，而是 <code>style=&#123; &#125;</code> JSX 大括号内的一个普通 <code>&#123;&#125;</code> 对象。当你的样式依赖于 JavaScript 变量时，你可以使用 <code>style</code> 属性。</p>
<hr>
<p><mark>条件渲染</mark>：React 没有特殊的语法来编写条件语句，因此你使用的就是普通的 JavaScript 代码。例如使用 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/if...else"><code>if</code></a> 语句根据条件引入 JSX：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-z8mocklqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-z8mocklqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">let</span> content;<br><br><span class="hljs-keyword">if</span> (isLoggedIn) &#123;<br>  content = <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">AdminPanel</span> /&gt;</span></span>;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>  content = <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">LoginForm</span> /&gt;</span></span>;<br>&#125;<br><br><span class="hljs-keyword">return</span> (<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">    &#123;content&#125;</span><br><span class="language-xml">  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>);<br></code></pre></td></tr></table></div></figure>

<p>如果你喜欢更为紧凑的代码，可以使用 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/Conditional_Operator">条件 <code>?</code> 运算符</a>。与 <code>if</code> 不同的是，它工作于 JSX 内部：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-ovktgmlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-ovktgmlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs jsx">&lt;div&gt;<br>  &#123;isLoggedIn ? (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">AdminPanel</span> /&gt;</span></span><br>  ) : (<br>   <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">LoginForm</span> /&gt;</span></span><br>  )&#125;<br>&lt;/div&gt;<br></code></pre></td></tr></table></div></figure>

<p>当你不需要 <code>else</code> 分支时，你还可以使用 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/Logical_AND#short-circuit_evaluation">逻辑 <code>&amp;&amp;</code> 语法</a>：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-d7r6fylqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-d7r6fylqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs jsx">&lt;div&gt;<br>  &#123;isLoggedIn &amp;&amp; <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">AdminPanel</span> /&gt;</span></span>&#125;<br>&lt;/div&gt;<br></code></pre></td></tr></table></div></figure>

<hr>
<p><mark>渲染列表</mark>：例如 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/for"><code>for</code> 循环</a> 和 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Array/map">array 的 <code>map()</code> 函数</a> 来渲染组件列表。</p>
<p>假设你有一个产品数组：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-so8b9slqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-so8b9slqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> products = [<br><br>  &#123; <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Cabbage&#x27;</span>, <span class="hljs-attr">id</span>: <span class="hljs-number">1</span> &#125;,<br><br>  &#123; <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Garlic&#x27;</span>, <span class="hljs-attr">id</span>: <span class="hljs-number">2</span> &#125;,<br><br>  &#123; <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Apple&#x27;</span>, <span class="hljs-attr">id</span>: <span class="hljs-number">3</span> &#125;,<br><br>];<br></code></pre></td></tr></table></div></figure>

<p>在你的组件中，使用 <code>map()</code> 函数将这个数组转换为 <code>&lt;li&gt;</code> 标签构成的列表:</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-tan7gilqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-tan7gilqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ShoppingList</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> listItems = products.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">product</span> =&gt;</span><br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;product.id&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">style</span>=<span class="hljs-string">&#123;&#123;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">color:</span> <span class="hljs-attr">product.isFruit</span> ? &#x27;<span class="hljs-attr">magenta</span>&#x27; <span class="hljs-attr">:</span> &#x27;<span class="hljs-attr">darkgreen</span>&#x27;</span></span><br><span class="hljs-tag"><span class="language-xml">      &#125;&#125;</span></span><br><span class="hljs-tag"><span class="language-xml">    &gt;</span></span><br><span class="language-xml">      &#123;product.title&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span><br>  );<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>&#123;listItems&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p> <code>&lt;li&gt;</code> 有一个 <code>key</code> 属性。对于列表中的每一个元素，你都应该传递一个字符串或者数字给 <code>key</code>，用于在其兄弟节点中唯一标识该元素。</p>
<p>这些 key 会告诉 React，每个组件对应着数组里的哪一项，所以 React 可以把它们匹配起来。这在数组项进行移动（例如排序）、插入或删除等操作时非常重要。一个合适的 <code>key</code> 可以帮助 React 推断发生了什么，从而得以正确地更新 DOM 树。</p>
<p>用作 key 的值应该在数据中提前就准备好，而不是在运行时才随手生成。</p>
<hr>
<p><mark>响应事件</mark>：通过在组件中声明 事件处理 函数来响应事件：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-ntk8gnlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-ntk8gnlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">MyButton</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">alert</span>(<span class="hljs-string">&#x27;You clicked me!&#x27;</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handleClick&#125;</span>&gt;</span></span><br><span class="language-xml">      Click me</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p class="note note-danger" style="border-left: 4px solid #d9534f;padding: 10px 15px;color: #777;background-color: #fcf1f2;">onClick={handleClick} 的结尾没有小括号！不要 调用 事件处理函数：你只需 把函数传递给事件 即可。当用户点击按钮时 React 会调用你传递的事件处理函数。</p>

<hr>
<p><mark>更新界面</mark>：从 React 引入 <a target="_blank" rel="noopener" href="http://localhost:3000/reference/react/useState"><code>useState</code></a>：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-rh4wldlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-rh4wldlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br></code></pre></td></tr></table></div></figure>

<p>现在你可以在你的组件中声明一个 state 变量：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-8v0ye9lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-8v0ye9lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">MyButton</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>你将从 <code>useState</code> 中获得两样东西：当前的 state（<code>count</code>），以及用于更新它的函数（<code>setCount</code>）。</p>
<p>第一次显示按钮时，<code>count</code> 的值为 <code>0</code>，因为你把 <code>0</code> 传给了 <code>useState()</code>。当你想改变 state 时，调用 <code>setCount()</code> 并将新的值传递给它。点击该按钮计数器将递增：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-mdf0dmlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-mdf0dmlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">MyButton</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handleClick&#125;</span>&gt;</span></span><br><span class="language-xml">      Clicked &#123;count&#125; times</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>如果你多次渲染同一个组件，每个组件都会拥有自己的 state。</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-kj2rkglqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-kj2rkglqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">MyApp</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Counters that update separately<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">MyButton</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">MyButton</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">MyButton</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handleClick&#125;</span>&gt;</span></span><br><span class="language-xml">      Clicked &#123;count&#125; times</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<img src="image-20231101143311372-1698820394429-1.png" srcset="/img/loading.gif" lazyload alt="image-20231101143311372" style="zoom:50%;" />

<p>每个按钮会 “记住” 自己的 <code>count</code>，而不影响其他按钮。</p>
<img src="image-20231101144402210.png" srcset="/img/loading.gif" lazyload alt="image-20231101144402210" style="zoom:50%;" />

<hr>
<p><mark>使用hook</mark>：以 <code>use</code> 开头的函数被称为 Hook。<code>useState</code> 是 React 提供的一个内置 Hook。Hook 比普通函数更为严格。你只能在你的组件（或其他 Hook）的 顶层 调用 Hook。如果你想在一个条件或循环中使用 <code>useState</code>，请提取一个新的组件并在组件内部使用它。</p>
<hr>
<p><mark>组件间共享数据</mark>：为了使得 <code>MyButton</code> 组件显示相同的 <code>count</code> 并一起更新，你需要将各个按钮的 state “向上” 移动到最接近包含所有按钮的组件之中。</p>
<img src="image-20231101144445700.png" srcset="/img/loading.gif" lazyload alt="image-20231101144445700" style="zoom:50%;" />

<p>此刻，当你点击任何一个按钮时，<code>MyApp</code> 中的 <code>count</code> 都将改变，同时会改变 <code>MyButton</code> 中的两个 count。</p>
<p>首先，将 <code>MyButton</code> 的 state 上移到 <code>MyApp</code> 中：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-0dv3oalqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-0dv3oalqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">MyApp</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Counters that update separately<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">MyButton</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">MyButton</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">MyButton</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-comment">// ... we&#x27;re moving code from here ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>接着，将 <code>MyApp</code> 中的点击事件处理函数以及 state 一同向下传递到 每个 <code>MyButton</code> 中。</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-t3f4x0lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-t3f4x0lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">MyApp</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Counters that update together<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">MyButton</span> <span class="hljs-attr">count</span>=<span class="hljs-string">&#123;count&#125;</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handleClick&#125;</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">MyButton</span> <span class="hljs-attr">count</span>=<span class="hljs-string">&#123;count&#125;</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handleClick&#125;</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>使用这种方式传递的信息被称作 prop。此时 <code>MyApp</code> 组件包含了 <code>count</code> state 以及 <code>handleClick</code> 事件处理函数，并将它们作为 prop 传递给 了每个按钮。</p>
<p>最后，改变 <code>MyButton</code> 以 读取 从父组件传递来的 prop：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-zt3eqvlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-zt3eqvlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">MyButton</span>(<span class="hljs-params">&#123; count, onClick &#125;</span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>   <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;onClick&#125;</span>&gt;</span></span><br><span class="language-xml">      Clicked &#123;count&#125; times</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>当你点击按钮时，<code>onClick</code> 处理程序会启动。每个按钮的 <code>onClick</code> prop 会被设置为 <code>MyApp</code> 内的 <code>handleClick</code> 函数，所以函数内的代码会被执行。该代码会调用 <code>setCount(count + 1)</code>，使得 state 变量 <code>count</code> 递增。新的 <code>count</code> 值会被作为 prop 传递给每个按钮，因此它们每次展示的都是最新的值。这被称为“<mark>状态提升</mark>”。通过向上移动 state，我们实现了在组件间共享它。</p>
<p>完整代码：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-uerg86lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-uerg86lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">MyApp</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Counters that update together<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">MyButton</span> <span class="hljs-attr">count</span>=<span class="hljs-string">&#123;count&#125;</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handleClick&#125;</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">MyButton</span> <span class="hljs-attr">count</span>=<span class="hljs-string">&#123;count&#125;</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handleClick&#125;</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">MyButton</span>(<span class="hljs-params">&#123; count, onClick &#125;</span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;onClick&#125;</span>&gt;</span></span><br><span class="language-xml">      Clicked &#123;count&#125; times</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<img src="image-20231101145014997.png" srcset="/img/loading.gif" lazyload alt="image-20231101145014997" style="zoom:50%;" />

<h1 id="三-描述用户界面UI"><a href="#三-描述用户界面UI" class="headerlink" title="三.描述用户界面UI"></a>三.描述用户界面UI</h1><h2 id="1-第一个组件"><a href="#1-第一个组件" class="headerlink" title="1.第一个组件"></a>1.第一个组件</h2><p>React 应用是由被称为 组件 的独立 UI 片段构建而成。React 组件本质上是可以任意添加标签的 JavaScript 函数。组件可以小到一个按钮，也可以大到是整个页面。</p>
<p>React 允许你将标签、CSS 和 JavaScript 组合成自定义“组件”，即 应用程序中可复用的 UI 元素。</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-ep7tfklqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-ep7tfklqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Profile</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">img</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://i.imgur.com/MK3eW3As.jpg&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;Katherine Johnson&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">    /&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Gallery</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">section</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Amazing scientists<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Profile</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Profile</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Profile</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>开源UI组件仓库：<a target="_blank" rel="noopener" href="https://github.com/mui">https://github.com/mui</a></p>
<p>material-ui文档：<a target="_blank" rel="noopener" href="https://mui.com/material-ui">https://mui.com/material-ui</a></p>
<p>React 组件是一段可以 使用标签进行扩展 的 JavaScript 函数。</p>
<p>构建组件的方法：</p>
<ol>
<li><p>导出组件： <code>export default</code> 前缀是一种 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/docs/web/javascript/reference/statements/export">JavaScript 标准语法</a>（非 React 的特性）。它允许你标签一个文件中的主要函数以便你以后可以从其他文件引入它。</p>
</li>
<li><p>定义函数： 使用 <code>function Profile() &#123; &#125;</code> 定义名为 <code>Profile</code> 的 JavaScript 函数。</p>
<p class="note note-success" style="border-left: 4px solid #42b983;padding: 10px 15px;color: #777;background-color: rgba(66, 185, 131, .1);">React 组件是常规的 JavaScript 函数，但 组件的名称必须以大写字母开头，否则它们将无法运行！</p>
</li>
<li><p>添加标签：这个组件返回一个带有 <code>src</code> 和 <code>alt</code> 属性的 <code>&lt;img /&gt;</code> 标签。<code>&lt;img /&gt;</code> 写得像 HTML，但实际上是 JavaScript！这种语法被称为 <a target="_blank" rel="noopener" href="http://localhost:3000/learn/writing-markup-with-jsx">JSX</a>，它允许你在 JavaScript 中嵌入使用标签。</p>
<p>返回语句可以全写在一行上，如下面组件中所示：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-b78lmilqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-b78lmilqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://i.imgur.com/MK3eW3As.jpg&quot;</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;Katherine Johnson&quot;</span> /&gt;</span></span>;<br></code></pre></td></tr></table></div></figure>

<p><mark>如果你的标签和 <code>return</code> 关键字不在同一行，则必须把它包裹在一对括号中</mark>，如下所示：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-vblq1mlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-vblq1mlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">return</span> (<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://i.imgur.com/MK3eW3As.jpg&quot;</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;Katherine Johnson&quot;</span> /&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>);<br></code></pre></td></tr></table></div></figure>

<p>没有括号包裹的话，任何在 <code>return</code> 下一行的代码都<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/2846283/what-are-the-rules-for-javascripts-automatic-semicolon-insertion-asi">将被忽略</a>！</p>
</li>
</ol>
<p>现在你已经定义了 <code>Profile</code> 组件，你可以在其他组件中使用它。例如，你可以导出一个内部使用了多个 <code>Profile</code> 组件的 <code>Gallery</code> 组件：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-bbuepjlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-bbuepjlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Profile</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://i.imgur.com/MK3eW3As.jpg&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;Katherine Johnson&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">    /&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Gallery</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">section</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>了不起的科学家<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Profile</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Profile</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Profile</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>区别：</p>
<ul>
<li><code>&lt;section&gt;</code> 是小写的，所以 React 知道我们指的是 HTML 标签。</li>
<li><code>&lt;Profile /&gt;</code> 以大写 <code>P</code> 开头，所以 React 知道我们想要使用名为 <code>Profile</code> 的组件。</li>
</ul>
<p> <code>Profile</code> 包含更多的 HTML：<code>&lt;img /&gt;</code>。这是浏览器最后所看到的：</p>
<figure class="highlight html"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-1s5vahlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-1s5vahlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">section</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>了不起的科学家<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://i.imgur.com/MK3eW3As.jpg&quot;</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;Katherine Johnson&quot;</span> /&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://i.imgur.com/MK3eW3As.jpg&quot;</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;Katherine Johnson&quot;</span> /&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://i.imgur.com/MK3eW3As.jpg&quot;</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;Katherine Johnson&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span><br></code></pre></td></tr></table></div></figure>

<p>因为 <code>Profile</code> 组件在 <code>Gallery</code> 组件中渲染——甚至好几次！——我们可以认为 <code>Gallery</code> 是一个 父组件，将每个 <code>Profile</code> 渲染为一个“孩子”。这是 React 的神奇之处：你可以只定义组件一次，然后按需多处和多次使用。</p>
<p>组件可以渲染其他组件，但是 请不要嵌套他们的定义：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-bhvn6tlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-bhvn6tlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Gallery</span>(<span class="hljs-params"></span>) &#123;<br><span class="hljs-comment">// 🔴 永远不要在组件中定义组件</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Profile</span>(<span class="hljs-params"></span>) &#123;<br><span class="hljs-comment">// ...</span><br>&#125;<br><span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>上面这段代码 <a target="_blank" rel="noopener" href="http://localhost:3000/learn/preserving-and-resetting-state#different-components-at-the-same-position-reset-state">非常慢，并且会导致 bug 产生</a>。因此，你应该在顶层定义每个组件：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-jp7o1glqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-jp7o1glqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Gallery</span>(<span class="hljs-params"></span>) &#123;<br><span class="hljs-comment">// ...</span><br>&#125;<br><br><span class="hljs-comment">// ✅ 在顶层声明组件</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Profile</span>(<span class="hljs-params"></span>) &#123;<br><span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>当子组件需要使用父组件的数据时，你需要 <a target="_blank" rel="noopener" href="http://localhost:3000/learn/passing-props-to-a-component">通过 props 的形式进行传递</a>，而不是嵌套定义。</p>
<h2 id="2-组件的导入与导出"><a href="#2-组件的导入与导出" class="headerlink" title="2.组件的导入与导出"></a>2.组件的导入与导出</h2><p>对组件进行拆分：</p>
<ol>
<li><p>创建 一个新的 JS 文件来存放该组件。</p>
</li>
<li><p>导出 该文件中的函数组件（可以使用 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/docs/Web/JavaScript/Reference/Statements/export#using_the_default_export">默认导出</a> 或 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/docs/Web/JavaScript/Reference/Statements/export#using_named_exports">具名导出</a>）</p>
<ul>
<li><p>JavaScript 里两个主要用来导出值的方式：默认导出和具名导出。到目前为止，我们的示例中只用到了默认导出。但你可以在一个文件中，选择使用其中一种，或者两种都使用。</p>
<p class="note note-success" style="border-left: 4px solid #42b983;padding: 10px 15px;color: #777;background-color: rgba(66, 185, 131, .1);">同一个文件里有且仅有一个默认导出，但是可以有任意多个 具名导出。</p>

<img src="image-20231103111403523.png" srcset="/img/loading.gif" lazyload alt="image-20231103111403523" style="zoom:50%;" />

<p>组件的导出方式决定了其导入方式。当你用默认导入的方式，导入具名导出的组件时，就会报错。如下表格可以帮你更好地理解它们：</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>导出语句</th>
<th>导入语句</th>
</tr>
</thead>
<tbody><tr>
<td>默认</td>
<td><code>export default function Button() &#123;&#125;</code></td>
<td><code>import Button from &#39;./Button.js&#39;;</code></td>
</tr>
<tr>
<td>具名</td>
<td><code>export function Button() &#123;&#125;</code></td>
<td><code>import &#123; Button &#125; from &#39;./Button.js&#39;;</code></td>
</tr>
</tbody></table>
<p class="note note-success" style="border-left: 4px solid #42b983;padding: 10px 15px;color: #777;background-color: rgba(66, 185, 131, .1);">当使用默认导入时，你可以在 `import` 语句后面进行任意命名。比如 `import Banana from './Button.js'`，如此你能获得与默认导出一致的内容。相反，对于具名导入，导入和导出的名字必须一致。这也是为什么称其为 具名 导入的原因！</p>

<p>通常，文件中仅包含一个组件时，人们会选择默认导出，而当文件中包含多个组件或某个值需要导出时，则会选择具名导出。 无论选择哪种方式，请记得给你的组件和相应的文件命名一个有意义的名字。我们不建议创建未命名的组件，比如 <code>export default () =&gt; &#123;&#125;</code>，因为这样会使得调试变得异常困难。</p>
</li>
</ul>
</li>
<li><p>在需要使用该组件的文件中 导入（可以根据相应的导出方式使用 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/docs/Web/JavaScript/Reference/Statements/import#importing_defaults">默认导入</a> 或 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/docs/Web/JavaScript/Reference/Statements/import#import_a_single_export_from_a_module">具名导入</a>）。</p>
</li>
</ol>
<p>这里将 <code>Profile</code> 组件和 <code>Gallery</code> 组件，从 <code>App.js</code> 文件中移动到了 <code>Gallery.js</code> 文件中。修改后，即可在 <code>App.js</code> 中导入 <code>Gallery.js</code> 中的 <code>Gallery</code> 组件：</p>
<p>App.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-k1umexlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-k1umexlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-comment">//无论是 &#x27;./Gallery.js&#x27; 还是 &#x27;./Gallery&#x27;，在 React 里都能正常使用，只是前者更符合 原生 ES 模块。</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">Gallery</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./Gallery.js&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Gallery</span> /&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>Gallery.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-pfddd7lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-pfddd7lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Profile</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://i.imgur.com/QIrZWGIs.jpg&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;Alan L. Hart&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">    /&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Gallery</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">section</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>了不起的科学家们<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Profile</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Profile</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Profile</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>Gallery.js</p>
<ul>
<li>定义了 <code>Profile</code> 组件，该组件仅在该文件内使用，没有被导出。</li>
<li>使用 默认导出 的方式，将 <code>Gallery</code> 组件导出</li>
</ul>
<p>App.js</p>
<ul>
<li>使用 默认导入 的方式，从 <code>Gallery.js</code> 中导入 <code>Gallery</code> 组件。</li>
<li>使用 默认导出 的方式，将根组件 <code>App</code> 导出。</li>
</ul>
<h2 id="3-使用JSX书写标签语言"><a href="#3-使用JSX书写标签语言" class="headerlink" title="3.使用JSX书写标签语言"></a>3.使用JSX书写标签语言</h2><p>JSX 是 JavaScript 语法扩展，可以让你在 JavaScript 文件中书写类似 HTML 的标签。</p>
<p>随着 Web 的交互性越来越强，逻辑越来越决定页面中的内容。JavaScript 负责 HTML 的内容！这也是为什么 在 React 中，渲染逻辑和标签共同存在于同一个地方——组件。</p>
<p>将一个按钮的渲染逻辑和标签放在一起可以确保它们在每次编辑时都能保持互相同步。反之，彼此无关的细节是互相隔离的，例如按钮的标签和侧边栏的标签。这样我们在修改其中任意一个组件时会更安全。</p>
<p>每个 React 组件都是一个 JavaScript 函数，它会返回一些标签，React 会将这些标签渲染到浏览器上。</p>
<p>JSX and React 是相互独立的 东西。但它们经常一起使用，但你 可以 单独使用它们中的任意一个，JSX 是一种语法扩展，而 React 则是一个 JavaScript 的库。</p>
<p>JSX 规则：</p>
<ol>
<li><p><mark>只能返回一个根元素</mark>：如果想要在一个组件中包含多个元素，需要用一个父标签把它们包裹起来。如果你不想在标签中增加一个额外的 <code>&lt;div&gt;</code>，可以用 <code>&lt;&gt;</code> 和 <code>&lt;/&gt;</code> 元素来代替。这个空标签被称作 *<a target="_blank" rel="noopener" href="http://localhost:3000/reference/react/Fragment">Fragment</a>*。React Fragment 允许你将子元素分组，而不会在 HTML 结构中添加额外节点。</p>
<p class="note note-success" style="border-left: 4px solid #42b983;padding: 10px 15px;color: #777;background-color: rgba(66, 185, 131, .1);">为什么多个 JSX 标签需要被一个父元素包裹：JSX 虽然看起来很像 HTML，但在底层其实被转化为了 JavaScript 对象，你不能在一个函数中返回多个对象，除非用一个数组把他们包装起来。</p>
</li>
<li><p><mark>标签必须正确闭合</mark>：像 <code>&lt;img&gt;</code> 这样的自闭合标签必须书写成 <code>&lt;img /&gt;</code>，而像 <code>&lt;li&gt;oranges</code> 这样只有开始标签的元素必须带有闭合标签，需要改为 <code>&lt;li&gt;oranges&lt;/li&gt;</code>。</p>
</li>
<li><p><mark>使用驼峰式命名法给大部分属性命名</mark>：JSX 最终会被转化为 JavaScript，而 JSX 中的属性也会变成 JavaScript 对象中的键值对。在你自己的组件中，经常会遇到需要用变量的方式读取这些属性的时候。但 JavaScript 对变量的命名有限制。例如，<mark>变量名称不能包含 <code>-</code> 符号或者像 <code>class</code> 这样的保留字</mark>。</p>
</li>
</ol>
<p>  这就是为什么在 React 中，大部分 HTML 和 SVG 属性都用驼峰式命名法表示。例如，需要用 <code>strokeWidth</code> 代替 <code>stroke-width</code>。由于 <code>class</code> 是一个保留字，所以在 React 中需要用 <code>className</code> 来代替。这也是 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/Element/className">DOM 属性中的命名</a>:</p>
  <figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-4vj5edlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-4vj5edlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs jsx">&lt;img   src=<span class="hljs-string">&quot;https://i.imgur.com/yXOvdOSs.jpg&quot;</span> <br>  alt=<span class="hljs-string">&quot;Hedy Lamarr&quot;</span> <br>  className=<span class="hljs-string">&quot;photo&quot;</span><br>/&gt;<br></code></pre></td></tr></table></div></figure>

<p> 你可以 <a target="_blank" rel="noopener" href="http://localhost:3000/reference/react-dom/components/common">在 React DOM 元素中找到所有对应的属性</a>。</p>
<p>由于历史原因，<a target="_blank" rel="noopener" href="https://developer.mozilla.org/docs/Web/Accessibility/ARIA"><code>aria-*</code></a> 和 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/docs/Learn/HTML/Howto/Use_data_attributes"><code>data-*</code></a> 属性是以带 <code>-</code> 符号的 HTML 格式书写的。</p>
<p>HTML→JSX转化器：<a target="_blank" rel="noopener" href="https://transform.tools/html-to-jsx">https://transform.tools/html-to-jsx</a></p>
<h2 id="4-在-JSX-中通过大括号使用-JavaScript"><a href="#4-在-JSX-中通过大括号使用-JavaScript" class="headerlink" title="4.在 JSX 中通过大括号使用 JavaScript"></a>4.在 JSX 中通过大括号使用 JavaScript</h2><p>当你想把一个字符串属性传递给 JSX 时，把它放到单引号或双引号中：<code>src=&quot;https://i.imgur.com/7vQD0fPs.jpg&quot;</code></p>
<p>如果你想要动态地指定 <code>src</code> 或 <code>alt</code> 的值呢？你可以 用 <code>&#123;</code> 和 <code>&#125;</code> 替代 <code>&quot;</code> 和 <code>&quot;</code> 以使用 JavaScript 变量 ：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-munmxwlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-munmxwlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Avatar</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> avatar = <span class="hljs-string">&#x27;https://i.imgur.com/7vQD0fPs.jpg&#x27;</span>;<br>  <span class="hljs-keyword">const</span> description = <span class="hljs-string">&#x27;Gregorio Y. Zara&#x27;</span>;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">img</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;avatar&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">src</span>=<span class="hljs-string">&#123;avatar&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">alt</span>=<span class="hljs-string">&#123;description&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">    /&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p><mark>大括号内的任何 JavaScript 表达式都能正常运行</mark>，包括像 <code>formatDate()</code> 这样的函数调用：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-dejy4ylqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-dejy4ylqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> today = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>();<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">formatDate</span>(<span class="hljs-params">date</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intl</span>.<span class="hljs-title class_">DateTimeFormat</span>(<br>    <span class="hljs-string">&#x27;zh-CN&#x27;</span>,<br>    &#123; <span class="hljs-attr">weekday</span>: <span class="hljs-string">&#x27;long&#x27;</span> &#125;<br>  ).<span class="hljs-title function_">format</span>(date);<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">TodoList</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>To Do List for &#123;formatDate(today)&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>在 JSX 中，只能在以下两种场景中使用大括号：</p>
<ol>
<li><mark>用作 JSX 标签内的文本</mark>：<code>&lt;h1&gt;&#123;name&#125;&#39;s To Do List&lt;/h1&gt;</code> 是有效的，但是 <code>&lt;&#123;tag&#125;&gt;Gregorio Y. Zara&#39;s To Do List&lt;/&#123;tag&#125;&gt;</code> 无效。</li>
<li><mark>用作紧跟在 <code>=</code> 符号后的 属性</mark>：<code>src=&#123;avatar&#125;</code> 会读取 <code>avatar</code> 变量，但是 <code>src=&quot;&#123;avatar&#125;&quot;</code> 只会传一个字符串 <code>&#123;avatar&#125;</code>。</li>
</ol>
<p><mark>双大括号</mark>：除了字符串、数字和其它 JavaScript 表达式，你甚至可以在 JSX 中传递对象。对象也用大括号表示，例如 <code>&#123; name: &quot;Hedy Lamarr&quot;, inventions: 5 &#125;</code>。因此，为了能在 JSX 中传递，你必须用另一对额外的大括号包裹对象：<code>person=&#123;&#123; name: "Hedy Lamarr", inventions: 5 &#125;&#125;</code>。</p>
<p>React 不要求你使用内联样式（使用 CSS 类就能满足大部分情况）。但是当你需要内联样式的时候，你可以给 <code>style</code> 属性传递一个对象：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-h4a6xwlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-h4a6xwlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">TodoList</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&#123;</span></span></span><br><span class="hljs-tag"><span class="language-xml">              &#123;</span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">backgroundColor:</span> &#x27;<span class="hljs-attr">black</span>&#x27;,</span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">color:</span> &#x27;<span class="hljs-attr">pink</span>&#x27;</span></span><br><span class="hljs-tag"><span class="language-xml">    &#125;</span></span><br><span class="hljs-tag"><span class="language-xml">          &#125;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>Improve the videophone<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>Prepare aeronautics lectures<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>Work on the alcohol-fuelled engine<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>内联 <code>style</code> 属性 使用驼峰命名法编写。例如，HTML <code>&lt;ul style=&quot;background-color: black&quot;&gt;</code> 在你的组件里应该写成 <code>&lt;ul style=&#123;&#123; backgroundColor: 'black' &#125;&#125;&gt;</code>。</p>
<p>可以将多个表达式合并到一个对象中，在 JSX 的大括号内分别使用它们：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-pbaps8lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-pbaps8lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> person = &#123;<br>  <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Gregorio Y. Zara&#x27;</span>,<br>  <span class="hljs-attr">theme</span>: &#123;<br>    <span class="hljs-attr">backgroundColor</span>: <span class="hljs-string">&#x27;black&#x27;</span>,<br>    <span class="hljs-attr">color</span>: <span class="hljs-string">&#x27;pink&#x27;</span><br>  &#125;<br>&#125;;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">TodoList</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&#123;person.theme&#125;</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>&#123;person.name&#125;&#x27;s Todos<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">img</span>       <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;avatar&quot;</span>     <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://i.imgur.com/7vQD0fPs.jpg&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;Gregorio Y. Zara&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<h2 id="5-将props传递给组件"><a href="#5-将props传递给组件" class="headerlink" title="5.将props传递给组件"></a>5.将props传递给组件</h2><p>React 组件使用 props 来互相通信。每个父组件都可以提供 props 给它的子组件，从而将一些信息传递给它。</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-qxmz1blqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-qxmz1blqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Avatar</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">img</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;avatar&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://i.imgur.com/1bX5QH6.jpg&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;Lin Lanying&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">width</span>=<span class="hljs-string">&#123;100&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">height</span>=<span class="hljs-string">&#123;100&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">    /&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Profile</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Avatar</span> /&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>向组件传递props：</p>
<ol>
<li><p><mark>将 props 传递给子组件</mark>：<code>person</code>（一个对象）和 <code>size</code>（一个数字）：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-31h5g4lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-31h5g4lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Profile</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Avatar</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">person</span>=<span class="hljs-string">&#123;&#123;</span> <span class="hljs-attr">name:</span> &#x27;<span class="hljs-attr">Lin</span> <span class="hljs-attr">Lanying</span>&#x27;, <span class="hljs-attr">imageId:</span> &#x27;<span class="hljs-attr">1bX5QH6</span>&#x27; &#125;&#125;</span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">size</span>=<span class="hljs-string">&#123;100&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">    /&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>
</li>
<li><p><mark>在子组件中读取 props</mark>：在 <code>function Avatar</code> 之后直接列出它们的名字 <code>person, size</code> 来读取这些 props。这些 props 在 <code>(&#123;</code> 和 <code>&#125;)</code> 之间，并由逗号分隔。</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-dxqcr3lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-dxqcr3lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Avatar</span>(<span class="hljs-params">&#123; person, size &#125;</span>) &#123;<br>  <span class="hljs-comment">// 在这里 person 和 size 是可访问的</span><br>&#125;<br></code></pre></td></tr></table></div></figure></li>
</ol>
<p>props 正是 组件的唯一参数！ React 组件函数接受一个参数，一个 <code>props</code> 对象：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-5ecajclqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-5ecajclqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Avatar</span>(<span class="hljs-params">props</span>) &#123;<br>  <span class="hljs-keyword">let</span> person = props.<span class="hljs-property">person</span>;<br>  <span class="hljs-keyword">let</span> size = props.<span class="hljs-property">size</span>;<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>通常你不需要整个 <code>props</code> 对象，所以可以将它解构为单独的 props。</p>
<p>在声明 props 时， 不要忘记 <code>(</code> 和 <code>)</code> 之间的一对花括号 <code>&#123;</code> 和 <code>&#125;</code>  ：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-94mayglqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-94mayglqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Avatar</span>(<span class="hljs-params">&#123; person, size &#125;</span>) &#123;<br><span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>这种语法被称为 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/docs/Web/JavaScript/Reference/Operators/Destructuring_assignment#Unpacking_fields_from_objects_passed_as_a_function_parameter">“解构”</a>，等价于于从函数参数中读取属性：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-4vfi32lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-4vfi32lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Avatar</span>(<span class="hljs-params">props</span>) &#123;<br>    <span class="hljs-keyword">let</span> person = props.<span class="hljs-property">person</span>;<br>    <span class="hljs-keyword">let</span> size = props.<span class="hljs-property">size</span>;<br>    <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>如果你想在没有指定值的情况下给 prop 一个默认值，你可以通过在参数后面写 <code>=</code> 和默认值来进行解构：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-tsjwbilqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-tsjwbilqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Avatar</span>(<span class="hljs-params">&#123; person, size = <span class="hljs-number">100</span> &#125;</span>) &#123;<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>现在， 如果 <code>&lt;Avatar person=&#123;...&#125; /&gt;</code> 渲染时没有 <code>size</code> prop，  <code>size</code> 将被赋值为 <code>100</code>。</p>
<p>默认值仅在缺少 <code>size</code> prop 或 <code>size=&#123;undefined&#125;</code> 时生效。 但是<mark>如果你传递了 <code>size=&#123;null&#125;</code> 或 <code>size=&#123;0&#125;</code>，默认值将不被使用。</mark></p>
<p>重复：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-0seyxelqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-0seyxelqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Profile</span>(<span class="hljs-params">&#123; person, size, isSepia, thickBorder &#125;</span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;card&quot;</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Avatar</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">person</span>=<span class="hljs-string">&#123;person&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">size</span>=<span class="hljs-string">&#123;size&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">isSepia</span>=<span class="hljs-string">&#123;isSepia&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">thickBorder</span>=<span class="hljs-string">&#123;thickBorder&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>改为<mark>使用 JSX 展开语法传递 props</mark>：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-jtwezzlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-jtwezzlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Profile</span>(<span class="hljs-params">props</span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;card&quot;</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Avatar</span> &#123;<span class="hljs-attr">...props</span>&#125; /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>这会将 <code>Profile</code> 的所有 props 转发到 <code>Avatar</code>，而不列出每个名字。</p>
<p>请克制地使用展开语法。 如果你在所有其他组件中都使用它，那就有问题了。 通常，它表示你应该拆分组件，并将子组件作为 JSX 传递。 </p>
<p><mark>将 JSX 作为子组件传递</mark>：当您将内容嵌套在 JSX 标签中时，父组件将在名为 <code>children</code> 的 prop 中接收到该内容。例如，下面的 <code>Card</code> 组件将接收一个被设为 <code>&lt;Avatar /&gt;</code> 的 <code>children</code> prop 并将其包裹在 div 中渲染。</p>
<p>App.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-zozv7glqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-zozv7glqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Avatar</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./Avatar.js&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Card</span>(<span class="hljs-params">&#123; children &#125;</span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;card&quot;</span>&gt;</span></span><br><span class="language-xml">      &#123;children&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Profile</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Card</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Avatar</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">size</span>=<span class="hljs-string">&#123;100&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">person</span>=<span class="hljs-string">&#123;&#123;</span> </span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">name:</span> &#x27;<span class="hljs-attr">Katsuko</span> <span class="hljs-attr">Saruhashi</span>&#x27;,</span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">imageId:</span> &#x27;<span class="hljs-attr">YfeOqp2</span>&#x27;</span></span><br><span class="hljs-tag"><span class="language-xml">        &#125;&#125;</span></span><br><span class="hljs-tag"><span class="language-xml">      /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">Card</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>Avatar.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-1al0zllqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-1al0zllqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; getImageUrl &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./utils.js&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Avatar</span>(<span class="hljs-params">&#123; person, size &#125;</span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">img</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;avatar&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">src</span>=<span class="hljs-string">&#123;getImageUrl(person)&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">alt</span>=<span class="hljs-string">&#123;person.name&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">width</span>=<span class="hljs-string">&#123;size&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">height</span>=<span class="hljs-string">&#123;size&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">    /&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>utils.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-q04405lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-q04405lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getImageUrl</span>(<span class="hljs-params">person, size = <span class="hljs-string">&#x27;s&#x27;</span></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="hljs-string">&#x27;https://i.imgur.com/&#x27;</span> +<br>    person.<span class="hljs-property">imageId</span> +<br>    size +<br>    <span class="hljs-string">&#x27;.jpg&#x27;</span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>一个组件可能会随着时间的推移收到不同的 props。 Props 并不总是静态的！Props 反映了组件在任何时间点的数据，并不仅仅是在开始时。</p>
<p>props 是 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Immutable_object">不可变的</a>（一个计算机科学术语，意思是“不可改变”）。当一个组件需要改变它的 props（例如，响应用户交互或新数据）时，它不得不“请求”它的父组件传递 不同的 props —— 一个新对象！它的旧 props 将被丢弃，最终 JavaScript 引擎将回收它们占用的内存。</p>
<p>不要尝试“更改 props”。 当你需要响应用户输入（例如更改所选颜色）时，你可以“设置 state”。</p>
<h2 id="6-条件渲染"><a href="#6-条件渲染" class="headerlink" title="6.条件渲染"></a>6.条件渲染</h2><p> React 中，你可以通过使用 JavaScript 的 <code>if</code> 语句、<code>&amp;&amp;</code> 和 <code>? :</code> 运算符【又称条件运算符，三目运算符】来选择性地渲染 JSX。</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-qs0qqylqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-qs0qqylqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Item</span>(<span class="hljs-params">&#123; name, isPacked &#125;</span>) &#123;<br>  <span class="hljs-keyword">if</span> (isPacked) &#123;<br>    <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;item&quot;</span>&gt;</span>&#123;name&#125; ✔<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span>;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;item&quot;</span>&gt;</span>&#123;name&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span>;<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">PackingList</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">section</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Sally Ride 的行李清单<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Item</span> </span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">isPacked</span>=<span class="hljs-string">&#123;true&#125;</span> </span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;宇航服&quot;</span> </span></span><br><span class="hljs-tag"><span class="language-xml">        /&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Item</span> </span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">isPacked</span>=<span class="hljs-string">&#123;true&#125;</span> </span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;带金箔的头盔&quot;</span> </span></span><br><span class="hljs-tag"><span class="language-xml">        /&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Item</span> </span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">isPacked</span>=<span class="hljs-string">&#123;false&#125;</span> </span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;Tam 的照片&quot;</span> </span></span><br><span class="hljs-tag"><span class="language-xml">        /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<img src="image-20231103154214180.png" srcset="/img/loading.gif" lazyload alt="image-20231103154214180" style="zoom:50%;" />

<p>条件运算符：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-kig5q9lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-kig5q9lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">if</span> (isPacked) &#123;<br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;item&quot;</span>&gt;</span>&#123;name&#125; ✔<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span>;<br><br>&#125;<br><span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;item&quot;</span>&gt;</span>&#123;name&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span>;<br></code></pre></td></tr></table></div></figure>

<p>→</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-4uqs1dlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-4uqs1dlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">return</span> (<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;item&quot;</span>&gt;</span></span><br><span class="language-xml">    &#123;isPacked ? name + &#x27; ✔&#x27; : name&#125;</span><br><span class="language-xml">  <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span><br>);<br></code></pre></td></tr></table></div></figure>

<p>使用 <code>&amp;&amp;</code>，你也可以实现仅当 <code>isPacked</code> 为 <code>true</code> 时，渲染勾选符号。</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-0irlrqlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-0irlrqlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">return</span> (<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;item&quot;</span>&gt;</span></span><br><span class="language-xml">    &#123;name&#125; &#123;isPacked &amp;&amp; &#x27;✔&#x27;&#125;</span><br><span class="language-xml">  <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span><br>);<br></code></pre></td></tr></table></div></figure>

<p>当 <code>isPacked</code> 为真值时，则（<code>&amp;&amp;</code>）渲染勾选符号，否则，不渲染。</p>
<p>当 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/Logical_AND">JavaScript &amp;&amp; 表达式</a> 的左侧（我们的条件）为 <code>true</code> 时，它则返回其右侧的值（在我们的例子里是勾选符号）。但条件的结果是 <code>false</code>，则整个表达式会变成 <code>false</code>。在 JSX 里，React 会将 <code>false</code> 视为一个“空值”，就像 <code>null</code> 或者 <code>undefined</code>，这样 React 就不会在这里进行任何渲染。</p>
<p>切勿将数字放在 <code>&amp;&amp;</code> 左侧：<mark>JavaScript 会自动将左侧的值转换成布尔类型以判断条件成立与否</mark>。然而，如果左侧是 <code>0</code>，整个表达式将变成左侧的值（<code>0</code>），React 此时则会渲染 <code>0</code> 而不是不进行渲染。</p>
<p>例如，一个常见的错误是 <code>messageCount &amp;&amp; &lt;p&gt;New messages&lt;/p&gt;</code>。其原本是想当 <code>messageCount</code> 为 0 的时候不进行渲染，但实际上却渲染了 <code>0</code>。</p>
<p>为了更正，可以将左侧的值改成布尔类型：<code>messageCount &gt; 0 &amp;&amp; &lt;p&gt;New messages&lt;/p&gt;</code>。</p>
<h2 id="7-渲染列表"><a href="#7-渲染列表" class="headerlink" title="7.渲染列表"></a>7.渲染列表</h2><figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-u3nplvlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-u3nplvlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs jsx">&lt;ul&gt;<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>凯瑟琳·约翰逊: 数学家<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span><br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>马里奥·莫利纳: 化学家<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span><br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>穆罕默德·阿卜杜勒·萨拉姆: 物理学家<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span><br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>珀西·莱温·朱利亚: 化学家<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span><br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>苏布拉马尼扬·钱德拉塞卡: 天体物理学家<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span><br>&lt;/ul&gt;<br></code></pre></td></tr></table></div></figure>

<p>→</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-k064rjlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-k064rjlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> people = [<br>  <span class="hljs-string">&#x27;凯瑟琳·约翰逊: 数学家&#x27;</span>,<br>  <span class="hljs-string">&#x27;马里奥·莫利纳: 化学家&#x27;</span>,<br>  <span class="hljs-string">&#x27;穆罕默德·阿卜杜勒·萨拉姆: 物理学家&#x27;</span>,<br>  <span class="hljs-string">&#x27;珀西·莱温·朱利亚: 化学家&#x27;</span>,<br>  <span class="hljs-string">&#x27;苏布拉马尼扬·钱德拉塞卡: 天体物理学家&#x27;</span>,<br>];<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">List</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> listItems = people.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">person</span> =&gt;</span><br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>&#123;person&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span><br>  );<br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>&#123;listItems&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span>;<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>输出控制台错误：<code>Warning: Each child in a list should have a unique “key” prop.</code></p>
<p>解决方法：因为你必须给数组中的每一项都指定一个 <code>key</code>——它可以是字符串或数字的形式，只要能唯一标识出各个数组项就行：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-6qtftrlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-6qtftrlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jsx">&lt;li key=&#123;person.<span class="hljs-property">id</span>&#125;&gt;...&lt;/li&gt;<br></code></pre></td></tr></table></div></figure>

<p><mark>直接放在 <code>map()</code> 方法里的 JSX 元素一般都需要指定 <code>key</code> 值！</mark></p>
<p>不同来源的数据往往对应不同的 key 值获取方式：</p>
<ul>
<li>来自数据库的数据： 如果你的数据是从数据库中获取的，那你可以直接使用数据表中的主键，因为它们天然具有唯一性。</li>
<li>本地产生数据： 如果你数据的产生和保存都在本地（例如笔记软件里的笔记），那么你可以使用一个自增计数器或者一个类似 <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/uuid"><code>uuid</code></a> 的库来生成 key。</li>
</ul>
<p>key 需要满足的条件：</p>
<ol>
<li>key 值在兄弟节点之间必须是唯一的。 不过不要求全局唯一，在不同的数组中可以使用相同的 key。</li>
<li>key 值不能改变，否则就失去了使用 key 的意义！所以千万不要在渲染时动态地生成 key。</li>
</ol>
<p class="note note-success" style="border-left: 4px solid #42b983;padding: 10px 15px;color: #777;background-color: rgba(66, 185, 131, .1);">你可能会想直接把数组项的索引当作 key 值来用，实际上，如果你没有显式地指定 `key` 值，React 确实默认会这么做。但是数组项的顺序在插入、删除或者重新排序等操作中会发生改变，此时把索引顺序用作 key 值会产生一些微妙且令人困惑的 bug。<br />与之类似，请不要在运行过程中动态地产生 key，像是 `key={Math.random()}` 这种方式。这会导致每次重新渲染后的 key 值都不一样，从而使得所有的组件和 DOM 元素每次都要重新创建。这不仅会造成运行变慢的问题，更有可能导致用户输入的丢失。所以，使用能从给定数据中稳定取得的值才是明智的选择。

<p>有一点需要注意，组件不会把 <code>key</code> 当作 props 的一部分。Key 的存在只对 React 本身起到提示作用。如果你的组件需要一个 ID，那么请把它作为一个单独的 prop 传给组件： <code>&lt;Profile key=&#123;id&#125; userId=&#123;id&#125; /&gt;</code>。</p></p>
<hr>
<p>data.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-rn0d43lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-rn0d43lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> people = [<br>  &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">0</span>,<br>    <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;凯瑟琳·约翰逊&#x27;</span>,<br>    <span class="hljs-attr">profession</span>: <span class="hljs-string">&#x27;数学家&#x27;</span>,<br>    <span class="hljs-attr">accomplishment</span>: <span class="hljs-string">&#x27;太空飞行相关数值的核算&#x27;</span>,<br>    <span class="hljs-attr">imageId</span>: <span class="hljs-string">&#x27;MK3eW3A&#x27;</span>,<br>  &#125;,<br>  &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,<br>    <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;马里奥·莫利纳&#x27;</span>,<br>    <span class="hljs-attr">profession</span>: <span class="hljs-string">&#x27;化学家&#x27;</span>,<br>    <span class="hljs-attr">accomplishment</span>: <span class="hljs-string">&#x27;北极臭氧空洞的发现&#x27;</span>,<br>    <span class="hljs-attr">imageId</span>: <span class="hljs-string">&#x27;mynHUSa&#x27;</span>,<br>  &#125;,<br>  &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>,<br>    <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;穆罕默德·阿卜杜勒·萨拉姆&#x27;</span>,<br>    <span class="hljs-attr">profession</span>: <span class="hljs-string">&#x27;物理学家&#x27;</span>,<br>    <span class="hljs-attr">accomplishment</span>: <span class="hljs-string">&#x27;关于基本粒子间弱相互作用和电磁相互作用的统一理论&#x27;</span>,<br>    <span class="hljs-attr">imageId</span>: <span class="hljs-string">&#x27;bE7W1ji&#x27;</span>,<br>  &#125;,<br>  &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">3</span>,<br>    <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;珀西·莱温·朱利亚&#x27;</span>,<br>    <span class="hljs-attr">profession</span>: <span class="hljs-string">&#x27;化学家&#x27;</span>,<br>    <span class="hljs-attr">accomplishment</span>: <span class="hljs-string">&#x27;开创性的可的松药物、类固醇和避孕药的研究&#x27;</span>,<br>    <span class="hljs-attr">imageId</span>: <span class="hljs-string">&#x27;IOjWm71&#x27;</span>,<br>  &#125;,<br>  &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">4</span>,<br>    <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;苏布拉马尼扬·钱德拉塞卡&#x27;</span>,<br>    <span class="hljs-attr">profession</span>: <span class="hljs-string">&#x27;天体物理学家&#x27;</span>,<br>    <span class="hljs-attr">accomplishment</span>: <span class="hljs-string">&#x27;白矮星质量计算&#x27;</span>,<br>    <span class="hljs-attr">imageId</span>: <span class="hljs-string">&#x27;lrWQx8l&#x27;</span>,<br>  &#125;,<br>];<br></code></pre></td></tr></table></div></figure>

<p>utils.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-qm3x5ulqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-qm3x5ulqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getImageUrl</span>(<span class="hljs-params">person</span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="hljs-string">&#x27;https://i.imgur.com/&#x27;</span> +<br>    person.<span class="hljs-property">imageId</span> +<br>    <span class="hljs-string">&#x27;s.jpg&#x27;</span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>App.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-xm0tn4lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-xm0tn4lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; people &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./data.js&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; getImageUrl &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./utils.js&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">List</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> chemists = people.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">person</span> =&gt;</span><br>    person.<span class="hljs-property">profession</span> === <span class="hljs-string">&#x27;化学家&#x27;</span><br>  );<br>  <span class="hljs-keyword">const</span> listItems = chemists.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">person</span> =&gt;</span><br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">img</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">src</span>=<span class="hljs-string">&#123;getImageUrl(person)&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">alt</span>=<span class="hljs-string">&#123;person.name&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">b</span>&gt;</span>&#123;person.name&#125;:<span class="hljs-tag">&lt;/<span class="hljs-name">b</span>&gt;</span></span><br><span class="language-xml">        &#123;&#x27; &#x27; + person.profession + &#x27; &#x27;&#125;</span><br><span class="language-xml">        因&#123;person.accomplishment&#125;而闻名世界</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span><br>  );<br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>&#123;listItems&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span>;<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>控制台错误：<code>Warning: Each child in a list should have a unique &quot;key&quot; prop. Check the render method of List. See https://reactjs.org/link/warning-keys for more information.    at li    at List</code></p>
<p><mark>因为箭头函数会隐式地返回位于 <code>=&gt;</code> 之后的表达式，所以你可以省略 <code>return</code> 语句。</mark></p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-bvsv4vlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-bvsv4vlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> listItems = chemists.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">person</span> =&gt;</span><br><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span> <span class="hljs-comment">// 隐式地返回！</span><br><br>);<br></code></pre></td></tr></table></div></figure>

<p><mark>如果你的 <code>=&gt;</code> 后面跟了一对花括号 <code>&#123;</code> ，那你必须使用 <code>return</code> 来指定返回值！</mark></p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-3xwejtlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-3xwejtlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> listItems = chemists.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">person</span> =&gt;</span> &#123; <span class="hljs-comment">// 花括号</span><br><span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span>;<br>&#125;);<br></code></pre></td></tr></table></div></figure>

<p>箭头函数 <code>=&gt; &#123;</code> 后面的部分被称为 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Functions/Arrow_functions#function_body">“块函数体”</a>，块函数体支持多行代码的写法，但要用 <code>return</code> 语句才能指定返回值。假如你忘了写 <code>return</code>，那这个函数什么都不会返回！</p>
<p>为每个列表项显示多个 DOM 节点：Fragment 语法的简写形式 <code>&lt;&gt; &lt;/&gt;</code> 无法接受 key 值，所以你只能要么把生成的节点用一个 <code>&lt;div&gt;</code> 标签包裹起来，要么使用长一点但更明确的 <code>&lt;Fragment&gt;</code> 写法：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-yairoilqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-yairoilqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Fragment</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">const</span> listItems = people.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">person</span> =&gt;</span><br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Fragment</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;person.id&#125;</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>&#123;person.name&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>&#123;person.bio&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;/<span class="hljs-name">Fragment</span>&gt;</span></span><br>);<br></code></pre></td></tr></table></div></figure>

<p>这里的 Fragment 标签本身并不会出现在 DOM 上，这串代码最终会转换成 <code>&lt;h1&gt;</code>、<code>&lt;p&gt;</code>、<code>&lt;h1&gt;</code>、<code>&lt;p&gt;</code>…… 的列表。</p>
<h2 id="8-保持组件纯粹"><a href="#8-保持组件纯粹" class="headerlink" title="8.保持组件纯粹"></a>8.保持组件纯粹</h2><p>部分 JavaScript 函数是 纯粹 的，这类函数通常被称为纯函数。纯函数仅执行计算操作，不做其他操作。你可以通过将组件按纯函数严格编写，以避免一些随着代码库的增长而出现的、令人困扰的 bug 以及不可预测的行为。</p>
<p>纯函数的特征：</p>
<ul>
<li>只负责自己的任务。它不会更改在该函数调用前就已存在的对象或变量。</li>
<li>输入相同，则输出相同。给定相同的输入，纯函数应总是返回相同的结果。</li>
</ul>
<p>React 假设你编写的所有组件都是纯函数。也就是说，对于相同的输入，你所编写的 React 组件必须总是返回相同的 JSX。</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-x7l50ylqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-x7l50ylqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Recipe</span>(<span class="hljs-params">&#123; drinkers &#125;</span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ol</span>&gt;</span>    </span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>Boil &#123;drinkers&#125; cups of water.<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>Add &#123;drinkers&#125; spoons of tea and &#123;0.5 * drinkers&#125; spoons of spice.<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>Add &#123;0.5 * drinkers&#125; cups of milk to boil and sugar to taste.<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">ol</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">section</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Spiced Chai Recipe<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>For two<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Recipe</span> <span class="hljs-attr">drinkers</span>=<span class="hljs-string">&#123;2&#125;</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>For a gathering<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Recipe</span> <span class="hljs-attr">drinkers</span>=<span class="hljs-string">&#123;4&#125;</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>React 的渲染过程必须自始至终是纯粹的。组件应该只 返回 它们的 JSX，而不 改变 在渲染前，就已存在的任何对象或变量 — 这将会使它们变得不纯粹！</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-pfeqtalqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-pfeqtalqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">let</span> guest = <span class="hljs-number">0</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Cup</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-comment">// Bad: changing a preexisting variable!</span><br>  guest = guest + <span class="hljs-number">1</span>;<br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>Tea cup for guest #&#123;guest&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></span>;<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">TeaSet</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Cup</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Cup</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Cup</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p> <a target="_blank" rel="noopener" href="http://localhost:3000/learn/passing-props-to-a-component">将 <code>guest</code> 作为 prop 传入</a> 来修复此组件：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-ttxvvnlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-ttxvvnlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Cup</span>(<span class="hljs-params">&#123; guest &#125;</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>Tea cup for guest #&#123;guest&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></span>;<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">TeaSet</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Cup</span> <span class="hljs-attr">guest</span>=<span class="hljs-string">&#123;1&#125;</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Cup</span> <span class="hljs-attr">guest</span>=<span class="hljs-string">&#123;2&#125;</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Cup</span> <span class="hljs-attr">guest</span>=<span class="hljs-string">&#123;3&#125;</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>在 React 中，你可以在渲染时读取三种输入：<a target="_blank" rel="noopener" href="http://localhost:3000/learn/passing-props-to-a-component">props</a>，<a target="_blank" rel="noopener" href="http://localhost:3000/learn/state-a-components-memory">state</a> 和 <a target="_blank" rel="noopener" href="http://localhost:3000/learn/passing-data-deeply-with-context">context</a>。你应该始终将这些输入视为只读。</p>
<p>当你想根据用户输入更改某些内容时，你应该 <a target="_blank" rel="noopener" href="http://localhost:3000/learn/state-a-components-memory">设置state</a>，而不是直接写入变量。当你的组件正在渲染时，你永远不应该改变预先存在的变量或对象。</p>
<p>React 提供了 “严格模式”，在严格模式下开发时，它将会调用每个组件函数两次。通过重复调用组件函数，严格模式有助于找到违反这些规则的组件。</p>
<p>严格模式在生产环境下不生效，因此它不会降低应用程序的速度。如需引入严格模式，你可以用 <code>&lt;React.StrictMode&gt;</code> 包裹根组件。一些框架会默认这样做。</p>
<hr>
<p>&#x3D;&#x3D;突变&#x3D;&#x3D;mutation：在渲染过程中，组件改变了 预先存在的 变量的值 。纯函数不会改变函数作用域外的变量、或在函数调用前创建的对象——这会使函数变得不纯粹！</p>
<p>但是，你完全可以在渲染时更改你刚刚创建的变量和对象。</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-sgh2jplqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-sgh2jplqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Cup</span>(<span class="hljs-params">&#123; guest &#125;</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>Tea cup for guest #&#123;guest&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></span>;<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">TeaGathering</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">let</span> cups = [];<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">12</span>; i++) &#123;<br>    cups.<span class="hljs-title function_">push</span>(<span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Cup</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;i&#125;</span> <span class="hljs-attr">guest</span>=<span class="hljs-string">&#123;i&#125;</span> /&gt;</span></span>);<br>  &#125;<br>  <span class="hljs-keyword">return</span> cups;<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>如果 <code>cups</code> 变量或 <code>[]</code> 数组是在 <code>TeaGathering</code> 函数之外创建的，这将是一个很大的问题！因为如果那样的话，当你调用数组的 push 方法时，就会更改 预先存在的 对象。</p>
<p>但是，这里不会有影响，因为每次渲染时，你都是在 <code>TeaGathering</code> 函数内部创建的它们。TeaGathering 之外的代码并不会知道发生了什么即局部mutation。</p>
<p> 副作用：更新屏幕、启动动画、更改数据等。它们是 “额外” 发生的事情，与渲染过程无关。</p>
<p>在 React 中，副作用通常属于 <a target="_blank" rel="noopener" href="http://localhost:3000/learn/responding-to-events">事件处理程序</a>。事件处理程序是 React 在你执行某些操作（如单击按钮）时运行的函数。即使事件处理程序是在你的组件 内部 定义的，它们也不会在渲染期间运行！ 因此事件处理程序无需是纯函数。</p>
<p>如果你用尽一切办法，仍无法为副作用找到合适的事件处理程序，你还可以调用组件中的 <a target="_blank" rel="noopener" href="http://localhost:3000/reference/react/useEffect"><code>useEffect</code></a> 方法将其附加到返回的 JSX 中。这会告诉 React 在渲染结束后执行它。然而，这种方法应该是你最后的手段。</p>
<p>React 为何侧重于纯函数：</p>
<ol>
<li>你的组件可以在不同的环境下运行 — 例如，在服务器上！由于它们针对相同的输入，总是返回相同的结果，因此一个组件可以满足多个用户请求。</li>
<li>你可以为那些输入未更改的组件来 <a target="_blank" rel="noopener" href="http://localhost:3000/reference/react/memo">跳过渲染</a>，以提高性能。这是安全的做法，因为纯函数总是返回相同的结果，所以可以安全地缓存它们。</li>
<li>如果在渲染深层组件树的过程中，某些数据发生了变化，React 可以重新开始渲染，而不会浪费时间完成过时的渲染。纯粹性使得它随时可以安全地停止计算。</li>
</ol>
<p>我们正在构建的每个 React 新特性都利用到了纯函数。从数据获取到动画再到性能，保持组件的纯粹可以充分释放 React 范式的能力。</p>
<h2 id="9-将UI视为树"><a href="#9-将UI视为树" class="headerlink" title="9.将UI视为树"></a>9.将UI视为树</h2><p>React 创建的 UI 树是由渲染过的组件构成的，被称为渲染树。</p>
<p>渲染树表示 React 应用程序的单个渲染过程。在 <a target="_blank" rel="noopener" href="http://localhost:3000/learn/conditional-rendering">条件渲染</a> 中，父组件可以根据传递的数据渲染不同的子组件。每次渲染过程的渲染树可能都不同。</p>
<p>在 React 应用程序中，可以使用树来建模的另一个关系是应用程序的模块依赖关系。当 <a target="_blank" rel="noopener" href="http://localhost:3000/learn/importing-and-exporting-components#exporting-and-importing-a-component">拆分组件</a> 和逻辑到不同的文件中时，就创建了 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Modules">JavaScript 模块</a>，在这些模块中可以导出组件、函数或常量。</p>
<p>模块依赖树中的每个节点都是一个模块，每个分支代表该模块中的 <code>import</code> 语句。</p>
<p>渲染树：</p>
<img src="image-20231103171110755.png" srcset="/img/loading.gif" lazyload alt="image-20231103171110755" style="zoom:50%;" />

<p>模块依赖树：</p>
<img src="image-20231103171127909.png" srcset="/img/loading.gif" lazyload alt="image-20231103171127909" style="zoom:50%;" />

<p>依赖树对于确定运行 React 应用程序所需的模块非常有用。在为生产环境构建 React 应用程序时，通常会有一个构建步骤，该步骤将捆绑所有必要的 JavaScript 以供客户端使用。负责此操作的工具称为 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Learn/Tools_and_testing/Understanding_client-side_tools/Overview#the_modern_tooling_ecosystem">bundler（捆绑器）</a>，并且 bundler 将使用依赖树来确定应包含哪些模块。</p>
<p>随着应用程序的增长，捆绑包大小通常也会增加。大型捆绑包大小对于客户端来说下载和运行成本高昂，并延迟 UI 绘制的时间。了解应用程序的依赖树可能有助于调试这些问题。</p>
<h1 id="四-添加交互"><a href="#四-添加交互" class="headerlink" title="四.添加交互"></a>四.添加交互</h1><p>在 React 中，随时间变化的数据被称为状态state。你可以向任何组件添加状态，并按需进行更新。</p>
<h2 id="1-响应事件"><a href="#1-响应事件" class="headerlink" title="1.响应事件"></a>1.响应事件</h2><p>React 允许你向 JSX 中添加事件处理程序。</p>
<p><code>&lt;button&gt;</code> 等内置组件只支持内置浏览器事件，如 <code>onClick</code>。可以定义 <code>handleClick</code> 函数然后 <a target="_blank" rel="noopener" href="http://localhost:3000/learn/passing-props-to-a-component">将其作为 prop 传入</a> <code>&lt;button&gt;</code>。其中 <code>handleClick</code> 是一个 事件处理函数 。<mark>事件处理函数</mark>有如下特点:</p>
<ul>
<li>通常在你的组件 内部 定义。</li>
<li>名称以 <code>handle</code> 开头，后跟事件名称。</li>
</ul>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-tsb3dtlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-tsb3dtlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Button</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">alert</span>(<span class="hljs-string">&#x27;你点击了我！&#x27;</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handleClick&#125;</span>&gt;</span></span><br><span class="language-xml">      点我</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>或者，你也可以在 JSX 中定义一个内联的事件处理函数：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-ez4kcilqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-ez4kcilqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jsx">&lt;button onClick=&#123;<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"></span>) &#123;<br><br>  <span class="hljs-title function_">alert</span>(<span class="hljs-string">&#x27;你点击了我！&#x27;</span>);<br><br>&#125;&#125;&gt;<br></code></pre></td></tr></table></div></figure>

<p>或者，直接使用更为简洁箭头函数：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-pwren7lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-pwren7lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jsx">&lt;button onClick=&#123;<span class="hljs-function">() =&gt;</span> &#123;<br><br>  <span class="hljs-title function_">alert</span>(<span class="hljs-string">&#x27;你点击了我！&#x27;</span>);<br><br>&#125;&#125;&gt;<br></code></pre></td></tr></table></div></figure>

<p>传递给事件处理函数的函数应直接传递，而非调用。例如：</p>
<table>
<thead>
<tr>
<th>传递一个函数（正确）</th>
<th>调用一个函数（错误）</th>
</tr>
</thead>
<tbody><tr>
<td><code>&lt;button onClick=&#123;handleClick&#125;&gt;</code></td>
<td><code>&lt;button onClick=&#123;handleClick()&#125;&gt;</code></td>
</tr>
</tbody></table>
<p>区别很微妙。在第一个示例中，<code>handleClick</code> 函数作为 <code>onClick</code> 事件处理函数传递。这会让 React 记住它，并且只在用户点击按钮时调用你的函数。</p>
<p>在第二个示例中，<code>handleClick()</code> 中最后的 <code>()</code> 会在 <a target="_blank" rel="noopener" href="http://localhost:3000/learn/render-and-commit">渲染</a> 过程中 立即 触发函数，即使没有任何点击。这是因为在 <a target="_blank" rel="noopener" href="http://localhost:3000/learn/javascript-in-jsx-with-curly-braces">JSX <code>&#123;</code> 和 <code>&#125;</code></a> 之间的 JavaScript 会立即执行。</p>
<p>当你编写内联代码时，同样的陷阱可能会以不同的方式出现：</p>
<table>
<thead>
<tr>
<th>传递一个函数（正确）</th>
<th>调用一个函数（错误）</th>
</tr>
</thead>
<tbody><tr>
<td><code>&lt;button onClick=&#123;() =&gt; alert(&#39;...&#39;)&#125;&gt;</code></td>
<td><code>&lt;button onClick=&#123;alert(&#39;...&#39;)&#125;&gt;</code></td>
</tr>
</tbody></table>
<p>如果按如下方式传递内联代码，并不会在点击时触发，而是会在每次组件渲染时触发：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-shhcsnlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-shhcsnlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-comment">// 这个 alert 在组件渲染时触发，而不是点击时触发！</span><br><br>&lt;button onClick=&#123;<span class="hljs-title function_">alert</span>(<span class="hljs-string">&#x27;你点击了我！&#x27;</span>)&#125;&gt;<br></code></pre></td></tr></table></div></figure>

<p>如果你想要定义内联事件处理函数，请将其包装在匿名函数中，如下所示：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-p4gtfolqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-p4gtfolqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jsx">&lt;button onClick=&#123;<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">alert</span>(<span class="hljs-string">&#x27;你点击了我！&#x27;</span>)&#125;&gt;<br></code></pre></td></tr></table></div></figure>

<p>这里创建了一个稍后调用的函数，而不会在每次渲染时执行其内部代码。</p>
<p>在这两种情况下，你都应该传递一个函数：</p>
<ul>
<li><code>&lt;button onClick=&#123;handleClick&#125;&gt;</code> 传递了 <code>handleClick</code> 函数。</li>
<li><code>&lt;button onClick=&#123;() =&gt; alert(&#39;...&#39;)&#125;&gt;</code> 传递了 <code>() =&gt; alert(&#39;...&#39;)</code> 函数。</li>
</ul>
<p>由于事件处理函数声明于组件内部，因此它们可以直接访问组件的 props：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-2jud4slqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-2jud4slqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">AlertButton</span>(<span class="hljs-params">&#123; message, children &#125;</span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> alert(message)&#125;&gt;</span><br><span class="language-xml">      &#123;children&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Toolbar</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">AlertButton</span> <span class="hljs-attr">message</span>=<span class="hljs-string">&quot;正在播放！&quot;</span>&gt;</span></span><br><span class="language-xml">        播放电影</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">AlertButton</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">AlertButton</span> <span class="hljs-attr">message</span>=<span class="hljs-string">&quot;正在上传！&quot;</span>&gt;</span></span><br><span class="language-xml">        上传图片</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">AlertButton</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>通常，我们会在父组件中定义子组件的事件处理函数。比如：置于不同位置的 <code>Button</code> 组件，可能最终执行的功能也不同。</p>
<p>为此，将组件从父组件接收的 prop 作为事件处理函数传递：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-dkh1kdlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-dkh1kdlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Button</span>(<span class="hljs-params">&#123; onClick, children &#125;</span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;onClick&#125;</span>&gt;</span></span><br><span class="language-xml">      &#123;children&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">PlayButton</span>(<span class="hljs-params">&#123; movieName &#125;</span>) &#123;<br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handlePlayClick</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">alert</span>(<span class="hljs-string">`正在播放 <span class="hljs-subst">$&#123;movieName&#125;</span>！`</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handlePlayClick&#125;</span>&gt;</span></span><br><span class="language-xml">      播放 &quot;&#123;movieName&#125;&quot;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">UploadButton</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> alert(&#x27;正在上传！&#x27;)&#125;&gt;</span><br><span class="language-xml">      上传图片</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Toolbar</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">PlayButton</span> <span class="hljs-attr">movieName</span>=<span class="hljs-string">&quot;魔女宅急便&quot;</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">UploadButton</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p><code>Toolbar</code> 组件渲染了一个 <code>PlayButton</code> 组件和 <code>UploadButton</code> 组件：</p>
<ul>
<li><code>PlayButton</code> 将 <code>handlePlayClick</code> 作为 <code>onClick</code> prop 传入 <code>Button</code> 组件内部。</li>
<li><code>UploadButton</code> 将 <code>() =&gt; alert(&#39;正在上传！&#39;)</code> 作为 <code>onClick</code> prop 传入 <code>Button</code> 组件内部。</li>
</ul>
<p>内置组件（<code>&lt;button&gt;</code> 和 <code>&lt;div&gt;</code>）仅支持 <a target="_blank" rel="noopener" href="http://localhost:3000/reference/react-dom/components/common#common-props">浏览器事件名称</a>，例如 <code>onClick</code>。但是，当你构建自己的组件时，你可以按你个人喜好命名事件处理函数的 prop。</p>
<p><mark>按照惯例，事件处理函数 props 应该以 <code>on</code> 开头，后跟一个大写字母。</mark></p>
<p>例如，<code>Button</code> 组件的 <code>onClick</code> prop 本来也可以被命名为 <code>onSmash</code>：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-pe7m31lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-pe7m31lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Button</span>(<span class="hljs-params">&#123; onSmash, children &#125;</span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;onSmash&#125;</span>&gt;</span></span><br><span class="language-xml">      &#123;children&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">onSmash</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> alert(&#x27;正在播放！&#x27;)&#125;&gt;</span><br><span class="language-xml">        播放电影</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">onSmash</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> alert(&#x27;正在上传！&#x27;)&#125;&gt;</span><br><span class="language-xml">        上传图片</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p><code>&lt;button onClick=&#123;onSmash&#125;&gt;</code> 代表浏览器内置的 <code>&lt;button&gt;</code>（小写）仍然需要使用 <code>onClick</code> prop，而自定义的 <code>Button</code> 组件接收到的 prop 名称可由你决定！</p>
<p><mark>确保为事件处理程序使用适当的 HTML 标签。例如，要处理点击事件，请使用 <code>&lt;div onClick=&#123;handleClick&#125;&gt;</code>。使用真正的浏览器 <code>&lt;button&gt;</code> 启用内置的浏览器行为，如键盘导航。</mark></p>
<p>事件处理函数还将捕获任何来自子组件的事件。</p>
<p><mark>事件传播</mark>：事件会沿着树向上“冒泡”或“传播”：它从事件发生的地方开始，然后沿着树向上传播。</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-zbmwtolqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-zbmwtolqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Toolbar</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;Toolbar&quot;</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> &#123;</span><br><span class="language-xml">      alert(&#x27;你点击了 toolbar ！&#x27;);</span><br><span class="language-xml">    &#125;&#125;&gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> alert(&#x27;正在播放！&#x27;)&#125;&gt;</span><br><span class="language-xml">        播放电影</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> alert(&#x27;正在上传！&#x27;)&#125;&gt;</span><br><span class="language-xml">        上传图片</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<img src="事件传播.gif" srcset="/img/loading.gif" lazyload alt="事件传播" style="zoom:50%;" />

<p>如果你点击任一按钮，它自身的 <code>onClick</code> 将首先执行，然后父级 <code>&lt;div&gt;</code> 的 <code>onClick</code> 会接着执行。因此会出现两条消息。如果你点击 toolbar 本身，将只有父级 <code>&lt;div&gt;</code> 的 <code>onClick</code> 会执行。</p>
<p>在 React 中所有事件都会传播，除了 <code>onScroll</code>，它仅适用于你附加到的 JSX 标签。</p>
<p><mark>阻止传播</mark>：事件处理函数接收一个 事件对象 作为唯一的参数。按照惯例，它通常被称为 <code>e</code> ，代表 “event”（事件）。你可以使用此对象来读取有关事件的信息。</p>
<p>这个事件对象还允许你阻止传播。如果你想阻止一个事件到达父组件，你需要像下面 <code>Button</code> 组件那样调用 <code>e.stopPropagation()</code> ：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-cwgf4hlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-cwgf4hlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Button</span>(<span class="hljs-params">&#123; onClick, children &#125;</span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> &#123;</span><br><span class="language-xml">      e.stopPropagation();</span><br><span class="language-xml">      onClick();</span><br><span class="language-xml">    &#125;&#125;&gt;</span><br><span class="language-xml">      &#123;children&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Toolbar</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;Toolbar&quot;</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> &#123;</span><br><span class="language-xml">      alert(&#x27;你点击了 toolbar ！&#x27;);</span><br><span class="language-xml">    &#125;&#125;&gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> alert(&#x27;正在播放！&#x27;)&#125;&gt;</span><br><span class="language-xml">        播放电影</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> alert(&#x27;正在上传！&#x27;)&#125;&gt;</span><br><span class="language-xml">        上传图片</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>当你点击按钮时：</p>
<ol>
<li><p>React 调用了传递给 <code>&lt;button&gt;</code> 的 <code>onClick</code> 处理函数。</p>
</li>
<li><p>定义在Button中的处理函数执行了如下操作：</p>
<ul>
<li>调用 <code>e.stopPropagation()</code>，阻止事件进一步冒泡。</li>
<li>调用 <code>onClick</code> 函数，它是从 <code>Toolbar</code> 组件传递过来的 prop。</li>
</ul>
</li>
<li><p>在 <code>Toolbar</code> 组件中定义的函数，显示按钮对应的 alert。</p>
</li>
<li><p>由于传播被阻止，父级 <code>&lt;div&gt;</code> 的 <code>onClick</code> 处理函数不会执行。</p>
</li>
</ol>
<p>由于调用了 <code>e.stopPropagation()</code>，点击按钮现在将只显示一个 alert（来自 <code>&lt;button&gt;</code>），而并非两个（分别来自 <code>&lt;button&gt;</code> 和父级 toolbar <code>&lt;div&gt;</code>）。</p>
<hr>
<p><mark>捕获阶段事件</mark>：极少数情况下，你可能需要捕获子元素上的所有事件，即便它们阻止了传播。例如，你可能想对每次点击进行埋点记录，传播逻辑暂且不论。那么你可以通过在事件名称末尾添加 <code>Capture</code> 来实现这一点：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-mqbar4lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-mqbar4lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs jsx">&lt;div onClickCapture=&#123;<span class="hljs-function">() =&gt;</span> &#123; <span class="hljs-comment">/* 这会首先执行 */</span> &#125;&#125;&gt;<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> e.stopPropagation()&#125; /&gt;</span><br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> e.stopPropagation()&#125; /&gt;</span><br>&lt;/div&gt;<br></code></pre></td></tr></table></div></figure>

<p>每个事件分三个阶段传播：</p>
<ol>
<li>它向下传播，调用所有的 <code>onClickCapture</code> 处理函数。</li>
<li>它执行被点击元素的 <code>onClick</code> 处理函数。</li>
<li>它向上传播，调用所有的 <code>onClick</code> 处理函数。</li>
</ol>
<p>捕获事件对于路由或数据分析之类的代码很有用，但你可能不会在应用程序代码中使用它们。</p>
<hr>
<p><mark>传递处理函数作为事件传播的替代方案</mark>：注意，此处的点击事件处理函数先执行了一行代码，然后调用了父组件传递的 <code>onClick</code> prop：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-6fkr9qlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-6fkr9qlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Button</span>(<span class="hljs-params">&#123; onClick, children &#125;</span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> &#123;</span><br><span class="language-xml">      e.stopPropagation();</span><br><span class="language-xml">      onClick();</span><br><span class="language-xml">    &#125;&#125;&gt;</span><br><span class="language-xml">      &#123;children&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>你也可以在调用父元素 <code>onClick</code> 函数之前，向这个处理函数添加更多代码。此模式是事件传播的另一种 替代方案 。它让子组件处理事件，同时也让父组件指定一些额外的行为。与事件传播不同，它并非自动。但使用这种模式的好处是你可以清楚地追踪因某个事件的触发而执行的整条代码链。</p>
<p>如果你依赖于事件传播，而且很难追踪哪些处理程序在执行，及其执行的原因，可以尝试这种方法。</p>
<hr>
<p>某些浏览器事件具有与事件相关联的默认行为。例如，点击 <code>&lt;form&gt;</code> 表单内部的按钮会触发表单提交事件，<mark>默认情况下将重新加载整个页面</mark>：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-180mg0lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-180mg0lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Signup</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">onSubmit</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> alert(&#x27;提交表单！&#x27;)&#125;&gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>发送<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<img src="默认行为.gif" srcset="/img/loading.gif" lazyload alt="默认行为" style="zoom:50%;" />

<p>可以调用事件对象中的 <code>e.preventDefault()</code> 来阻止这种情况发生：页面不会重新加载。</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-lqxtztlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-lqxtztlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Signup</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">onSubmit</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> &#123;</span><br><span class="language-xml">      e.preventDefault();</span><br><span class="language-xml">      alert(&#x27;提交表单！&#x27;);</span><br><span class="language-xml">    &#125;&#125;&gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>发送<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>区别：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/docs/Web/API/Event/stopPropagation"><code>e.stopPropagation()</code></a> 阻止触发绑定在外层标签上的事件处理函数。</li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/docs/Web/API/Event/preventDefault"><code>e.preventDefault()</code></a> 阻止少数事件的默认浏览器行为。</li>
</ul>
<p>事件处理函数是执行副作用的最佳位置。</p>
<p>与渲染函数不同，事件处理函数不需要是 <a target="_blank" rel="noopener" href="http://localhost:3000/learn/keeping-components-pure">纯函数</a>，因此它是用来 <em>更改</em> 某些值的绝佳位置。例如，更改输入框的值以响应键入，或者更改列表以响应按钮的触发。但是，为了更改某些信息，你首先需要某种方式存储它。在 React 中，这是通过 <a target="_blank" rel="noopener" href="http://localhost:3000/learn/state-a-components-memory">state（组件的记忆）</a> 来完成的。</p>
<h2 id="2-State：组件的记忆"><a href="#2-State：组件的记忆" class="headerlink" title="2.State：组件的记忆"></a>2.State：组件的记忆</h2><p>可以用 <a target="_blank" rel="noopener" href="http://localhost:3000/reference/react/useState"><code>useState</code></a> Hook 为组件添加状态。<em>Hook</em> 是能让你的组件使用 React 功能的特殊函数（状态是这些功能之一），只在 React <a target="_blank" rel="noopener" href="http://localhost:3000/learn/render-and-commit#step-1-trigger-a-render">渲染</a>时有效。它们能让你 “hook” 到不同的 React 特性中去。<code>useState</code> Hook 让你声明一个状态变量。它接收初始状态并返回一对值：当前状态，以及一个让你更新状态的设置函数。</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-9ailqglqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-9ailqglqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> [index, setIndex] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br><br><span class="hljs-keyword">const</span> [showMore, setShowMore] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);<br></code></pre></td></tr></table></div></figure>

<p>Hooks ——以 <code>use</code> 开头的函数——只能在组件或<a target="_blank" rel="noopener" href="http://localhost:3000/learn/reusing-logic-with-custom-hooks">自定义 Hook</a> 的最顶层调用。 你不能在条件语句、循环语句或其他嵌套函数内调用 Hook。Hook 是函数，但将它们视为关于组件需求的无条件声明会很有帮助。在组件顶部 “use” React 特性，类似于在文件顶部“导入”模块。</p>
<p>点击 “Next” 按钮应该显示下一个雕塑并将 <code>index</code> 更改为 <code>1</code>，再次点击又更改为 <code>2</code>，以此类推。但这个组件现在不起作用：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-0k1390lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-0k1390lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; sculptureList &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./data.js&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Gallery</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>;<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"></span>) &#123;<br>    index = index + <span class="hljs-number">1</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">let</span> sculpture = sculptureList[index];<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handleClick&#125;</span>&gt;</span></span><br><span class="language-xml">        Next</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">i</span>&gt;</span>&#123;sculpture.name&#125; <span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> </span><br><span class="language-xml">        by &#123;sculpture.artist&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>  </span><br><span class="language-xml">        (&#123;index + 1&#125; of &#123;sculptureList.length&#125;)</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">img</span> </span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">src</span>=<span class="hljs-string">&#123;sculpture.url&#125;</span> </span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">alt</span>=<span class="hljs-string">&#123;sculpture.alt&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml">        &#123;sculpture.description&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p><code>handleClick()</code> 事件处理函数正在更新局部变量 <code>index</code>。但存在两个原因使得变化不可见：</p>
<ol>
<li>局部变量无法在多次渲染中持久保存。 当 React 再次渲染这个组件时，它会从头开始渲染——不会考虑之前对局部变量的任何更改。</li>
<li>更改局部变量不会触发渲染。 React 没有意识到它需要使用新数据再次渲染组件。</li>
</ol>
<p>要使用新数据更新组件，需要做两件事：</p>
<ol>
<li>保留 渲染之间的数据。</li>
<li>触发 React 使用新数据渲染组件（重新渲染）。</li>
</ol>
<p><a target="_blank" rel="noopener" href="http://localhost:3000/reference/react/useState"><code>useState</code></a> Hook 提供了这两个功能：</p>
<ol>
<li>State 变量 用于保存渲染间的数据。</li>
<li>State setter 函数 更新变量并触发 React 再次渲染组件。</li>
</ol>
<p>要添加 state 变量，先从文件顶部的 React 中导入 <code>useState</code>：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-cof46mlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-cof46mlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br></code></pre></td></tr></table></div></figure>

<p>然后，替换这一行：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-0ij2r8lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-0ij2r8lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>;<br></code></pre></td></tr></table></div></figure>

<p>将其修改为</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-vbalwjlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-vbalwjlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> [index, setIndex] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br></code></pre></td></tr></table></div></figure>

<p><code>index</code> 是一个 state 变量，<code>setIndex</code> 是对应的 setter 函数。</p>
<p>这里的 <code>[</code> 和 <code>]</code> 语法称为<a target="_blank" rel="noopener" href="http://localhost:3000/learn/a-javascript-refresher#array-destructuring">数组解构</a>，它允许你从数组中读取值。 <code>useState</code> 返回的数组总是正好有两项。</p>
<p>以下展示了它们在 <code>handleClick()</code> 中是如何共同起作用的：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-6x9dxplqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-6x9dxplqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-title function_">setIndex</span>(index + <span class="hljs-number">1</span>);<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>现在点击 “Next” 按钮切换当前雕塑：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-lpf3ijlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-lpf3ijlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; sculptureList &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./data.js&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Gallery</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [index, setIndex] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">setIndex</span>(index + <span class="hljs-number">1</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">let</span> sculpture = sculptureList[index];<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handleClick&#125;</span>&gt;</span></span><br><span class="language-xml">        Next</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">i</span>&gt;</span>&#123;sculpture.name&#125; <span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> </span><br><span class="language-xml">        by &#123;sculpture.artist&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>  </span><br><span class="language-xml">        (&#123;index + 1&#125; of &#123;sculptureList.length&#125;)</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">img</span> </span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">src</span>=<span class="hljs-string">&#123;sculpture.url&#125;</span> </span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">alt</span>=<span class="hljs-string">&#123;sculpture.alt&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml">        &#123;sculpture.description&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p><code>useState</code> 的唯一参数是 state 变量的初始值。在这个例子中，<code>index</code> 的初始值被<code>useState(0)</code>设置为 <code>0</code>。</p>
<p>每次你的组件渲染时，<code>useState</code> 都会给你一个包含两个值的数组：</p>
<ol>
<li>state 变量 (<code>index</code>) 会保存上次渲染的值。</li>
<li>state setter 函数 (<code>setIndex</code>) 可以更新 state 变量并触发 React 重新渲染组件。</li>
</ol>
<p>以下是实际发生的情况：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-emi9rhlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-emi9rhlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> [index, setIndex] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br></code></pre></td></tr></table></div></figure>

<ol>
<li>组件进行第一次渲染。 因为你将 <code>0</code> 作为 <code>index</code> 的初始值传递给 <code>useState</code>，它将返回 <code>[0, setIndex]</code>。 React 记住 <code>0</code> 是最新的 state 值。</li>
<li>你更新了 state。当用户点击按钮时，它会调用 <code>setIndex(index + 1)</code>。 <code>index</code> 是 <code>0</code>，所以它是 <code>setIndex(1)</code>。这告诉 React 现在记住 <code>index</code> 是 <code>1</code> 并触发下一次渲染。</li>
<li>组件进行第二次渲染。React 仍然看到 <code>useState(0)</code>，但是因为 React <em>记住</em> 了你将 <code>index</code> 设置为了 <code>1</code>，它将返回 <code>[1, setIndex]</code>。</li>
<li>以此类推！</li>
</ol>
<p><mark>赋予一个组件多个 state 变量</mark>：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-x15kn2lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-x15kn2lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; sculptureList &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./data.js&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Gallery</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [index, setIndex] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">const</span> [showMore, setShowMore] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleNextClick</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">setIndex</span>(index + <span class="hljs-number">1</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleMoreClick</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">setShowMore</span>(!showMore);<br>  &#125;<br><br>  <span class="hljs-keyword">let</span> sculpture = sculptureList[index];<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handleNextClick&#125;</span>&gt;</span></span><br><span class="language-xml">        Next</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">i</span>&gt;</span>&#123;sculpture.name&#125; <span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> </span><br><span class="language-xml">        by &#123;sculpture.artist&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>  </span><br><span class="language-xml">        (&#123;index + 1&#125; of &#123;sculptureList.length&#125;)</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handleMoreClick&#125;</span>&gt;</span></span><br><span class="language-xml">        &#123;showMore ? &#x27;Hide&#x27; : &#x27;Show&#x27;&#125; details</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      &#123;showMore &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>&#123;sculpture.description&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">img</span> </span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">src</span>=<span class="hljs-string">&#123;sculpture.url&#125;</span> </span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">alt</span>=<span class="hljs-string">&#123;sculpture.alt&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>如果它们不相关，那么存在多个 state 变量是一个好主意，例如本例中的 <code>index</code> 和 <code>showMore</code>。但是，如果你发现经常同时更改两个 state 变量，那么最好将它们合并为一个。例如，如果你有一个包含多个字段的表单，那么有一个值为对象的 state 变量比每个字段对应一个 state 变量更方便。 <a target="_blank" rel="noopener" href="http://localhost:3000/learn/choosing-the-state-structure">选择 state 结构</a>在这方面有更多提示。</p>
<p><code>useState</code> 在调用时没有任何关于它引用的是<em>哪个</em> state 变量的信息。没有传递给 <code>useState</code> 的“标识符”，它是如何知道要返回哪个 state 变量呢？它是否依赖于解析函数之类的魔法？答案是否定的。</p>
<p>相反，为了使语法更简洁，在同一组件的每次渲染中，Hooks 都依托于一个稳定的调用顺序。这在实践中很有效，因为如果你遵循上面的规则（“只在顶层调用 Hooks”），Hooks 将始终以相同的顺序被调用。此外，<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/eslint-plugin-react-hooks">linter 插件</a>也可以捕获大多数错误。</p>
<p>在 React 内部，为每个组件保存了一个数组，其中每一项都是一个 state 对。它维护当前 state 对的索引值，在渲染之前将其设置为 “0”。每次调用 useState 时，React 都会为你提供一个 state 对并增加索引值。</p>
<hr>
<p><mark>State 是隔离且私有的</mark>：State 是屏幕上组件实例内部的状态。换句话说，如果你渲染同一个组件两次，每个副本都会有完全隔离的 state！改变其中一个不会影响另一个。</p>
<p>state 与声明在模块顶部的普通变量的区别： State 不依赖于特定的函数调用或在代码中的位置，它的作用域“只限于”屏幕上的某块特定区域。</p>
<p><code>Page</code> 组件“不知道”关于 <code>Gallery</code> state 的任何信息，甚至不知道它是否有任何 state。与 props 不同，&#x3D;&#x3D;state 完全私有于声明它的组件&#x3D;&#x3D;。父组件无法更改它。这使你可以向任何组件添加或删除 state，而不会影响其他组件。</p>
<p>如果你希望两个画廊保持其 states 同步怎么办？在 React 中执行此操作的正确方法是从子组件中<em>删除</em> state 并将其添加到离它们最近的共享父组件中。</p>
<h2 id="3-渲染和提交"><a href="#3-渲染和提交" class="headerlink" title="3.渲染和提交"></a>3.渲染和提交</h2><p>组件显示到屏幕之前，其必须被 React 渲染。</p>
<p>在一个 React 应用中一次屏幕更新都会发生以下三个步骤：触发+渲染+提交</p>
<ol>
<li><p><mark>触发一次渲染</mark></p>
<ul>
<li><p>有两种原因会导致组件的渲染:</p>
<ol>
<li><p>组件的 初次渲染：当应用启动时，会触发初次渲染。框架和沙箱有时会隐藏这部分代码，但它是通过调用目标 DOM 节点的 <a target="_blank" rel="noopener" href="http://localhost:3000/reference/react-dom/client/createRoot"><code>createRoot</code></a>，然后用你的组件调用 <code>render</code> 函数完成的：</p>
<p>index.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-nucnb6lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-nucnb6lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Image</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;.image.js&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; createRoot &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react-dom/client&#x27;</span>;<br><br><span class="hljs-keyword">const</span> root = <span class="hljs-title function_">createRoot</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;root&#x27;</span>))<br>root.<span class="hljs-title function_">render</span>(<span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Image</span> /&gt;</span></span>);<br></code></pre></td></tr></table></div></figure>

<p>Image.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-i54bu3lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-i54bu3lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Image</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">img</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://i.imgur.com/ZF6s192.jpg&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;&#x27;Floralis Genérica&#x27; by Eduardo Catalano: a gigantic metallic flower sculpture with reflective petals&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">    /&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>删除<code>root.render()</code>后，你将会看到组件消失。</p>
</li>
<li><p>组件（或者其祖先之一）的 状态发生了改变：一旦组件被初次渲染，你就可以通过使用 <a target="_blank" rel="noopener" href="http://localhost:3000/reference/react/useState#setstate"><code>set</code> 函数</a> 更新其状态来触发之后的渲染。更新组件的状态会自动将一次渲染送入队列。</p>
</li>
</ol>
</li>
</ul>
</li>
<li><p><mark>React 渲染你的组件</mark>：在你触发渲染后，React 会调用你的组件来确定要在屏幕上显示的内容。“渲染中” 即 React 在调用你的组件。</p>
<ul>
<li>在进行初次渲染时, React 会调用根组件。</li>
<li>对于后续的渲染, React 会调用内部状态更新触发了渲染的函数组件。</li>
</ul>
<p>这个过程是递归的：如果更新后的组件会返回某个另外的组件，那么 React 接下来就会渲染 <em>那个</em> 组件，而如果那个组件又返回了某个组件，那么 React 接下来就会渲染 那个 组件，以此类推。这个过程会持续下去，直到没有更多的嵌套组件并且 React 确切知道哪些东西应该显示到屏幕上为止。</p>
<p>index.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-l8m2t1lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-l8m2t1lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Gallery</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./Gallery.js&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; createRoot &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react-dom/client&#x27;</span>;<br><br><span class="hljs-keyword">const</span> root = <span class="hljs-title function_">createRoot</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;root&#x27;</span>))<br>root.<span class="hljs-title function_">render</span>(<span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Gallery</span> /&gt;</span></span>);<br></code></pre></td></tr></table></div></figure>

<p>Gallery.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-yek0t5lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-yek0t5lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Gallery</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">section</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>鼓舞人心的雕塑<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Image</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Image</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Image</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Image</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">img</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://i.imgur.com/ZF6s192.jpg&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;&#x27;Floralis Genérica&#x27; by Eduardo Catalano: a gigantic metallic flower sculpture with reflective petals&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">    /&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<ul>
<li>在初次渲染中， React 将会为<code>&lt;section&gt;</code>、<code>&lt;h1&gt;</code> 和三个 <code>&lt;img&gt;</code> 标签 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/docs/Web/API/Document/createElement">创建 DOM 节点</a>。</li>
<li>在一次重渲染过程中, React 将计算它们的哪些属性（如果有的话）自上次渲染以来已更改。在下一步（提交阶段）之前，它不会对这些信息执行任何操作。</li>
</ul>
<p>渲染必须始终是一次 <a target="_blank" rel="noopener" href="http://localhost:3000/learn/keeping-components-pure">纯计算</a>:</p>
<ul>
<li>输入相同，输出相同。 给定相同的输入，组件应始终返回相同的 JSX。（当有人点了西红柿沙拉时，他们不应该收到洋葱沙拉！）</li>
<li>只做它自己的事情。 它不应更改任何存在于渲染之前的对象或变量。（一个订单不应更改其他任何人的订单。）</li>
</ul>
<p>否则，随着代码库复杂性的增加，你可能会遇到令人困惑的错误和不可预测的行为。<mark>在 “严格模式” 下开发时，React 会调用每个组件的函数两次，这可以帮助发现由不纯函数引起的错误。</mark></p>
</li>
<li><p><mark>React 把更改提交到 DOM 上</mark>：在渲染（调用）你的组件之后，React 将会修改 DOM。</p>
<ul>
<li>对于初次渲染， React 会使用 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/docs/Web/API/Node/appendChild"><code>appendChild()</code></a> DOM API 将其创建的所有 DOM 节点放在屏幕上。</li>
<li>对于重渲染， React 将应用最少的必要操作（在渲染时计算！），以使得 DOM 与最新的渲染输出相互匹配。</li>
</ul>
<p>React 仅在渲染之间存在差异时才会更改 DOM 节点。 </p>
<p>例如，有一个组件，它每秒使用从父组件传递下来的不同属性重新渲染一次。注意，你可以添加一些文本到 <code>&lt;input&gt;</code> 标签，更新它的 <code>value</code>，但是文本不会在组件重渲染时消失：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-awzuotlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-awzuotlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Clock</span>(<span class="hljs-params">&#123; time &#125;</span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>&#123;time&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<img src="Clock.gif" srcset="/img/loading.gif" lazyload alt="Clock" style="zoom:50%;" />

<p>之所以会正常运行，是因为在最后一步中，React 只会使用最新的 <code>time</code> 更新 <code>&lt;h1&gt;</code> 标签的内容。它看到 <code>&lt;input&gt;</code> 标签出现在 JSX 中与上次相同的位置，因此 React 不会修改 <code>&lt;input&gt;</code> 标签或它的 <code>value</code>！</p>
</li>
</ol>
<p>在渲染完成并且 React 更新 DOM 之后，浏览器就会重新绘制屏幕。尽管这个过程被称为“浏览器渲染”（browser rendering），但我们还是将它称为“绘制”（painting），以避免在这些文档的其余部分中出现混淆。</p>
<h2 id="4-state如同一张快照"><a href="#4-state如同一张快照" class="headerlink" title="4.state如同一张快照"></a>4.state如同一张快照</h2><p><mark>设置 state 会触发渲染</mark>：要使界面对输入做出反应，你需要设置其 state。</p>
<p>当 React 重新渲染一个组件时：</p>
<ol>
<li>React 会再次调用你的函数</li>
<li>函数会返回新的 JSX 快照</li>
<li>React 会更新界面以匹配返回的快照</li>
</ol>
<p>当 React 调用你的组件时，它会为特定的那一次渲染提供一张 state 快照。你的组件会在其 JSX 中返回一张包含一整套新的 props 和事件处理函数的 UI 快照 ，其中所有的值都是 根据那一次渲染中 state 的值 被计算出来的！</p>
<p>你可能会以为点击“+3”按钮会调用 <code>setNumber(number + 1)</code> 三次从而使计数器递增三次：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-680qknlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-680qknlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [number, setNumber] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>&#123;number&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> &#123;</span><br><span class="language-xml">        setNumber(number + 1);</span><br><span class="language-xml">        setNumber(number + 1);</span><br><span class="language-xml">        setNumber(number + 1);</span><br><span class="language-xml">      &#125;&#125;&gt;+3<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  )<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p><mark>每次点击只会让 <code>number</code> 递增一次！</mark></p>
<p>设置 state 只会为下一次渲染变更 state 的值。在第一次渲染期间，<code>number</code> 为 <code>0</code>。这也就解释了为什么在 那次渲染中的 <code>onClick</code> 处理函数中，即便在调用了 <code>setNumber(number + 1)</code> 之后，<code>number</code> 的值也仍然是 <code>0</code>：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-hm1at7lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-hm1at7lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jsx">&lt;button onClick=&#123;<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-title function_">setNumber</span>(number + <span class="hljs-number">1</span>);<br>  <span class="hljs-title function_">setNumber</span>(number + <span class="hljs-number">1</span>);<br>  <span class="hljs-title function_">setNumber</span>(number + <span class="hljs-number">1</span>);<br>&#125;&#125;&gt;+<span class="hljs-number">3</span>&lt;/button&gt;<br></code></pre></td></tr></table></div></figure>

<p>以下是这个按钮的点击事件处理函数通知 React 要做的事情：</p>
<ol>
<li><p><code>setNumber(number + 1)</code>：</p>
<p><code>number</code>是0所以<code>setNumber(0 + 1)</code>。</p>
<ul>
<li>React 准备在下一次渲染时将 <code>number</code> 更改为 <code>1</code>。</li>
</ul>
</li>
<li><p><code>setNumber(number + 1)</code>：</p>
<p><code>number</code>是0所以<code>setNumber(0 + 1)</code>。</p>
<ul>
<li>React 准备在下一次渲染时将 <code>number</code> 更改为 <code>1</code>。</li>
</ul>
</li>
<li><p><code>setNumber(number + 1)</code>：</p>
<p><code>number</code>是0所以<code>setNumber(0 + 1)</code>。</p>
<ul>
<li>React 准备在下一次渲染时将 <code>number</code> 更改为 <code>1</code>。</li>
</ul>
</li>
</ol>
<p>尽管你调用了三次 <code>setNumber(number + 1)</code>，但在 这次渲染的 事件处理函数中 <code>number</code> 会一直是 <code>0</code>，所以你会三次将 state 设置成 <code>1</code>。这就是为什么在你的事件处理函数执行完以后，React 重新渲染的组件中的 <code>number</code> 等于 <code>1</code> 而不是 <code>3</code>。</p>
<p>你还可以通过在心里把 state 变量替换成它们在你代码中的值来想象这个过程。由于 这次渲染 中的 state 变量 <code>number</code> 是 <code>0</code>，其事件处理函数看起来会像这样：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-296liolqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-296liolqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jsx">&lt;button onClick=&#123;<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-title function_">setNumber</span>(<span class="hljs-number">0</span> + <span class="hljs-number">1</span>);<br>  <span class="hljs-title function_">setNumber</span>(<span class="hljs-number">0</span> + <span class="hljs-number">1</span>);<br>  <span class="hljs-title function_">setNumber</span>(<span class="hljs-number">0</span> + <span class="hljs-number">1</span>);<br>&#125;&#125;&gt;+<span class="hljs-number">3</span>&lt;/button&gt;<br></code></pre></td></tr></table></div></figure>

<p>对于下一次渲染来说，<code>number</code> 是 <code>1</code>，因此 那次渲染中的 点击事件处理函数看起来会像这样：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-u5yzxylqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-u5yzxylqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jsx">&lt;button onClick=&#123;<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-title function_">setNumber</span>(<span class="hljs-number">1</span> + <span class="hljs-number">1</span>);<br>  <span class="hljs-title function_">setNumber</span>(<span class="hljs-number">1</span> + <span class="hljs-number">1</span>);<br>  <span class="hljs-title function_">setNumber</span>(<span class="hljs-number">1</span> + <span class="hljs-number">1</span>);<br>&#125;&#125;&gt;+<span class="hljs-number">3</span>&lt;/button&gt;<br></code></pre></td></tr></table></div></figure>

<p>这就是为什么再次点击按钮会将计数器设置为 <code>2</code>，下次点击时会设为 <code>3</code>，依此类推。</p>
<hr>
<p>点击这个按钮会发出什么警告：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-97z45vlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-97z45vlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [number, setNumber] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>&#123;number&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> &#123;</span><br><span class="language-xml">        setNumber(number + 5);</span><br><span class="language-xml">        alert(number);</span><br><span class="language-xml">      &#125;&#125;&gt;+5<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  )<br>&#125;<br></code></pre></td></tr></table></div></figure>

<img src="button.gif" srcset="/img/loading.gif" lazyload alt="button" style="zoom:50%;" />

<p>如果你使用之前替换的方法，你就能猜到这个提示框将会显示 “0”：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-z4ln6ulqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-z4ln6ulqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-title function_">setNumber</span>(<span class="hljs-number">0</span> + <span class="hljs-number">5</span>);<br><span class="hljs-title function_">alert</span>(<span class="hljs-number">0</span>);<br></code></pre></td></tr></table></div></figure>

<p>但如果你在这个提示框上加上一个定时器， 使得它在组件重新渲染 之后 才触发，又会怎样呢？是会显示 “0” 还是 “5” ？</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-vx19g4lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-vx19g4lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [number, setNumber] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>&#123;number&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> &#123;</span><br><span class="language-xml">        setNumber(number + 5);</span><br><span class="language-xml">        setTimeout(() =&gt; &#123;</span><br><span class="language-xml">          alert(number);</span><br><span class="language-xml">        &#125;, 3000);</span><br><span class="language-xml">      &#125;&#125;&gt;+5<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  )<br>&#125;<br></code></pre></td></tr></table></div></figure>

<img src="timeout.gif" srcset="/img/loading.gif" lazyload alt="timeout" style="zoom:50%;" />

<p>如果使用替代法，就能看到被传入提示框的 state “快照”：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-8r6pcglqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-8r6pcglqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-title function_">setNumber</span>(<span class="hljs-number">0</span> + <span class="hljs-number">5</span>);<br><span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-title function_">alert</span>(<span class="hljs-number">0</span>);<br>&#125;, <span class="hljs-number">3000</span>);<br></code></pre></td></tr></table></div></figure>

<p>到提示框运行时，React 中存储的 state 可能已经发生了更改，但它是使用用户与之交互时状态的快照进行调度的！</p>
<p><mark>一个 state 变量的值永远不会在一次渲染的内部发生变化</mark>， 即使其事件处理函数的代码是异步的。在 那次渲染的 <code>onClick</code> 内部，<code>number</code> 的值即使在调用 <code>setNumber(number + 5)</code> 之后也还是 <code>0</code>。它的值在 React 通过调用你的组件“获取 UI 的快照”时就被“固定”了。</p>
<p>下面是一个会在五秒延迟之后发送一条消息的表单。想象以下场景：</p>
<ol>
<li>你按下“发送”按钮，向 Alice 发送“你好”。</li>
<li>在五秒延迟结束之前，将“To”字段的值更改为“Bob”。</li>
</ol>
<p>你觉得 <code>alert</code> 会显示什么？它是会显示“你向 Alice 说了你好“还是会显示“你向 Bob 说了你好”？</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-pjm7pnlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-pjm7pnlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Form</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [to, setTo] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;Alice&#x27;</span>);<br>  <span class="hljs-keyword">const</span> [message, setMessage] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;Hello&#x27;</span>);<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleSubmit</span>(<span class="hljs-params">e</span>) &#123;<br>    e.<span class="hljs-title function_">preventDefault</span>();<br>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-title function_">alert</span>(<span class="hljs-string">`You said <span class="hljs-subst">$&#123;message&#125;</span> to <span class="hljs-subst">$&#123;to&#125;</span>`</span>);<br>    &#125;, <span class="hljs-number">5000</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">onSubmit</span>=<span class="hljs-string">&#123;handleSubmit&#125;</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">        To:&#123;&#x27; &#x27;&#125;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">select</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;to&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> setTo(e.target.value)&#125;&gt;</span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;Alice&quot;</span>&gt;</span>Alice<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;Bob&quot;</span>&gt;</span>Bob<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">textarea</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;Message&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;message&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> setMessage(e.target.value)&#125;</span><br><span class="language-xml">      /&gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span>&gt;</span>Send<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<img src="hello.gif" srcset="/img/loading.gif" lazyload alt="hello" style="zoom:50%;" />

<p>React 会使 state 的值始终”固定“在一次渲染的各个事件处理函数内部。 你无需担心代码运行时 state 是否发生了变化。</p>
<p>但是，万一你想在重新渲染之前读取最新的 state 怎么办？你应该使用 <a target="_blank" rel="noopener" href="http://localhost:3000/learn/queueing-a-series-of-state-updates">状态更新函数</a>。</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-m00lqclqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-m00lqclqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">TrafficLight</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [walk, setWalk] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>);<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">setWalk</span>(!walk);<br>    <span class="hljs-title function_">alert</span>(walk ? <span class="hljs-string">&#x27;Stop is next&#x27;</span> : <span class="hljs-string">&#x27;Walk is next&#x27;</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handleClick&#125;</span>&gt;</span></span><br><span class="language-xml">        Change to &#123;walk ? &#x27;Stop&#x27; : &#x27;Walk&#x27;&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&#123;&#123;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">color:</span> <span class="hljs-attr">walk</span> ? &#x27;<span class="hljs-attr">darkgreen</span>&#x27; <span class="hljs-attr">:</span> &#x27;<span class="hljs-attr">darkred</span>&#x27;</span></span><br><span class="hljs-tag"><span class="language-xml">      &#125;&#125;&gt;</span></span><br><span class="language-xml">        &#123;walk ? &#x27;Walk&#x27; : &#x27;Stop&#x27;&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>实现红绿灯组件：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-mxr6xslqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-mxr6xslqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">TrafficLight</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [walk, setWalk] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>);<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">setWalk</span>(!walk);<br>    <span class="hljs-title function_">alert</span>(walk ? <span class="hljs-string">&#x27;Stop is next&#x27;</span> : <span class="hljs-string">&#x27;Walk is next&#x27;</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handleClick&#125;</span>&gt;</span></span><br><span class="language-xml">        Change to &#123;walk ? &#x27;Stop&#x27; : &#x27;Walk&#x27;&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&#123;&#123;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">color:</span> <span class="hljs-attr">walk</span> ? &#x27;<span class="hljs-attr">darkgreen</span>&#x27; <span class="hljs-attr">:</span> &#x27;<span class="hljs-attr">darkred</span>&#x27;</span></span><br><span class="hljs-tag"><span class="language-xml">      &#125;&#125;&gt;</span></span><br><span class="language-xml">        &#123;walk ? &#x27;Walk&#x27; : &#x27;Stop&#x27;&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>把 <code>alert</code> 方法放在 <code>setWalk</code> 方法之前或之后没有区别。那次渲染的 <code>walk</code> 的值是固定的。<mark>调用<code>setWalk</code> 只会为 下次 渲染对它进行变更，而不会影响来自上次渲染的事件处理函数。</mark></p>
<h2 id="5-把一系列-state-更新加入队列"><a href="#5-把一系列-state-更新加入队列" class="headerlink" title="5.把一系列 state 更新加入队列"></a>5.把一系列 state 更新加入队列</h2><p>设置组件 state 会把一次重新渲染加入队列。但有时你可能会希望在下次渲染加入队列之前对 state 的值执行多次操作。</p>
<p><mark>React 会等到事件处理函数中的 所有 代码都运行完毕再处理你的 state 更新。</mark></p>
<p>这让你可以更新多个 state 变量——甚至来自多个组件的 state 变量——而不会触发太多的 <a target="_blank" rel="noopener" href="http://localhost:3000/learn/render-and-commit#re-renders-when-state-updates">重新渲染</a>。但这也意味着只有在你的事件处理函数及其中任何代码执行完成 之后，UI 才会更新。这种特性也就是 批处理，它会使你的 React 应用运行得更快。它还会帮你避免处理只更新了一部分 state 变量的令人困惑的“半成品”渲染。</p>
<p>React 不会跨多个需要刻意触发的事件（如点击）进行批处理——每次点击都是单独处理的。请放心，React 只会在一般来说安全的情况下才进行批处理。这可以确保，例如，如果第一次点击按钮会禁用表单，那么第二次点击就不会再次提交它。</p>
<p><mark>在下次渲染前多次更新同一个 state </mark>：这是一个不常见的用例，但是如果你想在下次渲染之前多次更新同一个 state，你可以像 <code>setNumber(n =&gt; n + 1)</code> 这样传入一个根据队列中的前一个 state 计算下一个 state 的 函数，而不是像 <code>setNumber(number + 1)</code> 这样传入 下一个 state 值。这是一种告诉 React “用 state 值做某事”而不是仅仅替换它的方法。</p>
<p>现在尝试递增计数器：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-l2w588lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-l2w588lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [number, setNumber] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>&#123;number&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> &#123;</span><br><span class="language-xml">        setNumber(n =&gt; n + 1);</span><br><span class="language-xml">        setNumber(n =&gt; n + 1);</span><br><span class="language-xml">        setNumber(n =&gt; n + 1);</span><br><span class="language-xml">      &#125;&#125;&gt;+3<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  )<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p><code>n =&gt; n + 1</code> 被称为 更新函数。当你将它传递给一个 state 设置函数时：</p>
<ol>
<li>React 会将此函数加入队列，以便在事件处理函数中的所有其他代码运行后进行处理。</li>
<li>在下一次渲染期间，React 会遍历队列并给你更新之后的最终 state。</li>
</ol>
<p>React 在执行事件处理函数时处理这几行代码的过程：</p>
<ol>
<li><code>setNumber(n =&gt; n + 1)</code>：<code>n =&gt; n + 1</code> 是一个函数。React 将它加入队列。</li>
<li><code>setNumber(n =&gt; n + 1)</code>：<code>n =&gt; n + 1</code> 是一个函数。React 将它加入队列。</li>
<li><code>setNumber(n =&gt; n + 1)</code>：<code>n =&gt; n + 1</code> 是一个函数。React 将它加入队列。</li>
</ol>
<p>当你在下次渲染期间调用 <code>useState</code> 时，React 会遍历队列。之前的 <code>number</code> state 的值是 <code>0</code>，所以这就是 React 作为参数 <code>n</code> 传递给第一个更新函数的值。然后 React 会获取你上一个更新函数的返回值，并将其作为 <code>n</code> 传递给下一个更新函数，以此类推：</p>
<table>
<thead>
<tr>
<th>更新队列</th>
<th><code>n</code></th>
<th>返回值</th>
</tr>
</thead>
<tbody><tr>
<td><code>n =&gt; n + 1</code></td>
<td><code>0</code></td>
<td><code>0 + 1 = 1</code></td>
</tr>
<tr>
<td><code>n =&gt; n + 1</code></td>
<td><code>1</code></td>
<td><code>1 + 1 = 2</code></td>
</tr>
<tr>
<td><code>n =&gt; n + 1</code></td>
<td><code>2</code></td>
<td><code>2 + 1 = 3</code></td>
</tr>
</tbody></table>
<p>React 会保存 <code>3</code> 为最终结果并从 <code>useState</code> 中返回。</p>
<p><mark>如果你在替换 state 后更新 state 会发生什么</mark>：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-5saforlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-5saforlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [number, setNumber] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>&#123;number&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> &#123;</span><br><span class="language-xml">        setNumber(number + 5);</span><br><span class="language-xml">        setNumber(n =&gt; n + 1);</span><br><span class="language-xml">      &#125;&#125;&gt;增加数字<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  )<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>0→6→12→...</p>
<p>这是事件处理函数告诉 React 要做的事情：</p>
<ol>
<li><code>setNumber(number + 5)</code>：<code>number</code> 为 <code>0</code>，所以 <code>setNumber(0 + 5)</code>。React 将 <em>“替换为 <code>5</code>”</em> 添加到其队列中。</li>
<li><code>setNumber(n =&gt; n + 1)</code>：<code>n =&gt; n + 1</code> 是一个更新函数。 React 将 该函数 添加到其队列中。</li>
</ol>
<p>在下一次渲染期间，React 会遍历 state 队列：</p>
<table>
<thead>
<tr>
<th>更新队列</th>
<th><code>n</code></th>
<th>返回值</th>
</tr>
</thead>
<tbody><tr>
<td>“替换为 <code>5</code>”</td>
<td><code>0</code>（未使用）</td>
<td><code>5</code></td>
</tr>
<tr>
<td><code>n =&gt; n + 1</code></td>
<td><code>5</code></td>
<td><code>5 + 1 = 6</code></td>
</tr>
</tbody></table>
<p>React 会保存 <code>6</code> 为最终结果并从 <code>useState</code> 中返回。</p>
<p><code>setState(x)</code> 实际上会像 <code>setState(n =&gt; x)</code> 一样运行，只是没有使用 <code>n</code>！</p>
<p><mark>如果你在更新 state 后替换 state 会发生什么</mark>：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-yxyz9llqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-yxyz9llqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jsx">&lt;button onClick=&#123;<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-title function_">setNumber</span>(number + <span class="hljs-number">5</span>);<br>  <span class="hljs-title function_">setNumber</span>(<span class="hljs-function"><span class="hljs-params">n</span> =&gt;</span> n + <span class="hljs-number">1</span>);<br>  <span class="hljs-title function_">setNumber</span>(<span class="hljs-number">42</span>);<br>&#125;&#125;&gt;<br></code></pre></td></tr></table></div></figure>

<p>0→42</p>
<p>React 在执行事件处理函数时处理这几行代码的过程：</p>
<ol>
<li><code>setNumber(number + 5)</code>：<code>number</code> 为 <code>0</code>，所以 <code>setNumber(0 + 5)</code>。React 将 <em>“替换为 <code>5</code>”</em> 添加到其队列中。</li>
<li><code>setNumber(n =&gt; n + 1)</code>：<code>n =&gt; n + 1</code> 是一个更新函数。React 将该函数添加到其队列中。</li>
<li><code>setNumber(42)</code>：React 将 “替换为 <code>42</code>” 添加到其队列中。</li>
</ol>
<p>在下一次渲染期间，React 会遍历 state 队列：</p>
<table>
<thead>
<tr>
<th>更新队列</th>
<th><code>n</code></th>
<th>返回值</th>
</tr>
</thead>
<tbody><tr>
<td>“替换为 <code>5</code>”</td>
<td><code>0</code>（未使用）</td>
<td><code>5</code></td>
</tr>
<tr>
<td><code>n =&gt; n + 1</code></td>
<td><code>5</code></td>
<td><code>5 + 1 = 6</code></td>
</tr>
<tr>
<td>“替换为 <code>42</code>”</td>
<td><code>6</code>（未使用）</td>
<td><code>42</code></td>
</tr>
</tbody></table>
<p>然后 React 会保存 <code>42</code> 为最终结果并从 <code>useState</code> 中返回。</p>
<p>总而言之，以下是你可以考虑传递给 <code>setNumber</code> state 设置函数的内容：</p>
<ul>
<li>一个更新函数（例如：<code>n =&gt; n + 1</code>）会被添加到队列中。</li>
<li>任何其他的值（例如：数字 <code>5</code>）会导致“替换为 <code>5</code>”被添加到队列中，已经在队列中的内容会被忽略。</li>
</ul>
<p>事件处理函数执行完成后，React 将触发重新渲染。<mark>在重新渲染期间，React 将处理队列。更新函数会在渲染期间执行，因此 更新函数必须是 <a target="_blank" rel="noopener" href="http://localhost:3000/learn/keeping-components-pure">纯函数</a> 并且只 返回 结果。不要尝试从它们内部设置 state 或者执行其他副作用</mark>。在严格模式下，React 会执行每个更新函数两次（但是丢弃第二个结果）以便帮助你发现错误。</p>
<p>命名惯例：通常可以通过相应 state 变量的第一个字母来命名更新函数的参数：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-rccyhclqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-rccyhclqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-title function_">setEnabled</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> !e);<br><br><span class="hljs-title function_">setLastName</span>(<span class="hljs-function"><span class="hljs-params">ln</span> =&gt;</span> ln.<span class="hljs-title function_">reverse</span>());<br><br><span class="hljs-title function_">setFriendCount</span>(<span class="hljs-function"><span class="hljs-params">fc</span> =&gt;</span> fc * <span class="hljs-number">2</span>);<br></code></pre></td></tr></table></div></figure>

<p>如果你喜欢更冗长的代码，另一个常见的惯例是重复使用完整的 state 变量名称，如 <code>setEnabled(enabled =&gt; !enabled)</code>，或使用前缀，如 <code>setEnabled(prevEnabled =&gt; !prevEnabled)</code>。</p>
<h2 id="6-更新-state-中的对象"><a href="#6-更新-state-中的对象" class="headerlink" title="6.更新 state 中的对象"></a>6.更新 state 中的对象</h2><p>state 中可以保存任意类型的 JavaScript 值，包括对象。但是，你不应该直接修改存放在 React state 中的对象。相反，当你想要更新一个对象时，你需要创建一个新的对象（或者将其拷贝一份），然后将 state 更新为此对象。</p>
<p>数字、字符串和布尔值，这些类型的值在 JavaScript 中是不可变（immutable）的，这意味着它们不能被改变或是只读的。你可以通过替换它们的值以触发一次重新渲染。</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-cn96xrlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-cn96xrlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-title function_">setX</span>(<span class="hljs-number">5</span>);<br></code></pre></td></tr></table></div></figure>

<p>state <code>x</code> 从 <code>0</code> 变为 <code>5</code>，但是数字 <code>0</code> 本身并没有发生改变。在 JavaScript 中，无法对内置的原始值，如数字、字符串和布尔值，进行任何更改。</p>
<p>现在考虑 state 中存放对象的情况：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-gxeecslqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-gxeecslqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> [position, setPosition] = <span class="hljs-title function_">useState</span>(&#123; <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span> &#125;);<br></code></pre></td></tr></table></div></figure>

<p>从技术上来讲，可以改变对象自身的内容。当你这样做时，就制造了一个 mutation：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-6wa3j4lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-6wa3j4lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jsx">position.<span class="hljs-property">x</span> = <span class="hljs-number">5</span>;<br></code></pre></td></tr></table></div></figure>

<p>然而，虽然严格来说 React state 中存放的对象是可变的，但你应该像处理数字、布尔值、字符串一样将它们视为不可变的。因此你应该替换它们的值，而不是对它们进行修改。 </p>
<p>应该 <mark>把所有存放在 state 中的 JavaScript 对象都视为只读的</mark>。</p>
<p>在下面的例子中，我们用一个存放在 state 中的对象来表示指针当前的位置。当你在预览区触摸或移动光标时，红色的点本应移动。但是实际上红点仍停留在原处：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-vx2wkslqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-vx2wkslqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">MovingDot</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [position, setPosition] = <span class="hljs-title function_">useState</span>(&#123;<br>    <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>,<br>    <span class="hljs-attr">y</span>: <span class="hljs-number">0</span><br>  &#125;);<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">onPointerMove</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> &#123;</span><br><span class="language-xml">        position.x = e.clientX;</span><br><span class="language-xml">        position.y = e.clientY;</span><br><span class="language-xml">      &#125;&#125;</span><br><span class="language-xml">      style=&#123;&#123;</span><br><span class="language-xml">        position: &#x27;relative&#x27;,</span><br><span class="language-xml">        width: &#x27;100vw&#x27;,</span><br><span class="language-xml">        height: &#x27;100vh&#x27;,</span><br><span class="language-xml">      &#125;&#125;&gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&#123;&#123;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">position:</span> &#x27;<span class="hljs-attr">absolute</span>&#x27;,</span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">backgroundColor:</span> &#x27;<span class="hljs-attr">red</span>&#x27;,</span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">borderRadius:</span> &#x27;<span class="hljs-attr">50</span>%&#x27;,</span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">transform:</span> `<span class="hljs-attr">translate</span>($&#123;<span class="hljs-attr">position.x</span>&#125;<span class="hljs-attr">px</span>, $&#123;<span class="hljs-attr">position.y</span>&#125;<span class="hljs-attr">px</span>)`,</span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">left:</span> <span class="hljs-attr">-10</span>,</span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">top:</span> <span class="hljs-attr">-10</span>,</span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">width:</span> <span class="hljs-attr">20</span>,</span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">height:</span> <span class="hljs-attr">20</span>,</span></span><br><span class="hljs-tag"><span class="language-xml">      &#125;&#125; /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>这段代码直接修改了 <a target="_blank" rel="noopener" href="http://localhost:3000/learn/state-as-a-snapshot#rendering-takes-a-snapshot-in-time">上一次渲染中</a> 分配给 <code>position</code> 的对象。但是因为并没有使用 state 的设置函数，React 并不知道对象已更改。所以 React 没有做出任何响应。这就像在吃完饭之后才尝试去改变要点的菜一样。虽然在一些情况下，直接修改 state 可能是有效的，但我们并不推荐这么做。你应该把在渲染过程中可以访问到的 state 视为只读的。</p>
<p>在这种情况下，为了真正地 <a target="_blank" rel="noopener" href="http://localhost:3000/learn/state-as-a-snapshot#setting-state-triggers-renders">触发一次重新渲染</a>，你需要创建一个新对象并把它传递给 state 的设置函数：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-5ni92glqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-5ni92glqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs jsx">onPointerMove=&#123;<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> &#123;<br>  <span class="hljs-title function_">setPosition</span>(&#123;<br>    <span class="hljs-attr">x</span>: e.<span class="hljs-property">clientX</span>,<br>    <span class="hljs-attr">y</span>: e.<span class="hljs-property">clientY</span><br>  &#125;);<br>&#125;&#125;<br></code></pre></td></tr></table></div></figure>

<p>通过使用 <code>setPosition</code>，你在告诉 React：</p>
<ul>
<li>使用这个新的对象替换 <code>position</code> 的值</li>
<li>然后再次渲染这个组件</li>
</ul>
<p>现在你可以看到，当你在预览区触摸或移动光标时，红点会跟随着你的指针移动。</p>
<p>像这样的代码是有问题的，因为它改变了 state 中现有的对象：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-vtuncslqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-vtuncslqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs jsx">position.<span class="hljs-property">x</span> = e.<span class="hljs-property">clientX</span>;<br><br>position.<span class="hljs-property">y</span> = e.<span class="hljs-property">clientY</span>;<br></code></pre></td></tr></table></div></figure>

<p>但是像这样的代码就 没有任何问题，因为你改变的是你刚刚创建的一个新的对象：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-opa9delqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-opa9delqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> nextPosition = &#123;&#125;;<br><br>nextPosition.<span class="hljs-property">x</span> = e.<span class="hljs-property">clientX</span>;<br><br>nextPosition.<span class="hljs-property">y</span> = e.<span class="hljs-property">clientY</span>;<br><br><span class="hljs-title function_">setPosition</span>(nextPosition);<br></code></pre></td></tr></table></div></figure>

<p>事实上，它完全等同于下面这种写法：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-6yfcjwlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-6yfcjwlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-title function_">setPosition</span>(&#123;<br>    <span class="hljs-attr">x</span>: e.<span class="hljs-property">clientX</span>,<br>    <span class="hljs-attr">y</span>: e.<span class="hljs-property">client</span><br>&#125;);<br></code></pre></td></tr></table></div></figure>

<p>只有当你改变已经处于 state 中的 现有 对象时，mutation 才会成为问题。而修改一个你刚刚创建的对象就不会出现任何问题，因为 还没有其他的代码引用它。改变它并不会意外地影响到依赖它的东西。这叫做“局部 mutation”。你甚至可以 <a target="_blank" rel="noopener" href="http://localhost:3000/learn/keeping-components-pure#local-mutation-your-components-little-secret">在渲染的过程中</a> 进行“局部 mutation”的操作。</p>
<p><mark>使用展开语法复制对象</mark>：在之前的例子中，始终会根据当前指针的位置创建出一个新的 <code>position</code> 对象。但是通常，你会希望把 现有 数据作为你所创建的新对象的一部分。例如，你可能只想要更新表单中的一个字段，其他的字段仍然使用之前的值。</p>
<p>下面的代码中，输入框并不会正常运行【无法修改输入框的值】，因为 <code>onChange</code> 直接修改了 state ：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-vzbaltlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-vzbaltlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Form</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [person, setPerson] = <span class="hljs-title function_">useState</span>(&#123;<br>    <span class="hljs-attr">firstName</span>: <span class="hljs-string">&#x27;Barbara&#x27;</span>,<br>    <span class="hljs-attr">lastName</span>: <span class="hljs-string">&#x27;Hepworth&#x27;</span>,<br>    <span class="hljs-attr">email</span>: <span class="hljs-string">&#x27;bhepworth@sculpture.com&#x27;</span><br>  &#125;);<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleFirstNameChange</span>(<span class="hljs-params">e</span>) &#123;<br>    person.<span class="hljs-property">firstName</span> = e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleLastNameChange</span>(<span class="hljs-params">e</span>) &#123;<br>    person.<span class="hljs-property">lastName</span> = e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleEmailChange</span>(<span class="hljs-params">e</span>) &#123;<br>    person.<span class="hljs-property">email</span> = e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">        First name:</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">input</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;person.firstName&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;handleFirstNameChange&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">        Last name:</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">input</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;person.lastName&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;handleLastNameChange&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">        Email:</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">input</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;person.email&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;handleEmailChange&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml">        &#123;person.firstName&#125;&#123;&#x27; &#x27;&#125;</span><br><span class="language-xml">        &#123;person.lastName&#125;&#123;&#x27; &#x27;&#125;</span><br><span class="language-xml">        (&#123;person.email&#125;)</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<img src="image-20231107160248607.png" srcset="/img/loading.gif" lazyload alt="image-20231107160248607" style="zoom:50%;" />

<p>下面这行代码修改了上一次渲染中的 state：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-3tbc2olqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-3tbc2olqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jsx">person.<span class="hljs-property">firstName</span> = e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>;<br></code></pre></td></tr></table></div></figure>

<p>想要实现你的需求，最可靠的办法就是创建一个新的对象并将它传递给 <code>setPerson</code>。但是在这里，你还需要 把当前的数据复制到新对象中，因为你只改变了其中一个字段：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-zkpbfzlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-zkpbfzlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-title function_">setPerson</span>(&#123;<br>  <span class="hljs-attr">firstName</span>: e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>, <span class="hljs-comment">// 从 input 中获取新的 first name</span><br>  <span class="hljs-attr">lastName</span>: person.<span class="hljs-property">lastName</span>,<br>  <span class="hljs-attr">email</span>: person.<span class="hljs-property">email</span><br>&#125;);<br></code></pre></td></tr></table></div></figure>

<p>你可以使用 <code>...</code> <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/Spread_syntax#spread_in_object_literals">对象展开</a> 语法，这样你就不需要单独复制每个属性。</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-b25cx1lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-b25cx1lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-title function_">setPerson</span>(&#123;<br>  ...person, <span class="hljs-comment">// 复制上一个 person 中的所有字段</span><br>  <span class="hljs-attr">firstName</span>: e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span> <span class="hljs-comment">// 但是覆盖 firstName 字段 </span><br>&#125;);<br></code></pre></td></tr></table></div></figure>

<p>现在表单可以正常运行了！</p>
<p>可以看到，你并没有为每个输入框单独声明一个 state。对于大型表单，将所有数据都存放在同一个对象中是非常方便的——前提是你能够正确地更新它！</p>
<p><code>...</code> 展开语法本质是是“浅拷贝”——它只会复制一层。这使得它的执行速度很快，但是也意味着当你想要更新一个嵌套属性时，你必须得多次使用展开语法。</p>
<p>使用一个事件处理函数来更新多个字段：你也可以在对象的定义中使用 <code>[</code> 和 <code>]</code> 括号来实现属性的动态命名。下面是同一个例子，但它使用了一个事件处理函数而不是三个：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-inwizelqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-inwizelqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">handleChange</span>(<span class="hljs-params">e</span>) &#123;<br><span class="hljs-title function_">setPerson</span>(&#123;<br>  ...person,<br>  [e.<span class="hljs-property">target</span>.<span class="hljs-property">name</span>]: e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span><br>&#125;);<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p><code>e.target.name</code> 引用了 <code>&lt;input&gt;</code> 这个 DOM 元素的 <code>name</code> 属性。</p>
<p><mark>更新一个嵌套对象</mark>：考虑下面这种结构的嵌套对象：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-d2tpqjlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-d2tpqjlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> [person, setPerson] = <span class="hljs-title function_">useState</span>(&#123;<br>  <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Niki de Saint Phalle&#x27;</span>,<br>  <span class="hljs-attr">artwork</span>: &#123;<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Blue Nana&#x27;</span>,<br>    <span class="hljs-attr">city</span>: <span class="hljs-string">&#x27;Hamburg&#x27;</span>,<br>    <span class="hljs-attr">image</span>: <span class="hljs-string">&#x27;https://i.imgur.com/Sd1AgUOm.jpg&#x27;</span>,<br>  &#125;<br>&#125;);<br></code></pre></td></tr></table></div></figure>

<p>如果你想要更新 <code>person.artwork.city</code> 的值，用 mutation 来实现的方法非常容易理解：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-vzk2wslqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-vzk2wslqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jsx">person.<span class="hljs-property">artwork</span>.<span class="hljs-property">city</span> = <span class="hljs-string">&#x27;New Delhi&#x27;</span>;<br></code></pre></td></tr></table></div></figure>

<p>但是在 React 中，你需要将 state 视为不可变的！为了修改 <code>city</code> 的值，你首先需要创建一个新的 <code>artwork</code> 对象（其中预先填充了上一个 <code>artwork</code> 对象中的数据），然后创建一个新的 <code>person</code> 对象，并使得其中的 <code>artwork</code> 属性指向新创建的 <code>artwork</code> 对象：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-5vh98slqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-5vh98slqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> nextArtwork = &#123; ...person.<span class="hljs-property">artwork</span>, <span class="hljs-attr">city</span>: <span class="hljs-string">&#x27;New Delhi&#x27;</span> &#125;;<br><span class="hljs-keyword">const</span> nextPerson = &#123; ...person, <span class="hljs-attr">artwork</span>: nextArtwork &#125;;<br><span class="hljs-title function_">setPerson</span>(nextPerson);<br></code></pre></td></tr></table></div></figure>

<p>或者，写成一个函数调用：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-kk2vnxlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-kk2vnxlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-title function_">setPerson</span>(&#123;<br>  ...person, <span class="hljs-comment">// 复制其它字段的数据 </span><br>  <span class="hljs-attr">artwork</span>: &#123; <span class="hljs-comment">// 替换 artwork 字段 </span><br>    ...person.<span class="hljs-property">artwork</span>, <span class="hljs-comment">// 复制之前 person.artwork 中的数据</span><br>    <span class="hljs-attr">city</span>: <span class="hljs-string">&#x27;New Delhi&#x27;</span> <span class="hljs-comment">// 但是将 city 的值替换为 New Delhi！</span><br>  &#125;<br>&#125;);<br></code></pre></td></tr></table></div></figure>

<p>这虽然看起来有点冗长，但对于很多情况都能有效地解决问</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-x00m7zlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-x00m7zlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Form</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [person, setPerson] = <span class="hljs-title function_">useState</span>(&#123;<br>    <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Niki de Saint Phalle&#x27;</span>,<br>    <span class="hljs-attr">artwork</span>: &#123;<br>      <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Blue Nana&#x27;</span>,<br>      <span class="hljs-attr">city</span>: <span class="hljs-string">&#x27;Hamburg&#x27;</span>,<br>      <span class="hljs-attr">image</span>: <span class="hljs-string">&#x27;https://i.imgur.com/Sd1AgUOm.jpg&#x27;</span>,<br>    &#125;<br>  &#125;);<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleNameChange</span>(<span class="hljs-params">e</span>) &#123;<br>    <span class="hljs-title function_">setPerson</span>(&#123;<br>      ...person,<br>      <span class="hljs-attr">name</span>: e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span><br>    &#125;);<br>  &#125;<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleTitleChange</span>(<span class="hljs-params">e</span>) &#123;<br>    <span class="hljs-title function_">setPerson</span>(&#123;<br>      ...person,<br>      <span class="hljs-attr">artwork</span>: &#123;<br>        ...person.<span class="hljs-property">artwork</span>,<br>        <span class="hljs-attr">title</span>: e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span><br>      &#125;<br>    &#125;);<br>  &#125;<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleCityChange</span>(<span class="hljs-params">e</span>) &#123;<br>    <span class="hljs-title function_">setPerson</span>(&#123;<br>      ...person,<br>      <span class="hljs-attr">artwork</span>: &#123;<br>        ...person.<span class="hljs-property">artwork</span>,<br>        <span class="hljs-attr">city</span>: e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span><br>      &#125;<br>    &#125;);<br>  &#125;<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleImageChange</span>(<span class="hljs-params">e</span>) &#123;<br>    <span class="hljs-title function_">setPerson</span>(&#123;<br>      ...person,<br>      <span class="hljs-attr">artwork</span>: &#123;<br>        ...person.<span class="hljs-property">artwork</span>,<br>        <span class="hljs-attr">image</span>: e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span><br>      &#125;<br>    &#125;);<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">        Name:</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">input</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;person.name&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;handleNameChange&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">        Title:</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">input</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;person.artwork.title&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;handleTitleChange&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">        City:</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">input</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;person.artwork.city&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;handleCityChange&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">        Image:</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">input</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;person.artwork.image&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;handleImageChange&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">i</span>&gt;</span>&#123;person.artwork.title&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span></span><br><span class="language-xml">        &#123;&#x27; by &#x27;&#125;</span><br><span class="language-xml">        &#123;person.name&#125;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span></span><br><span class="language-xml">        (located in &#123;person.artwork.city&#125;)</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">img</span> </span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">src</span>=<span class="hljs-string">&#123;person.artwork.image&#125;</span> </span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">alt</span>=<span class="hljs-string">&#123;person.artwork.title&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>对象并非是真正嵌套的：下面这个对象从代码上来看是“嵌套”的：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-fsx1erlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-fsx1erlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">let</span> obj = &#123;<br><span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Niki de Saint Phalle&#x27;</span>,<br><span class="hljs-attr">artwork</span>: &#123;<br><span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Blue Nana&#x27;</span>,<br><span class="hljs-attr">city</span>: <span class="hljs-string">&#x27;Hamburg&#x27;</span>,<br><span class="hljs-attr">image</span>: <span class="hljs-string">&#x27;https://i.imgur.com/Sd1AgUOm.jpg&#x27;</span>,<br>&#125;<br>&#125;;<br></code></pre></td></tr></table></div></figure>

<p>然而，当我们思考对象的特性时，“嵌套”并不是一个非常准确的方式。当这段代码运行的时候，不存在“嵌套”的对象。你实际上看到的是两个不同的对象：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-9hskvhlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-9hskvhlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">let</span> obj1 = &#123;<br><span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Blue Nana&#x27;</span>,<br><span class="hljs-attr">city</span>: <span class="hljs-string">&#x27;Hamburg&#x27;</span>,<br><span class="hljs-attr">image</span>: <span class="hljs-string">&#x27;https://i.imgur.com/Sd1AgUOm.jpg&#x27;</span>,<br>&#125;;<br><br><span class="hljs-keyword">let</span> obj2 = &#123;<br><span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Niki de Saint Phalle&#x27;</span>,<br><span class="hljs-attr">artwork</span>: obj1<br>&#125;;<br></code></pre></td></tr></table></div></figure>

<p>对象 <code>obj1</code> 并不处于 <code>obj2</code> 的“内部”。例如，下面的代码中，<code>obj3</code> 中的属性也可以指向 <code>obj1</code>：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-b1b9tdlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-b1b9tdlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">let</span> obj1 = &#123;<br><span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Blue Nana&#x27;</span>,<br><span class="hljs-attr">city</span>: <span class="hljs-string">&#x27;Hamburg&#x27;</span>,<br><span class="hljs-attr">image</span>: <span class="hljs-string">&#x27;https://i.imgur.com/Sd1AgUOm.jpg&#x27;</span>,<br>&#125;;<br><br><span class="hljs-keyword">let</span> obj2 = &#123;<br><span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Niki de Saint Phalle&#x27;</span>,<br><span class="hljs-attr">artwork</span>: obj1<br>&#125;;<br><br><span class="hljs-keyword">let</span> obj3 = &#123;<br><span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Copycat&#x27;</span>,<br><span class="hljs-attr">artwork</span>: obj1<br>&#125;;<br></code></pre></td></tr></table></div></figure>

<p>如果你直接修改 <code>obj3.artwork.city</code>，就会同时影响 <code>obj2.artwork.city</code> 和 <code>obj1.city</code>。这是因为 <code>obj3.artwork</code>、<code>obj2.artwork</code> 和 <code>obj1</code> 都指向同一个对象。当你用“嵌套”的方式看待对象时，很难看出这一点。相反，它们是相互独立的对象，只不过是用属性“指向”彼此而已。</p>
<p><mark>使用 Immer 编写简洁的更新逻辑</mark>：如果你的 state 有多层的嵌套，你或许应该考虑 <a target="_blank" rel="noopener" href="http://localhost:3000/learn/choosing-the-state-structure#avoid-deeply-nested-state">将其扁平化</a>。但是，如果你不想改变 state 的数据结构，你可能更喜欢用一种更便捷的方式来实现嵌套展开的效果。<a target="_blank" rel="noopener" href="https://github.com/immerjs/use-immer">Immer</a> 是一个非常流行的库，它可以让你使用简便但可以直接修改的语法编写代码，并会帮你处理好复制的过程。通过使用 Immer，你写出的代码看起来就像是你“打破了规则”而直接修改了对象：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-3rhwvmlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-3rhwvmlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-title function_">updatePerson</span>(<span class="hljs-function"><span class="hljs-params">draft</span> =&gt;</span> &#123;<br>  draft.<span class="hljs-property">artwork</span>.<span class="hljs-property">city</span> = <span class="hljs-string">&#x27;Lagos&#x27;</span>;<br>&#125;);<br></code></pre></td></tr></table></div></figure>

<p>但是不同于一般的 mutation，它并不会覆盖之前的 state！</p>
<p>由 Immer 提供的 <code>draft</code> 是一种特殊类型的对象，被称为 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy">Proxy</a>，它会记录你用它所进行的操作。这就是你能够随心所欲地直接修改对象的原因所在！从原理上说，Immer 会弄清楚 <code>draft</code> 对象的哪些部分被改变了，并会依照你的修改创建出一个全新的对象。</p>
<p>使用 Immer:</p>
<ol>
<li>运行 <code>npm install use-immer</code> 添加 Immer 依赖</li>
<li>用 <code>import &#123; useImmer &#125; from &#39;use-immer&#39;</code> 替换掉 <code>import &#123; useState &#125; from &#39;react&#39;</code></li>
</ol>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-14pb63lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-14pb63lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useImmer &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;use-immer&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Form</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [person, updatePerson] = <span class="hljs-title function_">useImmer</span>(&#123;<br>    <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Niki de Saint Phalle&#x27;</span>,<br>    <span class="hljs-attr">artwork</span>: &#123;<br>      <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Blue Nana&#x27;</span>,<br>      <span class="hljs-attr">city</span>: <span class="hljs-string">&#x27;Hamburg&#x27;</span>,<br>      <span class="hljs-attr">image</span>: <span class="hljs-string">&#x27;https://i.imgur.com/Sd1AgUOm.jpg&#x27;</span>,<br>    &#125;<br>  &#125;);<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleNameChange</span>(<span class="hljs-params">e</span>) &#123;<br>    <span class="hljs-title function_">updatePerson</span>(<span class="hljs-function"><span class="hljs-params">draft</span> =&gt;</span> &#123;<br>      draft.<span class="hljs-property">name</span> = e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>;<br>    &#125;);<br>  &#125;<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleTitleChange</span>(<span class="hljs-params">e</span>) &#123;<br>    <span class="hljs-title function_">updatePerson</span>(<span class="hljs-function"><span class="hljs-params">draft</span> =&gt;</span> &#123;<br>      draft.<span class="hljs-property">artwork</span>.<span class="hljs-property">title</span> = e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>;<br>    &#125;);<br>  &#125;<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleCityChange</span>(<span class="hljs-params">e</span>) &#123;<br>    <span class="hljs-title function_">updatePerson</span>(<span class="hljs-function"><span class="hljs-params">draft</span> =&gt;</span> &#123;<br>      draft.<span class="hljs-property">artwork</span>.<span class="hljs-property">city</span> = e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>;<br>    &#125;);<br>  &#125;<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleImageChange</span>(<span class="hljs-params">e</span>) &#123;<br>    <span class="hljs-title function_">updatePerson</span>(<span class="hljs-function"><span class="hljs-params">draft</span> =&gt;</span> &#123;<br>      draft.<span class="hljs-property">artwork</span>.<span class="hljs-property">image</span> = e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>;<br>    &#125;);<br>  &#125;<br>  ...<br>&#125; <br></code></pre></td></tr></table></div></figure>

<p>可以看到，事件处理函数变得更简洁了。你可以随意在一个组件中同时使用 <code>useState</code> 和 <code>useImmer</code>。如果你想要写出更简洁的更新处理函数，Immer 会是一个不错的选择，尤其是当你的 state 中有嵌套，并且复制对象会带来重复的代码时。</p>
<hr>
<p><mark>为什么在 React 中不推荐直接修改 state？</mark></p>
<ol>
<li>调试：如果你使用 <code>console.log</code> 并且不直接修改 state，你之前日志中的 state 的值就不会被新的 state 变化所影响。这样你就可以清楚地看到两次渲染之间 state 的值发生了什么变化</li>
<li>优化：React 常见的 <a target="_blank" rel="noopener" href="http://localhost:3000/reference/react/memo">优化策略</a> 依赖于如果之前的 props 或者 state 的值和下一次相同就跳过渲染。如果你从未直接修改 state ，那么你就可以很快看到 state 是否发生了变化。如果 <code>prevObj === obj</code>，那么你就可以肯定这个对象内部并没有发生改变。</li>
<li>新功能：我们正在构建的 React 的新功能依赖于 state 被 <a target="_blank" rel="noopener" href="http://localhost:3000/learn/state-as-a-snapshot">像快照一样看待</a> 的理念。如果你直接修改 state 的历史版本，可能会影响你使用这些新功能。</li>
<li>需求变更：有些应用功能在不出现任何修改的情况下会更容易实现，比如实现撤销&#x2F;恢复、展示修改历史，或是允许用户把表单重置成某个之前的值。这是因为你可以把 state 之前的拷贝保存到内存中，并适时对其进行再次使用。如果一开始就用了直接修改 state 的方式，那么后面要实现这样的功能就会变得非常困难。</li>
<li>更简单的实现：React 并不依赖于 mutation ，所以你不需要对对象进行任何特殊操作。它不需要像很多“响应式”的解决方案一样去劫持对象的属性、总是用代理把对象包裹起来，或者在初始化时做其他工作。这也是为什么 React 允许你把任何对象存放在 state 中——不管对象有多大——而不会造成有任何额外的性能或正确性问题的原因。</li>
</ol>
<p>在实践中，你经常可以“侥幸”直接修改 state 而不出现什么问题，但是我们强烈建议你不要这样做，这样你就可以使用我们秉承着这种理念开发的 React 新功能。</p>
<h2 id="7-更新-state-中的数组"><a href="#7-更新-state-中的数组" class="headerlink" title="7.更新 state 中的数组"></a>7.更新 state 中的数组</h2><p>数组是另外一种可以存储在 state 中的 JavaScript 对象，它虽然是可变的，但是却应该被视为不可变。同对象一样，当你想要更新存储于 state 中的数组时，你需要创建一个新的数组（或者创建一份已有数组的拷贝值），并使用新数组设置 state。</p>
<p><mark>在没有 mutation 的前提下更新数组</mark>：在 JavaScript 中，数组只是另一种对象。<a target="_blank" rel="noopener" href="http://localhost:3000/learn/updating-objects-in-state">同对象一样</a>，你需要将 React state 中的数组视为只读的。这意味着你不应该使用类似于 <code>arr[0] = &#39;bird&#39;</code> 这样的方式来重新分配数组中的元素，也不应该使用会直接修改原始数组的方法，例如 <code>push()</code> 和 <code>pop()</code>。</p>
<p>相反，每次要更新一个数组时，你需要把一个新的数组传入 state 的 setting 方法中。为此，你可以通过使用像 <code>filter()</code> 和 <code>map()</code> 这样不会直接修改原始值的方法，从原始数组生成一个新的数组。然后你就可以将 state 设置为这个新生成的数组。</p>
<p>当你操作 React state 中的数组时，你需要避免使用左列的方法，而首选右列的方法：</p>
<table>
<thead>
<tr>
<th></th>
<th>避免使用 (会改变原始数组)</th>
<th>推荐使用 (会返回一个新数组）</th>
</tr>
</thead>
<tbody><tr>
<td>添加元素</td>
<td><code>push</code>，<code>unshift</code></td>
<td><code>concat</code>，<code>[...arr]</code> 展开语法（<a target="_blank" rel="noopener" href="http://localhost:3000/learn/updating-arrays-in-state#adding-to-an-array">例子</a>）</td>
</tr>
<tr>
<td>删除元素</td>
<td><code>pop</code>，<code>shift</code>，<code>splice</code></td>
<td><code>filter</code>，<code>slice</code>（<a target="_blank" rel="noopener" href="http://localhost:3000/learn/updating-arrays-in-state#removing-from-an-array">例子</a>）</td>
</tr>
<tr>
<td>替换元素</td>
<td><code>splice</code>，<code>arr[i] = ...</code> 赋值</td>
<td><code>map</code>（<a target="_blank" rel="noopener" href="http://localhost:3000/learn/updating-arrays-in-state#replacing-items-in-an-array">例子</a>）</td>
</tr>
<tr>
<td>排序</td>
<td><code>reverse</code>，<code>sort</code></td>
<td>先将数组复制一份（<a target="_blank" rel="noopener" href="http://localhost:3000/learn/updating-arrays-in-state#making-other-changes-to-an-array">例子</a>）</td>
</tr>
</tbody></table>
<p>或者，你可以<a target="_blank" rel="noopener" href="http://localhost:3000/learn/updating-arrays-in-state#write-concise-update-logic-with-immer">使用 Immer</a> ，这样你便可以使用表格中的所有方法了。</p>
<ul>
<li><code>slice</code> 让你可以拷贝数组或是数组的一部分。</li>
<li><code>splice</code> 会直接修改 原始数组（插入或者删除元素）。</li>
</ul>
<p>在 React 中，更多情况下你会使用 <code>slice</code>（没有 <code>p</code> ！），因为你不想改变 state 中的对象或数组。</p>
<p><mark>向数组中添加元素</mark>：<code>push()</code> 会直接修改原始数组，而你不希望这样：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-t2vc0flqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-t2vc0flqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">let</span> nextId = <span class="hljs-number">0</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">List</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [name, setName] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;&#x27;</span>);<br>  <span class="hljs-keyword">const</span> [artists, setArtists] = <span class="hljs-title function_">useState</span>([]);<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>振奋人心的雕塑家们：<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">input</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;name&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> setName(e.target.value)&#125;</span><br><span class="language-xml">      /&gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> &#123;</span><br><span class="language-xml">        artists.push(&#123;</span><br><span class="language-xml">          id: nextId++,</span><br><span class="language-xml">          name: name,</span><br><span class="language-xml">        &#125;);</span><br><span class="language-xml">      &#125;&#125;&gt;添加<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span></span><br><span class="language-xml">        &#123;artists.map(artist =&gt; (</span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;artist.id&#125;</span>&gt;</span>&#123;artist.name&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span><br><span class="language-xml">        ))&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>相反，你应该创建一个 新 数组，其包含了原始数组的所有元素 以及 一个在末尾的新元素。这可以通过很多种方法实现，最简单的一种就是使用 <code>...</code> <a target="_blank" rel="noopener" href="http://localhost:3000/a-javascript-refresher#array-spread">数组展开</a> 语法：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-67i4onlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-67i4onlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs jsx">&lt;button onClick=&#123;<span class="hljs-function">() =&gt;</span> &#123;<br>        <span class="hljs-title function_">setArtists</span>( <span class="hljs-comment">// 替换 state</span><br>  [ <span class="hljs-comment">// 是通过传入一个新数组实现的</span><br>    ...artists, <span class="hljs-comment">// 新数组包含原数组的所有元素</span><br>    &#123; <span class="hljs-attr">id</span>: nextId++, <span class="hljs-attr">name</span>: name &#125; <span class="hljs-comment">// 并在末尾添加了一个新的元素</span><br>  ]<br>);<br>    &#125;&#125;&gt;添加&lt;/button&gt;<br></code></pre></td></tr></table></div></figure>

<p>数组展开运算符还允许你把新添加的元素放在原始的 <code>...artists</code> 之前：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-6kulkilqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-6kulkilqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-title function_">setArtists</span>([<br><br>  &#123; <span class="hljs-attr">id</span>: nextId++, <span class="hljs-attr">name</span>: name &#125;,<br><br>  ...artists <span class="hljs-comment">// 将原数组中的元素放在末尾</span><br><br>]);<br></code></pre></td></tr></table></div></figure>

<p>这样一来，展开操作就可以完成 <code>push()</code> 和 <code>unshift()</code> 的工作，将新元素添加到数组的末尾和开头。</p>
<hr>
<p> <mark>从数组中删除元素</mark>：从数组中删除一个元素最简单的方法就是将它过滤出去。换句话说，你需要生成一个不包含该元素的新数组。这可以通过 <code>filter</code> 方法实现：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-77grb1lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-77grb1lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">let</span> initialArtists = [<br>  &#123; <span class="hljs-attr">id</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Marta Colvin Andrade&#x27;</span> &#125;,<br>  &#123; <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Lamidi Olonade Fakeye&#x27;</span>&#125;,<br>  &#123; <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Louise Nevelson&#x27;</span>&#125;,<br>];<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">List</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [artists, setArtists] = <span class="hljs-title function_">useState</span>(<br>    initialArtists<br>  );<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>振奋人心的雕塑家们：<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span></span><br><span class="language-xml">        &#123;artists.map(artist =&gt; (</span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;artist.id&#125;</span>&gt;</span></span><br><span class="language-xml">            &#123;artist.name&#125;&#123;&#x27; &#x27;&#125;</span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> &#123;</span><br><span class="language-xml">              setArtists(</span><br><span class="language-xml">                artists.filter(a =&gt;</span><br><span class="language-xml">                  a.id !== artist.id</span><br><span class="language-xml">                )</span><br><span class="language-xml">              );</span><br><span class="language-xml">            &#125;&#125;&gt;</span><br><span class="language-xml">              删除</span><br><span class="language-xml">            <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span><br><span class="language-xml">        ))&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p><code>artists.filter(s =&gt; s.id !== artist.id)</code> 表示“创建一个新的数组，该数组由那些 ID 与 <code>artists.id</code> 不同的 <code>artists</code> 组成”。换句话说，每个 artist 的“删除”按钮会把 <em>那一个</em> artist 从原始数组中过滤掉，并使用过滤后的数组再次进行渲染。注意，<code>filter</code> 并不会改变原始数组。</p>
<hr>
<p><mark>转换数组</mark>：如果你想改变数组中的某些或全部元素，你可以用 <code>map()</code> 创建一个新数组。你传入 <code>map</code> 的函数决定了要根据每个元素的值或索引（或二者都要）对元素做何处理。</p>
<p>一个数组记录了两个圆形和一个正方形的坐标。当你点击按钮时，仅有两个圆形会向下移动 100 像素。这是通过使用 <code>map()</code> 生成一个新数组实现的：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-1vlzfwlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-1vlzfwlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">let</span> initialShapes = [<br>  &#123; <span class="hljs-attr">id</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;circle&#x27;</span>, <span class="hljs-attr">x</span>: <span class="hljs-number">50</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">100</span> &#125;,<br>  &#123; <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;square&#x27;</span>, <span class="hljs-attr">x</span>: <span class="hljs-number">150</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">100</span> &#125;,<br>  &#123; <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;circle&#x27;</span>, <span class="hljs-attr">x</span>: <span class="hljs-number">250</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">100</span> &#125;,<br>];<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ShapeEditor</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [shapes, setShapes] = <span class="hljs-title function_">useState</span>(<br>    initialShapes<br>  );<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">const</span> nextShapes = shapes.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">shape</span> =&gt;</span> &#123;<br>      <span class="hljs-keyword">if</span> (shape.<span class="hljs-property">type</span> === <span class="hljs-string">&#x27;square&#x27;</span>) &#123;<br>        <span class="hljs-comment">// 不作改变</span><br>        <span class="hljs-keyword">return</span> shape;<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// 返回一个新的圆形，位置在下方 50px 处</span><br>        <span class="hljs-keyword">return</span> &#123;<br>          ...shape,<br>          <span class="hljs-attr">y</span>: shape.<span class="hljs-property">y</span> + <span class="hljs-number">50</span>,<br>        &#125;;<br>      &#125;<br>    &#125;);<br>    <span class="hljs-comment">// 使用新的数组进行重渲染</span><br>    <span class="hljs-title function_">setShapes</span>(nextShapes);<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handleClick&#125;</span>&gt;</span></span><br><span class="language-xml">        所有圆形向下移动！</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      &#123;shapes.map(shape =&gt; (</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">div</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;shape.id&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">style</span>=<span class="hljs-string">&#123;&#123;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">background:</span> &#x27;<span class="hljs-attr">purple</span>&#x27;,</span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">position:</span> &#x27;<span class="hljs-attr">absolute</span>&#x27;,</span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">left:</span> <span class="hljs-attr">shape.x</span>,</span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">top:</span> <span class="hljs-attr">shape.y</span>,</span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">borderRadius:</span></span></span><br><span class="hljs-tag"><span class="language-xml">            <span class="hljs-attr">shape.type</span> === <span class="hljs-string">&#x27;circle&#x27;</span></span></span><br><span class="hljs-tag"><span class="language-xml">              ? &#x27;<span class="hljs-attr">50</span>%&#x27; <span class="hljs-attr">:</span> &#x27;&#x27;,</span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">width:</span> <span class="hljs-attr">20</span>,</span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">height:</span> <span class="hljs-attr">20</span>,</span></span><br><span class="hljs-tag"><span class="language-xml">        &#125;&#125; /&gt;</span></span><br><span class="language-xml">      ))&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>&#x3D;&#x3D;替换数组中的元素&#x3D;&#x3D;：想要替换数组中一个或多个元素是非常常见的。类似 <code>arr[0] = &#39;bird&#39;</code> 这样的赋值语句会直接修改原始数组，所以在这种情况下，你也应该使用 <code>map</code>。</p>
<p>要替换一个元素，请使用 <code>map</code> 创建一个新数组。在你的 <code>map</code> 回调里，第二个参数是元素的索引。使用索引来判断最终是返回原始的元素（即回调的第一个参数）还是替换成其他值：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-shmgkolqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-shmgkolqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">let</span> initialCounters = [<br>  <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span><br>];<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">CounterList</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [counters, setCounters] = <span class="hljs-title function_">useState</span>(<br>    initialCounters<br>  );<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleIncrementClick</span>(<span class="hljs-params">index</span>) &#123;<br>    <span class="hljs-keyword">const</span> nextCounters = counters.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">c, i</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">if</span> (i === index) &#123;<br>        <span class="hljs-comment">// 递增被点击的计数器数值</span><br>        <span class="hljs-keyword">return</span> c + <span class="hljs-number">1</span>;<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// 其余部分不发生变化</span><br>        <span class="hljs-keyword">return</span> c;<br>      &#125;<br>    &#125;);<br>    <span class="hljs-title function_">setCounters</span>(nextCounters);<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span></span><br><span class="language-xml">      &#123;counters.map((counter, i) =&gt; (</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;i&#125;</span>&gt;</span></span><br><span class="language-xml">          &#123;counter&#125;</span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> &#123;</span><br><span class="language-xml">            handleIncrementClick(i);</span><br><span class="language-xml">          &#125;&#125;&gt;+1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span><br><span class="language-xml">      ))&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>&#x3D;&#x3D;向数组中插入元素&#x3D;&#x3D;：有时，你也许想向数组特定位置插入一个元素，这个位置既不在数组开头，也不在末尾。为此，你可以将数组展开运算符 <code>...</code> 和 <code>slice()</code> 方法一起使用。<code>slice()</code> 方法让你从数组中切出“一片”。为了将元素插入数组，你需要先展开原数组在插入点之前的切片，然后插入新元素，最后展开原数组中剩下的部分。</p>
<p>下面的例子中，插入按钮总是会将元素插入到数组中索引为 <code>1</code> 的位置。</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-v3fg4elqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-v3fg4elqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">let</span> nextId = <span class="hljs-number">3</span>;<br><span class="hljs-keyword">const</span> initialArtists = [<br>  &#123; <span class="hljs-attr">id</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Marta Colvin Andrade&#x27;</span> &#125;,<br>  &#123; <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Lamidi Olonade Fakeye&#x27;</span>&#125;,<br>  &#123; <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Louise Nevelson&#x27;</span>&#125;,<br>];<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">List</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [name, setName] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;&#x27;</span>);<br>  <span class="hljs-keyword">const</span> [artists, setArtists] = <span class="hljs-title function_">useState</span>(<br>    initialArtists<br>  );<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">const</span> insertAt = <span class="hljs-number">1</span>; <span class="hljs-comment">// 可能是任何索引</span><br>    <span class="hljs-keyword">const</span> nextArtists = [<br>      <span class="hljs-comment">// 插入点之前的元素：</span><br>      ...artists.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, insertAt),<br>      <span class="hljs-comment">// 新的元素：</span><br>      &#123; <span class="hljs-attr">id</span>: nextId++, <span class="hljs-attr">name</span>: name &#125;,<br>      <span class="hljs-comment">// 插入点之后的元素：</span><br>      ...artists.<span class="hljs-title function_">slice</span>(insertAt)<br>    ];<br>    <span class="hljs-title function_">setArtists</span>(nextArtists);<br>    <span class="hljs-title function_">setName</span>(<span class="hljs-string">&#x27;&#x27;</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>振奋人心的雕塑家们：<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">input</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;name&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> setName(e.target.value)&#125;</span><br><span class="language-xml">      /&gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handleClick&#125;</span>&gt;</span></span><br><span class="language-xml">        插入</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span></span><br><span class="language-xml">        &#123;artists.map(artist =&gt; (</span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;artist.id&#125;</span>&gt;</span>&#123;artist.name&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span><br><span class="language-xml">        ))&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>可能想翻转数组，或是对数组排序。而 JavaScript 中的 <code>reverse()</code> 和 <code>sort()</code> 方法会改变原数组，所以你无法直接使用它们。</p>
<p>然而，你可以先拷贝这个数组，再改变这个拷贝后的值。</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-bks0vdlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-bks0vdlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">let</span> nextId = <span class="hljs-number">3</span>;<br><span class="hljs-keyword">const</span> initialList = [<br>  &#123; <span class="hljs-attr">id</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Big Bellies&#x27;</span> &#125;,<br>  &#123; <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Lunar Landscape&#x27;</span> &#125;,<br>  &#123; <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Terracotta Army&#x27;</span> &#125;,<br>];<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">List</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [list, setList] = <span class="hljs-title function_">useState</span>(initialList);<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">const</span> nextList = [...list];<br>    nextList.<span class="hljs-title function_">reverse</span>();<br>    <span class="hljs-title function_">setList</span>(nextList);<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handleClick&#125;</span>&gt;</span></span><br><span class="language-xml">        翻转</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span></span><br><span class="language-xml">        &#123;list.map(artwork =&gt; (</span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;artwork.id&#125;</span>&gt;</span>&#123;artwork.title&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span><br><span class="language-xml">        ))&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>即使你拷贝了数组，你还是不能直接修改其内部的元素。这是因为<mark>数组的拷贝是浅拷贝——新的数组中依然保留了与原始数组相同的元素</mark>。因此，如果你修改了拷贝数组内部的某个对象，其实你正在直接修改当前的 state。举个例子，像下面的代码就会带来问题。</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-3gcs3blqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-3gcs3blqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> nextList = [...list];<br><br>nextList[<span class="hljs-number">0</span>].<span class="hljs-property">seen</span> = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 问题：直接修改了 list[0] 的值</span><br><br><span class="hljs-title function_">setList</span>(nextList);<br></code></pre></td></tr></table></div></figure>

<p>虽然 <code>nextList</code> 和 <code>list</code> 是两个不同的数组，<code>nextList[0]</code> 和 <code>list[0]</code> <mark>却指向了同一个对象</mark>。因此，通过改变 <code>nextList[0].seen</code>，<code>list[0].seen</code> 的值也被改变了。这是一种 state 的 mutation 操作，你应该避免这么做！你可以用类似于 <a target="_blank" rel="noopener" href="http://localhost:3000/learn/updating-objects-in-state#updating-a-nested-object">更新嵌套的 JavaScript 对象</a> 的方式解决这个问题——<mark>拷贝想要修改的特定元素，而不是直接修改它</mark>。下面是具体的操作。</p>
<hr>
<p><mark>更新数组内部的对象</mark>：对象并不是 真的 位于数组“内部”。可能他们在代码中看起来像是在数组“内部”，但其实<mark>数组中的每个对象都是这个数组“指向”的一个存储于其它位置的值</mark>。这就是当你在处理类似 <code>list[0]</code> 这样的嵌套字段时需要格外小心的原因。其他人的艺术品清单可能指向了数组的同一个元素！</p>
<p><mark>当你更新一个嵌套的 state 时，你需要从想要更新的地方创建拷贝值，一直这样，直到顶层。</mark> </p>
<p>在下面的例子中，两个不同的艺术品清单有着相同的初始 state。他们本应该互不影响，但是因为一次 mutation，他们的 state 被意外地共享了，勾选一个清单中的事项会影响另外一个清单：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-vpbvuklqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-vpbvuklqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">let</span> nextId = <span class="hljs-number">3</span>;<br><span class="hljs-keyword">const</span> initialList = [<br>  &#123; <span class="hljs-attr">id</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Big Bellies&#x27;</span>, <span class="hljs-attr">seen</span>: <span class="hljs-literal">false</span> &#125;,<br>  &#123; <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Lunar Landscape&#x27;</span>, <span class="hljs-attr">seen</span>: <span class="hljs-literal">false</span> &#125;,<br>  &#123; <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Terracotta Army&#x27;</span>, <span class="hljs-attr">seen</span>: <span class="hljs-literal">true</span> &#125;,<br>];<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">BucketList</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [myList, setMyList] = <span class="hljs-title function_">useState</span>(initialList);<br>  <span class="hljs-keyword">const</span> [yourList, setYourList] = <span class="hljs-title function_">useState</span>(<br>    initialList<br>  );<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleToggleMyList</span>(<span class="hljs-params">artworkId, nextSeen</span>) &#123;<br>    <span class="hljs-keyword">const</span> myNextList = [...myList];<br>    <span class="hljs-keyword">const</span> artwork = myNextList.<span class="hljs-title function_">find</span>(<br>      <span class="hljs-function"><span class="hljs-params">a</span> =&gt;</span> a.<span class="hljs-property">id</span> === artworkId<br>    );<br>    artwork.<span class="hljs-property">seen</span> = nextSeen;<br>    <span class="hljs-title function_">setMyList</span>(myNextList);<br>  &#125;<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleToggleYourList</span>(<span class="hljs-params">artworkId, nextSeen</span>) &#123;<br>    <span class="hljs-keyword">const</span> yourNextList = [...yourList];<br>    <span class="hljs-keyword">const</span> artwork = yourNextList.<span class="hljs-title function_">find</span>(<br>      <span class="hljs-function"><span class="hljs-params">a</span> =&gt;</span> a.<span class="hljs-property">id</span> === artworkId<br>    );<br>    artwork.<span class="hljs-property">seen</span> = nextSeen;<br>    <span class="hljs-title function_">setYourList</span>(yourNextList);<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>艺术愿望清单<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>我想看的艺术清单：<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ItemList</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">artworks</span>=<span class="hljs-string">&#123;myList&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">onToggle</span>=<span class="hljs-string">&#123;handleToggleMyList&#125;</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>你想看的艺术清单：<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ItemList</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">artworks</span>=<span class="hljs-string">&#123;yourList&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">onToggle</span>=<span class="hljs-string">&#123;handleToggleYourList&#125;</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ItemList</span>(<span class="hljs-params">&#123; artworks, onToggle &#125;</span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span></span><br><span class="language-xml">      &#123;artworks.map(artwork =&gt; (</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;artwork.id&#125;</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">input</span></span></span><br><span class="hljs-tag"><span class="language-xml">              <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;checkbox&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">              <span class="hljs-attr">checked</span>=<span class="hljs-string">&#123;artwork.seen&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">              <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> &#123;</span><br><span class="language-xml">                onToggle(</span><br><span class="language-xml">                  artwork.id,</span><br><span class="language-xml">                  e.target.checked</span><br><span class="language-xml">                );</span><br><span class="language-xml">              &#125;&#125;</span><br><span class="language-xml">            /&gt;</span><br><span class="language-xml">            &#123;artwork.title&#125;</span><br><span class="language-xml">          <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span><br><span class="language-xml">      ))&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>虽然 <code>myNextList</code> 这个数组是新的，但是其内部的元素本身与原数组 <code>myList</code> 是相同的。因此，修改 <code>artwork.seen</code>，其实是在修改原始的 artwork 对象。而这个 artwork 对象也被 <code>yourList</code> 使用，这样就带来了 bug。这样的 bug 可能难以想到，但好在如果你避免直接修改 state，它们就会消失。</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-yv4po6lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-yv4po6lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> myNextList = [...myList];<br><span class="hljs-keyword">const</span> artwork = myNextList.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">a</span> =&gt;</span> a.<span class="hljs-property">id</span> === artworkId);<br>artwork.<span class="hljs-property">seen</span> = nextSeen; <span class="hljs-comment">// 问题：直接修改了已有的元素</span><br><span class="hljs-title function_">setMyList</span>(myNextList);<br></code></pre></td></tr></table></div></figure>

<p>可以使用 <code>map</code> 在没有 mutation 的前提下将一个旧的元素替换成更新的版本。</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-uij0b6lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-uij0b6lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-title function_">setMyList</span>(myList.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">artwork</span> =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span> (artwork.<span class="hljs-property">id</span> === artworkId) &#123;<br>    <span class="hljs-comment">// 创建包含变更的*新*对象</span><br>    <span class="hljs-keyword">return</span> &#123; ...artwork, <span class="hljs-attr">seen</span>: nextSeen &#125;;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">// 没有变更</span><br>    <span class="hljs-keyword">return</span> artwork;<br>  &#125;<br>&#125;));<br></code></pre></td></tr></table></div></figure>

<p>此处的 <code>...</code> 是一个对象展开语法，被用来<a target="_blank" rel="noopener" href="http://localhost:3000/learn/updating-objects-in-state#copying-objects-with-the-spread-syntax">创建一个对象的拷贝</a>.</p>
<p>通过这种方式，没有任何现有的 state 中的元素会被改变，bug 也就被修复了。</p>
<p>通常来讲，你应该只直接修改你刚刚创建的对象。如果你正在插入一个新的 artwork，你可以修改它，但是如果你想要改变的是 state 中已经存在的东西，你就需要先拷贝一份了。</p>
<p><mark>使用 Immer 编写简洁的更新逻辑</mark>：在没有 mutation 的前提下更新嵌套数组可能会变得有点重复。<a target="_blank" rel="noopener" href="http://localhost:3000/learn/updating-objects-in-state#write-concise-update-logic-with-immer">就像对对象一样</a>:</p>
<ul>
<li>通常情况下，你应该不需要更新处于非常深层级的 state 。如果你有此类需求，你或许需要<a target="_blank" rel="noopener" href="http://localhost:3000/learn/choosing-the-state-structure#avoid-deeply-nested-state">调整一下数据的结构</a>，让数据变得扁平一些。</li>
<li>如果你不想改变 state 的数据结构，你也许会更喜欢使用 <a target="_blank" rel="noopener" href="https://github.com/immerjs/use-immer">Immer</a> ，它让你可以继续使用方便的，但会直接修改原值的语法，并负责为你生成拷贝值。</li>
</ul>
<p>下面是我们用 Immer 来重写的艺术愿望清单的例子：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-963ksvlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-963ksvlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; useImmer &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;use-immer&#x27;</span>;<br><br><span class="hljs-keyword">let</span> nextId = <span class="hljs-number">3</span>;<br><span class="hljs-keyword">const</span> initialList = [<br>  &#123; <span class="hljs-attr">id</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Big Bellies&#x27;</span>, <span class="hljs-attr">seen</span>: <span class="hljs-literal">false</span> &#125;,<br>  &#123; <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Lunar Landscape&#x27;</span>, <span class="hljs-attr">seen</span>: <span class="hljs-literal">false</span> &#125;,<br>  &#123; <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Terracotta Army&#x27;</span>, <span class="hljs-attr">seen</span>: <span class="hljs-literal">true</span> &#125;,<br>];<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">BucketList</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [myList, updateMyList] = <span class="hljs-title function_">useImmer</span>(<br>    initialList<br>  );<br>  <span class="hljs-keyword">const</span> [yourList, updateYourList] = <span class="hljs-title function_">useImmer</span>(<br>    initialList<br>  );<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleToggleMyList</span>(<span class="hljs-params">id, nextSeen</span>) &#123;<br>    <span class="hljs-title function_">updateMyList</span>(<span class="hljs-function"><span class="hljs-params">draft</span> =&gt;</span> &#123;<br>      <span class="hljs-keyword">const</span> artwork = draft.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">a</span> =&gt;</span><br>        a.<span class="hljs-property">id</span> === id<br>      );<br>      artwork.<span class="hljs-property">seen</span> = nextSeen;<br>    &#125;);<br>  &#125;<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleToggleYourList</span>(<span class="hljs-params">artworkId, nextSeen</span>) &#123;<br>    <span class="hljs-title function_">updateYourList</span>(<span class="hljs-function"><span class="hljs-params">draft</span> =&gt;</span> &#123;<br>      <span class="hljs-keyword">const</span> artwork = draft.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">a</span> =&gt;</span><br>        a.<span class="hljs-property">id</span> === artworkId<br>      );<br>      artwork.<span class="hljs-property">seen</span> = nextSeen;<br>    &#125;);<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>艺术愿望清单<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>我想看的艺术清单：<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ItemList</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">artworks</span>=<span class="hljs-string">&#123;myList&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">onToggle</span>=<span class="hljs-string">&#123;handleToggleMyList&#125;</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>你想看的艺术清单：<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ItemList</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">artworks</span>=<span class="hljs-string">&#123;yourList&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">onToggle</span>=<span class="hljs-string">&#123;handleToggleYourList&#125;</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ItemList</span>(<span class="hljs-params">&#123; artworks, onToggle &#125;</span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span></span><br><span class="language-xml">      &#123;artworks.map(artwork =&gt; (</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;artwork.id&#125;</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">input</span></span></span><br><span class="hljs-tag"><span class="language-xml">              <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;checkbox&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">              <span class="hljs-attr">checked</span>=<span class="hljs-string">&#123;artwork.seen&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">              <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> &#123;</span><br><span class="language-xml">                onToggle(</span><br><span class="language-xml">                  artwork.id,</span><br><span class="language-xml">                  e.target.checked</span><br><span class="language-xml">                );</span><br><span class="language-xml">              &#125;&#125;</span><br><span class="language-xml">            /&gt;</span><br><span class="language-xml">            &#123;artwork.title&#125;</span><br><span class="language-xml">          <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span><br><span class="language-xml">      ))&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>请注意当使用 Immer 时，类似 <code>artwork.seen = nextSeen</code> 这种会产生 mutation 的语法不会再有任何问题了：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-p92en3lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-p92en3lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-title function_">updateMyTodos</span>(<span class="hljs-function"><span class="hljs-params">draft</span> =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> artwork = draft.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">a</span> =&gt;</span> a.<span class="hljs-property">id</span> === artworkId);<br>  artwork.<span class="hljs-property">seen</span> = nextSeen;<br>&#125;);<br></code></pre></td></tr></table></div></figure>

<p>这是因为你并不是在直接修改原始的 state，而是在修改 Immer 提供的一个特殊的 <code>draft</code> 对象。同理，你也可以为 <code>draft</code> 的内容使用 <code>push()</code> 和 <code>pop()</code> 这些会直接修改原值的方法。</p>
<p>在幕后，Immer 总是会根据你对 <code>draft</code> 的修改来从头开始构建下一个 state。这使得你的事件处理程序非常的简洁，同时也不会直接修改 state。</p>
<h1 id="五-状态管理"><a href="#五-状态管理" class="headerlink" title="五.状态管理"></a>五.状态管理</h1><h2 id="1-用状态响应输入"><a href="#1-用状态响应输入" class="headerlink" title="1.用状态响应输入"></a>1.用状态响应输入</h2><p>React 控制 UI 的方式是声明式的。你不必直接控制 UI 的各个部分，只需要声明组件可以处于的不同状态，并根据用户的输入在它们之间切换。使用 React，你不用直接从代码层面修改 UI。例如，不用编写诸如“禁用按钮”、“启用按钮”、“显示成功消息”等命令。相反，你只需要描述组件在不同状态（“初始状态”、“输入状态”、“成功状态”）下希望展现的 UI，然后根据用户输入触发状态更改。</p>
<p>下面是一个使用 React 编写的反馈表单。请注意看它是如何使用 <code>status</code> 这个状态变量来决定启用或禁用提交按钮，以及是否显示成功消息的。</p>
<p>想象一个允许用户提交一个答案的表单：</p>
<ul>
<li>当你向表单输入数据时，“提交”按钮会随之变成可用状态</li>
<li>当你点击“提交”后，表单和提交按钮都会随之变成不可用状态，并且会加载动画会随之出现</li>
<li>如果网络请求成功，表单会随之隐藏，同时“提交成功”的信息会随之出现</li>
<li>如果网络请求失败，错误信息会随之出现，同时表单又变为可用状态</li>
</ul>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-yp6rz6lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-yp6rz6lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Form</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [answer, setAnswer] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;&#x27;</span>);<br>  <span class="hljs-keyword">const</span> [error, setError] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);<br>  <span class="hljs-keyword">const</span> [status, setStatus] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;typing&#x27;</span>);<br><br>  <span class="hljs-keyword">if</span> (status === <span class="hljs-string">&#x27;success&#x27;</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>答对了！<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br>  &#125;<br><br>  <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleSubmit</span>(<span class="hljs-params">e</span>) &#123;<br>    e.<span class="hljs-title function_">preventDefault</span>();<br>    <span class="hljs-title function_">setStatus</span>(<span class="hljs-string">&#x27;submitting&#x27;</span>);<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">await</span> <span class="hljs-title function_">submitForm</span>(answer);<br>      <span class="hljs-title function_">setStatus</span>(<span class="hljs-string">&#x27;success&#x27;</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (err) &#123;<br>      <span class="hljs-title function_">setStatus</span>(<span class="hljs-string">&#x27;typing&#x27;</span>);<br>      <span class="hljs-title function_">setError</span>(err);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleTextareaChange</span>(<span class="hljs-params">e</span>) &#123;<br>    <span class="hljs-title function_">setAnswer</span>(e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>城市测验<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml">        哪个城市有把空气变成饮用水的广告牌？</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">onSubmit</span>=<span class="hljs-string">&#123;handleSubmit&#125;</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">textarea</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;answer&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;handleTextareaChange&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">disabled</span>=<span class="hljs-string">&#123;status</span> === <span class="hljs-string">&#x27;submitting&#x27;</span>&#125;</span></span><br><span class="hljs-tag"><span class="language-xml">        /&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">disabled</span>=<span class="hljs-string">&#123;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">answer.length</span> === <span class="hljs-string">0</span> ||</span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">status</span> === <span class="hljs-string">&#x27;submitting&#x27;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        &#125;&gt;</span></span><br><span class="language-xml">          提交</span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">        &#123;error !== null &amp;&amp;</span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;Error&quot;</span>&gt;</span></span><br><span class="language-xml">            &#123;error.message&#125;</span><br><span class="language-xml">          <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml">        &#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">submitForm</span>(<span class="hljs-params">answer</span>) &#123;<br>  <span class="hljs-comment">// 模拟接口请求</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-keyword">let</span> shouldError = answer.<span class="hljs-title function_">toLowerCase</span>() !== <span class="hljs-string">&#x27;lima&#x27;</span><br>      <span class="hljs-keyword">if</span> (shouldError) &#123;<br>        <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;猜的不错，但答案不对。再试试看吧！&#x27;</span>));<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-title function_">resolve</span>();<br>      &#125;<br>    &#125;, <span class="hljs-number">1500</span>);<br>  &#125;);<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p><mark>声明式地考虑 UI 的过程</mark>：</p>
<ol>
<li><p><mark>定位组件中不同的视图状态</mark>：需要去可视化 UI 界面中用户可能看到的所有不同的“状态”：</p>
<ul>
<li>无数据：表单有一个不可用状态的“提交”按钮。</li>
<li>输入中：表单有一个可用状态的“提交”按钮。</li>
<li>提交中：表单完全处于不可用状态，加载动画出现。</li>
<li>成功时：显示“成功”的消息而非表单。</li>
<li>错误时：与输入状态类似，但会多错误的消息。</li>
</ul>
<p>如果一个组件有多个视图状态，你可以很方便地将它们展示在一个页面中：</p>
<p>App.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-98f0phlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-98f0phlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Form</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./Form.js&#x27;</span>;<br><br><span class="hljs-keyword">let</span> statuses = [<br>  <span class="hljs-string">&#x27;empty&#x27;</span>,<br>  <span class="hljs-string">&#x27;typing&#x27;</span>,<br>  <span class="hljs-string">&#x27;submitting&#x27;</span>,<br>  <span class="hljs-string">&#x27;success&#x27;</span>,<br>  <span class="hljs-string">&#x27;error&#x27;</span>,<br>];<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      &#123;statuses.map(status =&gt; (</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">section</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;status&#125;</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>Form (&#123;status&#125;):<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">Form</span> <span class="hljs-attr">status</span>=<span class="hljs-string">&#123;status&#125;</span> /&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span></span><br><span class="language-xml">      ))&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>Form.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-0e4rsslqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-0e4rsslqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Form</span>(<span class="hljs-params">&#123; status &#125;</span>) &#123;<br>  <span class="hljs-keyword">if</span> (status === <span class="hljs-string">&#x27;success&#x27;</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>That&#x27;s right!<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br>  &#125;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">form</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">textarea</span> <span class="hljs-attr">disabled</span>=<span class="hljs-string">&#123;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">status</span> === <span class="hljs-string">&#x27;submitting&#x27;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      &#125; /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">disabled</span>=<span class="hljs-string">&#123;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">status</span> === <span class="hljs-string">&#x27;empty&#x27;</span> ||</span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">status</span> === <span class="hljs-string">&#x27;submitting&#x27;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      &#125;&gt;</span></span><br><span class="language-xml">        Submit</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      &#123;status === &#x27;error&#x27; &amp;&amp;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;Error&quot;</span>&gt;</span></span><br><span class="language-xml">          Good guess but a wrong answer. Try again!</span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml">      &#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>
</li>
<li><p><mark>确定是什么触发了这些状态的改变</mark>：可以触发 state 的更新来响应两种输入：</p>
<ul>
<li>人为输入。比如点击按钮、在表单中输入内容，或导航到链接。【人为输入通常需要 <a target="_blank" rel="noopener" href="http://localhost:3000/learn/responding-to-events">事件处理函数</a>！】</li>
<li>计算机输入。比如网络请求得到反馈、定时器被触发，或加载一张图片。</li>
</ul>
<p>以上两种情况中，你必须设置 <a target="_blank" rel="noopener" href="http://localhost:3000/learn/state-a-components-memory#anatomy-of-usestate">state 变量</a> 去更新 UI。对于正在开发中的表单来说，你需要改变 state 以响应几个不同的输入：</p>
<ul>
<li>改变输入框中的文本时（人为）应该根据输入框的内容是否是空值，从而决定将表单的状态从空值状态切换到输入中或切换回原状态。</li>
<li>点击提交按钮时（人为）应该将表单的状态切换到提交中的状态。</li>
<li>网络请求成功后（计算机）应该将表单的状态切换到成功的状态。</li>
<li>网络请求失败后（计算机）应该将表单的状态切换到失败的状态，与此同时，显示错误信息。</li>
</ul>
</li>
<li><p><mark>通过 <code>useState</code> 表示内存中的 state</mark>：state 的每个部分都是“处于变化中的”，并且你需要让“变化的部分”尽可能的少。</p>
<p>先从绝对必须存在的状态开始。例如，你需要存储输入的 <code>answer</code> 以及用于存储最后一个错误的 <code>error</code> （如果存在的话）：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-5v1qs1lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-5v1qs1lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> [answer, setAnswer] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;&#x27;</span>);<br><span class="hljs-keyword">const</span> [error, setError] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);<br></code></pre></td></tr></table></div></figure>

<p>接下来，你需要一个状态变量来代表你想要显示的那个可视状态。通常有多种方式在内存中表示它，因此你需要进行实验。</p>
<p>如果你很难立即想出最好的办法，那就先从添加足够多的 state 开始，确保所有可能的视图状态都囊括其中：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-3fy5tilqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-3fy5tilqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> [isEmpty, setIsEmpty] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>);<br><span class="hljs-keyword">const</span> [isTyping, setIsTyping] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);<br><span class="hljs-keyword">const</span> [isSubmitting, setIsSubmitting] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);<br><span class="hljs-keyword">const</span> [isSuccess, setIsSuccess] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);<br><span class="hljs-keyword">const</span> [isError, setIsError] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);<br></code></pre></td></tr></table></div></figure>

<p>你最初的想法或许不是最好的，但是没关系，重构 state 也是步骤中的一部分！</p>
</li>
<li><p><mark>删除任何不必要的 state 变量</mark>：防止出现在内存中的 state 不代表任何你希望用户看到的有效 UI 的情况。</p>
<p>关于 state 变量的问题：</p>
<ul>
<li>这个 state 是否会导致矛盾？例如，<code>isTyping</code> 与 <code>isSubmitting</code> 的状态不能同时为 <code>true</code>。矛盾的产生通常说明了这个 state 没有足够的约束条件。两个布尔值有四种可能的组合，但是只有三种对应有效的状态。为了将“不可能”的状态移除，你可以将 <code>&#39;typing&#39;</code>、<code>&#39;submitting&#39;</code> 以及 <code>&#39;success&#39;</code> 这三个中的其中一个与 <code>status</code> 结合。</li>
<li>相同的信息是否已经在另一个 state 变量中存在？另一个矛盾：<code>isEmpty</code> 和 <code>isTyping</code> 不能同时为 <code>true</code>。通过使它们成为独立的 state 变量，可能会导致它们不同步并导致 bug。幸运的是，你可以移除 <code>isEmpty</code> 转而用 <code>message.length === 0</code>。</li>
<li>你是否可以通过另一个 state 变量的相反值得到相同的信息？<code>isError</code> 是多余的，因为你可以检查 <code>error !== null</code>。</li>
</ul>
<p>在清理之后，你只剩下 3 个（从原本的 7 个！）<em>必要</em>的 state 变量：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-9nzzz1lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-9nzzz1lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> [answer, setAnswer] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;&#x27;</span>);<br><span class="hljs-keyword">const</span> [error, setError] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);<br><span class="hljs-keyword">const</span> [status, setStatus] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;typing&#x27;</span>); <span class="hljs-comment">// &#x27;typing&#x27;, &#x27;submitting&#x27;, or &#x27;success&#x27;</span><br></code></pre></td></tr></table></div></figure>

<p>正是因为你不能在不破坏功能的情况下删除其中任何一个状态变量，因此你可以确定这些都是必要的。</p>
<p><mark>通过 reducer 来减少“不可能” state</mark>：尽管这三个变量对于表示这个表单的状态来说已经足够好了，仍然是有一些中间状态并不是完全有意义的。例如一个非空的 <code>error</code> 当 <code>status</code> 的值为 <code>success</code> 时没有意义。为了更精确地模块化状态，你可以 <a target="_blank" rel="noopener" href="http://localhost:3000/learn/extracting-state-logic-into-a-reducer">将状态提取到一个 reducer 中</a>。Reducer 可以让您合并多个状态变量到一个对象中并巩固所有相关的逻辑！</p>
</li>
<li><p><mark>连接事件处理函数以设置 state</mark>：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-lnw6jqlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-lnw6jqlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Form</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [answer, setAnswer] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;&#x27;</span>);<br>  <span class="hljs-keyword">const</span> [error, setError] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);<br>  <span class="hljs-keyword">const</span> [status, setStatus] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;typing&#x27;</span>);<br><br>  <span class="hljs-keyword">if</span> (status === <span class="hljs-string">&#x27;success&#x27;</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>That&#x27;s right!<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br>  &#125;<br><br>  <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleSubmit</span>(<span class="hljs-params">e</span>) &#123;<br>    e.<span class="hljs-title function_">preventDefault</span>();<br>    <span class="hljs-title function_">setStatus</span>(<span class="hljs-string">&#x27;submitting&#x27;</span>);<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">await</span> <span class="hljs-title function_">submitForm</span>(answer);<br>      <span class="hljs-title function_">setStatus</span>(<span class="hljs-string">&#x27;success&#x27;</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (err) &#123;<br>      <span class="hljs-title function_">setStatus</span>(<span class="hljs-string">&#x27;typing&#x27;</span>);<br>      <span class="hljs-title function_">setError</span>(err);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleTextareaChange</span>(<span class="hljs-params">e</span>) &#123;<br>    <span class="hljs-title function_">setAnswer</span>(e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>City quiz<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml">        In which city is there a billboard that turns air into drinkable water?</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">onSubmit</span>=<span class="hljs-string">&#123;handleSubmit&#125;</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">textarea</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;answer&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;handleTextareaChange&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">disabled</span>=<span class="hljs-string">&#123;status</span> === <span class="hljs-string">&#x27;submitting&#x27;</span>&#125;</span></span><br><span class="hljs-tag"><span class="language-xml">        /&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">disabled</span>=<span class="hljs-string">&#123;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">answer.length</span> === <span class="hljs-string">0</span> ||</span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">status</span> === <span class="hljs-string">&#x27;submitting&#x27;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        &#125;&gt;</span></span><br><span class="language-xml">          Submit</span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">        &#123;error !== null &amp;&amp;</span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;Error&quot;</span>&gt;</span></span><br><span class="language-xml">            &#123;error.message&#125;</span><br><span class="language-xml">          <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml">        &#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">submitForm</span>(<span class="hljs-params">answer</span>) &#123;<br>  <span class="hljs-comment">// Pretend it&#x27;s hitting the network.</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-keyword">let</span> shouldError = answer.<span class="hljs-title function_">toLowerCase</span>() !== <span class="hljs-string">&#x27;lima&#x27;</span><br>      <span class="hljs-keyword">if</span> (shouldError) &#123;<br>        <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;Good guess but a wrong answer. Try again!&#x27;</span>));<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-title function_">resolve</span>();<br>      &#125;<br>    &#125;, <span class="hljs-number">1500</span>);<br>  &#125;);<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>将所有的交互变为 state 的改变，可以让你避免之后引入新的视图状态后导致现有 state 被破坏。同时也使你在不必改变交互逻辑的情况下，更改每个状态对应的 UI。</p>
</li>
</ol>
<h2 id="2-选择state结构"><a href="#2-选择state结构" class="headerlink" title="2.选择state结构"></a>2.选择state结构</h2><p><mark>构建 state 的原则</mark>：</p>
<ol>
<li><p><mark>合并关联的 state</mark>。如果你总是同时更新两个或更多的 state 变量，请考虑将它们合并为一个单独的 state 变量。</p>
<p>有时候你可能会不确定是使用单个 state 变量还是多个 state 变量。</p>
<p>你会像下面这样做吗？</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-ktbirdlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-ktbirdlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> [x, setX] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br><br><span class="hljs-keyword">const</span> [y, setY] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br></code></pre></td></tr></table></div></figure>

<p>或这样？</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-3qothulqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-3qothulqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> [position, setPosition] = <span class="hljs-title function_">useState</span>(&#123; <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span> &#125;);<br></code></pre></td></tr></table></div></figure>

<p>从技术上讲，你可以使用其中任何一种方法。但是，如果某两个 state 变量总是一起变化，则将它们统一成一个 state 变量可能更好。</p>
<p><mark>如果你的 state 变量是一个对象时，请记住，<a target="_blank" rel="noopener" href="http://localhost:3000/learn/updating-objects-in-state">你不能只更新其中的一个字段</a> 而不显式复制其他字段</mark>。例如，在上面的例子中，你不能写成 <code>setPosition(&#123; x: 100 &#125;)</code>，因为它根本就没有 <code>y</code> 属性! 相反，如果你想要仅设置 <code>x</code>，则可执行 <code>setPosition(&#123; ...position, x: 100 &#125;)</code>，或将它们分成两个 state 变量，并执行 <code>setX(100)</code>。</p>
</li>
<li><p><mark>避免互相矛盾的 state</mark>。当 state 结构中存在多个相互矛盾或“不一致”的 state 时，你就可能为此会留下隐患。应尽量避免这种情况。</p>
<p>下面是带有 <code>isSending</code> 和 <code>isSent</code> 两个 state 变量的酒店反馈表单：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-l44hbclqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-l44hbclqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">FeedbackForm</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [text, setText] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;&#x27;</span>);<br>  <span class="hljs-keyword">const</span> [isSending, setIsSending] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);<br>  <span class="hljs-keyword">const</span> [isSent, setIsSent] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);<br><br>  <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleSubmit</span>(<span class="hljs-params">e</span>) &#123;<br>    e.<span class="hljs-title function_">preventDefault</span>();<br>    <span class="hljs-title function_">setIsSending</span>(<span class="hljs-literal">true</span>);<br>    <span class="hljs-keyword">await</span> <span class="hljs-title function_">sendMessage</span>(text);<br>    <span class="hljs-title function_">setIsSending</span>(<span class="hljs-literal">false</span>);<br>    <span class="hljs-title function_">setIsSent</span>(<span class="hljs-literal">true</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (isSent) &#123;<br>    <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Thanks for feedback!<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">onSubmit</span>=<span class="hljs-string">&#123;handleSubmit&#125;</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>How was your stay at The Prancing Pony?<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">textarea</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">disabled</span>=<span class="hljs-string">&#123;isSending&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;text&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> setText(e.target.value)&#125;</span><br><span class="language-xml">      /&gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">disabled</span>=<span class="hljs-string">&#123;isSending&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      &gt;</span></span><br><span class="language-xml">        Send</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      &#123;isSending &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Sending...<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-comment">// 假装发送一条消息。</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">sendMessage</span>(<span class="hljs-params">text</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> &#123;<br>    <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">2000</span>);<br>  &#125;);<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>尽管这段代码是有效的，但也会让一些 state “极难处理”。例如，如果你忘记同时调用 <code>setIsSent</code> 和 <code>setIsSending</code>，则可能会出现 <code>isSending</code> 和 <code>isSent</code> 同时为 <code>true</code> 的情况。你的组件越复杂，你就越难理解发生了什么。</p>
<p>因为 <code>isSending</code> 和 <code>isSent</code> 不应同时为 <code>true</code>，所以最好用一个 <code>status</code> 变量来代替它们，这个 state 变量可以采取三种有效状态其中之一：<code>&#39;typing&#39;</code> (初始), <code>&#39;sending&#39;</code>, 和 <code>&#39;sent&#39;</code>：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-h9a2c1lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-h9a2c1lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">FeedbackForm</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [text, setText] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;&#x27;</span>);<br>  <span class="hljs-keyword">const</span> [status, setStatus] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;typing&#x27;</span>);<br><br>  <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleSubmit</span>(<span class="hljs-params">e</span>) &#123;<br>    e.<span class="hljs-title function_">preventDefault</span>();<br>    <span class="hljs-title function_">setStatus</span>(<span class="hljs-string">&#x27;sending&#x27;</span>);<br>    <span class="hljs-keyword">await</span> <span class="hljs-title function_">sendMessage</span>(text);<br>    <span class="hljs-title function_">setStatus</span>(<span class="hljs-string">&#x27;sent&#x27;</span>);<br>  &#125;<br><span class="hljs-comment">//常量</span><br>  <span class="hljs-keyword">const</span> isSending = status === <span class="hljs-string">&#x27;sending&#x27;</span>;<br>  <span class="hljs-keyword">const</span> isSent = status === <span class="hljs-string">&#x27;sent&#x27;</span>;<br><br>  <span class="hljs-keyword">if</span> (isSent) &#123;<br>    <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Thanks for feedback!<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">onSubmit</span>=<span class="hljs-string">&#123;handleSubmit&#125;</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>How was your stay at The Prancing Pony?<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">textarea</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">disabled</span>=<span class="hljs-string">&#123;isSending&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;text&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> setText(e.target.value)&#125;</span><br><span class="language-xml">      /&gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">disabled</span>=<span class="hljs-string">&#123;isSending&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      &gt;</span></span><br><span class="language-xml">        Send</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      &#123;isSending &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Sending...<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-comment">// 假装发送一条消息。</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">sendMessage</span>(<span class="hljs-params">text</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> &#123;<br>    <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">2000</span>);<br>  &#125;);<br>&#125;<br></code></pre></td></tr></table></div></figure>
</li>
<li><p><mark>避免冗余的 state</mark>。如果你能在渲染期间从组件的 props 或其现有的 state 变量中计算出一些信息，则不应将这些信息放入该组件的 state 中。</p>
<p><mark>不要在 state 中镜像 props</mark>：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-hsqzwzlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-hsqzwzlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Message</span>(<span class="hljs-params">&#123; messageColor &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> [color, setColor] = <span class="hljs-title function_">useState</span>(messageColor);   <br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>这里，一个 <code>color</code> state 变量被初始化为 <code>messageColor</code> 的 prop 值。这段代码的问题在于，如果父组件稍后传递不同的 <code>messageColor</code> 值（例如，将其从 <code>&#39;blue&#39;</code> 更改为 <code>&#39;red&#39;</code>），则 <code>color</code> state 变量将不会更新！ state 仅在第一次渲染期间初始化。</p>
<p>这就是为什么在 state 变量中，“镜像”一些 prop 属性会导致混淆的原因。相反，你要在代码中直接使用 <code>messageColor</code> 属性。如果你想给它起一个更短的名称，请使用常量：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-j8vkialqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-j8vkialqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Message</span>(<span class="hljs-params">&#123; messageColor &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> color = messageColor;<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>这种写法就不会与从父组件传递的属性失去同步。</p>
<p>只有当你 想要 忽略特定 props 属性的所有更新时，将 props “镜像”到 state 才有意义。按照惯例，prop 名称以 <code>initial</code> 或 <code>default</code> 开头，以阐明该 prop 的新值将被忽略：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-quuhq2lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-quuhq2lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Message</span>(<span class="hljs-params">&#123; initialColor &#125;</span>) &#123;<br>  <span class="hljs-comment">// 这个 `color` state 变量用于保存 `initialColor` 的 初始值。</span><br>  <span class="hljs-comment">// 对于 `initialColor` 属性的进一步更改将被忽略。</span><br>  <span class="hljs-keyword">const</span> [color, setColor] = <span class="hljs-title function_">useState</span>(initialColor)<br>&#125;<br></code></pre></td></tr></table></div></figure>
</li>
<li><p><mark>避免重复的 state</mark>。当同一数据在多个 state 变量之间或在多个嵌套对象中重复时，这会很难保持它们同步。应尽可能减少重复。</p>
<p>下面这个菜单列表组件可以让你在多种旅行小吃中选择一个：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-3j9oo3lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-3j9oo3lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">const</span> initialItems = [<br>  &#123; <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;pretzels&#x27;</span>, <span class="hljs-attr">id</span>: <span class="hljs-number">0</span> &#125;,<br>  &#123; <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;crispy seaweed&#x27;</span>, <span class="hljs-attr">id</span>: <span class="hljs-number">1</span> &#125;,<br>  &#123; <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;granola bar&#x27;</span>, <span class="hljs-attr">id</span>: <span class="hljs-number">2</span> &#125;,<br>];<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Menu</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [items, setItems] = <span class="hljs-title function_">useState</span>(initialItems);<br>  <span class="hljs-keyword">const</span> [selectedItem, setSelectedItem] = <span class="hljs-title function_">useState</span>(<br>    items[<span class="hljs-number">0</span>]<br>  );<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>What&#x27;s your travel snack?<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span></span><br><span class="language-xml">        &#123;items.map(item =&gt; (</span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;item.id&#125;</span>&gt;</span></span><br><span class="language-xml">            &#123;item.title&#125;</span><br><span class="language-xml">            &#123;&#x27; &#x27;&#125;</span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> &#123;</span><br><span class="language-xml">              setSelectedItem(item);</span><br><span class="language-xml">            &#125;&#125;&gt;Choose<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span><br><span class="language-xml">        ))&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>You picked &#123;selectedItem.title&#125;.<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<img src="image-20231108141335706.png" srcset="/img/loading.gif" lazyload alt="image-20231108141335706" style="zoom:50%;" />

<p>当前，它将所选元素作为对象存储在 <code>selectedItem</code> state 变量中。然而，这并不好：<code>selectedItem</code> 的内容与 <code>items</code> 列表中的某个项是同一个对象。 这意味着关于该项本身的信息在两个地方产生了重复。</p>
<p>为什么这是个问题？让我们使每个项目都可以编辑：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-lyvehjlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-lyvehjlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">const</span> initialItems = [<br>  &#123; <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;pretzels&#x27;</span>, <span class="hljs-attr">id</span>: <span class="hljs-number">0</span> &#125;,<br>  &#123; <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;crispy seaweed&#x27;</span>, <span class="hljs-attr">id</span>: <span class="hljs-number">1</span> &#125;,<br>  &#123; <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;granola bar&#x27;</span>, <span class="hljs-attr">id</span>: <span class="hljs-number">2</span> &#125;,<br>];<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Menu</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [items, setItems] = <span class="hljs-title function_">useState</span>(initialItems);<br>  <span class="hljs-keyword">const</span> [selectedItem, setSelectedItem] = <span class="hljs-title function_">useState</span>(<br>    items[<span class="hljs-number">0</span>]<br>  );<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleItemChange</span>(<span class="hljs-params">id, e</span>) &#123;<br>    <span class="hljs-title function_">setItems</span>(items.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> &#123;<br>      <span class="hljs-keyword">if</span> (item.<span class="hljs-property">id</span> === id) &#123;<br>        <span class="hljs-keyword">return</span> &#123;<br>          ...item,<br>          <span class="hljs-attr">title</span>: e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>,<br>        &#125;;<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> item;<br>      &#125;<br>    &#125;));<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>What&#x27;s your travel snack?<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span> </span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span></span><br><span class="language-xml">        &#123;items.map((item, index) =&gt; (</span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;item.id&#125;</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">input</span></span></span><br><span class="hljs-tag"><span class="language-xml">              <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;item.title&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">              <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> &#123;</span><br><span class="language-xml">                handleItemChange(item.id, e)</span><br><span class="language-xml">              &#125;&#125;</span><br><span class="language-xml">            /&gt;</span><br><span class="language-xml">            &#123;&#x27; &#x27;&#125;</span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> &#123;</span><br><span class="language-xml">              setSelectedItem(item);</span><br><span class="language-xml">            &#125;&#125;&gt;Choose<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span><br><span class="language-xml">        ))&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>You picked &#123;selectedItem.title&#125;.<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<img src="image-20231108141408780.png" srcset="/img/loading.gif" lazyload alt="image-20231108141408780" style="zoom:50%;" />

<p>如果你首先单击菜单上的“Choose” 然后 编辑它，输入会更新，但底部的标签不会反映编辑内容。 这是因为你有重复的 state，并且你忘记更新了 <code>selectedItem</code>。</p>
<p>尽管你也可以更新 <code>selectedItem</code>，但更简单的解决方法是消除重复项。在下面这个例子中，你将 <code>selectedId</code> 保存在 state 中，而不是在 <code>selectedItem</code> 对象中（它创建了一个与 <code>items</code> 内重复的对象），然后 通过搜索 <code>items</code> 数组中具有该 ID 的项，以此获取 <code>selectedItem</code>：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-getrf0lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-getrf0lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">const</span> initialItems = [<br>  &#123; <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;pretzels&#x27;</span>, <span class="hljs-attr">id</span>: <span class="hljs-number">0</span> &#125;,<br>  &#123; <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;crispy seaweed&#x27;</span>, <span class="hljs-attr">id</span>: <span class="hljs-number">1</span> &#125;,<br>  &#123; <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;granola bar&#x27;</span>, <span class="hljs-attr">id</span>: <span class="hljs-number">2</span> &#125;,<br>];<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Menu</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [items, setItems] = <span class="hljs-title function_">useState</span>(initialItems);<br>  <span class="hljs-keyword">const</span> [selectedId, setSelectedId] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br><br>  <span class="hljs-keyword">const</span> selectedItem = items.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span><br>    item.<span class="hljs-property">id</span> === selectedId<br>  );<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleItemChange</span>(<span class="hljs-params">id, e</span>) &#123;<br>    <span class="hljs-title function_">setItems</span>(items.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> &#123;<br>      <span class="hljs-keyword">if</span> (item.<span class="hljs-property">id</span> === id) &#123;<br>        <span class="hljs-keyword">return</span> &#123;<br>          ...item,<br>          <span class="hljs-attr">title</span>: e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>,<br>        &#125;;<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> item;<br>      &#125;<br>    &#125;));<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>What&#x27;s your travel snack?<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span></span><br><span class="language-xml">        &#123;items.map((item, index) =&gt; (</span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;item.id&#125;</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">input</span></span></span><br><span class="hljs-tag"><span class="language-xml">              <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;item.title&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">              <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> &#123;</span><br><span class="language-xml">                handleItemChange(item.id, e)</span><br><span class="language-xml">              &#125;&#125;</span><br><span class="language-xml">            /&gt;</span><br><span class="language-xml">            &#123;&#x27; &#x27;&#125;</span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> &#123;</span><br><span class="language-xml">              setSelectedId(item.id);</span><br><span class="language-xml">            &#125;&#125;&gt;Choose<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span><br><span class="language-xml">        ))&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>You picked &#123;selectedItem.title&#125;.<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<img src="image-20231108141513225.png" srcset="/img/loading.gif" lazyload alt="image-20231108141513225" style="zoom:50%;" />

<p>如果你编辑 selected 元素，下面的消息将立即更新。这是因为 <code>setItems</code> 会<mark>触发重新渲染</mark>，而 <code>items.find(...)</code> 会找到带有更新文本的元素。你不需要在 state 中保存 选定的元素，因为只有 选定的 ID 是必要的。其余的可以在渲染期间计算。</p>
</li>
<li><p><mark>避免深度嵌套的 state</mark>。深度分层的 state 更新起来不是很方便。如果可能的话，最好以扁平化方式构建 state。</p>
<p>一个由行星、大陆和国家组成的旅行计划。你可能会尝试使用嵌套对象和数组来构建它的 state：</p>
<p>place.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-80hhumlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-80hhumlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> initialTravelPlan = &#123;<br>  <span class="hljs-attr">id</span>: <span class="hljs-number">0</span>,<br>  <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;(Root)&#x27;</span>,<br>  <span class="hljs-attr">childPlaces</span>: [&#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Earth&#x27;</span>,<br>    <span class="hljs-attr">childPlaces</span>: [&#123;<br>      <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>,<br>      <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Africa&#x27;</span>,<br>      <span class="hljs-attr">childPlaces</span>: [&#123;<br>        <span class="hljs-attr">id</span>: <span class="hljs-number">3</span>,<br>        <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Botswana&#x27;</span>,<br>        <span class="hljs-attr">childPlaces</span>: []<br>      &#125;, &#123;<br>        <span class="hljs-attr">id</span>: <span class="hljs-number">4</span>,<br>        <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Egypt&#x27;</span>,<br>        <span class="hljs-attr">childPlaces</span>: []<br>      &#125;, &#123;<br>        <span class="hljs-attr">id</span>: <span class="hljs-number">5</span>,<br>        <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Kenya&#x27;</span>,<br>        <span class="hljs-attr">childPlaces</span>: []<br>      &#125;, &#123;<br>        <span class="hljs-attr">id</span>: <span class="hljs-number">6</span>,<br>        <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Madagascar&#x27;</span>,<br>        <span class="hljs-attr">childPlaces</span>: []<br>      &#125;, &#123;<br>        <span class="hljs-attr">id</span>: <span class="hljs-number">7</span>,<br>        <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Morocco&#x27;</span>,<br>        <span class="hljs-attr">childPlaces</span>: []<br>      &#125;, &#123;<br>        <span class="hljs-attr">id</span>: <span class="hljs-number">8</span>,<br>        <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Nigeria&#x27;</span>,<br>        <span class="hljs-attr">childPlaces</span>: []<br>      &#125;, &#123;<br>        <span class="hljs-attr">id</span>: <span class="hljs-number">9</span>,<br>        <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;South Africa&#x27;</span>,<br>        <span class="hljs-attr">childPlaces</span>: []<br>      &#125;]<br>    &#125;, &#123;<br>      <span class="hljs-attr">id</span>: <span class="hljs-number">10</span>,<br>      <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Americas&#x27;</span>,<br>      <span class="hljs-attr">childPlaces</span>: [&#123;<br>        <span class="hljs-attr">id</span>: <span class="hljs-number">11</span>,<br>        <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Argentina&#x27;</span>,<br>        <span class="hljs-attr">childPlaces</span>: []<br>      &#125;, &#123;<br>        <span class="hljs-attr">id</span>: <span class="hljs-number">12</span>,<br>        <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Brazil&#x27;</span>,<br>        <span class="hljs-attr">childPlaces</span>: []<br>      &#125;, &#123;<br>        <span class="hljs-attr">id</span>: <span class="hljs-number">13</span>,<br>        <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Barbados&#x27;</span>,<br>        <span class="hljs-attr">childPlaces</span>: []<br>      &#125;, &#123;<br>        <span class="hljs-attr">id</span>: <span class="hljs-number">14</span>,<br>        <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Canada&#x27;</span>,<br>        <span class="hljs-attr">childPlaces</span>: []<br>      &#125;, &#123;<br>        <span class="hljs-attr">id</span>: <span class="hljs-number">15</span>,<br>        <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Jamaica&#x27;</span>,<br>        <span class="hljs-attr">childPlaces</span>: []<br>      &#125;, &#123;<br>        <span class="hljs-attr">id</span>: <span class="hljs-number">16</span>,<br>        <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Mexico&#x27;</span>,<br>        <span class="hljs-attr">childPlaces</span>: []<br>      &#125;, &#123;<br>        <span class="hljs-attr">id</span>: <span class="hljs-number">17</span>,<br>        <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Trinidad and Tobago&#x27;</span>,<br>        <span class="hljs-attr">childPlaces</span>: []<br>      &#125;, &#123;<br>        <span class="hljs-attr">id</span>: <span class="hljs-number">18</span>,<br>        <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Venezuela&#x27;</span>,<br>        <span class="hljs-attr">childPlaces</span>: []<br>      &#125;]<br>    &#125;, &#123;<br>      <span class="hljs-attr">id</span>: <span class="hljs-number">19</span>,<br>      <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Asia&#x27;</span>,<br>      <span class="hljs-attr">childPlaces</span>: [&#123;<br>        <span class="hljs-attr">id</span>: <span class="hljs-number">20</span>,<br>        <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;China&#x27;</span>,<br>        <span class="hljs-attr">childPlaces</span>: []<br>      &#125;, &#123;<br>        <span class="hljs-attr">id</span>: <span class="hljs-number">21</span>,<br>        <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;India&#x27;</span>,<br>        <span class="hljs-attr">childPlaces</span>: []<br>      &#125;, &#123;<br>        <span class="hljs-attr">id</span>: <span class="hljs-number">22</span>,<br>        <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Singapore&#x27;</span>,<br>        <span class="hljs-attr">childPlaces</span>: []<br>      &#125;, &#123;<br>        <span class="hljs-attr">id</span>: <span class="hljs-number">23</span>,<br>        <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;South Korea&#x27;</span>,<br>        <span class="hljs-attr">childPlaces</span>: []<br>      &#125;, &#123;<br>        <span class="hljs-attr">id</span>: <span class="hljs-number">24</span>,<br>        <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Thailand&#x27;</span>,<br>        <span class="hljs-attr">childPlaces</span>: []<br>      &#125;, &#123;<br>        <span class="hljs-attr">id</span>: <span class="hljs-number">25</span>,<br>        <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Vietnam&#x27;</span>,<br>        <span class="hljs-attr">childPlaces</span>: []<br>      &#125;]<br>    &#125;, &#123;<br>      <span class="hljs-attr">id</span>: <span class="hljs-number">26</span>,<br>      <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Europe&#x27;</span>,<br>      <span class="hljs-attr">childPlaces</span>: [&#123;<br>        <span class="hljs-attr">id</span>: <span class="hljs-number">27</span>,<br>        <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Croatia&#x27;</span>,<br>        <span class="hljs-attr">childPlaces</span>: [],<br>      &#125;, &#123;<br>        <span class="hljs-attr">id</span>: <span class="hljs-number">28</span>,<br>        <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;France&#x27;</span>,<br>        <span class="hljs-attr">childPlaces</span>: [],<br>      &#125;, &#123;<br>        <span class="hljs-attr">id</span>: <span class="hljs-number">29</span>,<br>        <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Germany&#x27;</span>,<br>        <span class="hljs-attr">childPlaces</span>: [],<br>      &#125;, &#123;<br>        <span class="hljs-attr">id</span>: <span class="hljs-number">30</span>,<br>        <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Italy&#x27;</span>,<br>        <span class="hljs-attr">childPlaces</span>: [],<br>      &#125;, &#123;<br>        <span class="hljs-attr">id</span>: <span class="hljs-number">31</span>,<br>        <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Portugal&#x27;</span>,<br>        <span class="hljs-attr">childPlaces</span>: [],<br>      &#125;, &#123;<br>        <span class="hljs-attr">id</span>: <span class="hljs-number">32</span>,<br>        <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Spain&#x27;</span>,<br>        <span class="hljs-attr">childPlaces</span>: [],<br>      &#125;, &#123;<br>        <span class="hljs-attr">id</span>: <span class="hljs-number">33</span>,<br>        <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Turkey&#x27;</span>,<br>        <span class="hljs-attr">childPlaces</span>: [],<br>      &#125;]<br>    &#125;, &#123;<br>      <span class="hljs-attr">id</span>: <span class="hljs-number">34</span>,<br>      <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Oceania&#x27;</span>,<br>      <span class="hljs-attr">childPlaces</span>: [&#123;<br>        <span class="hljs-attr">id</span>: <span class="hljs-number">35</span>,<br>        <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Australia&#x27;</span>,<br>        <span class="hljs-attr">childPlaces</span>: [],<br>      &#125;, &#123;<br>        <span class="hljs-attr">id</span>: <span class="hljs-number">36</span>,<br>        <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Bora Bora (French Polynesia)&#x27;</span>,<br>        <span class="hljs-attr">childPlaces</span>: [],<br>      &#125;, &#123;<br>        <span class="hljs-attr">id</span>: <span class="hljs-number">37</span>,<br>        <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Easter Island (Chile)&#x27;</span>,<br>        <span class="hljs-attr">childPlaces</span>: [],<br>      &#125;, &#123;<br>        <span class="hljs-attr">id</span>: <span class="hljs-number">38</span>,<br>        <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Fiji&#x27;</span>,<br>        <span class="hljs-attr">childPlaces</span>: [],<br>      &#125;, &#123;<br>        <span class="hljs-attr">id</span>: <span class="hljs-number">39</span>,<br>        <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Hawaii (the USA)&#x27;</span>,<br>        <span class="hljs-attr">childPlaces</span>: [],<br>      &#125;, &#123;<br>        <span class="hljs-attr">id</span>: <span class="hljs-number">40</span>,<br>        <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;New Zealand&#x27;</span>,<br>        <span class="hljs-attr">childPlaces</span>: [],<br>      &#125;, &#123;<br>        <span class="hljs-attr">id</span>: <span class="hljs-number">41</span>,<br>        <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Vanuatu&#x27;</span>,<br>        <span class="hljs-attr">childPlaces</span>: [],<br>      &#125;]<br>    &#125;]<br>  &#125;, &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">42</span>,<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Moon&#x27;</span>,<br>    <span class="hljs-attr">childPlaces</span>: [&#123;<br>      <span class="hljs-attr">id</span>: <span class="hljs-number">43</span>,<br>      <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Rheita&#x27;</span>,<br>      <span class="hljs-attr">childPlaces</span>: []<br>    &#125;, &#123;<br>      <span class="hljs-attr">id</span>: <span class="hljs-number">44</span>,<br>      <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Piccolomini&#x27;</span>,<br>      <span class="hljs-attr">childPlaces</span>: []<br>    &#125;, &#123;<br>      <span class="hljs-attr">id</span>: <span class="hljs-number">45</span>,<br>      <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Tycho&#x27;</span>,<br>      <span class="hljs-attr">childPlaces</span>: []<br>    &#125;]<br>  &#125;, &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">46</span>,<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Mars&#x27;</span>,<br>    <span class="hljs-attr">childPlaces</span>: [&#123;<br>      <span class="hljs-attr">id</span>: <span class="hljs-number">47</span>,<br>      <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Corn Town&#x27;</span>,<br>      <span class="hljs-attr">childPlaces</span>: []<br>    &#125;, &#123;<br>      <span class="hljs-attr">id</span>: <span class="hljs-number">48</span>,<br>      <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Green Hill&#x27;</span>,<br>      <span class="hljs-attr">childPlaces</span>: []      <br>    &#125;]<br>  &#125;]<br>&#125;;<br></code></pre></td></tr></table></div></figure>

<p>App.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-ugwx3vlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-ugwx3vlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; initialTravelPlan &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./places.js&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">PlaceTree</span>(<span class="hljs-params">&#123; place &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> childPlaces = place.<span class="hljs-property">childPlaces</span>;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span></span><br><span class="language-xml">      &#123;place.title&#125;</span><br><span class="language-xml">      &#123;childPlaces.length &gt; 0 &amp;&amp; (</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">ol</span>&gt;</span></span><br><span class="language-xml">          &#123;childPlaces.map(place =&gt; (</span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">PlaceTree</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;place.id&#125;</span> <span class="hljs-attr">place</span>=<span class="hljs-string">&#123;place&#125;</span> /&gt;</span></span><br><span class="language-xml">          ))&#125;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">ol</span>&gt;</span></span><br><span class="language-xml">      )&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">TravelPlan</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [plan, setPlan] = <span class="hljs-title function_">useState</span>(initialTravelPlan);<br>  <span class="hljs-keyword">const</span> planets = plan.<span class="hljs-property">childPlaces</span>;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>Places to visit<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ol</span>&gt;</span></span><br><span class="language-xml">        &#123;planets.map(place =&gt; (</span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">PlaceTree</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;place.id&#125;</span> <span class="hljs-attr">place</span>&#123;<span class="hljs-attr">place</span>&#125; /&gt;</span></span><br><span class="language-xml">        ))&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">ol</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>假设你想添加一个按钮来删除一个你已经去过的地方。你会怎么做呢？<a target="_blank" rel="noopener" href="http://localhost:3000/learn/updating-objects-in-state#updating-a-nested-object">更新嵌套的 state</a> 需要从更改部分一直向上复制对象。删除一个深度嵌套的地点将涉及复制其整个父级地点链。这样的代码可能非常冗长。</p>
<p>如果 state 嵌套太深，难以轻松更新，可以考虑将其“扁平化”。 这里有一个方法可以重构上面这个数据。不同于树状结构，每个节点的 <code>place</code> 都是一个包含 其子节点 的数组，你可以让每个节点的 <code>place</code> 作为数组保存 其子节点的 ID。然后存储一个节点 ID 与相应节点的映射关系。</p>
<p>这个数据重组可能会让你想起看到一个数据库表：</p>
<p>place.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-9613jhlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-9613jhlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> initialTravelPlan = &#123;<br>  <span class="hljs-number">0</span>: &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">0</span>,<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;(Root)&#x27;</span>,<br>    <span class="hljs-attr">childIds</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">42</span>, <span class="hljs-number">46</span>],<br>  &#125;,<br>  <span class="hljs-number">1</span>: &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Earth&#x27;</span>,<br>    <span class="hljs-attr">childIds</span>: [<span class="hljs-number">2</span>, <span class="hljs-number">10</span>, <span class="hljs-number">19</span>, <span class="hljs-number">26</span>, <span class="hljs-number">34</span>]<br>  &#125;,<br>  <span class="hljs-number">2</span>: &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>,<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Africa&#x27;</span>,<br>    <span class="hljs-attr">childIds</span>: [<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span> , <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>]<br>  &#125;, <br>  <span class="hljs-number">3</span>: &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">3</span>,<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Botswana&#x27;</span>,<br>    <span class="hljs-attr">childIds</span>: []<br>  &#125;,<br>  <span class="hljs-number">4</span>: &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">4</span>,<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Egypt&#x27;</span>,<br>    <span class="hljs-attr">childIds</span>: []<br>  &#125;,<br>  <span class="hljs-number">5</span>: &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">5</span>,<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Kenya&#x27;</span>,<br>    <span class="hljs-attr">childIds</span>: []<br>  &#125;,<br>  <span class="hljs-number">6</span>: &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">6</span>,<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Madagascar&#x27;</span>,<br>    <span class="hljs-attr">childIds</span>: []<br>  &#125;, <br>  <span class="hljs-number">7</span>: &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">7</span>,<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Morocco&#x27;</span>,<br>    <span class="hljs-attr">childIds</span>: []<br>  &#125;,<br>  <span class="hljs-number">8</span>: &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">8</span>,<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Nigeria&#x27;</span>,<br>    <span class="hljs-attr">childIds</span>: []<br>  &#125;,<br>  <span class="hljs-number">9</span>: &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">9</span>,<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;South Africa&#x27;</span>,<br>    <span class="hljs-attr">childIds</span>: []<br>  &#125;,<br>  <span class="hljs-number">10</span>: &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">10</span>,<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Americas&#x27;</span>,<br>    <span class="hljs-attr">childIds</span>: [<span class="hljs-number">11</span>, <span class="hljs-number">12</span>, <span class="hljs-number">13</span>, <span class="hljs-number">14</span>, <span class="hljs-number">15</span>, <span class="hljs-number">16</span>, <span class="hljs-number">17</span>, <span class="hljs-number">18</span>],   <br>  &#125;,<br>  <span class="hljs-number">11</span>: &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">11</span>,<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Argentina&#x27;</span>,<br>    <span class="hljs-attr">childIds</span>: []<br>  &#125;,<br>  <span class="hljs-number">12</span>: &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">12</span>,<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Brazil&#x27;</span>,<br>    <span class="hljs-attr">childIds</span>: []<br>  &#125;,<br>  <span class="hljs-number">13</span>: &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">13</span>,<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Barbados&#x27;</span>,<br>    <span class="hljs-attr">childIds</span>: []<br>  &#125;, <br>  <span class="hljs-number">14</span>: &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">14</span>,<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Canada&#x27;</span>,<br>    <span class="hljs-attr">childIds</span>: []<br>  &#125;,<br>  <span class="hljs-number">15</span>: &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">15</span>,<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Jamaica&#x27;</span>,<br>    <span class="hljs-attr">childIds</span>: []<br>  &#125;,<br>  <span class="hljs-number">16</span>: &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">16</span>,<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Mexico&#x27;</span>,<br>    <span class="hljs-attr">childIds</span>: []<br>  &#125;,<br>  <span class="hljs-number">17</span>: &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">17</span>,<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Trinidad and Tobago&#x27;</span>,<br>    <span class="hljs-attr">childIds</span>: []<br>  &#125;,<br>  <span class="hljs-number">18</span>: &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">18</span>,<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Venezuela&#x27;</span>,<br>    <span class="hljs-attr">childIds</span>: []<br>  &#125;,<br>  <span class="hljs-number">19</span>: &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">19</span>,<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Asia&#x27;</span>,<br>    <span class="hljs-attr">childIds</span>: [<span class="hljs-number">20</span>, <span class="hljs-number">21</span>, <span class="hljs-number">22</span>, <span class="hljs-number">23</span>, <span class="hljs-number">24</span>, <span class="hljs-number">25</span>],   <br>  &#125;,<br>  <span class="hljs-number">20</span>: &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">20</span>,<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;China&#x27;</span>,<br>    <span class="hljs-attr">childIds</span>: []<br>  &#125;,<br>  <span class="hljs-number">21</span>: &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">21</span>,<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;India&#x27;</span>,<br>    <span class="hljs-attr">childIds</span>: []<br>  &#125;,<br>  <span class="hljs-number">22</span>: &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">22</span>,<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Singapore&#x27;</span>,<br>    <span class="hljs-attr">childIds</span>: []<br>  &#125;,<br>  <span class="hljs-number">23</span>: &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">23</span>,<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;South Korea&#x27;</span>,<br>    <span class="hljs-attr">childIds</span>: []<br>  &#125;,<br>  <span class="hljs-number">24</span>: &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">24</span>,<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Thailand&#x27;</span>,<br>    <span class="hljs-attr">childIds</span>: []<br>  &#125;,<br>  <span class="hljs-number">25</span>: &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">25</span>,<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Vietnam&#x27;</span>,<br>    <span class="hljs-attr">childIds</span>: []<br>  &#125;,<br>  <span class="hljs-number">26</span>: &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">26</span>,<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Europe&#x27;</span>,<br>    <span class="hljs-attr">childIds</span>: [<span class="hljs-number">27</span>, <span class="hljs-number">28</span>, <span class="hljs-number">29</span>, <span class="hljs-number">30</span>, <span class="hljs-number">31</span>, <span class="hljs-number">32</span>, <span class="hljs-number">33</span>],   <br>  &#125;,<br>  <span class="hljs-number">27</span>: &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">27</span>,<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Croatia&#x27;</span>,<br>    <span class="hljs-attr">childIds</span>: []<br>  &#125;,<br>  <span class="hljs-number">28</span>: &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">28</span>,<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;France&#x27;</span>,<br>    <span class="hljs-attr">childIds</span>: []<br>  &#125;,<br>  <span class="hljs-number">29</span>: &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">29</span>,<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Germany&#x27;</span>,<br>    <span class="hljs-attr">childIds</span>: []<br>  &#125;,<br>  <span class="hljs-number">30</span>: &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">30</span>,<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Italy&#x27;</span>,<br>    <span class="hljs-attr">childIds</span>: []<br>  &#125;,<br>  <span class="hljs-number">31</span>: &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">31</span>,<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Portugal&#x27;</span>,<br>    <span class="hljs-attr">childIds</span>: []<br>  &#125;,<br>  <span class="hljs-number">32</span>: &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">32</span>,<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Spain&#x27;</span>,<br>    <span class="hljs-attr">childIds</span>: []<br>  &#125;,<br>  <span class="hljs-number">33</span>: &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">33</span>,<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Turkey&#x27;</span>,<br>    <span class="hljs-attr">childIds</span>: []<br>  &#125;,<br>  <span class="hljs-number">34</span>: &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">34</span>,<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Oceania&#x27;</span>,<br>    <span class="hljs-attr">childIds</span>: [<span class="hljs-number">35</span>, <span class="hljs-number">36</span>, <span class="hljs-number">37</span>, <span class="hljs-number">38</span>, <span class="hljs-number">39</span>, <span class="hljs-number">40</span>, <span class="hljs-number">41</span>],   <br>  &#125;,<br>  <span class="hljs-number">35</span>: &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">35</span>,<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Australia&#x27;</span>,<br>    <span class="hljs-attr">childIds</span>: []<br>  &#125;,<br>  <span class="hljs-number">36</span>: &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">36</span>,<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Bora Bora (French Polynesia)&#x27;</span>,<br>    <span class="hljs-attr">childIds</span>: []<br>  &#125;,<br>  <span class="hljs-number">37</span>: &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">37</span>,<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Easter Island (Chile)&#x27;</span>,<br>    <span class="hljs-attr">childIds</span>: []<br>  &#125;,<br>  <span class="hljs-number">38</span>: &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">38</span>,<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Fiji&#x27;</span>,<br>    <span class="hljs-attr">childIds</span>: []<br>  &#125;,<br>  <span class="hljs-number">39</span>: &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">40</span>,<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Hawaii (the USA)&#x27;</span>,<br>    <span class="hljs-attr">childIds</span>: []<br>  &#125;,<br>  <span class="hljs-number">40</span>: &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">40</span>,<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;New Zealand&#x27;</span>,<br>    <span class="hljs-attr">childIds</span>: []<br>  &#125;,<br>  <span class="hljs-number">41</span>: &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">41</span>,<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Vanuatu&#x27;</span>,<br>    <span class="hljs-attr">childIds</span>: []<br>  &#125;,<br>  <span class="hljs-number">42</span>: &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">42</span>,<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Moon&#x27;</span>,<br>    <span class="hljs-attr">childIds</span>: [<span class="hljs-number">43</span>, <span class="hljs-number">44</span>, <span class="hljs-number">45</span>]<br>  &#125;,<br>  <span class="hljs-number">43</span>: &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">43</span>,<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Rheita&#x27;</span>,<br>    <span class="hljs-attr">childIds</span>: []<br>  &#125;,<br>  <span class="hljs-number">44</span>: &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">44</span>,<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Piccolomini&#x27;</span>,<br>    <span class="hljs-attr">childIds</span>: []<br>  &#125;,<br>  <span class="hljs-number">45</span>: &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">45</span>,<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Tycho&#x27;</span>,<br>    <span class="hljs-attr">childIds</span>: []<br>  &#125;,<br>  <span class="hljs-number">46</span>: &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">46</span>,<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Mars&#x27;</span>,<br>    <span class="hljs-attr">childIds</span>: [<span class="hljs-number">47</span>, <span class="hljs-number">48</span>]<br>  &#125;,<br>  <span class="hljs-number">47</span>: &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">47</span>,<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Corn Town&#x27;</span>,<br>    <span class="hljs-attr">childIds</span>: []<br>  &#125;,<br>  <span class="hljs-number">48</span>: &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">48</span>,<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Green Hill&#x27;</span>,<br>    <span class="hljs-attr">childIds</span>: []<br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></div></figure>

<p>App.jsx：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-2u1qh6lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-2u1qh6lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; initialTravelPlan &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./places.js&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">PlaceTree</span>(<span class="hljs-params">&#123; id, placesById &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> place = placesById[id];<br>  <span class="hljs-keyword">const</span> childIds = place.<span class="hljs-property">childIds</span>;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span></span><br><span class="language-xml">      &#123;place.title&#125;</span><br><span class="language-xml">      &#123;childIds.length &gt; 0 &amp;&amp; (</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">ol</span>&gt;</span></span><br><span class="language-xml">          &#123;childIds.map(childId =&gt; (</span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">PlaceTree</span></span></span><br><span class="hljs-tag"><span class="language-xml">              <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;childId&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">              <span class="hljs-attr">id</span>=<span class="hljs-string">&#123;childId&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">              <span class="hljs-attr">placesById</span>=<span class="hljs-string">&#123;placesById&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">            /&gt;</span></span><br><span class="language-xml">          ))&#125;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">ol</span>&gt;</span></span><br><span class="language-xml">      )&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">TravelPlan</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [plan, setPlan] = <span class="hljs-title function_">useState</span>(initialTravelPlan);<br>  <span class="hljs-keyword">const</span> root = plan[<span class="hljs-number">0</span>];<br>  <span class="hljs-keyword">const</span> planetIds = root.<span class="hljs-property">childIds</span>;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>Places to visit<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ol</span>&gt;</span></span><br><span class="language-xml">        &#123;planetIds.map(id =&gt; (</span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">PlaceTree</span></span></span><br><span class="hljs-tag"><span class="language-xml">            <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;id&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">            <span class="hljs-attr">id</span>=<span class="hljs-string">&#123;id&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">            <span class="hljs-attr">placesById</span>=<span class="hljs-string">&#123;plan&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          /&gt;</span></span><br><span class="language-xml">        ))&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">ol</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p><mark>现在 state 已经“扁平化”（也称为“规范化”），更新嵌套项会变得更加容易，并且有助于确保在嵌套对象的不同部分中没有重复。</mark></p>
<p>现在要删除一个地点，您只需要更新两个 state 级别：</p>
<ul>
<li>其 <strong>父级</strong> 地点的更新版本应该从其 <code>childIds</code> 数组中排除已删除的 ID。</li>
<li>其根级“表”对象的更新版本应包括父级地点的更新版本。</li>
</ul>
<p>有时候，你也可以通过将一些嵌套 state 移动到子组件中来减少 state 的嵌套。这对于不需要保存的短暂 UI 状态非常有效，比如一个选项是否被悬停。</p>
</li>
</ol>
<p>这些原则背后的目标是 使 state 易于更新而不引入错误。</p>
<h2 id="3-在组件间共享状态"><a href="#3-在组件间共享状态" class="headerlink" title="3.在组件间共享状态"></a>3.在组件间共享状态</h2><p>有时候，你希望两个组件的状态始终同步更改。要实现这一点，可以将相关 state 从这两个组件上移除，并把 state 放到它们的公共父级，再通过 props 将 state 传递给这两个组件。这被称为“<mark>状态提升</mark>”。</p>
<p>父组件 <code>Accordion</code> 渲染了 2 个独立的 <code>Panel</code> 组件。</p>
<p><code>Accordion</code></p>
<ul>
<li><code>Panel</code></li>
<li><code>Panel</code></li>
</ul>
<p>每个 <code>Panel</code> 组件都有一个布尔值 <code>isActive</code>，用于控制其内容是否可见：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-su30wylqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-su30wylqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Panel</span>(<span class="hljs-params">&#123; title, children &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> [isActive, setIsActive] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">section</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;panel&quot;</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>&#123;title&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span></span><br><span class="language-xml">      &#123;isActive ? (</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>&#123;children&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml">      ) : (</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> setIsActive(true)&#125;&gt;</span><br><span class="language-xml">          显示</span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      )&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Accordion</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>哈萨克斯坦，阿拉木图<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Panel</span> <span class="hljs-attr">title</span>=<span class="hljs-string">&quot;关于&quot;</span>&gt;</span></span><br><span class="language-xml">        阿拉木图人口约200万，是哈萨克斯坦最大的城市。它在 1929 年到 1997 年间都是首都。</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">Panel</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Panel</span> <span class="hljs-attr">title</span>=<span class="hljs-string">&quot;词源&quot;</span>&gt;</span></span><br><span class="language-xml">        这个名字来自于 <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;kk-KZ&quot;</span>&gt;</span>алма<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>，哈萨克语中“苹果”的意思，经常被翻译成“苹果之乡”。事实上，阿拉木图的周边地区被认为是苹果的发源地，<span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;la&quot;</span>&gt;</span>Malus sieversii<span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> 被认为是现今苹果的祖先。</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">Panel</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>点击其中一个面板中的按钮并不会影响另外一个，他们是独立的。</p>
<img src="image-20231109094105013.png" srcset="/img/loading.gif" lazyload alt="image-20231109094105013" style="zoom:50%;" />

<img src="image-20231109094146988.png" srcset="/img/loading.gif" lazyload alt="image-20231109094146988" style="zoom:50%;" />

<p>**<mark>假设现在您想改变这种行为，以便在任何时候只展开一个面板</mark>**。在这种设计下，展开第 2 个面板应会折叠第 1 个面板。您该如何做到这一点呢？”</p>
<p>要协调好这两个面板，我们需要分 3 步将状态“提升”到他们的父组件中。</p>
<ol>
<li><p>从子组件中 <strong>移除</strong> state：先从 <code>Panel</code> 组件中 <strong>删除下面这一行</strong>：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-bcee2rlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-bcee2rlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> [isActive, setIsActive] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);<br></code></pre></td></tr></table></div></figure>

<p>然后，把 <code>isActive</code> 加入 <code>Panel</code> 组件的 <code>props</code> 中：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-vk8tdolqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-vk8tdolqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Panel</span>(<span class="hljs-params">&#123; title, children, isActive &#125;</span>) &#123;<br></code></pre></td></tr></table></div></figure>

<p>现在 <code>Panel</code> 的父组件就可以通过 <a target="_blank" rel="noopener" href="http://localhost:3000/learn/passing-props-to-a-component">向下传递 prop</a> 来 <strong>控制</strong> <code>isActive</code>。但相反地，<code>Panel</code> 组件对 <code>isActive</code> 的值 <strong>没有控制权</strong> —— 现在完全由父组件决定！</p>
</li>
<li><p>父组件 <strong>传递</strong> 硬编码数据：为了实现状态提升，必须定位到你想协调的 <strong>两个</strong> 子组件最近的公共父组件。在这个例子中，公共父组件是 <code>Accordion</code>。因为它位于两个面板之上，可以控制它们的 props，所以它将成为当前激活面板的“控制之源”。通过 <code>Accordion</code> 组件将硬编码值 <code>isActive</code>（例如 <code>true</code> ）传递给两个面板：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-btaatxlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-btaatxlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Accordion</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>哈萨克斯坦，阿拉木图<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Panel</span> <span class="hljs-attr">title</span>=<span class="hljs-string">&quot;关于&quot;</span> <span class="hljs-attr">isActive</span>=<span class="hljs-string">&#123;true&#125;</span>&gt;</span></span><br><span class="language-xml">        阿拉木图人口约200万，是哈萨克斯坦最大的城市。它在 1929 年到 1997 年间都是首都。</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">Panel</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Panel</span> <span class="hljs-attr">title</span>=<span class="hljs-string">&quot;词源&quot;</span> <span class="hljs-attr">isActive</span>=<span class="hljs-string">&#123;true&#125;</span>&gt;</span></span><br><span class="language-xml">        这个名字来自于 <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;kk-KZ&quot;</span>&gt;</span>алма<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>，哈萨克语中“苹果”的意思，经常被翻译成“苹果之乡”。事实上，阿拉木图的周边地区被认为是苹果的发源地，<span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;la&quot;</span>&gt;</span>Malus sieversii<span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> 被认为是现今苹果的祖先。</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">Panel</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Panel</span>(<span class="hljs-params">&#123; title, children, isActive &#125;</span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">section</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;panel&quot;</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>&#123;title&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span></span><br><span class="language-xml">      &#123;isActive ? (</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>&#123;children&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml">      ) : (</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> setIsActive(true)&#125;&gt;</span><br><span class="language-xml">          显示</span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      )&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>
</li>
<li><p><mark>为共同的父组件添加 state ，并将其与事件处理函数一起向下传递</mark>：状态提升通常会改变原状态的数据存储类型。</p>
<p>在这个例子中，一次只能激活一个面板。这意味着 <code>Accordion</code> 这个父组件需要记录 <strong>哪个</strong> 面板是被激活的面板。我们可以用数字作为当前被激活 <code>Panel</code> 的索引，而不是 <code>boolean</code> 值：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-tgi18rlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-tgi18rlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> [activeIndex, setActiveIndex] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br></code></pre></td></tr></table></div></figure>

<p>当 <code>activeIndex</code> 为 <code>0</code> 时，激活第一个面板，为 <code>1</code> 时，激活第二个面板。</p>
<p>在任意一个 <code>Panel</code> 中点击“显示”按钮都需要更改 <code>Accordion</code> 中的激活索引值。 <code>Panel</code> 中无法直接设置状态 <code>activeIndex</code> 的值，因为该状态是在 <code>Accordion</code> 组件内部定义的。 <code>Accordion</code> 组件需要 <strong>显式允许</strong> <code>Panel</code> 组件通过 <a target="_blank" rel="noopener" href="http://localhost:3000/learn/responding-to-events#passing-event-handlers-as-props">将事件处理程序作为 prop 向下传递</a> 来更改其状态：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-6hgadllqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-6hgadllqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs jsx">&lt;&gt;<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Panel</span></span></span><br><span class="hljs-tag"><span class="language-xml">    <span class="hljs-attr">isActive</span>=<span class="hljs-string">&#123;activeIndex</span> === <span class="hljs-string">0&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">    <span class="hljs-attr">onShow</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> setActiveIndex(0)&#125;</span><br><span class="language-xml">  &gt;</span><br><span class="language-xml">    ...</span><br><span class="language-xml">  <span class="hljs-tag">&lt;/<span class="hljs-name">Panel</span>&gt;</span></span><br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Panel</span></span></span><br><span class="hljs-tag"><span class="language-xml">    <span class="hljs-attr">isActive</span>=<span class="hljs-string">&#123;activeIndex</span> === <span class="hljs-string">1&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">    <span class="hljs-attr">onShow</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> setActiveIndex(1)&#125;</span><br><span class="language-xml">  &gt;</span><br><span class="language-xml">    ...</span><br><span class="language-xml">  <span class="hljs-tag">&lt;/<span class="hljs-name">Panel</span>&gt;</span></span><br>&lt;/&gt;<br></code></pre></td></tr></table></div></figure>

<p>现在 <code>Panel</code> 组件中的 <code>&lt;button&gt;</code> 将使用 <code>onShow</code> 这个属性作为其点击事件的处理程序：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-uamlmslqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-uamlmslqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Accordion</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [activeIndex, setActiveIndex] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>哈萨克斯坦，阿拉木图<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Panel</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">title</span>=<span class="hljs-string">&quot;关于&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">isActive</span>=<span class="hljs-string">&#123;activeIndex</span> === <span class="hljs-string">0&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">onShow</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> setActiveIndex(0)&#125;</span><br><span class="language-xml">      &gt;</span><br><span class="language-xml">        阿拉木图人口约200万，是哈萨克斯坦最大的城市。它在 1929 年到 1997 年间都是首都。</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">Panel</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Panel</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">title</span>=<span class="hljs-string">&quot;词源&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">isActive</span>=<span class="hljs-string">&#123;activeIndex</span> === <span class="hljs-string">1&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">onShow</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> setActiveIndex(1)&#125;</span><br><span class="language-xml">      &gt;</span><br><span class="language-xml">        这个名字来自于 <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;kk-KZ&quot;</span>&gt;</span>алма<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>，哈萨克语中“苹果”的意思，经常被翻译成“苹果之乡”。事实上，阿拉木图的周边地区被认为是苹果的发源地，<span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;la&quot;</span>&gt;</span>Malus sieversii<span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> 被认为是现今苹果的祖先。</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">Panel</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Panel</span>(<span class="hljs-params">&#123;</span><br><span class="hljs-params">  title,</span><br><span class="hljs-params">  children,</span><br><span class="hljs-params">  isActive,</span><br><span class="hljs-params">  onShow</span><br><span class="hljs-params">&#125;</span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">section</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;panel&quot;</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>&#123;title&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span></span><br><span class="language-xml">      &#123;isActive ? (</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>&#123;children&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml">      ) : (</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;onShow&#125;</span>&gt;</span></span><br><span class="language-xml">          显示</span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      )&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure></li>
</ol>
<p>这样，<code>Accordion</code> 组件就可以控制 2 个 <code>Panel</code> 组件，保证同一时间只能展开一个。我们就完成了对状态的提升！将状态移至公共父组件中可以让你更好的管理这两个面板。使用激活索引值代替之前的 <code>是否显示</code> 标识确保了一次只能激活一个面板。而通过向下传递事件处理函数可以让子组件修改父组件的状态。</p>
<img src="image-20231109103148744.png" srcset="/img/loading.gif" lazyload alt="image-20231109103148744" style="zoom:50%;" />

<p><mark>受控组件和非受控组件</mark>：通常我们把包含“不受控制”状态的组件称为“非受控组件”。例如，最开始带有 <code>isActive</code> 状态变量的 <code>Panel</code> 组件就是不受控制的，因为其父组件无法控制面板的激活状态。</p>
<p>相反，当组件中的重要信息是由 <code>props</code> 而不是其自身状态驱动时，就可以认为该组件是“受控组件”。这就允许父组件完全指定其行为。最后带有 <code>isActive</code> 属性的 <code>Panel</code> 组件是由 <code>Accordion</code> 组件控制的。</p>
<p>非受控组件通常很简单，因为它们不需要太多配置。但是当你想把它们组合在一起使用时，就不那么灵活了。受控组件具有最大的灵活性，但它们需要父组件使用 <code>props</code> 对其进行配置。</p>
<p>在实践中，“受控”和“非受控”并不是严格的技术术语——通常每个组件都同时拥有内部状态和 <code>props</code>。然而，这对于组件该如何设计和提供什么样功能的讨论是有帮助的。</p>
<p>当编写一个组件时，你应该考虑哪些信息应该受控制（通过 <code>props</code>），哪些信息不应该受控制（通过 <code>state</code>）。当然，你可以随时改变主意并重构代码。</p>
<hr>
<p><mark>每个状态都对应唯一的数据源 </mark>：在 <code>React</code> 应用中，很多组件都有自己的状态。一些状态可能“活跃”在叶子组件（树形结构最底层的组件）附近，例如输入框。另一些状态可能在应用程序顶部“活动”。例如，客户端路由库也是通过将当前路由存储在 <code>React</code> 状态中，利用 <code>props</code> 将状态层层传递下去来实现的！</p>
<p><strong>对于每个独特的状态，都应该存在且只存在于一个指定的组件中作为 state</strong>。这一原则也被称为拥有 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Single_source_of_truth">“可信单一数据源”</a>。它并不意味着所有状态都存在一个地方——对每个状态来说，都需要一个特定的组件来保存这些状态信息。你应该 <strong>将状态提升</strong> 到公共父级，或 <strong>将状态传递</strong> 到需要它的子级中，而不是在组件之间复制共享的状态。</p>
<p>你的应用会随着你的操作而变化。当你将状态上下移动时，你依然会想要确定每个状态在哪里“活跃”。这都是过程的一部分！</p>
<h2 id="4-对state进行保留和重置"><a href="#4-对state进行保留和重置" class="headerlink" title="4.对state进行保留和重置"></a>4.对state进行保留和重置</h2><p>各个组件的 state 是各自独立的。根据组件在 UI 树中的位置，React 可以跟踪哪些 state 属于哪个组件。你可以控制在重新渲染过程中何时对 state 进行保留和重置。</p>
<p><mark>状态与渲染树中的位置相关</mark>：React 会为 UI 中的组件结构构建 <a target="_blank" rel="noopener" href="http://localhost:3000/learn/understanding-your-ui-as-a-tree#the-render-tree">渲染树</a>。当向一个组件添加状态时，那么可能会认为状态“存在”在组件内。但实际上，状态是由 React 保存的。React 通过组件在渲染树中的位置将它保存的每个状态与正确的组件关联起来。</p>
<p>下面的例子中只有一个 <code>&lt;Counter /&gt;</code> JSX 标签，但它会在两个不同的位置渲染：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-30t112lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-30t112lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> counter = <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Counter</span> /&gt;</span></span>;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      &#123;counter&#125;</span><br><span class="language-xml">      &#123;counter&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [score, setScore] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">const</span> [hover, setHover] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);<br><br>  <span class="hljs-keyword">let</span> className = <span class="hljs-string">&#x27;counter&#x27;</span>;<br>  <span class="hljs-keyword">if</span> (hover) &#123;<br>    className += <span class="hljs-string">&#x27; hover&#x27;</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">className</span>=<span class="hljs-string">&#123;className&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">onPointerEnter</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> setHover(true)&#125;</span><br><span class="language-xml">      onPointerLeave=&#123;() =&gt; setHover(false)&#125;</span><br><span class="language-xml">    &gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>&#123;score&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> setScore(score + 1)&#125;&gt;</span><br><span class="language-xml">        加一</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<img src="image-20231109111059717.png" srcset="/img/loading.gif" lazyload alt="image-20231109111059717" style="zoom:50%;" />

<p>React树：</p>
<img src="image-20231109111139160.png" srcset="/img/loading.gif" lazyload alt="image-20231109111139160" style="zoom:50%;" />

<p><strong><mark>这是两个独立的 counter，因为它们在树中被渲染在了各自的位置。</mark></strong> 一般情况下你不用去考虑这些位置来使用 React，但知道它们是如何工作会很有用。</p>
<p>在 React 中，屏幕中的每个组件都有完全独立的 state。举个例子，当你并排渲染两个 <code>Counter</code> 组件时，它们都会拥有各自独立的 <code>score</code> 和 <code>hover</code> state。</p>
<p>当一个计数器被更新时，只有该组件的状态会被更新：</p>
<img src="image-20231109111343125.png" srcset="/img/loading.gif" lazyload alt="image-20231109111343125" style="zoom:50%;" />

<p><mark>只有当在树中相同的位置渲染相同的组件时，React 才会一直保留着组件的 state</mark>。想要验证这一点，可以将两个计数器的值递增，取消勾选 “渲染第二个计数器” 复选框，然后再次勾选它：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-k686t2lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-k686t2lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [showB, setShowB] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>);<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Counter</span> /&gt;</span></span><br><span class="language-xml">      &#123;showB &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">Counter</span> /&gt;</span>&#125; </span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">input</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;checkbox&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">checked</span>=<span class="hljs-string">&#123;showB&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> &#123;</span><br><span class="language-xml">            setShowB(e.target.checked)</span><br><span class="language-xml">          &#125;&#125;</span><br><span class="language-xml">        /&gt;</span><br><span class="language-xml">        渲染第二个计数器</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [score, setScore] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">const</span> [hover, setHover] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);<br><br>  <span class="hljs-keyword">let</span> className = <span class="hljs-string">&#x27;counter&#x27;</span>;<br>  <span class="hljs-keyword">if</span> (hover) &#123;<br>    className += <span class="hljs-string">&#x27; hover&#x27;</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">className</span>=<span class="hljs-string">&#123;className&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">onPointerEnter</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> setHover(true)&#125;</span><br><span class="language-xml">      onPointerLeave=&#123;() =&gt; setHover(false)&#125;</span><br><span class="language-xml">    &gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>&#123;score&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> setScore(score + 1)&#125;&gt;</span><br><span class="language-xml">        加一</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<img src="counter.gif" srcset="/img/loading.gif" lazyload alt="counter" style="zoom:50%;" />

<p>当你停止渲染第二个计数器的那一刻，它的 state 完全消失了。这是因为 <mark>React 在移除一个组件时，也会销毁它的 state</mark>。</p>
<p>当你重新勾选“渲染第二个计数器”复选框时，另一个计数器及其 state 将从头开始初始化（<code>score = 0</code>）并被添加到 DOM 中。</p>
<p><strong><mark>只要一个组件还被渲染在 UI 树的相同位置，React 就会保留它的 state</mark>。</strong> 如果它被移除，或者一个不同的组件被渲染在相同的位置，那么 React 就会丢掉它的 state。</p>
<hr>
<p><mark>相同位置的相同组件会使得 state 被保留下来 </mark>：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-qwga1jlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-qwga1jlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [isFancy, setIsFancy] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      &#123;isFancy ? (</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Counter</span> <span class="hljs-attr">isFancy</span>=<span class="hljs-string">&#123;true&#125;</span> /&gt;</span> </span><br><span class="language-xml">      ) : (</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Counter</span> <span class="hljs-attr">isFancy</span>=<span class="hljs-string">&#123;false&#125;</span> /&gt;</span> </span><br><span class="language-xml">      )&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">input</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;checkbox&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">checked</span>=<span class="hljs-string">&#123;isFancy&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> &#123;</span><br><span class="language-xml">            setIsFancy(e.target.checked)</span><br><span class="language-xml">          &#125;&#125;</span><br><span class="language-xml">        /&gt;</span><br><span class="language-xml">        使用好看的样式</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params">&#123; isFancy &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> [score, setScore] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">const</span> [hover, setHover] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);<br><br>  <span class="hljs-keyword">let</span> className = <span class="hljs-string">&#x27;counter&#x27;</span>;<br>  <span class="hljs-keyword">if</span> (hover) &#123;<br>    className += <span class="hljs-string">&#x27; hover&#x27;</span>;<br>  &#125;<br>  <span class="hljs-keyword">if</span> (isFancy) &#123;<br>    className += <span class="hljs-string">&#x27; fancy&#x27;</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">className</span>=<span class="hljs-string">&#123;className&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">onPointerEnter</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> setHover(true)&#125;</span><br><span class="language-xml">      onPointerLeave=&#123;() =&gt; setHover(false)&#125;</span><br><span class="language-xml">    &gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>&#123;score&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> setScore(score + 1)&#125;&gt;</span><br><span class="language-xml">        加一</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<img src="fancy1.gif" srcset="/img/loading.gif" lazyload alt="fancy1" style="zoom:50%;" />

<p>当你勾选或清空复选框的时候，计数器 state 并没有被重置。不管 <code>isFancy</code> 是 <code>true</code> 还是 <code>false</code>，根组件 <code>App</code> 返回的 <code>div</code> 的第一个子组件都是 <code>&lt;Counter /&gt;</code>：</p>
<img src="image-20231109135330938.png" srcset="/img/loading.gif" lazyload alt="image-20231109135330938" style="zoom:50%;" />

<p>更新 <code>App</code> 的状态不会重置 <code>Counter</code>，因为 <code>Counter</code> 始终保持在同一位置。<mark>它是位于相同位置的相同组件，所以对 React 来说，它是同一个计数器。</mark></p>
<p><mark>记住 对 React 来说重要的是组件在 UI 树中的位置,而不是在 JSX 中的位置！ </mark></p>
<p>这个组件在 <code>if</code> 内外有两个<code>return</code> 语句，它们带有不同的 <code>&lt;Counter /&gt;</code> JSX 标签：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-uxlcr6lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-uxlcr6lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [isFancy, setIsFancy] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);<br>  <span class="hljs-keyword">if</span> (isFancy) &#123;<br>    <span class="hljs-keyword">return</span> (<br>      <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Counter</span> <span class="hljs-attr">isFancy</span>=<span class="hljs-string">&#123;true&#125;</span> /&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">input</span></span></span><br><span class="hljs-tag"><span class="language-xml">            <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;checkbox&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">            <span class="hljs-attr">checked</span>=<span class="hljs-string">&#123;isFancy&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">            <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> &#123;</span><br><span class="language-xml">              setIsFancy(e.target.checked)</span><br><span class="language-xml">            &#125;&#125;</span><br><span class="language-xml">          /&gt;</span><br><span class="language-xml">          使用好看的样式</span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>    );<br>  &#125;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Counter</span> <span class="hljs-attr">isFancy</span>=<span class="hljs-string">&#123;false&#125;</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">input</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;checkbox&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">checked</span>=<span class="hljs-string">&#123;isFancy&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> &#123;</span><br><span class="language-xml">            setIsFancy(e.target.checked)</span><br><span class="language-xml">          &#125;&#125;</span><br><span class="language-xml">        /&gt;</span><br><span class="language-xml">        使用好看的样式</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params">&#123; isFancy &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> [score, setScore] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">const</span> [hover, setHover] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);<br><br>  <span class="hljs-keyword">let</span> className = <span class="hljs-string">&#x27;counter&#x27;</span>;<br>  <span class="hljs-keyword">if</span> (hover) &#123;<br>    className += <span class="hljs-string">&#x27; hover&#x27;</span>;<br>  &#125;<br>  <span class="hljs-keyword">if</span> (isFancy) &#123;<br>    className += <span class="hljs-string">&#x27; fancy&#x27;</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">className</span>=<span class="hljs-string">&#123;className&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">onPointerEnter</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> setHover(true)&#125;</span><br><span class="language-xml">      onPointerLeave=&#123;() =&gt; setHover(false)&#125;</span><br><span class="language-xml">    &gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>&#123;score&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> setScore(score + 1)&#125;&gt;</span><br><span class="language-xml">        加一</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<img src="fancy1.gif" srcset="/img/loading.gif" lazyload alt="fancy1" style="zoom:50%;" />

<p>你可能以为当你勾选复选框的时候 state 会被重置，但它并没有！这是因为 <strong>两个 <code>&lt;Counter /&gt;</code> 标签<mark>被渲染在了相同的位置</mark>。</strong> React 不知道你的函数里是如何进行条件判断的，它只会“看到”你返回的树。在这两种情况下，<code>App</code> 组件都会返回一个包裹着 <code>&lt;Counter /&gt;</code> 作为第一个子组件的 <code>div</code>。这就是 React 认为它们是 <strong>同一个</strong> <code>&lt;Counter /&gt;</code> 的原因。</p>
<p>你可以认为它们有相同的“地址”：根组件的第一个子组件的第一个子组件。不管你的逻辑是怎么组织的，这就是 React 在前后两次渲染之间将它们进行匹配的方式。</p>
<p><mark>相同位置的不同组件会使 state 重置 </mark>：在这个例子中，勾选复选框会将 <code>&lt;Counter&gt;</code> 替换为一个 <code>&lt;p&gt;</code>：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-83ba3dlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-83ba3dlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [isPaused, setIsPaused] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      &#123;isPaused ? (</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>待会见！<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span> </span><br><span class="language-xml">      ) : (</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Counter</span> /&gt;</span> </span><br><span class="language-xml">      )&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">input</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;checkbox&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">checked</span>=<span class="hljs-string">&#123;isPaused&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> &#123;</span><br><span class="language-xml">            setIsPaused(e.target.checked)</span><br><span class="language-xml">          &#125;&#125;</span><br><span class="language-xml">        /&gt;</span><br><span class="language-xml">        休息一下</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [score, setScore] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">const</span> [hover, setHover] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);<br><br>  <span class="hljs-keyword">let</span> className = <span class="hljs-string">&#x27;counter&#x27;</span>;<br>  <span class="hljs-keyword">if</span> (hover) &#123;<br>    className += <span class="hljs-string">&#x27; hover&#x27;</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">className</span>=<span class="hljs-string">&#123;className&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">onPointerEnter</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> setHover(true)&#125;</span><br><span class="language-xml">      onPointerLeave=&#123;() =&gt; setHover(false)&#125;</span><br><span class="language-xml">    &gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>&#123;score&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> setScore(score + 1)&#125;&gt;</span><br><span class="language-xml">        加一</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<img src="fancy2-1699509744853-4.gif" srcset="/img/loading.gif" lazyload alt="fancy2" style="zoom:50%;" />

<p>在相同位置对 <strong>不同</strong> 的组件类型进行切换。刚开始 <code>&lt;div&gt;</code> 的第一个子组件是一个 <code>Counter</code>。但是当你切换成 <code>p</code> 时，React 将 <code>Counter</code> 从 UI 树中移除了并销毁了它的状态。</p>
<img src="image-20231109140248758.png" srcset="/img/loading.gif" lazyload alt="image-20231109140248758" style="zoom:50%;" />

<p>当切换回来时，<code>p</code> 会被删除，而 <code>Counter</code> 会被添加：</p>
<img src="image-20231109140313803.png" srcset="/img/loading.gif" lazyload alt="image-20231109140313803" style="zoom:50%;" />

<p><mark>当你在相同位置渲染不同的组件时，组件的整个子树都会被重置</mark>：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-4e0ikllqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-4e0ikllqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [isFancy, setIsFancy] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      &#123;isFancy ? (</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">Counter</span> <span class="hljs-attr">isFancy</span>=<span class="hljs-string">&#123;true&#125;</span> /&gt;</span> </span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      ) : (</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">section</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">Counter</span> <span class="hljs-attr">isFancy</span>=<span class="hljs-string">&#123;false&#125;</span> /&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span></span><br><span class="language-xml">      )&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">input</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;checkbox&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">checked</span>=<span class="hljs-string">&#123;isFancy&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> &#123;</span><br><span class="language-xml">            setIsFancy(e.target.checked)</span><br><span class="language-xml">          &#125;&#125;</span><br><span class="language-xml">        /&gt;</span><br><span class="language-xml">        使用好看的样式</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params">&#123; isFancy &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> [score, setScore] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">const</span> [hover, setHover] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);<br><br>  <span class="hljs-keyword">let</span> className = <span class="hljs-string">&#x27;counter&#x27;</span>;<br>  <span class="hljs-keyword">if</span> (hover) &#123;<br>    className += <span class="hljs-string">&#x27; hover&#x27;</span>;<br>  &#125;<br>  <span class="hljs-keyword">if</span> (isFancy) &#123;<br>    className += <span class="hljs-string">&#x27; fancy&#x27;</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">className</span>=<span class="hljs-string">&#123;className&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">onPointerEnter</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> setHover(true)&#125;</span><br><span class="language-xml">      onPointerLeave=&#123;() =&gt; setHover(false)&#125;</span><br><span class="language-xml">    &gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>&#123;score&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> setScore(score + 1)&#125;&gt;</span><br><span class="language-xml">        加一</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<img src="fancy3.gif" srcset="/img/loading.gif" lazyload style="zoom:50%;" />

<p>当你勾选复选框后计数器的 state 被重置了。虽然你渲染了一个 <code>Counter</code>，但是 <code>div</code> 的第一个子组件从 <code>div</code> 变成了 <code>section</code>。当子组件 <code>div</code> 从 DOM 中被移除的时候，它底下的整棵树（包含 <code>Counter</code> 以及它的 state）也都被销毁了。</p>
<p>当 <code>section</code> 变为 <code>div</code> 时，<code>section</code> 会被删除，新的 <code>div</code> 被添加：</p>
<img src="image-20231109140745131.png" srcset="/img/loading.gif" lazyload alt="image-20231109140745131" style="zoom:50%;" />

<p>当切换回来时，<code>div</code> 会被删除，新的 <code>section</code> 被添加：</p>
<img src="image-20231109140804072.png" srcset="/img/loading.gif" lazyload alt="image-20231109140804072" style="zoom:50%;" />

<p><mark><strong>如果你想在重新渲染时保留 state，几次渲染中的树形结构就应该相互“匹配”</strong>。结构不同就会导致 state 的销毁，因为 React 会在将一个组件从树中移除时销毁它的 state。</mark></p>
<p><mark>不应该把组件函数的定义嵌套起来</mark>：示例中， <code>MyTextField</code> 组件被定义在 <code>MyComponent</code> <strong>内部</strong>：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-bd7pnhlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-bd7pnhlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">MyComponent</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [counter, setCounter] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">MyTextField</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">const</span> [text, setText] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;&#x27;</span>);<br><br>    <span class="hljs-keyword">return</span> (<br>      <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;text&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> setText(e.target.value)&#125;</span><br><span class="language-xml">      /&gt;</span><br>    );<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">MyTextField</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> &#123;</span><br><span class="language-xml">        setCounter(counter + 1)</span><br><span class="language-xml">      &#125;&#125;&gt;点击了 &#123;counter&#125; 次<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<img src="click.gif" srcset="/img/loading.gif" lazyload alt="click" style="zoom:50%;" />

<p>每次你点击按钮，输入框的 state 都会消失！这是因为每次 <code>MyComponent</code> 渲染时都会创建一个 <strong>不同</strong> 的 <code>MyTextField</code> 函数。你在相同位置渲染的是 <strong>不同</strong> 的组件，所以 React 将其下所有的 state 都重置了。这样会导致 bug 以及性能问题。<mark>为了避免这个问题， <strong>永远要将组件定义在最上层并且不要把它们的定义嵌套起来。</strong></mark></p>
<p><mark>在相同位置重置 state</mark>：默认情况下，React 会在一个组件保持在同一位置时保留它的 state。通常这就是你想要的，所以把它作为默认特性很合理。但有时候，你可能想要重置一个组件的 state。考虑一下这个应用，它可以让两个玩家在每个回合中记录他们的得分：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-akmd62lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-akmd62lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Scoreboard</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [isPlayerA, setIsPlayerA] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>);<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      &#123;isPlayerA ? (</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Counter</span> <span class="hljs-attr">person</span>=<span class="hljs-string">&quot;Taylor&quot;</span> /&gt;</span></span><br><span class="language-xml">      ) : (</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Counter</span> <span class="hljs-attr">person</span>=<span class="hljs-string">&quot;Sarah&quot;</span> /&gt;</span></span><br><span class="language-xml">      )&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> &#123;</span><br><span class="language-xml">        setIsPlayerA(!isPlayerA);</span><br><span class="language-xml">      &#125;&#125;&gt;</span><br><span class="language-xml">        下一位玩家！</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params">&#123; person &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> [score, setScore] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">const</span> [hover, setHover] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);<br><br>  <span class="hljs-keyword">let</span> className = <span class="hljs-string">&#x27;counter&#x27;</span>;<br>  <span class="hljs-keyword">if</span> (hover) &#123;<br>    className += <span class="hljs-string">&#x27; hover&#x27;</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">className</span>=<span class="hljs-string">&#123;className&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">onPointerEnter</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> setHover(true)&#125;</span><br><span class="language-xml">      onPointerLeave=&#123;() =&gt; setHover(false)&#125;</span><br><span class="language-xml">    &gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>&#123;person&#125; 的分数：&#123;score&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> setScore(score + 1)&#125;&gt;</span><br><span class="language-xml">        加一</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<img src="score.gif" srcset="/img/loading.gif" lazyload alt="score" style="zoom:50%;" />

<p>目前当你切换玩家时，分数会被保留下来。这两个 <code>Counter</code> 出现在相同的位置，所以 React 会认为它们是 <strong>同一个</strong> <code>Counter</code>，只是传了不同的 <code>person</code> prop。</p>
<p>但是从概念上讲，这个应用中的两个计数器应该是各自独立的。虽然它们在 UI 中的位置相同，但是一个是 Taylor 的计数器，一个是 Sarah 的计数器。</p>
<p>有两个方法可以在它们相互切换时重置 state：</p>
<ol>
<li><p>将组件渲染在不同的位置：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-akh4m5lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-akh4m5lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Scoreboard</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [isPlayerA, setIsPlayerA] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>);<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      &#123;isPlayerA &amp;&amp;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Counter</span> <span class="hljs-attr">person</span>=<span class="hljs-string">&quot;Taylor&quot;</span> /&gt;</span></span><br><span class="language-xml">      &#125;</span><br><span class="language-xml">      &#123;!isPlayerA &amp;&amp;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Counter</span> <span class="hljs-attr">person</span>=<span class="hljs-string">&quot;Sarah&quot;</span> /&gt;</span></span><br><span class="language-xml">      &#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> &#123;</span><br><span class="language-xml">        setIsPlayerA(!isPlayerA);</span><br><span class="language-xml">      &#125;&#125;&gt;</span><br><span class="language-xml">        下一位玩家！</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params">&#123; person &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> [score, setScore] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">const</span> [hover, setHover] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);<br><br>  <span class="hljs-keyword">let</span> className = <span class="hljs-string">&#x27;counter&#x27;</span>;<br>  <span class="hljs-keyword">if</span> (hover) &#123;<br>    className += <span class="hljs-string">&#x27; hover&#x27;</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">className</span>=<span class="hljs-string">&#123;className&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">onPointerEnter</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> setHover(true)&#125;</span><br><span class="language-xml">      onPointerLeave=&#123;() =&gt; setHover(false)&#125;</span><br><span class="language-xml">    &gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>&#123;person&#125; 的分数：&#123;score&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> setScore(score + 1)&#125;&gt;</span><br><span class="language-xml">        加一</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<img src="score2.gif" srcset="/img/loading.gif" lazyload alt="score2" style="zoom:50%;" />

<p>起初 <code>isPlayerA</code> 的值是 <code>true</code>。所以第一个位置包含了 <code>Counter</code> 的 state，而第二个位置是空的。</p>
<p>当你点击“下一位玩家”按钮时，第一个位置会被清空，而第二个位置现在包含了一个 <code>Counter</code>。</p>
<img src="image-20231109142132582.png" srcset="/img/loading.gif" lazyload alt="image-20231109142132582" style="zoom:50%;" />
</li>
<li><p>使用 <code>key</code> 赋予每个组件一个明确的身份：<mark>使用 key 来让 React 区分任何组件</mark>。默认情况下，React 使用父组件内部的顺序（“第一个计数器”、“第二个计数器”）来区分组件。但是 key 可以让你告诉 React 这不仅仅是 <strong>第一个</strong> 或者 <strong>第二个</strong> 计数器，而且还是一个特定的计数器——例如，<strong>Taylor 的</strong> 计数器。这样无论它出现在树的任何位置， React 都会知道它是 <strong>Taylor 的</strong> 计数器！</p>
<p>在这个例子中，即使两个 <code>&lt;Counter /&gt;</code> 会出现在 JSX 中的同一个位置，它们也不会共享 state：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-xlppnrlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-xlppnrlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Scoreboard</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [isPlayerA, setIsPlayerA] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>);<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      &#123;isPlayerA ? (</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Counter</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;Taylor&quot;</span> <span class="hljs-attr">person</span>=<span class="hljs-string">&quot;Taylor&quot;</span> /&gt;</span></span><br><span class="language-xml">      ) : (</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Counter</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;Sarah&quot;</span> <span class="hljs-attr">person</span>=<span class="hljs-string">&quot;Sarah&quot;</span> /&gt;</span></span><br><span class="language-xml">      )&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> &#123;</span><br><span class="language-xml">        setIsPlayerA(!isPlayerA);</span><br><span class="language-xml">      &#125;&#125;&gt;</span><br><span class="language-xml">        下一位玩家！</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params">&#123; person &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> [score, setScore] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">const</span> [hover, setHover] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);<br><br>  <span class="hljs-keyword">let</span> className = <span class="hljs-string">&#x27;counter&#x27;</span>;<br>  <span class="hljs-keyword">if</span> (hover) &#123;<br>    className += <span class="hljs-string">&#x27; hover&#x27;</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">className</span>=<span class="hljs-string">&#123;className&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">onPointerEnter</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> setHover(true)&#125;</span><br><span class="language-xml">      onPointerLeave=&#123;() =&gt; setHover(false)&#125;</span><br><span class="language-xml">    &gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>&#123;person&#125; 的分数：&#123;score&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> setScore(score + 1)&#125;&gt;</span><br><span class="language-xml">        加一</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<img src="score3.gif" srcset="/img/loading.gif" lazyload alt="score3" style="zoom:50%;" />

<p>指定一个 <code>key</code> 能够让 React 将 <code>key</code> 本身而非它们在父组件中的顺序作为位置的一部分。这就是为什么尽管你用 JSX 将组件渲染在相同位置，但在 React 看来它们是两个不同的计数器。因此它们永远都不会共享 state。每当一个计数器出现在屏幕上时，它的 state 会被创建出来。每当它被移除时，它的 state 就会被销毁。在它们之间切换会一次又一次地使它们的 state 重置。</p>
<p><mark>请记住 key 不是全局唯一的。它们只能指定 <strong>父组件内部</strong> 的顺序。</mark></p>
</li>
</ol>
<p><mark>使用 key 来重置 state 在处理表单时特别有用</mark>：在这个聊天应用中， <code>&lt;Chat&gt;</code> 组件包含文本输入 state：只需给组件添加一个 <code>key</code> 就可以确保了当你选择一个不同的收件人时， <code>Chat</code> 组件——包括其下方树中的任何 state——都将从头开始重新创建。 React 还将重新创建 DOM 元素，而不是复用它们。切换收件人就总会清除文本字段：</p>
<p>Chat.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-j1lml7lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-j1lml7lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Chat</span>(<span class="hljs-params">&#123; contact &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> [text, setText] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;&#x27;</span>);<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">section</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;chat&quot;</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">textarea</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;text&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&#123;</span>&#x27;<span class="hljs-attr">跟</span> &#x27; + <span class="hljs-attr">contact.name</span> + &#x27; <span class="hljs-attr">聊一聊</span>&#x27;&#125;</span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> setText(e.target.value)&#125;</span><br><span class="language-xml">      /&gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>发送到 &#123;contact.email&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>ContatctList.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-efe50tlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-efe50tlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ContactList</span>(<span class="hljs-params">&#123;</span><br><span class="hljs-params">  selectedContact,</span><br><span class="hljs-params">  contacts,</span><br><span class="hljs-params">  onSelect</span><br><span class="hljs-params">&#125;</span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">section</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;contact-list&quot;</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span></span><br><span class="language-xml">        &#123;contacts.map(contact =&gt;</span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;contact.id&#125;</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> &#123;</span><br><span class="language-xml">              onSelect(contact);</span><br><span class="language-xml">            &#125;&#125;&gt;</span><br><span class="language-xml">              &#123;contact.name&#125;</span><br><span class="language-xml">            <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span><br><span class="language-xml">        )&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>App.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-dg7g4llqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-dg7g4llqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-title class_">Chat</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./Chat.js&#x27;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-title class_">ContactList</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./ContactList.js&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Messenger</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [to, setTo] = <span class="hljs-title function_">useState</span>(contacts[<span class="hljs-number">0</span>]);<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ContactList</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">contacts</span>=<span class="hljs-string">&#123;contacts&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">selectedContact</span>=<span class="hljs-string">&#123;to&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">onSelect</span>=<span class="hljs-string">&#123;contact</span> =&gt;</span> setTo(contact)&#125;</span><br><span class="language-xml">      /&gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Chat</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;to.id&#125;</span> <span class="hljs-attr">contact</span>=<span class="hljs-string">&#123;to&#125;</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  )<br>&#125;<br><br><span class="hljs-keyword">const</span> contacts = [<br>  &#123; <span class="hljs-attr">id</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Taylor&#x27;</span>, <span class="hljs-attr">email</span>: <span class="hljs-string">&#x27;taylor@mail.com&#x27;</span> &#125;,<br>  &#123; <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Alice&#x27;</span>, <span class="hljs-attr">email</span>: <span class="hljs-string">&#x27;alice@mail.com&#x27;</span> &#125;,<br>  &#123; <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Bob&#x27;</span>, <span class="hljs-attr">email</span>: <span class="hljs-string">&#x27;bob@mail.com&#x27;</span> &#125;<br>];<br></code></pre></td></tr></table></div></figure>

<img src="chat.gif" srcset="/img/loading.gif" lazyload alt="chat" style="zoom:50%;" />

<p><mark>为被移除的组件保留 state</mark>：在真正的聊天应用中，你可能会想在用户再次选择前一个收件人时恢复输入 state。对于一个不可见的组件，有几种方法可以让它的 state “活下去”：</p>
<ul>
<li>与其只渲染现在这一个聊天，你可以把 <strong>所有</strong> 聊天都渲染出来，但用 CSS 把其他聊天隐藏起来。这些聊天就不会从树中被移除了，所以它们的内部 state 会被保留下来。这种解决方法对于简单 UI 非常有效。但如果要隐藏的树形结构很大且包含了大量的 DOM 节点，那么性能就会变得很差。</li>
<li>你可以进行 <a target="_blank" rel="noopener" href="http://localhost:3000/learn/sharing-state-between-components">状态提升</a> 并在父组件中保存每个收件人的草稿消息。这样即使子组件被移除了也无所谓，因为保留重要信息的是父组件。这是最常见的解决方法。</li>
<li>除了 React 的 state，你也可以使用其他数据源。例如，也许你希望即使用户不小心关闭页面也可以保存一份信息草稿。要实现这一点，你可以让 <code>Chat</code> 组件通过读取 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/localStorage"><code>localStorage</code></a> 对其 state 进行初始化，并把草稿保存在那里。</li>
</ul>
<h2 id="5-迁移状态逻辑至-Reducer-中"><a href="#5-迁移状态逻辑至-Reducer-中" class="headerlink" title="5.迁移状态逻辑至 Reducer 中"></a>5.迁移状态逻辑至 Reducer 中</h2><p>对于拥有许多状态更新逻辑的组件来说，过于分散的事件处理程序可能会令人不知所措。对于这种情况，你可以将组件的所有状态更新逻辑整合到一个外部函数中，这个函数叫作 <strong>reducer</strong>。</p>
<p><mark>使用 reducer 整合状态逻辑</mark>：随着组件复杂度的增加，你将很难一眼看清所有的组件状态更新逻辑。例如，下面的 <code>TaskApp</code> 组件有一个数组类型的状态 <code>tasks</code>，并通过三个不同的事件处理程序来实现任务的添加、删除和修改：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-uh22rylqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-uh22rylqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-title class_">AddTask</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./AddTask.js&#x27;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-title class_">TaskList</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./TaskList.js&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">TaskApp</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [tasks, setTasks] = <span class="hljs-title function_">useState</span>(initialTasks);<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleAddTask</span>(<span class="hljs-params">text</span>) &#123;<br>    <span class="hljs-title function_">setTasks</span>([<br>      ...tasks,<br>      &#123;<br>        <span class="hljs-attr">id</span>: nextId++,<br>        <span class="hljs-attr">text</span>: text,<br>        <span class="hljs-attr">done</span>: <span class="hljs-literal">false</span>,<br>      &#125;,<br>    ]);<br>  &#125;<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleChangeTask</span>(<span class="hljs-params">task</span>) &#123;<br>    <span class="hljs-title function_">setTasks</span>(<br>      tasks.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> &#123;<br>        <span class="hljs-keyword">if</span> (t.<span class="hljs-property">id</span> === task.<span class="hljs-property">id</span>) &#123;<br>          <span class="hljs-keyword">return</span> task;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-keyword">return</span> t;<br>        &#125;<br>      &#125;)<br>    );<br>  &#125;<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleDeleteTask</span>(<span class="hljs-params">taskId</span>) &#123;<br>    <span class="hljs-title function_">setTasks</span>(tasks.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> t.<span class="hljs-property">id</span> !== taskId));<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>布拉格的行程安排<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">AddTask</span> <span class="hljs-attr">onAddTask</span>=<span class="hljs-string">&#123;handleAddTask&#125;</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">TaskList</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">tasks</span>=<span class="hljs-string">&#123;tasks&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">onChangeTask</span>=<span class="hljs-string">&#123;handleChangeTask&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">onDeleteTask</span>=<span class="hljs-string">&#123;handleDeleteTask&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">let</span> nextId = <span class="hljs-number">3</span>;<br><span class="hljs-keyword">const</span> initialTasks = [<br>  &#123;<span class="hljs-attr">id</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">&#x27;参观卡夫卡博物馆&#x27;</span>, <span class="hljs-attr">done</span>: <span class="hljs-literal">true</span>&#125;,<br>  &#123;<span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">&#x27;看木偶戏&#x27;</span>, <span class="hljs-attr">done</span>: <span class="hljs-literal">false</span>&#125;,<br>  &#123;<span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">&#x27;打卡列侬墙&#x27;</span>, <span class="hljs-attr">done</span>: <span class="hljs-literal">false</span>&#125;,<br>];<br></code></pre></td></tr></table></div></figure>

<p>这个组件的每个事件处理程序都通过 <code>setTasks</code> 来更新状态。随着这个组件的不断迭代，其状态逻辑也会越来越多。为了降低这种复杂度，并让所有逻辑都可以存放在一个易于理解的地方，你可以将这些状态逻辑移到组件之外的一个称为 <strong>reducer</strong> 的函数中。</p>
<p>Reducer 是处理状态的另一种方式。你可以通过三个步骤将 <code>useState</code> 迁移到 <code>useReducer</code>：</p>
<ol>
<li><p>&#x3D;&#x3D;将设置状态的逻辑 <strong>修改</strong> 成 dispatch 的一个 action&#x3D;&#x3D;：移除所有的状态设置逻辑。只留下三个事件处理函数：</p>
<ul>
<li><code>handleAddTask(text)</code> 在用户点击 “添加” 时被调用。</li>
<li><code>handleChangeTask(task)</code> 在用户切换任务或点击 “保存” 时被调用。</li>
<li><code>handleDeleteTask(taskId)</code> 在用户点击 “删除” 时被调用。</li>
</ul>
<p>使用 reducers 管理状态与直接设置状态略有不同。它不是通过设置状态来告诉 React “要做什么”，而是通过事件处理程序 dispatch 一个 “action” 来指明 “用户刚刚做了什么”。（而状态更新逻辑则保存在其他地方！）因此，我们不再通过事件处理器直接 “设置 <code>task</code>”，而是 dispatch 一个 “添加&#x2F;修改&#x2F;删除任务” 的 action。这更加符合用户的思维。</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-te7ovzlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-te7ovzlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">handleAddTask</span>(<span class="hljs-params">text</span>) &#123;<br>  <span class="hljs-title function_">dispatch</span>(&#123;<br>    <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;added&#x27;</span>,<br>    <span class="hljs-attr">id</span>: nextId++,<br>    <span class="hljs-attr">text</span>: text,<br>  &#125;);<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">handleChangeTask</span>(<span class="hljs-params">task</span>) &#123;<br>  <span class="hljs-title function_">dispatch</span>(&#123;<br>    <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;changed&#x27;</span>,<br>    <span class="hljs-attr">task</span>: task,<br>  &#125;);<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">handleDeleteTask</span>(<span class="hljs-params">taskId</span>) &#123;<br>  <span class="hljs-title function_">dispatch</span>(&#123;<br>    <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;deleted&#x27;</span>,<br>    <span class="hljs-attr">id</span>: taskId,<br>  &#125;);<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>你传递给 <code>dispatch</code> 的对象叫做 “action”：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-f47ayclqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-f47ayclqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">handleDeleteTask</span>(<span class="hljs-params">taskId</span>) &#123;<br>  <span class="hljs-title function_">dispatch</span>(<br>    <span class="hljs-comment">// &quot;action&quot; 对象：</span><br>    &#123;<br>      <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;deleted&#x27;</span>,<br>      <span class="hljs-attr">id</span>: taskId,<br>    &#125;<br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>它是一个普通的 JavaScript 对象。它的结构是由你决定的，但通常来说，它应该至少包含可以表明 <strong>发生了什么事情</strong> 的信息。</p>
<p><code>action 对象</code>可以有多种结构：按照惯例，我们通常会添加一个字符串类型的 <code>type</code> 字段来描述发生了什么，并通过其它字段传递额外的信息。<code>type</code> 是特定于组件的，在这个例子中 <code>added</code> 和 <code>addded_task</code> 都可以。选一个能描述清楚发生的事件的名字！</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-n99z3glqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-n99z3glqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-title function_">dispatch</span>(&#123;<br>  <span class="hljs-comment">// 针对特定的组件</span><br>  <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;what_happened&#x27;</span>,<br>  <span class="hljs-comment">// 其它字段放这里</span><br>&#125;);<br></code></pre></td></tr></table></div></figure>
</li>
<li><p>&#x3D;&#x3D;<strong>编写</strong> 一个 reducer 函数&#x3D;&#x3D;：reducer 函数就是你放置状态逻辑的地方。它接受两个参数，分别为当前 state 和 action 对象，并且返回的是更新后的 state：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-5f24azlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-5f24azlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">yourReducer</span>(<span class="hljs-params">state, action</span>) &#123;<br>  <span class="hljs-comment">// 给 React 返回更新后的状态</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>React 会将状态设置为你从 reducer 返回的状态。</p>
<p>在这个例子中，要将状态设置逻辑从事件处理程序移到 reducer 函数中，你需要：</p>
<ol>
<li>声明当前状态（<code>tasks</code>）作为第一个参数；</li>
<li>声明 <code>action</code> 对象作为第二个参数；</li>
<li>从 <code>reducer</code> 返回 <strong>下一个</strong> 状态（React 会将旧的状态设置为这个最新的状态）。</li>
</ol>
<p>下面是所有迁移到 <code>reducer</code> 函数的状态设置逻辑：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-9s6sv7lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-9s6sv7lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">tasksReducer</span>(<span class="hljs-params">tasks, action</span>) &#123;<br>  <span class="hljs-keyword">if</span> (action.<span class="hljs-property">type</span> === <span class="hljs-string">&#x27;added&#x27;</span>) &#123;<br>    <span class="hljs-keyword">return</span> [<br>      ...tasks,<br>      &#123;<br>        <span class="hljs-attr">id</span>: action.<span class="hljs-property">id</span>,<br>        <span class="hljs-attr">text</span>: action.<span class="hljs-property">text</span>,<br>        <span class="hljs-attr">done</span>: <span class="hljs-literal">false</span>,<br>      &#125;,<br>    ];<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (action.<span class="hljs-property">type</span> === <span class="hljs-string">&#x27;changed&#x27;</span>) &#123;<br>    <span class="hljs-keyword">return</span> tasks.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">if</span> (t.<span class="hljs-property">id</span> === action.<span class="hljs-property">task</span>.<span class="hljs-property">id</span>) &#123;<br>        <span class="hljs-keyword">return</span> action.<span class="hljs-property">task</span>;<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> t;<br>      &#125;<br>    &#125;);<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (action.<span class="hljs-property">type</span> === <span class="hljs-string">&#x27;deleted&#x27;</span>) &#123;<br>    <span class="hljs-keyword">return</span> tasks.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> t.<span class="hljs-property">id</span> !== action.<span class="hljs-property">id</span>);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;未知 action: &#x27;</span> + action.<span class="hljs-property">type</span>);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>由于 <code>reducer</code> 函数接受 <code>state</code>（tasks）作为参数，因此你可以 <strong>在组件之外声明它</strong>。这减少了代码的缩进级别，提升了代码的可读性。</p>
<p>上面的代码使用了 <code>if/else</code> 语句，但是在 reducers 中使用 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/docs/Web/JavaScript/Reference/Statements/switch">switch 语句</a> 是一种惯例。两种方式结果是相同的，但 <code>switch</code> 语句读起来一目了然。</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-uw8cgjlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-uw8cgjlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">tasksReducer</span>(<span class="hljs-params">tasks, action</span>) &#123;<br>  <span class="hljs-keyword">switch</span> (action.<span class="hljs-property">type</span>) &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;added&#x27;</span>: &#123;<br>      <span class="hljs-keyword">return</span> [<br>        ...tasks,<br>        &#123;<br>          <span class="hljs-attr">id</span>: action.<span class="hljs-property">id</span>,<br>          <span class="hljs-attr">text</span>: action.<span class="hljs-property">text</span>,<br>         <span class="hljs-attr">done</span>: <span class="hljs-literal">false</span>,<br>        &#125;,<br>      ];<br>    &#125;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;changed&#x27;</span>: &#123;<br>      <span class="hljs-keyword">return</span> tasks.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> &#123;<br>        <span class="hljs-keyword">if</span> (t.<span class="hljs-property">id</span> === action.<span class="hljs-property">task</span>.<span class="hljs-property">id</span>) &#123;<br>          <span class="hljs-keyword">return</span> action.<span class="hljs-property">task</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-keyword">return</span> t;<br>        &#125;<br>      &#125;);<br>    &#125;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;deleted&#x27;</span>: &#123;<br>      <span class="hljs-keyword">return</span> tasks.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> t.<span class="hljs-property">id</span> !== action.<span class="hljs-property">id</span>);<br>    &#125;<br>    <span class="hljs-attr">default</span>: &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;未知 action: &#x27;</span> + action.<span class="hljs-property">type</span>);<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>我们建议将每个 <code>case</code> 块包装到 <code>&#123;</code> 和 <code>&#125;</code> 花括号中，这样在不同 <code>case</code> 中声明的变量就不会互相冲突。此外，<code>case</code> 通常应该以 <code>return</code> 结尾。如果你忘了 <code>return</code>，代码就会 <code>进入</code> 到下一个 <code>case</code>，这就会导致错误！</p>
<p>尽管 <code>reducer</code> 可以 “减少” 组件内的代码量，但它实际上是以数组上的 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Array/Reduce"><code>reduce()</code></a> 方法命名的。</p>
<p><code>reduce()</code> 允许你将数组中的多个值 “累加” 成一个值：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-gnmm2plqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-gnmm2plqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> arr = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>];<br><span class="hljs-keyword">const</span> sum = arr.<span class="hljs-title function_">reduce</span>(<br>  <span class="hljs-function">(<span class="hljs-params">result, number</span>) =&gt;</span> result + number<br><br>); <span class="hljs-comment">// 1 + 2 + 3 + 4 + 5</span><br></code></pre></td></tr></table></div></figure>

<p class="note note-success" style="border-left: 4px solid #42b983;padding: 10px 15px;color: #777;background-color: rgba(66, 185, 131, .1);">result参数代表累积计算的结果。在第一次调用回调函数时，它的值是传递给reduce()方法的初始值（如果提供了初始值），或者是数组的第一个元素。
number参数代表当前正在处理的数组元素。
该回调函数的目标是将每个元素与累积的结果相加，从而计算出总和。</p>

<p>你传递给 <code>reduce</code> 的函数被称为 “reducer”。它接受 <code>目前的结果</code> 和 <code>当前的值</code>，然后返回 <code>下一个结果</code>。React 中的 <code>reducer</code> 和这个是一样的：它们都接受 <code>目前的状态</code> 和 <code>action</code> ，然后返回 <code>下一个状态</code>。这样，action 会随着时间推移累积到状态中。</p>
</li>
<li><p>&#x3D;&#x3D;在你的组件中 <strong>使用</strong> reducer：&#x3D;&#x3D;</p>
</li>
<li><p>将 <code>tasksReducer</code> 导入到组件中。记得先从 React 中导入 <code>useReducer</code> Hook：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-49wji7lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-49wji7lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useReducer &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br></code></pre></td></tr></table></div></figure>

<p>然后把</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-s7s148lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-s7s148lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> [tasks, setTasks] = <span class="hljs-title function_">useState</span>(initialTasks);<br></code></pre></td></tr></table></div></figure>

<p>替换为：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-ub98islqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-ub98islqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> [tasks, dispatch] = <span class="hljs-title function_">useReducer</span>(tasksReducer, initialTasks);<br></code></pre></td></tr></table></div></figure></li>
</ol>
<p>完整代码：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-qvbpoxlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-qvbpoxlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useReducer &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-title class_">AddTask</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./AddTask.js&#x27;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-title class_">TaskList</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./TaskList.js&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">TaskApp</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [tasks, dispatch] = <span class="hljs-title function_">useReducer</span>(tasksReducer, initialTasks);<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleAddTask</span>(<span class="hljs-params">text</span>) &#123;<br>    <span class="hljs-title function_">dispatch</span>(&#123;<br>      <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;added&#x27;</span>,<br>      <span class="hljs-attr">id</span>: nextId++,<br>      <span class="hljs-attr">text</span>: text,<br>    &#125;);<br>  &#125;<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleChangeTask</span>(<span class="hljs-params">task</span>) &#123;<br>    <span class="hljs-title function_">dispatch</span>(&#123;<br>      <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;changed&#x27;</span>,<br>      <span class="hljs-attr">task</span>: task,<br>    &#125;);<br>  &#125;<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleDeleteTask</span>(<span class="hljs-params">taskId</span>) &#123;<br>    <span class="hljs-title function_">dispatch</span>(&#123;<br>      <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;deleted&#x27;</span>,<br>      <span class="hljs-attr">id</span>: taskId,<br>    &#125;);<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>布拉格的行程安排<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">AddTask</span> <span class="hljs-attr">onAddTask</span>=<span class="hljs-string">&#123;handleAddTask&#125;</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">TaskList</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">tasks</span>=<span class="hljs-string">&#123;tasks&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">onChangeTask</span>=<span class="hljs-string">&#123;handleChangeTask&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">onDeleteTask</span>=<span class="hljs-string">&#123;handleDeleteTask&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">tasksReducer</span>(<span class="hljs-params">tasks, action</span>) &#123;<br>  <span class="hljs-keyword">switch</span> (action.<span class="hljs-property">type</span>) &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;added&#x27;</span>: &#123;<br>      <span class="hljs-keyword">return</span> [<br>        ...tasks,<br>        &#123;<br>          <span class="hljs-attr">id</span>: action.<span class="hljs-property">id</span>,<br>          <span class="hljs-attr">text</span>: action.<span class="hljs-property">text</span>,<br>          <span class="hljs-attr">done</span>: <span class="hljs-literal">false</span>,<br>        &#125;,<br>      ];<br>    &#125;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;changed&#x27;</span>: &#123;<br>      <span class="hljs-keyword">return</span> tasks.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> &#123;<br>        <span class="hljs-keyword">if</span> (t.<span class="hljs-property">id</span> === action.<span class="hljs-property">task</span>.<span class="hljs-property">id</span>) &#123;<br>          <span class="hljs-keyword">return</span> action.<span class="hljs-property">task</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-keyword">return</span> t;<br>        &#125;<br>      &#125;);<br>    &#125;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;deleted&#x27;</span>: &#123;<br>      <span class="hljs-keyword">return</span> tasks.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> t.<span class="hljs-property">id</span> !== action.<span class="hljs-property">id</span>);<br>    &#125;<br>    <span class="hljs-attr">default</span>: &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;未知 action: &#x27;</span> + action.<span class="hljs-property">type</span>);<br>    &#125;<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">let</span> nextId = <span class="hljs-number">3</span>;<br><span class="hljs-keyword">const</span> initialTasks = [<br>  &#123;<span class="hljs-attr">id</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">&#x27;参观卡夫卡博物馆&#x27;</span>, <span class="hljs-attr">done</span>: <span class="hljs-literal">true</span>&#125;,<br>  &#123;<span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">&#x27;看木偶戏&#x27;</span>, <span class="hljs-attr">done</span>: <span class="hljs-literal">false</span>&#125;,<br>  &#123;<span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">&#x27;打卡列侬墙&#x27;</span>, <span class="hljs-attr">done</span>: <span class="hljs-literal">false</span>&#125;<br>];<br></code></pre></td></tr></table></div></figure>

<img src="image-20231109170735742.png" srcset="/img/loading.gif" lazyload alt="image-20231109170735742" style="zoom:50%;" />

<p>也可以把 reducer 移到一个单独的文件中：</p>
<p>tasksReducer.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-6tzug4lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-6tzug4lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">tasksReducer</span>(<span class="hljs-params">tasks, action</span>) &#123;<br>  <span class="hljs-keyword">switch</span> (action.<span class="hljs-property">type</span>) &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;added&#x27;</span>: &#123;<br>      <span class="hljs-keyword">return</span> [<br>        ...tasks,<br>        &#123;<br>          <span class="hljs-attr">id</span>: action.<span class="hljs-property">id</span>,<br>          <span class="hljs-attr">text</span>: action.<span class="hljs-property">text</span>,<br>          <span class="hljs-attr">done</span>: <span class="hljs-literal">false</span>,<br>        &#125;,<br>      ];<br>    &#125;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;changed&#x27;</span>: &#123;<br>      <span class="hljs-keyword">return</span> tasks.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> &#123;<br>        <span class="hljs-keyword">if</span> (t.<span class="hljs-property">id</span> === action.<span class="hljs-property">task</span>.<span class="hljs-property">id</span>) &#123;<br>          <span class="hljs-keyword">return</span> action.<span class="hljs-property">task</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-keyword">return</span> t;<br>        &#125;<br>      &#125;);<br>    &#125;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;deleted&#x27;</span>: &#123;<br>      <span class="hljs-keyword">return</span> tasks.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> t.<span class="hljs-property">id</span> !== action.<span class="hljs-property">id</span>);<br>    &#125;<br>    <span class="hljs-attr">default</span>: &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;未知 action：&#x27;</span> + action.<span class="hljs-property">type</span>);<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>App.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-i8zy5xlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-i8zy5xlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useReducer &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-title class_">AddTask</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./AddTask.js&#x27;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-title class_">TaskList</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./TaskList.js&#x27;</span>;<br><span class="hljs-keyword">import</span> tasksReducer <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./tasksReducer.js&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">TaskApp</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [tasks, dispatch] = <span class="hljs-title function_">useReducer</span>(tasksReducer, initialTasks);<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleAddTask</span>(<span class="hljs-params">text</span>) &#123;<br>    <span class="hljs-title function_">dispatch</span>(&#123;<br>      <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;added&#x27;</span>,<br>      <span class="hljs-attr">id</span>: nextId++,<br>      <span class="hljs-attr">text</span>: text,<br>    &#125;);<br>  &#125;<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleChangeTask</span>(<span class="hljs-params">task</span>) &#123;<br>    <span class="hljs-title function_">dispatch</span>(&#123;<br>      <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;changed&#x27;</span>,<br>      <span class="hljs-attr">task</span>: task,<br>    &#125;);<br>  &#125;<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleDeleteTask</span>(<span class="hljs-params">taskId</span>) &#123;<br>    <span class="hljs-title function_">dispatch</span>(&#123;<br>      <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;deleted&#x27;</span>,<br>      <span class="hljs-attr">id</span>: taskId,<br>    &#125;);<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>布拉格的行程安排<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">AddTask</span> <span class="hljs-attr">onAddTask</span>=<span class="hljs-string">&#123;handleAddTask&#125;</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">TaskList</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">tasks</span>=<span class="hljs-string">&#123;tasks&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">onChangeTask</span>=<span class="hljs-string">&#123;handleChangeTask&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">onDeleteTask</span>=<span class="hljs-string">&#123;handleDeleteTask&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">let</span> nextId = <span class="hljs-number">3</span>;<br><span class="hljs-keyword">const</span> initialTasks = [<br>  &#123;<span class="hljs-attr">id</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">&#x27;参观卡夫卡博物馆&#x27;</span>, <span class="hljs-attr">done</span>: <span class="hljs-literal">true</span>&#125;,<br>  &#123;<span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">&#x27;看木偶戏&#x27;</span>, <span class="hljs-attr">done</span>: <span class="hljs-literal">false</span>&#125;,<br>  &#123;<span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">&#x27;打卡列侬墙&#x27;</span>, <span class="hljs-attr">done</span>: <span class="hljs-literal">false</span>&#125;,<br>];<br></code></pre></td></tr></table></div></figure>

<p><code>useReducer</code> 和 <code>useState</code> 的区别：</p>
<ol>
<li><p>相同：必须给它传递一个初始状态，它会返回一个有状态的值和一个设置该状态的函数。</p>
</li>
<li><p>不同：<code>useReducer</code> 钩子接受 2 个参数：</p>
<ol>
<li>一个 reducer 函数</li>
<li>一个初始的 state</li>
</ol>
<p>它返回如下内容：</p>
<ol>
<li>一个有状态的值</li>
<li>一个 dispatch 函数（用来 “派发” 用户操作给 reducer）</li>
</ol>
</li>
</ol>
<p>对比：</p>
<ul>
<li><strong>代码体积：</strong> 通常，在使用 <code>useState</code> 时，一开始只需要编写少量代码。而 <code>useReducer</code> 必须提前编写 reducer 函数和需要调度的 actions。但是，当多个事件处理程序以相似的方式修改 state 时，<code>useReducer</code> 可以减少代码量。</li>
<li><strong>可读性：</strong> 当状态更新逻辑足够简单时，<code>useState</code> 的可读性还行。但是，一旦逻辑变得复杂起来，它们会使组件变得臃肿且难以阅读。在这种情况下，<code>useReducer</code> 允许你将状态更新逻辑与事件处理程序分离开来。</li>
<li><strong>可调试性：</strong> 当使用 <code>useState</code> 出现问题时, 你很难发现具体原因以及为什么。 而使用 <code>useReducer</code> 时， 你可以在 reducer 函数中通过打印日志的方式来观察每个状态的更新，以及为什么要更新（来自哪个 <code>action</code>）。 如果所有 <code>action</code> 都没问题，你就知道问题出在了 reducer 本身的逻辑中。 然而，与使用 <code>useState</code> 相比，你必须单步执行更多的代码。</li>
<li><strong>可测试性：</strong> reducer 是一个不依赖于组件的纯函数。这就意味着你可以单独对它进行测试。一般来说，我们最好是在真实环境中测试组件，但对于复杂的状态更新逻辑，针对特定的初始状态和 <code>action</code>，断言 reducer 返回的特定状态会很有帮助。</li>
</ul>
<p>如果你在修改某些组件状态时经常出现问题或者想给组件添加更多逻辑时，我们建议你还是使用 reducer。当然，你也不必整个项目都用 reducer，这是可以自由搭配的。你甚至可以在一个组件中同时使用 <code>useState</code> 和 <code>useReducer</code>。</p>
<p>编写 <code>reducers</code> 时最好牢记以下两点：</p>
<ul>
<li><strong>reducers 必须是纯粹的。</strong> 这一点和 <a target="_blank" rel="noopener" href="http://localhost:3000/learn/queueing-a-series-of-state-updates">状态更新函数</a> 是相似的，<code>reducers</code> 在是在渲染时运行的！（actions 会排队直到下一次渲染)。 这就意味着 <code>reducers</code> <a target="_blank" rel="noopener" href="http://localhost:3000/learn/keeping-components-pure">必须纯净</a>，即当输入相同时，输出也是相同的。它们不应该包含异步请求、定时器或者任何副作用（对组件外部有影响的操作）。它们应该以不可变值的方式去更新 <a target="_blank" rel="noopener" href="http://localhost:3000/learn/updating-objects-in-state">对象</a> 和 <a target="_blank" rel="noopener" href="http://localhost:3000/learn/updating-arrays-in-state">数组</a>。</li>
<li><strong>每个 action 都描述了一个单一的用户交互，即使它会引发数据的多个变化。</strong> 举个例子，如果用户在一个由 <code>reducer</code> 管理的表单（包含五个表单项）中点击了 <code>重置按钮</code>，那么 dispatch 一个 <code>reset_form</code> 的 action 比 dispatch 五个单独的 <code>set_field</code> 的 action 更加合理。如果你在一个 <code>reducer</code> 中打印了所有的 <code>action</code> 日志，那么这个日志应该是很清晰的，它能让你以某种步骤复现已发生的交互或响应。这对代码调试很有帮助！</li>
</ul>
<p><mark>使用 Immer 简化 reducers</mark>：与在平常的 state 中 <a target="_blank" rel="noopener" href="http://localhost:3000/learn/updating-objects-in-state#write-concise-update-logic-with-immer">修改对象</a> 和 <a target="_blank" rel="noopener" href="http://localhost:3000/learn/updating-arrays-in-state#write-concise-update-logic-with-immer">数组</a> 一样，你可以使用 <code>Immer</code> 这个库来简化 <code>reducer</code>。在这里，<a target="_blank" rel="noopener" href="https://github.com/immerjs/use-immer#useimmerreducer"><code>useImmerReducer</code></a> 让你可以通过 <code>push</code> 或 <code>arr[i] =</code> 来修改 state ：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-9olky6lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-9olky6lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useImmerReducer &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;use-immer&#x27;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-title class_">AddTask</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./AddTask.js&#x27;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-title class_">TaskList</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./TaskList.js&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">tasksReducer</span>(<span class="hljs-params">draft, action</span>) &#123;<br>  <span class="hljs-keyword">switch</span> (action.<span class="hljs-property">type</span>) &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;added&#x27;</span>: &#123;<br>      draft.<span class="hljs-title function_">push</span>(&#123;<br>        <span class="hljs-attr">id</span>: action.<span class="hljs-property">id</span>,<br>        <span class="hljs-attr">text</span>: action.<span class="hljs-property">text</span>,<br>        <span class="hljs-attr">done</span>: <span class="hljs-literal">false</span>,<br>      &#125;);<br>      <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;changed&#x27;</span>: &#123;<br>      <span class="hljs-keyword">const</span> index = draft.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> t.<span class="hljs-property">id</span> === action.<span class="hljs-property">task</span>.<span class="hljs-property">id</span>);<br>      draft[index] = action.<span class="hljs-property">task</span>;<br>      <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;deleted&#x27;</span>: &#123;<br>      <span class="hljs-keyword">return</span> draft.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> t.<span class="hljs-property">id</span> !== action.<span class="hljs-property">id</span>);<br>    &#125;<br>    <span class="hljs-attr">default</span>: &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;未知 action：&#x27;</span> + action.<span class="hljs-property">type</span>);<br>    &#125;<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">TaskApp</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [tasks, dispatch] = <span class="hljs-title function_">useImmerReducer</span>(tasksReducer, initialTasks);<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleAddTask</span>(<span class="hljs-params">text</span>) &#123;<br>    <span class="hljs-title function_">dispatch</span>(&#123;<br>      <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;added&#x27;</span>,<br>      <span class="hljs-attr">id</span>: nextId++,<br>      <span class="hljs-attr">text</span>: text,<br>    &#125;);<br>  &#125;<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleChangeTask</span>(<span class="hljs-params">task</span>) &#123;<br>    <span class="hljs-title function_">dispatch</span>(&#123;<br>      <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;changed&#x27;</span>,<br>      <span class="hljs-attr">task</span>: task,<br>    &#125;);<br>  &#125;<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleDeleteTask</span>(<span class="hljs-params">taskId</span>) &#123;<br>    <span class="hljs-title function_">dispatch</span>(&#123;<br>      <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;deleted&#x27;</span>,<br>      <span class="hljs-attr">id</span>: taskId,<br>    &#125;);<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>布拉格的行程安排<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">AddTask</span> <span class="hljs-attr">onAddTask</span>=<span class="hljs-string">&#123;handleAddTask&#125;</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">TaskList</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">tasks</span>=<span class="hljs-string">&#123;tasks&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">onChangeTask</span>=<span class="hljs-string">&#123;handleChangeTask&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">onDeleteTask</span>=<span class="hljs-string">&#123;handleDeleteTask&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">let</span> nextId = <span class="hljs-number">3</span>;<br><span class="hljs-keyword">const</span> initialTasks = [<br>  &#123;<span class="hljs-attr">id</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">&#x27;参观卡夫卡博物馆&#x27;</span>, <span class="hljs-attr">done</span>: <span class="hljs-literal">true</span>&#125;,<br>  &#123;<span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">&#x27;看木偶戏&#x27;</span>, <span class="hljs-attr">done</span>: <span class="hljs-literal">false</span>&#125;,<br>  &#123;<span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">&#x27;打卡列侬墙&#x27;</span>, <span class="hljs-attr">done</span>: <span class="hljs-literal">false</span>&#125;,<br>];<br></code></pre></td></tr></table></div></figure>

<p>Reducers 应该是纯净的，所以它们不应该去修改 state。而 Immer 为你提供了一种特殊的 <code>draft</code> 对象，你可以通过它安全的修改 state。在底层，Immer 会基于当前 state 创建一个副本。这就是为什么通过 <code>useImmerReducer</code> 来管理 reducers 时，可以修改第一个参数，且不需要返回一个新的 state 的原因。</p>
<h2 id="6-使用-Context-深层传递参数"><a href="#6-使用-Context-深层传递参数" class="headerlink" title="6.使用 Context 深层传递参数"></a>6.使用 Context 深层传递参数</h2><p>通常来说，你会通过 props 将信息从父组件传递到子组件。但是，如果你必须通过许多中间组件向下传递 props，或是在你应用中的许多组件需要相同的信息，传递 props 会变的十分冗长和不便。<mark><strong>Context</strong> 允许父组件向其下层无论多深的任何组件提供信息，而无需通过 props 显式传递。</mark></p>
<p><mark>传递 props 带来的问题</mark>：<a target="_blank" rel="noopener" href="http://localhost:3000/learn/passing-props-to-a-component">传递 props</a> 是将数据通过 UI 树显式传递到使用它的组件的好方法。</p>
<p>但是当你需要在组件树中深层传递参数以及需要在组件间复用相同的参数时，传递 props 就会变得很麻烦。最近的根节点父组件可能离需要数据的组件很远，<a target="_blank" rel="noopener" href="http://localhost:3000/learn/sharing-state-between-components">状态提升</a> 到太高的层级会导致 “逐层传递 props” 的情况。</p>
<img src="image-20231110160115640.png" srcset="/img/loading.gif" lazyload alt="image-20231110160115640" style="zoom:50%;" />

<p>React 的 context 功能可以在组件树中不需要 props 将数据“直达”到所需的组件中。</p>
<p> <mark>Context：传递 props 的另一种方法</mark>：Context 让父组件可以为它下面的整个组件树提供数据。</p>
<p>思考一下这个 <code>Heading</code> 组件接收一个 <code>level</code> 参数来决定它标题尺寸的场景：</p>
<p>Heading.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-ilbntjlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-ilbntjlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Heading</span>(<span class="hljs-params">&#123; level, children &#125;</span>) &#123;<br>  <span class="hljs-keyword">switch</span> (level) &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>      <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>&#123;children&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>      <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>&#123;children&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:<br>      <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>&#123;children&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span></span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>:<br>      <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>&#123;children&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span></span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">5</span>:<br>      <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">h5</span>&gt;</span>&#123;children&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h5</span>&gt;</span></span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">6</span>:<br>      <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">h6</span>&gt;</span>&#123;children&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h6</span>&gt;</span></span>;<br>    <span class="hljs-attr">default</span>:<br>      <span class="hljs-keyword">throw</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;未知的 level：&#x27;</span> + level);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>Section.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-fx4kallqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-fx4kallqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Section</span>(<span class="hljs-params">&#123; children &#125;</span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">section</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;section&quot;</span>&gt;</span></span><br><span class="language-xml">      &#123;children&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>App.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-1wlvohlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-1wlvohlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Heading</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./Heading.js&#x27;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-title class_">Section</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./Section.js&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Page</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Section</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Heading</span> <span class="hljs-attr">level</span>=<span class="hljs-string">&#123;1&#125;</span>&gt;</span>主标题<span class="hljs-tag">&lt;/<span class="hljs-name">Heading</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Heading</span> <span class="hljs-attr">level</span>=<span class="hljs-string">&#123;2&#125;</span>&gt;</span>副标题<span class="hljs-tag">&lt;/<span class="hljs-name">Heading</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Heading</span> <span class="hljs-attr">level</span>=<span class="hljs-string">&#123;3&#125;</span>&gt;</span>子标题<span class="hljs-tag">&lt;/<span class="hljs-name">Heading</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Heading</span> <span class="hljs-attr">level</span>=<span class="hljs-string">&#123;4&#125;</span>&gt;</span>子子标题<span class="hljs-tag">&lt;/<span class="hljs-name">Heading</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Heading</span> <span class="hljs-attr">level</span>=<span class="hljs-string">&#123;5&#125;</span>&gt;</span>子子子标题<span class="hljs-tag">&lt;/<span class="hljs-name">Heading</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Heading</span> <span class="hljs-attr">level</span>=<span class="hljs-string">&#123;6&#125;</span>&gt;</span>子子子子标题<span class="hljs-tag">&lt;/<span class="hljs-name">Heading</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">Section</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>假设你想让相同 <code>Section</code> 中的多个 Heading 具有相同的尺寸：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-dhf96olqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-dhf96olqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jsx">&lt;<span class="hljs-title class_">Section</span>&gt;<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Heading</span> <span class="hljs-attr">level</span>=<span class="hljs-string">&#123;3&#125;</span>&gt;</span>关于<span class="hljs-tag">&lt;/<span class="hljs-name">Heading</span>&gt;</span></span><br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Heading</span> <span class="hljs-attr">level</span>=<span class="hljs-string">&#123;3&#125;</span>&gt;</span>照片<span class="hljs-tag">&lt;/<span class="hljs-name">Heading</span>&gt;</span></span><br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Heading</span> <span class="hljs-attr">level</span>=<span class="hljs-string">&#123;3&#125;</span>&gt;</span>视频<span class="hljs-tag">&lt;/<span class="hljs-name">Heading</span>&gt;</span></span><br>&lt;/<span class="hljs-title class_">Section</span>&gt;<br></code></pre></td></tr></table></div></figure>

<p>将 <code>level</code> 参数传递给 <code>&lt;Section&gt;</code> 组件而不是传给 <code>&lt;Heading&gt;</code> 组件看起来更好一些。这样的话你可以强制使同一个 section 中的所有标题都有相同的尺寸：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-6hgvd5lqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-6hgvd5lqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jsx">&lt;<span class="hljs-title class_">Section</span> level=&#123;<span class="hljs-number">3</span>&#125;&gt;<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Heading</span>&gt;</span>关于<span class="hljs-tag">&lt;/<span class="hljs-name">Heading</span>&gt;</span></span><br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Heading</span>&gt;</span>照片<span class="hljs-tag">&lt;/<span class="hljs-name">Heading</span>&gt;</span></span><br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Heading</span>&gt;</span>视频<span class="hljs-tag">&lt;/<span class="hljs-name">Heading</span>&gt;</span></span><br>&lt;/<span class="hljs-title class_">Section</span>&gt;<br></code></pre></td></tr></table></div></figure>

<p>但是 <code>&lt;Heading&gt;</code> 组件是如何知道离它最近的 <code>&lt;Section&gt;</code> 的 level 的呢？**<mark>这需要子组件可以通过某种方式“访问”到组件树中某处在其上层的数据。</mark>**</p>
<p>你不能只通过 props 来实现它。这就是 context 大显身手的地方。</p>
<p><mark>Context 可以让父节点，甚至是很远的父节点都可以为其内部的整个组件树提供数据。</mark></p>
<img src="image-20231110160909884.png" srcset="/img/loading.gif" lazyload alt="image-20231110160909884" style="zoom:50%;" />

<p>你可以通过以下三个步骤来实现它：</p>
<ol>
<li><p><strong>创建</strong> 一个 context。（你可以将其命名为 <code>LevelContext</code>, 因为它表示的是标题级别。)</p>
<p>LevelContext.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-45fcwmlqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-45fcwmlqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; createContext &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">LevelContext</span> = <span class="hljs-title function_">createContext</span>(<span class="hljs-number">1</span>);<br></code></pre></td></tr></table></div></figure>

<p><code>createContext</code> 只需<strong>默认值</strong>一个参数。在这里, <code>1</code> 表示最大的标题级别，但是你可以传递任何类型的值（甚至可以传入一个对象）。</p>
</li>
<li><p>在需要数据的组件内 <strong>使用</strong> 刚刚创建的 context。（<code>Heading</code> 将会使用 <code>LevelContext</code>。）</p>
<p>从 React 中引入 <code>useContext</code> Hook 以及你刚刚创建的 context:</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-z3nloglqadar0r" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-z3nloglqadar0r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useContext &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">LevelContext</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./LevelContext.js&#x27;</span>;<br></code></pre></td></tr></table></div></figure>

<p>目前，<code>Heading</code> 组件从 props 中读取 <code>level</code>：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-e9kw0klqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-e9kw0klqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Heading</span>(<span class="hljs-params">&#123; level, children &#125;</span>) &#123;<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>删掉 <code>level</code> 参数并从你刚刚引入的 <code>LevelContext</code> 中读取值：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-5v1n8elqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-5v1n8elqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Heading</span>(<span class="hljs-params">&#123; children &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> level = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">LevelContext</span>);<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p><code>useContext</code> 是一个 Hook。和 <code>useState</code> 以及 <code>useReducer</code>一样，你只能在 React 组件中（不是循环或者条件里）立即调用 Hook。**<code>useContext</code> 告诉 React <code>Heading</code> 组件想要读取 <code>LevelContext</code>。**</p>
<p>现在 <code>Heading</code> 组件没有 <code>level</code> 参数，你不需要再像这样在你的 JSX 中将 level 参数传递给 <code>Heading</code>：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-wgngl1lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-wgngl1lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jsx">&lt;<span class="hljs-title class_">Section</span>&gt;<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Heading</span> <span class="hljs-attr">level</span>=<span class="hljs-string">&#123;4&#125;</span>&gt;</span>子子标题<span class="hljs-tag">&lt;/<span class="hljs-name">Heading</span>&gt;</span></span><br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Heading</span> <span class="hljs-attr">level</span>=<span class="hljs-string">&#123;4&#125;</span>&gt;</span>子子标题<span class="hljs-tag">&lt;/<span class="hljs-name">Heading</span>&gt;</span></span><br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Heading</span> <span class="hljs-attr">level</span>=<span class="hljs-string">&#123;4&#125;</span>&gt;</span>子子标题<span class="hljs-tag">&lt;/<span class="hljs-name">Heading</span>&gt;</span></span><br>&lt;/<span class="hljs-title class_">Section</span>&gt;<br></code></pre></td></tr></table></div></figure>

<p>修改一下 JSX，让 <code>Section</code> 组件代替 <code>Heading</code> 组件接收 level 参数：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-5f83y6lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-5f83y6lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jsx">&lt;<span class="hljs-title class_">Section</span> level=&#123;<span class="hljs-number">4</span>&#125;&gt;<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Heading</span>&gt;</span>子子标题<span class="hljs-tag">&lt;/<span class="hljs-name">Heading</span>&gt;</span></span><br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Heading</span>&gt;</span>子子标题<span class="hljs-tag">&lt;/<span class="hljs-name">Heading</span>&gt;</span></span><br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Heading</span>&gt;</span>子子标题<span class="hljs-tag">&lt;/<span class="hljs-name">Heading</span>&gt;</span></span><br>&lt;/<span class="hljs-title class_">Section</span>&gt;<br></code></pre></td></tr></table></div></figure>
</li>
<li><p>在指定数据的组件中 <strong>提供</strong> 这个 context。 （<code>Section</code> 将会提供 <code>LevelContext</code>。）</p>
<p><strong>把它们用 context provider 包裹起来</strong>  以提供 <code>LevelContext</code> 给它们：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-dfpbyulqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-dfpbyulqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">LevelContext</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./LevelContext.js&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Section</span>(<span class="hljs-params">&#123; level, children &#125;</span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">section</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;section&quot;</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">LevelContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;level&#125;</span>&gt;</span></span><br><span class="language-xml">        &#123;children&#125;   <span class="hljs-tag">&lt;/<span class="hljs-name">LevelContext.Provider</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>这告诉 React：“如果在 <code>&lt;Section&gt;</code> 组件中的任何子组件请求 <code>LevelContext</code>，给他们这个 <code>level</code>。”组件会使用 UI 树中在它上层最近的那个 <code>&lt;LevelContext.Provider&gt;</code> 传递过来的值。</p>
<p>不需要向每个 <code>Heading</code> 组件传递 <code>level</code> 参数了！取而代之的是，它通过访问上层最近的 <code>Section</code> 来“断定”它的标题级别：</p>
<ol>
<li>你将一个 <code>level</code> 参数传递给 <code>&lt;Section&gt;</code>。</li>
<li><code>Section</code> 把它的子元素包在 <code>&lt;LevelContext.Provider value=&#123;level&#125;&gt;</code> 里面。</li>
<li><code>Heading</code> 使用 <code>useContext(LevelContext)</code> 访问上层最近的 <code>LevelContext</code> 提供的值。</li>
</ol>
</li>
</ol>
<p><mark>在相同的组件中使用并提供 context </mark>：目前，你仍需要手动指定每个 section 的 <code>level</code>：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-ed7gualqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-ed7gualqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Page</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    &lt;Section level=&#123;1&#125;&gt;<br>      ...<br>      &lt;Section level=&#123;2&#125;&gt;<br>        ...<br>        &lt;Section level=&#123;3&#125;&gt;<br>          ...<br></code></pre></td></tr></table></div></figure>

<p>由于 context 让你可以从上层的组件读取信息，每个 <code>Section</code> 都会从上层的 <code>Section</code> 读取 <code>level</code>，并自动向下层传递 <code>level + 1</code>。 你可以像下面这样做：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-mzh128lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-mzh128lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useContext &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">LevelContext</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./LevelContext.js&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Section</span>(<span class="hljs-params">&#123; children &#125;</span>) &#123;<br><br>  <span class="hljs-keyword">const</span> level = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">LevelContext</span>);<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">section</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;section&quot;</span>&gt;</span>     <span class="hljs-tag">&lt;<span class="hljs-name">LevelContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;level</span> + <span class="hljs-attr">1</span>&#125;&gt;</span></span><br><span class="language-xml">        &#123;children&#125;</span><br><span class="language-xml"> <span class="hljs-tag">&lt;/<span class="hljs-name">LevelContext.Provider</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>这样修改之后，你不用将 <code>level</code> 参数传给 <code>&lt;Section&gt;</code> <strong>或者是</strong> <code>&lt;Heading&gt;</code> 了：</p>
<p>LevelContext.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-l65tjelqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-l65tjelqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; createContext &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">LevelContext</span> = <span class="hljs-title function_">createContext</span>(<span class="hljs-number">0</span>);<br></code></pre></td></tr></table></div></figure>

<p>App.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-tmu204lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-tmu204lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Heading</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./Heading.js&#x27;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-title class_">Section</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./Section.js&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Page</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Section</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Heading</span>&gt;</span>主标题<span class="hljs-tag">&lt;/<span class="hljs-name">Heading</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Section</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Heading</span>&gt;</span>副标题<span class="hljs-tag">&lt;/<span class="hljs-name">Heading</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Heading</span>&gt;</span>副标题<span class="hljs-tag">&lt;/<span class="hljs-name">Heading</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Heading</span>&gt;</span>副标题<span class="hljs-tag">&lt;/<span class="hljs-name">Heading</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Section</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">Heading</span>&gt;</span>子标题<span class="hljs-tag">&lt;/<span class="hljs-name">Heading</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">Heading</span>&gt;</span>子标题<span class="hljs-tag">&lt;/<span class="hljs-name">Heading</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">Heading</span>&gt;</span>子标题<span class="hljs-tag">&lt;/<span class="hljs-name">Heading</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">Section</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">Heading</span>&gt;</span>子子标题<span class="hljs-tag">&lt;/<span class="hljs-name">Heading</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">Heading</span>&gt;</span>子子标题<span class="hljs-tag">&lt;/<span class="hljs-name">Heading</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">Heading</span>&gt;</span>子子标题<span class="hljs-tag">&lt;/<span class="hljs-name">Heading</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;/<span class="hljs-name">Section</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">Section</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">Section</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">Section</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p><code>Heading</code> 和 <code>Section</code> 都通过读取 <code>LevelContext</code> 来判断它们的深度。而且 <code>Section</code> 把它的子组件都包在 <code>LevelContext</code> 中来指定其中的任何内容都处于一个“更深”的级别。</p>
<p><mark>Context 会穿过中间层级的组件</mark>： 你可以在提供 context 的组件和使用它的组件之间的层级插入任意数量的组件。这包括像 <code>&lt;div&gt;</code> 这样的内置组件和你自己创建的组件。</p>
<p>在这个示例中，相同的 <code>Post</code> 组件（带有虚线边框）在两个不同的嵌套层级上渲染。注意，它内部的 <code>&lt;Heading&gt;</code> 会自动从最近的 <code>&lt;Section&gt;</code> 获取它的级别：</p>
<p>Section.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-emvwsrlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-emvwsrlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useContext &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">LevelContext</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./LevelContext.js&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Section</span>(<span class="hljs-params">&#123; children, isFancy &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> level = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">LevelContext</span>);<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">section</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&#123;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      &#x27;<span class="hljs-attr">section</span> &#x27; +</span></span><br><span class="hljs-tag"><span class="language-xml">      (<span class="hljs-attr">isFancy</span> ? &#x27;<span class="hljs-attr">fancy</span>&#x27; <span class="hljs-attr">:</span> &#x27;&#x27;)</span></span><br><span class="hljs-tag"><span class="language-xml">    &#125;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">LevelContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;level</span> + <span class="hljs-attr">1</span>&#125;&gt;</span></span><br><span class="language-xml">        &#123;children&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">LevelContext.Provider</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>App.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-myxorxlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-myxorxlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Heading</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./Heading.js&#x27;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-title class_">Section</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./Section.js&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ProfilePage</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Section</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Heading</span>&gt;</span>My Profile<span class="hljs-tag">&lt;/<span class="hljs-name">Heading</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Post</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">title</span>=<span class="hljs-string">&quot;旅行者，你好！&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">body</span>=<span class="hljs-string">&quot;来看看我的冒险。&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">AllPosts</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">Section</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">AllPosts</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Section</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Heading</span>&gt;</span>帖子<span class="hljs-tag">&lt;/<span class="hljs-name">Heading</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">RecentPosts</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">Section</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">RecentPosts</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Section</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Heading</span>&gt;</span>最近的帖子<span class="hljs-tag">&lt;/<span class="hljs-name">Heading</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Post</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">title</span>=<span class="hljs-string">&quot;里斯本的味道&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">body</span>=<span class="hljs-string">&quot;...那些蛋挞！&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Post</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">title</span>=<span class="hljs-string">&quot;探戈节奏中的布宜诺斯艾利斯&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">body</span>=<span class="hljs-string">&quot;我爱它！&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">Section</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Post</span>(<span class="hljs-params">&#123; title, body &#125;</span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Section</span> <span class="hljs-attr">isFancy</span>=<span class="hljs-string">&#123;true&#125;</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Heading</span>&gt;</span></span><br><span class="language-xml">        &#123;title&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">Heading</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span>&gt;</span>&#123;body&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">Section</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<img src="image-20231110171520033.png" srcset="/img/loading.gif" lazyload alt="image-20231110171520033" style="zoom:50%;" />

<p><strong><mark>Context 让你可以编写“适应周围环境”的组件，并且根据 在哪 （或者说 在哪个 context 中）来渲染它们不同的样子。</mark></strong></p>
<p>Context 的工作方式可能会让你想起 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/CSS/inheritance">CSS 属性继承</a>。在 CSS 中，你可以为一个 <code>&lt;div&gt;</code> 手动指定 <code>color: blue</code>，并且其中的任何 DOM 节点，无论多深，都会继承那个颜色，除非中间的其他 DOM 节点用 <code>color: green</code> 来覆盖它。类似地，在 React 中，覆盖来自上层的某些 context 的唯一方法是将子组件包裹到一个提供不同值的 context provider 中。</p>
<p>在 CSS 中，诸如 <code>color</code> 和 <code>background-color</code> 之类的不同属性不会覆盖彼此。你可以设置所有 <code>&lt;div&gt;</code> 的 <code>color</code> 为红色，而不会影响 <code>background-color</code>。类似地，<strong>不同的 React context 不会覆盖彼此</strong>。你通过 <code>createContext()</code> 创建的每个 context 都和其他 context 完全分离，只有使用和提供 <strong>那个特定的</strong> context 的组件才会联系在一起。一个组件可以轻松地使用或者提供许多不同的 context。</p>
<p><strong>如果你只想把一些 props 传递到多个层级中，这并不意味着你需要把这些信息放到 context 里。</strong></p>
<p>在使用 context 之前，你可以考虑以下几种替代方案：</p>
<ol>
<li>**<mark>从 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/passing-props-to-a-component">传递 props</a> 开始</mark>**： 如果你的组件看起来不起眼，那么通过十几个组件向下传递一堆 props 并不罕见。这有点像是在埋头苦干，但是这样做可以让哪些组件用了哪些数据变得十分清晰！维护你代码的人会很高兴你用 props 让数据流变得更加清晰。</li>
<li>**<mark>抽象组件并 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/passing-props-to-a-component#passing-jsx-as-children">将 JSX 作为 <code>children</code> 传递</a> 给它们</mark>**： 如果你通过很多层不使用该数据的中间组件（并且只会向下传递）来传递数据，这通常意味着你在此过程中忘记了抽象组件。举个例子，你可能想传递一些像 <code>posts</code> 的数据 props 到不会直接使用这个参数的组件，类似 <code>&lt;Layout posts=&#123;posts&#125; /&gt;</code>。取而代之的是，让 <code>Layout</code> 把 <code>children</code> 当做一个参数，然后渲染 <code>&lt;Layout&gt;&lt;Posts posts=&#123;posts&#125; /&gt;&lt;/Layout&gt;</code>。这样就减少了定义数据的组件和使用数据的组件之间的层级。</li>
</ol>
<p>如果这两种方法都不适合你，再考虑使用 context。</p>
<p><mark>Context 的使用场景 </mark>：</p>
<ul>
<li><strong>主题：</strong> 如果你的应用允许用户更改其外观（例如暗夜模式），你可以在应用顶层放一个 context provider，并在需要调整其外观的组件中使用该 context。</li>
<li><strong>当前账户：</strong> 许多组件可能需要知道当前登录的用户信息。将它放到 context 中可以方便地在树中的任何位置读取它。某些应用还允许你同时操作多个账户（例如，以不同用户的身份发表评论）。在这些情况下，将 UI 的一部分包裹到具有不同账户数据的 provider 中会很方便。</li>
<li><strong>路由：</strong> 大多数路由解决方案在其内部使用 context 来保存当前路由。这就是每个链接“知道”它是否处于活动状态的方式。如果你创建自己的路由库，你可能也会这么做。</li>
<li><strong>状态管理：</strong> 随着你的应用的增长，最终在靠近应用顶部的位置可能会有很多 state。许多遥远的下层组件可能想要修改它们。通常 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/scaling-up-with-reducer-and-context">将 reducer 与 context 搭配使用</a>来管理复杂的状态并将其传递给深层的组件来避免过多的麻烦。</li>
</ul>
<p>Context 不局限于静态值。如果你在下一次渲染时传递不同的值，React 将会更新读取它的所有下层组件！这就是 context 经常和 state 结合使用的原因。</p>
<p>一般而言，如果树中不同部分的远距离组件需要某些信息，context 将会对你大有帮助。</p>
<h2 id="7-使用-Reducer-和-Context-拓展你的应用"><a href="#7-使用-Reducer-和-Context-拓展你的应用" class="headerlink" title="7.使用 Reducer 和 Context 拓展你的应用"></a>7.使用 Reducer 和 Context 拓展你的应用</h2><p>Reducer 可以整合组件的状态更新逻辑。Context 可以将信息深入传递给其他组件。你可以组合使用它们来共同管理一个复杂页面的状态。</p>
<p>Reducer 有助于保持事件处理程序的简短明了。但随着应用规模越来越庞大，你就可能会遇到别的困难。<strong>目前，<code>tasks</code> 状态和 <code>dispatch</code> 函数仅在顶级 <code>TaskApp</code> 组件中可用</strong>。要让其他组件读取任务列表或更改它，你必须显式 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/passing-props-to-a-component">传递</a> 当前状态和事件处理程序，将其作为 props。</p>
<p>例如，<code>TaskApp</code> 将 一系列 task 和事件处理程序传递给 <code>TaskList</code>：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-l3ywcalqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-l3ywcalqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jsx">&lt;<span class="hljs-title class_">TaskList</span><br>  tasks=&#123;tasks&#125;<br>  onChangeTask=&#123;handleChangeTask&#125;<br>  onDeleteTask=&#123;handleDeleteTask&#125;<br>/&gt;<br></code></pre></td></tr></table></div></figure>

<p><code>TaskList</code> 将事件处理程序传递给 <code>Task</code>：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-zjmxu7lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-zjmxu7lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jsx">&lt;<span class="hljs-title class_">Task</span><br>  task=&#123;task&#125;<br>  onChange=&#123;onChangeTask&#125;<br>  onDelete=&#123;onDeleteTask&#125;<br>/&gt;<br></code></pre></td></tr></table></div></figure>

<p>在像这样的小示例里这样做没什么问题，但是如果你有成千上百个组件，传递所有状态和函数可能会非常麻烦！</p>
<p>这就是为什么，比起通过 props 传递它们，你可能想把 <code>tasks</code> 状态和 <code>dispatch</code> 函数都 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/passing-data-deeply-with-context">放入 context</a>。<strong>这样，所有的在 <code>TaskApp</code> 组件树之下的组件都不必一直往下传 props 而可以直接读取 tasks 和 dispatch 函数</strong>。</p>
<p>结合使用 reducer 和 context：</p>
<ol>
<li><p><strong>创建</strong> context：<code>useReducer</code> 返回当前的 <code>tasks</code> 和 <code>dispatch</code> 函数来让你更新它们：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-c96gbzlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-c96gbzlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> [tasks, dispatch] = <span class="hljs-title function_">useReducer</span>(tasksReducer, initialTasks);<br></code></pre></td></tr></table></div></figure>

<p>为了将它们从组件树往下传，你将 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/passing-data-deeply-with-context#step-2-use-the-context">创建</a> 两个不同的 context：</p>
<ul>
<li><code>TasksContext</code> 提供当前的 tasks 列表。</li>
<li><code>TasksDispatchContext</code> 提供了一个函数可以让组件分发动作。</li>
</ul>
<p>将它们从单独的文件导出，以便以后可以从其他文件导入它们：</p>
<p>TasksContext.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-ypdfx0lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-ypdfx0lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; createContext &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">TasksContext</span> = <span class="hljs-title function_">createContext</span>(<span class="hljs-literal">null</span>);<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">TasksDispatchContext</span> = <span class="hljs-title function_">createContext</span>(<span class="hljs-literal">null</span>);<br></code></pre></td></tr></table></div></figure>

<p>把 <code>null</code> 作为默认值传递给两个 context。实际值是由 <code>TaskApp</code> 组件提供的。</p>
</li>
<li><p>将 state 和 dispatch <strong>放入</strong> context：现在，你可以将所有的 context 导入 <code>TaskApp</code> 组件。获取 <code>useReducer()</code> 返回的 <code>tasks</code> 和 <code>dispatch</code> 并将它们 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/passing-data-deeply-with-context#step-3-provide-the-context">提供</a> 给整个组件树：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-ja7d64lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-ja7d64lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">TasksContext</span>, <span class="hljs-title class_">TasksDispatchContext</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./TasksContext.js&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">TaskApp</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [tasks, dispatch] = <span class="hljs-title function_">useReducer</span>(tasksReducer, initialTasks);<br>  <span class="hljs-comment">// ...</span><br>  <span class="hljs-keyword">return</span> ( <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">TasksContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;tasks&#125;</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">TasksDispatchContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;dispatch&#125;</span>&gt;</span></span><br><span class="language-xml">        ...</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">TasksDispatchContext.Provider</span>&gt;</span>    <span class="hljs-tag">&lt;/<span class="hljs-name">TasksContext.Provider</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>现在，你可以同时通过 props 和 context 传递信息：</p>
<p>App.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-iqi1j7lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-iqi1j7lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useReducer &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-title class_">AddTask</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./AddTask.js&#x27;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-title class_">TaskList</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./TaskList.js&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">TasksContext</span>, <span class="hljs-title class_">TasksDispatchContext</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./TasksContext.js&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">TaskApp</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [tasks, dispatch] = <span class="hljs-title function_">useReducer</span>(<br>    tasksReducer,<br>    initialTasks<br>  );<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleAddTask</span>(<span class="hljs-params">text</span>) &#123;<br>    <span class="hljs-title function_">dispatch</span>(&#123;<br>      <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;added&#x27;</span>,<br>      <span class="hljs-attr">id</span>: nextId++,<br>      <span class="hljs-attr">text</span>: text,<br>    &#125;);<br>  &#125;<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleChangeTask</span>(<span class="hljs-params">task</span>) &#123;<br>    <span class="hljs-title function_">dispatch</span>(&#123;<br>      <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;changed&#x27;</span>,<br>      <span class="hljs-attr">task</span>: task<br>    &#125;);<br>  &#125;<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleDeleteTask</span>(<span class="hljs-params">taskId</span>) &#123;<br>    <span class="hljs-title function_">dispatch</span>(&#123;<br>      <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;deleted&#x27;</span>,<br>      <span class="hljs-attr">id</span>: taskId<br>    &#125;);<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">TasksContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;tasks&#125;</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">TasksDispatchContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;dispatch&#125;</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Day off in Kyoto<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">AddTask</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">onAddTask</span>=<span class="hljs-string">&#123;handleAddTask&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        /&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">TaskList</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">tasks</span>=<span class="hljs-string">&#123;tasks&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">onChangeTask</span>=<span class="hljs-string">&#123;handleChangeTask&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">onDeleteTask</span>=<span class="hljs-string">&#123;handleDeleteTask&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">TasksDispatchContext.Provider</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">TasksContext.Provider</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">tasksReducer</span>(<span class="hljs-params">tasks, action</span>) &#123;<br>  <span class="hljs-keyword">switch</span> (action.<span class="hljs-property">type</span>) &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;added&#x27;</span>: &#123;<br>      <span class="hljs-keyword">return</span> [...tasks, &#123;<br>        <span class="hljs-attr">id</span>: action.<span class="hljs-property">id</span>,<br>        <span class="hljs-attr">text</span>: action.<span class="hljs-property">text</span>,<br>        <span class="hljs-attr">done</span>: <span class="hljs-literal">false</span><br>      &#125;];<br>    &#125;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;changed&#x27;</span>: &#123;<br>      <span class="hljs-keyword">return</span> tasks.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> &#123;<br>        <span class="hljs-keyword">if</span> (t.<span class="hljs-property">id</span> === action.<span class="hljs-property">task</span>.<span class="hljs-property">id</span>) &#123;<br>          <span class="hljs-keyword">return</span> action.<span class="hljs-property">task</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-keyword">return</span> t;<br>        &#125;<br>      &#125;);<br>    &#125;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;deleted&#x27;</span>: &#123;<br>      <span class="hljs-keyword">return</span> tasks.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> t.<span class="hljs-property">id</span> !== action.<span class="hljs-property">id</span>);<br>    &#125;<br>    <span class="hljs-attr">default</span>: &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;Unknown action: &#x27;</span> + action.<span class="hljs-property">type</span>);<br>    &#125;<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">let</span> nextId = <span class="hljs-number">3</span>;<br><span class="hljs-keyword">const</span> initialTasks = [<br>  &#123; <span class="hljs-attr">id</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">&#x27;Philosopher’s Path&#x27;</span>, <span class="hljs-attr">done</span>: <span class="hljs-literal">true</span> &#125;,<br>  &#123; <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">&#x27;Visit the temple&#x27;</span>, <span class="hljs-attr">done</span>: <span class="hljs-literal">false</span> &#125;,<br>  &#123; <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">&#x27;Drink matcha&#x27;</span>, <span class="hljs-attr">done</span>: <span class="hljs-literal">false</span> &#125;<br>];<br></code></pre></td></tr></table></div></figure>
</li>
<li><p>在组件树的任何地方 <strong>使用</strong> context：</p>
</li>
<li><p>现在你不需要将 tasks 和事件处理程序在组件树中传递：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-c6bps7lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-c6bps7lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs jsx">&lt;<span class="hljs-title class_">TasksContext</span>.<span class="hljs-property">Provider</span> value=&#123;tasks&#125;&gt;<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">TasksDispatchContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;dispatch&#125;</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Day off in Kyoto<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">AddTask</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">TaskList</span> /&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;/<span class="hljs-name">TasksDispatchContext.Provider</span>&gt;</span></span><br>&lt;/<span class="hljs-title class_">TasksContext</span>.<span class="hljs-property">Provider</span>&gt;<br></code></pre></td></tr></table></div></figure>

<p>相反，任何需要 tasks 的组件都可以从 <code>TaskContext</code> 中读取它：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-gfzo9dlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-gfzo9dlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">TaskList</span>(<span class="hljs-params"></span>) &#123;<br><br>  <span class="hljs-keyword">const</span> tasks = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">TasksContext</span>);<br>  <span class="hljs-comment">// ...</span><br></code></pre></td></tr></table></div></figure>

<p>任何组件都可以从 context 中读取 <code>dispatch</code> 函数并调用它，从而更新任务列表：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-mb7ff0lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-mb7ff0lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">AddTask</span>(<span class="hljs-params"></span>) &#123;<br><br>  <span class="hljs-keyword">const</span> [text, setText] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;&#x27;</span>);<br><br>  <span class="hljs-keyword">const</span> dispatch = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">TasksDispatchContext</span>);<br>  <span class="hljs-comment">// ...</span><br>  <span class="hljs-keyword">return</span> (<br>    <span class="hljs-comment">// ...</span><br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> &#123;</span><br><span class="language-xml">      setText(&#x27;&#x27;);</span><br><span class="language-xml">      dispatch(&#123;</span><br><span class="language-xml">        type: &#x27;added&#x27;,</span><br><span class="language-xml">        id: nextId++,</span><br><span class="language-xml">        text: text,</span><br><span class="language-xml">      &#125;);</span><br><span class="language-xml">    &#125;&#125;&gt;Add<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br>    <span class="hljs-comment">// ...</span><br></code></pre></td></tr></table></div></figure>

<p><mark><strong><code>TaskApp</code> 组件不会向下传递任何事件处理程序，<code>TaskList</code> 也不会</strong>。每个组件都会读取它需要的 context</mark>：</p>
<p>TaskList.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-h2cyxxlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-h2cyxxlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState, useContext &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">TasksContext</span>, <span class="hljs-title class_">TasksDispatchContext</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./TasksContext.js&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">TaskList</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> tasks = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">TasksContext</span>);<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span></span><br><span class="language-xml">      &#123;tasks.map(task =&gt; (</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;task.id&#125;</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">Task</span> <span class="hljs-attr">task</span>=<span class="hljs-string">&#123;task&#125;</span> /&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span><br><span class="language-xml">      ))&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Task</span>(<span class="hljs-params">&#123; task &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> [isEditing, setIsEditing] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);<br>  <span class="hljs-keyword">const</span> dispatch = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">TasksDispatchContext</span>);<br>  <span class="hljs-keyword">let</span> taskContent;<br>  <span class="hljs-keyword">if</span> (isEditing) &#123;<br>    taskContent = (<br>      <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">input</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;task.text&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> &#123;</span><br><span class="language-xml">            dispatch(&#123;</span><br><span class="language-xml">              type: &#x27;changed&#x27;,</span><br><span class="language-xml">              task: &#123;</span><br><span class="language-xml">                ...task,</span><br><span class="language-xml">                text: e.target.value</span><br><span class="language-xml">              &#125;</span><br><span class="language-xml">            &#125;);</span><br><span class="language-xml">          &#125;&#125; /&gt;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> setIsEditing(false)&#125;&gt;</span><br><span class="language-xml">          Save</span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/&gt;</span></span><br>    );<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    taskContent = (<br>      <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">        &#123;task.text&#125;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> setIsEditing(true)&#125;&gt;</span><br><span class="language-xml">          Edit</span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/&gt;</span></span><br>    );<br>  &#125;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">input</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;checkbox&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">checked</span>=<span class="hljs-string">&#123;task.done&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> &#123;</span><br><span class="language-xml">          dispatch(&#123;</span><br><span class="language-xml">            type: &#x27;changed&#x27;,</span><br><span class="language-xml">            task: &#123;</span><br><span class="language-xml">              ...task,</span><br><span class="language-xml">              done: e.target.checked</span><br><span class="language-xml">            &#125;</span><br><span class="language-xml">          &#125;);</span><br><span class="language-xml">        &#125;&#125;</span><br><span class="language-xml">      /&gt;</span><br><span class="language-xml">      &#123;taskContent&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> &#123;</span><br><span class="language-xml">        dispatch(&#123;</span><br><span class="language-xml">          type: &#x27;deleted&#x27;,</span><br><span class="language-xml">          id: task.id</span><br><span class="language-xml">        &#125;);</span><br><span class="language-xml">      &#125;&#125;&gt;</span><br><span class="language-xml">        Delete</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p><strong>state 仍然 “存在于” 顶层 <code>Task</code> 组件中，由 <code>useReducer</code> 进行管理</strong>。不过，组件树里的组件只要导入这些 context 之后就可以获取 <code>tasks</code> 和 <code>dispatch</code>。</p>
</li>
</ol>
<p><mark>将相关逻辑迁移到一个文件当中 </mark>：这不是必须的，但你可以通过将 reducer 和 context 移动到单个文件中来进一步整理组件。目前，“TasksContext.js” 仅包含两个 context 声明：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-eacg4vlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-eacg4vlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; createContext &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">TasksContext</span> = <span class="hljs-title function_">createContext</span>(<span class="hljs-literal">null</span>);<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">TasksDispatchContext</span> = <span class="hljs-title function_">createContext</span>(<span class="hljs-literal">null</span>);<br></code></pre></td></tr></table></div></figure>

<p>来给这个文件添加更多代码！将 reducer 移动到此文件中，然后声明一个新的 <code>TasksProvider</code> 组件。此组件将所有部分连接在一起：</p>
<ol>
<li>它将管理 reducer 的状态。</li>
<li>它将提供现有的 context 给组件树。</li>
<li>它将 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/passing-props-to-a-component#passing-jsx-as-children">把 <code>children</code> 作为 prop</a>，所以你可以传递 JSX。</li>
</ol>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-3y620flqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-3y620flqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">TasksProvider</span>(<span class="hljs-params">&#123; children &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> [tasks, dispatch] = <span class="hljs-title function_">useReducer</span>(tasksReducer, initialTasks);<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">TasksContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;tasks&#125;</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">TasksDispatchContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;dispatch&#125;</span>&gt;</span></span><br><span class="language-xml">        &#123;children&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">TasksDispatchContext.Provider</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">TasksContext.Provider</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p><strong>这将使 <code>TaskApp</code> 组件更加直观：</strong></p>
<p>App.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-00av4wlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-00av4wlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">AddTask</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./AddTask.js&#x27;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-title class_">TaskList</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./TaskList.js&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">TasksProvider</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./TasksContext.js&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">TaskApp</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">TasksProvider</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Day off in Kyoto<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">AddTask</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">TaskList</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">TasksProvider</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>你也可以从 <code>TasksContext.js</code> 中导出使用 context 的函数：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-19pv8tlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-19pv8tlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useTasks</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">TasksContext</span>);<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useTasksDispatch</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">TasksDispatchContext</span>);<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>组件可以通过以下函数读取 context：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-fvze6glqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-fvze6glqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> tasks = <span class="hljs-title function_">useTasks</span>();<br><br><span class="hljs-keyword">const</span> dispatch = <span class="hljs-title function_">useTasksDispatch</span>();<br></code></pre></td></tr></table></div></figure>

<p>这不会改变任何行为，但它会允许你之后进一步分割这些 context 或向这些函数添加一些逻辑。<strong>现在所有的 context 和 reducer 连接部分都在 <code>TasksContext.js</code> 中。这保持了组件的干净和整洁，让我们专注于它们显示的内容，而不是它们从哪里获得数据：</strong></p>
<p>TaskList.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-wut727lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-wut727lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; useTasks, useTasksDispatch &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./TasksContext.js&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">TaskList</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> tasks = <span class="hljs-title function_">useTasks</span>();<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span></span><br><span class="language-xml">      &#123;tasks.map(task =&gt; (</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;task.id&#125;</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">Task</span> <span class="hljs-attr">task</span>=<span class="hljs-string">&#123;task&#125;</span> /&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span><br><span class="language-xml">      ))&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Task</span>(<span class="hljs-params">&#123; task &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> [isEditing, setIsEditing] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);<br>  <span class="hljs-keyword">const</span> dispatch = <span class="hljs-title function_">useTasksDispatch</span>();<br>  <span class="hljs-keyword">let</span> taskContent;<br>  <span class="hljs-keyword">if</span> (isEditing) &#123;<br>    taskContent = (<br>      <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">input</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;task.text&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> &#123;</span><br><span class="language-xml">            dispatch(&#123;</span><br><span class="language-xml">              type: &#x27;changed&#x27;,</span><br><span class="language-xml">              task: &#123;</span><br><span class="language-xml">                ...task,</span><br><span class="language-xml">                text: e.target.value</span><br><span class="language-xml">              &#125;</span><br><span class="language-xml">            &#125;);</span><br><span class="language-xml">          &#125;&#125; /&gt;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> setIsEditing(false)&#125;&gt;</span><br><span class="language-xml">          Save</span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/&gt;</span></span><br>    );<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    taskContent = (<br>      <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">        &#123;task.text&#125;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> setIsEditing(true)&#125;&gt;</span><br><span class="language-xml">          Edit</span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/&gt;</span></span><br>    );<br>  &#125;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">input</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;checkbox&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">checked</span>=<span class="hljs-string">&#123;task.done&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> &#123;</span><br><span class="language-xml">          dispatch(&#123;</span><br><span class="language-xml">            type: &#x27;changed&#x27;,</span><br><span class="language-xml">            task: &#123;</span><br><span class="language-xml">              ...task,</span><br><span class="language-xml">              done: e.target.checked</span><br><span class="language-xml">            &#125;</span><br><span class="language-xml">          &#125;);</span><br><span class="language-xml">        &#125;&#125;</span><br><span class="language-xml">      /&gt;</span><br><span class="language-xml">      &#123;taskContent&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> &#123;</span><br><span class="language-xml">        dispatch(&#123;</span><br><span class="language-xml">          type: &#x27;deleted&#x27;,</span><br><span class="language-xml">          id: task.id</span><br><span class="language-xml">        &#125;);</span><br><span class="language-xml">      &#125;&#125;&gt;</span><br><span class="language-xml">        Delete</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>可以将 <code>TasksProvider</code> 视为页面的一部分，它知道如何处理 tasks。<code>useTasks</code> 用来读取它们，<code>useTasksDispatch</code> 用来从组件树下的任何组件更新它们。</p>
<p>AddTask.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-f360r2lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-f360r2lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; useTasksDispatch &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./TasksContext.js&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">AddTask</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [text, setText] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;&#x27;</span>);<br>  <span class="hljs-keyword">const</span> dispatch = <span class="hljs-title function_">useTasksDispatch</span>();<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">input</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;Add task&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;text&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> setText(e.target.value)&#125;</span><br><span class="language-xml">      /&gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> &#123;</span><br><span class="language-xml">        setText(&#x27;&#x27;);</span><br><span class="language-xml">        dispatch(&#123;</span><br><span class="language-xml">          type: &#x27;added&#x27;,</span><br><span class="language-xml">          id: nextId++,</span><br><span class="language-xml">          text: text,</span><br><span class="language-xml">        &#125;); </span><br><span class="language-xml">      &#125;&#125;&gt;Add<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">let</span> nextId = <span class="hljs-number">3</span>;<br></code></pre></td></tr></table></div></figure>

<p>TasksContext.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-kbzrl8lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-kbzrl8lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; createContext, useContext, useReducer &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">TasksContext</span> = <span class="hljs-title function_">createContext</span>(<span class="hljs-literal">null</span>);<br><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">TasksDispatchContext</span> = <span class="hljs-title function_">createContext</span>(<span class="hljs-literal">null</span>);<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">TasksProvider</span>(<span class="hljs-params">&#123; children &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> [tasks, dispatch] = <span class="hljs-title function_">useReducer</span>(<br>    tasksReducer,<br>    initialTasks<br>  );<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">TasksContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;tasks&#125;</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">TasksDispatchContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;dispatch&#125;</span>&gt;</span></span><br><span class="language-xml">        &#123;children&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">TasksDispatchContext.Provider</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">TasksContext.Provider</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useTasks</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">TasksContext</span>);<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useTasksDispatch</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">TasksDispatchContext</span>);<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">tasksReducer</span>(<span class="hljs-params">tasks, action</span>) &#123;<br>  <span class="hljs-keyword">switch</span> (action.<span class="hljs-property">type</span>) &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;added&#x27;</span>: &#123;<br>      <span class="hljs-keyword">return</span> [...tasks, &#123;<br>        <span class="hljs-attr">id</span>: action.<span class="hljs-property">id</span>,<br>        <span class="hljs-attr">text</span>: action.<span class="hljs-property">text</span>,<br>        <span class="hljs-attr">done</span>: <span class="hljs-literal">false</span><br>      &#125;];<br>    &#125;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;changed&#x27;</span>: &#123;<br>      <span class="hljs-keyword">return</span> tasks.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> &#123;<br>        <span class="hljs-keyword">if</span> (t.<span class="hljs-property">id</span> === action.<span class="hljs-property">task</span>.<span class="hljs-property">id</span>) &#123;<br>          <span class="hljs-keyword">return</span> action.<span class="hljs-property">task</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-keyword">return</span> t;<br>        &#125;<br>      &#125;);<br>    &#125;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;deleted&#x27;</span>: &#123;<br>      <span class="hljs-keyword">return</span> tasks.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> t.<span class="hljs-property">id</span> !== action.<span class="hljs-property">id</span>);<br>    &#125;<br>    <span class="hljs-attr">default</span>: &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;Unknown action: &#x27;</span> + action.<span class="hljs-property">type</span>);<br>    &#125;<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">const</span> initialTasks = [<br>  &#123; <span class="hljs-attr">id</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">&#x27;Philosopher’s Path&#x27;</span>, <span class="hljs-attr">done</span>: <span class="hljs-literal">true</span> &#125;,<br>  &#123; <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">&#x27;Visit the temple&#x27;</span>, <span class="hljs-attr">done</span>: <span class="hljs-literal">false</span> &#125;,<br>  &#123; <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">&#x27;Drink matcha&#x27;</span>, <span class="hljs-attr">done</span>: <span class="hljs-literal">false</span> &#125;<br>];<br></code></pre></td></tr></table></div></figure>

<img src="image-20231113101014842.png" srcset="/img/loading.gif" lazyload alt="image-20231113101014842" style="zoom:50%;" />

<p class="note note-success" style="border-left: 4px solid #42b983;padding: 10px 15px;color: #777;background-color: rgba(66, 185, 131, .1);">像 useTasks 和 useTasksDispatch 这样的函数被称为 自定义 Hook。 如果你的函数名以 use 开头，它就被认为是一个自定义 Hook。这让你可以使用其他 Hook，比如 useContext。</p>

<p>随着应用的增长，你可能会有许多这样的 context 和 reducer 的组合。这是一种强大的拓展应用并 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/sharing-state-between-components">提升状态</a> 的方式，让你在组件树深处访问数据时无需进行太多工作。</p>
<h1 id="六-应急方案"><a href="#六-应急方案" class="headerlink" title="六.应急方案"></a>六.应急方案</h1><p>有些组件可能需要控制和同步 React 之外的系统。例如，你可能需要使用浏览器 API 聚焦输入框，或者在没有 React 的情况下实现视频播放器，或者连接并监听远程服务器的消息。</p>
<h2 id="1-使用-ref-引用值"><a href="#1-使用-ref-引用值" class="headerlink" title="1.使用 ref 引用值"></a>1.使用 ref 引用值</h2><p>当你希望组件“记住”某些信息，但又不想让这些信息 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/render-and-commit">触发新的渲染</a> 时，你可以使用 <strong>ref</strong> 。</p>
<p>可以通过从 React 导入 <code>useRef</code> Hook 来为你的组件添加一个 ref：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-5p0q8zlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-5p0q8zlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useRef &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br></code></pre></td></tr></table></div></figure>

<p>在你的组件内，调用 <code>useRef</code> Hook 并传入你想要引用的初始值作为唯一参数。例如，这里的 ref 引用的值是“0”：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-zprti5lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-zprti5lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> ref = <span class="hljs-title function_">useRef</span>(<span class="hljs-number">0</span>);<br></code></pre></td></tr></table></div></figure>

<p><code>useRef</code> 返回一个这样的对象:</p>
<figure class="highlight js"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-0zi324lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-0zi324lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js">&#123; <br>  <span class="hljs-attr">current</span>: <span class="hljs-number">0</span> <span class="hljs-comment">// 你向 useRef 传入的值</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>你可以用 <code>ref.current</code> 属性访问该 ref 的当前值。这个值是有意被设置为可变的，意味着你既可以读取它也可以写入它。就像一个 React 追踪不到的、用来存储组件信息的秘密“口袋”。（这就是让它成为 React 单向数据流的“应急方案”的原因）</p>
<p>每次点击按钮时会使 <code>ref.current</code> 递增：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-f3y9tnlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-f3y9tnlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useRef &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">let</span> ref = <span class="hljs-title function_">useRef</span>(<span class="hljs-number">0</span>);<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"></span>) &#123;<br>    ref.<span class="hljs-property">current</span> = ref.<span class="hljs-property">current</span> + <span class="hljs-number">1</span>;<br>    <span class="hljs-title function_">alert</span>(<span class="hljs-string">&#x27;你点击了 &#x27;</span> + ref.<span class="hljs-property">current</span> + <span class="hljs-string">&#x27; 次！&#x27;</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handleClick&#125;</span>&gt;</span></span><br><span class="language-xml">      点击我！</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>像 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/state-a-components-memory">state</a> 一样，你可以让它指向任何东西：字符串、对象，甚至是函数。与 state 不同的是，ref 是一个普通的 JavaScript 对象，具有可以被读取和修改的 <code>current</code> 属性。</p>
<p>请注意，<strong>组件不会在每次递增时重新渲染。</strong> <mark>与 state 一样，React 会在每次重新渲染之间保留 ref。但是，设置 state 会重新渲染组件，更改 ref 不会重新渲染组件</mark>！</p>
<hr>
<p>制作一个秒表，用户可以通过按按钮来使其启动或停止。为了显示从用户按下“开始”以来经过的时间长度，你需要追踪按下“开始”按钮的时间和当前时间。<strong>此信息用于渲染，所以你会把它保存在 state 中：</strong></p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-1e44bzlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-1e44bzlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> [startTime, setStartTime] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);<br><br><span class="hljs-keyword">const</span> [now, setNow] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);<br></code></pre></td></tr></table></div></figure>

<p>当用户按下“开始”时，你将用 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/docs/Web/API/setInterval"><code>setInterval</code></a> 每 10 毫秒更新一次时间：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-bdy5o8lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-bdy5o8lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Stopwatch</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [startTime, setStartTime] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);<br>  <span class="hljs-keyword">const</span> [now, setNow] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleStart</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-comment">// 开始计时。</span><br>    <span class="hljs-title function_">setStartTime</span>(<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>());<br>    <span class="hljs-title function_">setNow</span>(<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>());<br><br>    <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-comment">// 每 10ms 更新一次当前时间。</span><br>      <span class="hljs-title function_">setNow</span>(<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>());<br>    &#125;, <span class="hljs-number">10</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">let</span> secondsPassed = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">if</span> (startTime != <span class="hljs-literal">null</span> &amp;&amp; now != <span class="hljs-literal">null</span>) &#123;<br>    secondsPassed = (now - startTime) / <span class="hljs-number">1000</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>时间过去了： &#123;secondsPassed.toFixed(3)&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handleStart&#125;</span>&gt;</span></span><br><span class="language-xml">        开始</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<img src="clock-1699857496128-1.gif" srcset="/img/loading.gif" lazyload alt="clock" style="zoom:50%;" />

<p>当按下“停止”按钮时，你需要取消现有的 interval，以便让它停止更新 <code>now</code> state 变量。你可以通过调用 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/clearInterval"><code>clearInterval</code></a> 来完成此操作。但你需要为其提供 interval ID，此 ID 是之前用户按下 Start、调用 <code>setInterval</code> 时返回的。你需要将 interval ID 保留在某处。 <strong>由于 interval ID 不用于渲染，你可以将其保存在 ref 中：</strong></p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-ogpajelqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-ogpajelqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState, useRef &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Stopwatch</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [startTime, setStartTime] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);<br>  <span class="hljs-keyword">const</span> [now, setNow] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);<br>  <span class="hljs-keyword">const</span> intervalRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleStart</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">setStartTime</span>(<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>());<br>    <span class="hljs-title function_">setNow</span>(<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>());<br><br>    <span class="hljs-built_in">clearInterval</span>(intervalRef.<span class="hljs-property">current</span>);<br>    intervalRef.<span class="hljs-property">current</span> = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-title function_">setNow</span>(<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>());<br>    &#125;, <span class="hljs-number">10</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleStop</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-built_in">clearInterval</span>(intervalRef.<span class="hljs-property">current</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">let</span> secondsPassed = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">if</span> (startTime != <span class="hljs-literal">null</span> &amp;&amp; now != <span class="hljs-literal">null</span>) &#123;<br>    secondsPassed = (now - startTime) / <span class="hljs-number">1000</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>时间过去了： &#123;secondsPassed.toFixed(3)&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handleStart&#125;</span>&gt;</span></span><br><span class="language-xml">        开始</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handleStop&#125;</span>&gt;</span></span><br><span class="language-xml">        停止</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<img src="clock2.gif" srcset="/img/loading.gif" lazyload alt="clock2" style="zoom:50%;" />

<p><mark>当一条信息用于渲染时，将它保存在 state 中。当一条信息仅被事件处理器需要，并且更改它不需要重新渲染时，使用 ref 可能会更高效。</mark></p>
<p>ref和state的区别：</p>
<table>
<thead>
<tr>
<th>ref</th>
<th>state</th>
</tr>
</thead>
<tbody><tr>
<td><code>useRef(initialValue)</code>返回 <code>&#123; current: initialValue &#125;</code></td>
<td><code>useState(initialValue)</code> 返回 state 变量的当前值和一个 state 设置函数 ( <code>[value, setValue]</code>)</td>
</tr>
<tr>
<td>更改时不会触发重新渲染</td>
<td>更改时触发重新渲染。</td>
</tr>
<tr>
<td>可变 —— 你可以在渲染过程之外修改和更新 <code>current</code> 的值。</td>
<td>“不可变” —— 你必须使用 state 设置函数来修改 state 变量，从而排队重新渲染。</td>
</tr>
<tr>
<td>你不应在渲染期间读取（或写入） <code>current</code> 值。</td>
<td>你可以随时读取 state。但是，每次渲染都有自己不变的 state <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/state-as-a-snapshot">快照</a>。</td>
</tr>
</tbody></table>
<p>使用 state 实现的计数器按钮：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-iysfr0lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-iysfr0lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handleClick&#125;</span>&gt;</span></span><br><span class="language-xml">      你点击了 &#123;count&#125; 次</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<img src="click1.gif" srcset="/img/loading.gif" lazyload alt="click1" style="zoom:50%;" />

<p>因为 <code>count</code> 的值将会被显示，所以为其使用 state 是合理的。当使用 setCount() 设置计数器的值时，React 会重新渲染组件，并且屏幕会更新以展示新的计数。</p>
<p>如果你试图用 ref 来实现它，React 永远不会重新渲染组件，所以你永远不会看到计数变化！看看点击这个按钮如何 <strong>不更新它的文本</strong>：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-1wd7kblqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-1wd7kblqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useRef &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">let</span> countRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-number">0</span>);<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-comment">// 这样并未重新渲染组件！</span><br>    countRef.<span class="hljs-property">current</span> = countRef.<span class="hljs-property">current</span> + <span class="hljs-number">1</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handleClick&#125;</span>&gt;</span></span><br><span class="language-xml">      你点击了 &#123;countRef.current&#125; 次</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<img src="click2.gif" srcset="/img/loading.gif" lazyload alt="click2" style="zoom:50%;" />

<p>这就是为什么在渲染期间读取 <code>ref.current</code> 会导致代码不可靠的原因。如果需要，请改用 state。</p>
<p>何时使用ref：当你的组件需要“跳出” React 并与外部 API 通信时，你会用到 ref —— 通常是不会影响组件外观的浏览器 API。以下是这些罕见情况中的几个：</p>
<ul>
<li>存储 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/docs/Web/API/setTimeout">timeout ID</a></li>
<li>存储和操作 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/docs/Web/API/Element">DOM 元素</a></li>
<li>存储不需要被用来计算 JSX 的其他对象。</li>
</ul>
<p>如果你的组件需要存储一些值，但不影响渲染逻辑，请选择 ref。</p>
<p>遵循这些原则将使你的组件更具可预测性：</p>
<ul>
<li><strong>将 ref 视为应急方案。</strong> 当你使用外部系统或浏览器 API 时，ref 很有用。如果你很大一部分应用程序逻辑和数据流都依赖于 ref，你可能需要重新考虑你的方法。</li>
<li><strong>不要在渲染过程中读取或写入 <code>ref.current</code>。</strong> 如果渲染过程中需要某些信息，请使用 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/state-a-components-memory">state</a> 代替。由于 React 不知道 <code>ref.current</code> 何时发生变化，即使在渲染时读取它也会使组件的行为难以预测。（唯一的例外是像 <code>if (!ref.current) ref.current = new Thing()</code> 这样的代码，它只在第一次渲染期间设置一次 ref。）</li>
</ul>
<p>React state 的限制不适用于 ref。例如，state 就像 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/state-as-a-snapshot">每次渲染的快照</a>，并且 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/queueing-a-series-of-state-updates">不会同步更新</a>。但是当你改变 ref 的 current 值时，它会立即改变：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-jqvkiilqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-jqvkiilqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs jsx">ref.<span class="hljs-property">current</span> = <span class="hljs-number">5</span>;<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(ref.<span class="hljs-property">current</span>); <span class="hljs-comment">// 5</span><br></code></pre></td></tr></table></div></figure>

<p>这是因为 <strong>ref 本身是一个普通的 JavaScript 对象，</strong> 所以它的行为就像对象那样。</p>
<p>当你使用 ref 时，也无需担心 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/updating-objects-in-state">避免变更</a>。只要你改变的对象不用于渲染，React 就不会关心你对 ref 或其内容做了什么。</p>
<p>ref 最常见的用法是访问 DOM 元素。例如，如果你想以编程方式聚焦一个输入框，这种用法就会派上用场。当你将 ref 传递给 JSX 中的 <code>ref</code> 属性时，比如 <code>&lt;div ref=&#123;myRef&#125;&gt;</code>，React 会将相应的 DOM 元素放入 <code>myRef.current</code> 中。当元素从 DOM 中删除时，React 会将 <code>myRef.current</code> 更新为 <code>null</code>。</p>
<hr>
<p>修复坏掉的聊天输入框：输入消息并单击“发送”。你会注意到，在看到“已发送！”提示框之前有 3 秒的延迟。在此延迟期间，你可以看到一个“撤消”按钮。点击它。这个“撤消”按钮应该阻止“发送！”消息弹出。它通过调用 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/clearTimeout"><code>clearTimeout</code></a> 来做到这点，这一步骤需要使用在 <code>handleSend</code> 时保存的 timeout ID。但是，即使在单击“撤消”后，“已发送！”消息仍然出现。找出它不起作用的原因，然后修复它。</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-hty3yalqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-hty3yalqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">let</span> timeoutID = <span class="hljs-literal">null</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">handleSend</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">setIsSending</span>(<span class="hljs-literal">true</span>);<br>    timeoutID = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>        <span class="hljs-title function_">alert</span>(<span class="hljs-string">&#x27;已发送！&#x27;</span>);<br>        <span class="hljs-title function_">setIsSending</span>(<span class="hljs-literal">false</span>);<br>    &#125;, <span class="hljs-number">3000</span>);<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">handleUndo</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">setIsSending</span>(<span class="hljs-literal">false</span>);<br>    <span class="hljs-built_in">clearTimeout</span>(timeoutID);<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>每当你的组件重新渲染时（例如当你设置 state 时），所有局部变量都会从头开始初始化。这就是为什么你不能将 timeout ID 保存在像 <code>timeoutID</code> 这样的局部变量中，然后期望未来另一个事件处理器“看到”它。相反，将它存储在一个 ref 中，React 将在渲染之间保留它。</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-z49n83lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-z49n83lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState, useRef &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Chat</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [text, setText] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;&#x27;</span>);<br>  <span class="hljs-keyword">const</span> [isSending, setIsSending] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);<br>  <span class="hljs-keyword">const</span> timeoutRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleSend</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">setIsSending</span>(<span class="hljs-literal">true</span>);<br>    timeoutRef.<span class="hljs-property">current</span> = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-title function_">alert</span>(<span class="hljs-string">&#x27;已发送!&#x27;</span>);<br>      <span class="hljs-title function_">setIsSending</span>(<span class="hljs-literal">false</span>);<br>    &#125;, <span class="hljs-number">3000</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleUndo</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">setIsSending</span>(<span class="hljs-literal">false</span>);<br>    <span class="hljs-built_in">clearTimeout</span>(timeoutRef.<span class="hljs-property">current</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">input</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">disabled</span>=<span class="hljs-string">&#123;isSending&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;text&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> setText(e.target.value)&#125;</span><br><span class="language-xml">      /&gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">disabled</span>=<span class="hljs-string">&#123;isSending&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handleSend&#125;</span>&gt;</span></span><br><span class="language-xml">        &#123;isSending ? &#x27;发送中……&#x27; : &#x27;发送&#x27;&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      &#123;isSending &amp;&amp;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handleUndo&#125;</span>&gt;</span></span><br><span class="language-xml">          撤销</span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      &#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<img src="image-20231113150628769.png" srcset="/img/loading.gif" lazyload alt="image-20231113150628769" style="zoom:50%;" />

<hr>
<p>修复无法重新渲染的组件：这个按钮本该在显示“开”和“关”之间切换。但是，它始终显示“关”。这段代码有什么问题？修复它。</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-zzsqsslqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-zzsqsslqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useRef &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Toggle</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> isOnRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">false</span>);<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> &#123;</span><br><span class="language-xml">      isOnRef.current = !isOnRef.current;</span><br><span class="language-xml">    &#125;&#125;&gt;</span><br><span class="language-xml">      &#123;isOnRef.current ? &#x27;开&#x27; : &#x27;关&#x27;&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>修复：ref 的 current 值被用于计算渲染输出：<code>&#123;isOnRef.current ? &#39;开&#39;：&#39;关&#39;&#125;</code>。这表明此信息本来不应该在 ref 中，而应该放在 state 里。要修复它，请删除 ref ，使用 state 代替：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-zve69flqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-zve69flqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Toggle</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [isOn, setIsOn] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> &#123;</span><br><span class="language-xml">      setIsOn(!isOn);</span><br><span class="language-xml">    &#125;&#125;&gt;</span><br><span class="language-xml">      &#123;isOn ? &#x27;开&#x27; : &#x27;关&#x27;&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<img src="on.gif" srcset="/img/loading.gif" lazyload alt="on" style="zoom:50%;" />

<hr>
<p>修复防抖：所有按钮点击处理器都是 <a target="_blank" rel="noopener" href="https://redd.one/blog/debounce-vs-throttle">“防抖的”</a>。 要了解这意味着什么，请按下其中一个按钮。注意消息在一秒后显示。如果你在等待消息时按下按钮，计时器将重置。因此如果你多次快速单击同一个按钮，则直到你停止单击 <strong>之后</strong> 1 秒钟，该消息才会显示。防抖可以让你将一些动作推迟到用户“停止动作”之后。</p>
<p>这个例子可以正常运行，但并不完全符合预期。按钮不是独立的。要查看问题，请单击其中一个按钮，然后立即单击另一个按钮。你本来期望在延迟之后，你会看到两个按钮的消息。但只有最后一个按钮的消息出现了。第一个按钮的消息丢失了。</p>
<p>为什么按钮会相互干扰呢？查找并修复问题。</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-bjc0rqlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-bjc0rqlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">let</span> timeoutID;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">DebouncedButton</span>(<span class="hljs-params">&#123; onClick, children &#125;</span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> &#123;</span><br><span class="language-xml">      clearTimeout(timeoutID);</span><br><span class="language-xml">      timeoutID = setTimeout(() =&gt; &#123;</span><br><span class="language-xml">        onClick();</span><br><span class="language-xml">      &#125;, 1000);</span><br><span class="language-xml">    &#125;&#125;&gt;</span><br><span class="language-xml">      &#123;children&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>修复：像 <code>timeoutID</code> 这样的变量是被所有组件共享的。这就是为什么单击第二个按钮会重置第一个按钮未完成的 timeout 的原因。要解决此问题，你可以把 timeout 保存在 ref 中。每个按钮都有自己的 ref，因此它们不会相互冲突。请注意快速单击两个按钮如何显示两个消息。</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-2l48nulqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-2l48nulqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useRef &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">DebouncedButton</span>(<span class="hljs-params">&#123; onClick, children &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> timeoutRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> &#123;</span><br><span class="language-xml">      clearTimeout(timeoutRef.current);</span><br><span class="language-xml">      timeoutRef.current = setTimeout(() =&gt; &#123;</span><br><span class="language-xml">        onClick();</span><br><span class="language-xml">      &#125;, 1000);</span><br><span class="language-xml">    &#125;&#125;&gt;</span><br><span class="language-xml">      &#123;children&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Dashboard</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">DebouncedButton</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> alert(&#x27;宇宙飞船已发射！&#x27;)&#125;</span><br><span class="language-xml">      &gt;</span><br><span class="language-xml">        发射宇宙飞船</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">DebouncedButton</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">DebouncedButton</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> alert(&#x27;汤煮好了！&#x27;)&#125;</span><br><span class="language-xml">      &gt;</span><br><span class="language-xml">        煮点儿汤</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">DebouncedButton</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">DebouncedButton</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> alert(&#x27;摇篮曲唱完了！&#x27;)&#125;</span><br><span class="language-xml">      &gt;</span><br><span class="language-xml">        唱首摇篮曲</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">DebouncedButton</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  )<br>&#125;<br></code></pre></td></tr></table></div></figure>

<img src="debounce.gif" srcset="/img/loading.gif" lazyload alt="debounce" style="zoom:50%;" />

<hr>
<p>读取最新的 state：当你按下“发送”后，在显示消息之前会有一小段延迟。输入“你好”，按下发送，然后再次快速编辑输入。尽管你进行了编辑，提示框仍会显示“你好”（这是按钮被点击 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/state-as-a-snapshot#state-over-time">那一刻</a> state 的值）。</p>
<p>通常，这种行为是你在应用程序中想要的。但是，有时可能需要一些异步代码来读取某些 state 的 <strong>最新</strong> 版本。你能想出一种方法，让提示框显示 <strong>当前</strong> 输入文本而不是点击时的内容吗？</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-da76f5lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-da76f5lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState, useRef &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Chat</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [text, setText] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;&#x27;</span>);<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleSend</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-title function_">alert</span>(<span class="hljs-string">&#x27;正在发送：&#x27;</span> + text);<br>    &#125;, <span class="hljs-number">3000</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">input</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;text&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> setText(e.target.value)&#125;</span><br><span class="language-xml">      /&gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handleSend&#125;</span>&gt;</span></span><br><span class="language-xml">        发送</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>修复：state 运作起来 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/state-as-a-snapshot">就像快照</a>，因此你无法从 timeout 等异步操作中读取最新的 state。但是，你可以在 ref 中保存最新的输入文本。ref 是可变的，因此你可以随时读取 <code>current</code> 属性。由于当前文本也用于渲染，在这个例子中，你需要 <strong>同时</strong> 使用一个 state 变量（用于渲染）<strong>和</strong> 一个 ref（在 timeout 时读取它）。你需要手动更新当前的 ref 值。</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-b3z398lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-b3z398lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState, useRef &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Chat</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [text, setText] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;&#x27;</span>);<br>  <span class="hljs-keyword">const</span> textRef = <span class="hljs-title function_">useRef</span>(text);<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleChange</span>(<span class="hljs-params">e</span>) &#123;<br>    <span class="hljs-title function_">setText</span>(e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>);<br>    textRef.<span class="hljs-property">current</span> = e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleSend</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-title function_">alert</span>(<span class="hljs-string">&#x27;正在发送：&#x27;</span> + textRef.<span class="hljs-property">current</span>);<br>    &#125;, <span class="hljs-number">3000</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">input</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;text&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;handleChange&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handleSend&#125;</span>&gt;</span></span><br><span class="language-xml">        发送</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<img src="send.gif" srcset="/img/loading.gif" lazyload alt="send" style="zoom:50%;" />

<h2 id="2-使用-ref-操作-DOM"><a href="#2-使用-ref-操作-DOM" class="headerlink" title="2.使用 ref 操作 DOM"></a>2.使用 ref 操作 DOM</h2><p>由于 React 会自动处理更新 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/docs/Web/API/Document_Object_Model/Introduction">DOM</a> 以匹配你的渲染输出，因此你在组件中通常不需要操作 DOM。但是，有时你可能需要访问由 React 管理的 DOM 元素 —— 例如，让一个节点获得焦点、滚动到它或测量它的尺寸和位置。在 React 中没有内置的方法来做这些事情，所以你需要一个指向 DOM 节点的 <strong>ref</strong> 来实现。</p>
<p>要访问由 React 管理的 DOM 节点，首先，引入 <code>useRef</code> Hook：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-8x2m61lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-8x2m61lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useRef &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br></code></pre></td></tr></table></div></figure>

<p>然后，在你的组件中使用它声明一个 ref：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-4dspeslqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-4dspeslqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> myRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);<br></code></pre></td></tr></table></div></figure>

<p>最后，将 ref 作为 ref 属性传递给您想要获取 DOM 节点的 JSX 标签：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-gpy7yelqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-gpy7yelqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jsx">&lt;div ref=&#123;myRef&#125;&gt;<br></code></pre></td></tr></table></div></figure>

<p><code>useRef</code> Hook 返回一个对象，该对象有一个名为 <code>current</code> 的属性。最初，<code>myRef.current</code> 是 <code>null</code>。当 React 为这个 <code>&lt;div&gt;</code> 创建一个 DOM 节点时，React 会把对该节点的引用放入 <code>myRef.current</code>。然后，你可以从 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/responding-to-events">事件处理器</a> 访问此 DOM 节点，并使用在其上定义的内置<a target="_blank" rel="noopener" href="https://developer.mozilla.org/docs/Web/API/Element">浏览器 API</a>。</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-1tcjsulqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-1tcjsulqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-comment">// 你可以使用任意浏览器 API，例如：</span><br>myRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">scrollIntoView</span>();<br></code></pre></td></tr></table></div></figure>

<p>虽然 DOM 操作是 ref 最常见的用例，但 <code>useRef</code> Hook 可用于存储 React 之外的其他内容，例如计时器 ID 。与 state 类似，ref 能在渲染之间保留。你甚至可以将 ref 视为设置它们时不会触发重新渲染的 state 变量！</p>
<hr>
<p>滚动图像轮播：此图像轮播有一个“下一个”按钮，可以切换激活的图像。单击时使图库水平滚动到激活的图像。你需要在激活的图像的 DOM 节点上调用 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/Element/scrollIntoView"><code>scrollIntoView()</code></a>：可以声明一个 <code>selectedRef</code>，然后根据条件将它传递给当前图像：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-6dxg5ulqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-6dxg5ulqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jsx">&lt;li ref=&#123;index === i ? selectedRef : <span class="hljs-literal">null</span>&#125;&gt;<br></code></pre></td></tr></table></div></figure>

<p>当<code>index === i</code>时，表示图像是被选中的图像，相应的 <code>&lt;li&gt;</code> 将接收到 <code>selectedRef</code>。React 将确保 <code>selectedRef.current</code> 始终指向正确的 DOM 节点。</p>
<p>请注意，为了强制 React 在滚动前更新 DOM，<code>flushSync</code> 调用是必需的。否则，<code>selectedRef.current</code>将始终指向之前选择的项目。</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-bkl3mjlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-bkl3mjlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useRef, useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; flushSync &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react-dom&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">CatFriends</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> selectedRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);<br>  <span class="hljs-keyword">const</span> [index, setIndex] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">nav</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> &#123;</span><br><span class="language-xml">          flushSync(() =&gt; &#123;</span><br><span class="language-xml">            if (index &lt; catList.length - 1) &#123;</span><br><span class="language-xml">              setIndex(index + 1);</span><br><span class="language-xml">            &#125; else &#123;</span><br><span class="language-xml">              setIndex(0);</span><br><span class="language-xml">            &#125;</span><br><span class="language-xml">          &#125;);</span><br><span class="language-xml">          selectedRef.current.scrollIntoView(&#123;</span><br><span class="language-xml">            behavior: &#x27;smooth&#x27;,</span><br><span class="language-xml">            block: &#x27;nearest&#x27;,</span><br><span class="language-xml">            inline: &#x27;center&#x27;</span><br><span class="language-xml">          &#125;);            </span><br><span class="language-xml">        &#125;&#125;&gt;</span><br><span class="language-xml">          下一步</span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span></span><br><span class="language-xml">          &#123;catList.map((cat, i) =&gt; (</span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">li</span></span></span><br><span class="hljs-tag"><span class="language-xml">              <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;cat.id&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">              <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;index</span> === <span class="hljs-string">i</span> ?</span></span><br><span class="hljs-tag"><span class="language-xml">                <span class="hljs-attr">selectedRef</span> <span class="hljs-attr">:</span></span></span><br><span class="hljs-tag"><span class="language-xml">                <span class="hljs-attr">null</span></span></span><br><span class="hljs-tag"><span class="language-xml">              &#125;</span></span><br><span class="hljs-tag"><span class="language-xml">            &gt;</span></span><br><span class="language-xml">              <span class="hljs-tag">&lt;<span class="hljs-name">img</span></span></span><br><span class="hljs-tag"><span class="language-xml">                <span class="hljs-attr">className</span>=<span class="hljs-string">&#123;</span></span></span><br><span class="hljs-tag"><span class="language-xml">                  <span class="hljs-attr">index</span> === <span class="hljs-string">i</span> ?</span></span><br><span class="hljs-tag"><span class="language-xml">                    &#x27;<span class="hljs-attr">active</span>&#x27;</span></span><br><span class="hljs-tag"><span class="language-xml">                    <span class="hljs-attr">:</span> &#x27;&#x27;</span></span><br><span class="hljs-tag"><span class="language-xml">                &#125;</span></span><br><span class="hljs-tag"><span class="language-xml">                <span class="hljs-attr">src</span>=<span class="hljs-string">&#123;cat.imageUrl&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">                <span class="hljs-attr">alt</span>=<span class="hljs-string">&#123;</span>&#x27;<span class="hljs-attr">猫猫</span> #&#x27; + <span class="hljs-attr">cat.id</span>&#125;</span></span><br><span class="hljs-tag"><span class="language-xml">              /&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span><br><span class="language-xml">          ))&#125;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">const</span> catList = [];<br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>  catList.<span class="hljs-title function_">push</span>(&#123;<br>    <span class="hljs-attr">id</span>: i,<br>    <span class="hljs-attr">imageUrl</span>: <span class="hljs-string">&#x27;https://placekitten.com/250/200?image=&#x27;</span> + i<br>  &#125;);<br>&#125;<br></code></pre></td></tr></table></div></figure>

<img src="scroll.gif" srcset="/img/loading.gif" lazyload alt="scroll" style="zoom:50%;" />

<p>如何使用 ref 回调管理 ref 列表：有时ref 的数量是预先确定的。但有时候，你可能需要为列表中的每一项都绑定 ref ，而你又不知道会有多少项。像下面这样做<strong>是行不通的</strong>：</p>
<figure class="highlight html"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-vs31nxlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-vs31nxlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span><br>  &#123;items.map((item) =&gt; &#123;<br>    // 行不通！<br>    const ref = useRef(null);<br>    return <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;ref&#125;</span> /&gt;</span>;<br>  &#125;)&#125;<br><span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span><br></code></pre></td></tr></table></div></figure>

<p>这是因为 <strong>Hook 只能在组件的顶层被调用</strong>。不能在循环语句、条件语句或 <code>map()</code> 函数中调用 <code>useRef</code> 。</p>
<p>可能的解决方案：</p>
<ol>
<li>用一个 ref 引用其父元素，然后用 DOM 操作方法如 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/Document/querySelectorAll"><code>querySelectorAll</code></a> 来寻找它的子节点。然而，这种方法很脆弱，如果 DOM 结构发生变化，可能会失效或报错。</li>
<li><strong>将函数传递给 <code>ref</code> 属性</strong>。这称为 <mark><a target="_blank" rel="noopener" href="https://zh-hans.react.dev/reference/react-dom/components/common#ref-callback"><code>ref</code> 回调</a></mark>。当需要设置 ref 时，React 将传入 DOM 节点来调用你的 ref 回调，并在需要清除它时传入 <code>null</code> 。这使你可以维护自己的数组或 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Map">Map</a>，并通过其索引或某种类型的 ID 访问任何 ref。</li>
</ol>
<p>此示例展示了如何使用此方法滚动到长列表中的任意节点：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-oi5q3llqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-oi5q3llqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useRef &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">CatFriends</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> itemsRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">scrollToId</span>(<span class="hljs-params">itemId</span>) &#123;<br>    <span class="hljs-keyword">const</span> map = <span class="hljs-title function_">getMap</span>();<br>    <span class="hljs-keyword">const</span> node = map.<span class="hljs-title function_">get</span>(itemId);<br>    node.<span class="hljs-title function_">scrollIntoView</span>(&#123;<br>      <span class="hljs-attr">behavior</span>: <span class="hljs-string">&#x27;smooth&#x27;</span>,<br>      <span class="hljs-attr">block</span>: <span class="hljs-string">&#x27;nearest&#x27;</span>,<br>      <span class="hljs-attr">inline</span>: <span class="hljs-string">&#x27;center&#x27;</span><br>    &#125;);<br>  &#125;<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">getMap</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">if</span> (!itemsRef.<span class="hljs-property">current</span>) &#123;<br>      <span class="hljs-comment">// 首次运行时初始化 Map。</span><br>      itemsRef.<span class="hljs-property">current</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();<br>    &#125;<br>    <span class="hljs-keyword">return</span> itemsRef.<span class="hljs-property">current</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">nav</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> scrollToId(0)&#125;&gt;</span><br><span class="language-xml">          Tom</span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> scrollToId(5)&#125;&gt;</span><br><span class="language-xml">          Maru</span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> scrollToId(9)&#125;&gt;</span><br><span class="language-xml">          Jellylorum</span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span></span><br><span class="language-xml">          &#123;catList.map(cat =&gt; (</span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">li</span></span></span><br><span class="hljs-tag"><span class="language-xml">              <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;cat.id&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">              <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;(node)</span> =&gt;</span> &#123;</span><br><span class="language-xml">                const map = getMap();</span><br><span class="language-xml">                if (node) &#123;</span><br><span class="language-xml">                  map.set(cat.id, node);</span><br><span class="language-xml">                &#125; else &#123;</span><br><span class="language-xml">                  map.delete(cat.id);</span><br><span class="language-xml">                &#125;</span><br><span class="language-xml">              &#125;&#125;</span><br><span class="language-xml">            &gt;</span><br><span class="language-xml">              <span class="hljs-tag">&lt;<span class="hljs-name">img</span></span></span><br><span class="hljs-tag"><span class="language-xml">                <span class="hljs-attr">src</span>=<span class="hljs-string">&#123;cat.imageUrl&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">                <span class="hljs-attr">alt</span>=<span class="hljs-string">&#123;</span>&#x27;<span class="hljs-attr">Cat</span> #&#x27; + <span class="hljs-attr">cat.id</span>&#125;</span></span><br><span class="hljs-tag"><span class="language-xml">              /&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span><br><span class="language-xml">          ))&#125;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">const</span> catList = [];<br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>  catList.<span class="hljs-title function_">push</span>(&#123;<br>    <span class="hljs-attr">id</span>: i,<br>    <span class="hljs-attr">imageUrl</span>: <span class="hljs-string">&#x27;https://placekitten.com/250/200?image=&#x27;</span> + i<br>  &#125;);<br>&#125;<br></code></pre></td></tr></table></div></figure>

<img src="scroll2.gif" srcset="/img/loading.gif" lazyload alt="scroll2" style="zoom:50%;" />

<p>当你将 ref 放在像 <code>&lt;input /&gt;</code> 这样输出浏览器元素的内置组件上时，React 会将该 ref 的 <code>current</code> 属性设置为相应的 DOM 节点（例如浏览器中实际的 <code>&lt;input /&gt;</code> ）。</p>
<p>但是，如果你尝试将 ref 放在 <strong>你自己的</strong> 组件上，例如 <code>&lt;MyInput /&gt;</code>，默认情况下你会得到 <code>null</code>。请注意单击按钮 <strong>并不会</strong> 聚焦输入框：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-s3dogwlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-s3dogwlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useRef &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">MyInput</span>(<span class="hljs-params">props</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> &#123;<span class="hljs-attr">...props</span>&#125; /&gt;</span></span>;<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">MyForm</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> inputRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"></span>) &#123;<br>    inputRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">focus</span>();<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">MyInput</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;inputRef&#125;</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handleClick&#125;</span>&gt;</span></span><br><span class="language-xml">        聚焦输入框</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>报错<code>Warning: Function components cannot be given refs. Attempts to access this ref will fail. Did you mean to use React.forwardRef()?</code></p>
<p>发生这种情况是因为默认情况下，React 不允许组件访问其他组件的 DOM 节点。甚至自己的子组件也不行！这是故意的。Refs 是一个应急方案，应该谨慎使用。手动操作 <strong>另一个</strong> 组件的 DOM 节点会使你的代码更加脆弱。</p>
<p>相反，<strong>想要</strong> 暴露其 DOM 节点的组件必须<strong>选择</strong>该行为。<mark>一个组件可以指定将它的 ref “转发”给一个子组件</mark>。下面是 <code>MyInput</code> 如何使用 <code>forwardRef</code> API：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-i9vblxlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-i9vblxlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> <span class="hljs-title class_">MyInput</span> = <span class="hljs-title function_">forwardRef</span>(<span class="hljs-function">(<span class="hljs-params">props, ref</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> &#123;<span class="hljs-attr">...props</span>&#125; <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;ref&#125;</span> /&gt;</span></span>;<br>&#125;);<br></code></pre></td></tr></table></div></figure>

<p>它是这样工作的:</p>
<ol>
<li><code>&lt;MyInput ref=&#123;inputRef&#125; /&gt;</code> 告诉 React 将对应的 DOM 节点放入 <code>inputRef.current</code> 中。但是，这取决于 <code>MyInput</code> 组件是否允许这种行为， 默认情况下是不允许的。</li>
<li><code>MyInput</code> 组件是使用 <code>forwardRef</code> 声明的。 <strong>这让从上面接收的 <code>inputRef</code> 作为第二个参数 <code>ref</code> 传入组件</strong>，第一个参数是 <code>props</code> 。</li>
<li><code>MyInput</code> 组件将自己接收到的 <code>ref</code> 传递给它内部的 <code>&lt;input&gt;</code>。</li>
</ol>
<p>现在，单击按钮聚焦输入框起作用了：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-q2fjj5lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-q2fjj5lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; forwardRef, useRef &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">MyInput</span> = <span class="hljs-title function_">forwardRef</span>(<span class="hljs-function">(<span class="hljs-params">props, ref</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> &#123;<span class="hljs-attr">...props</span>&#125; <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;ref&#125;</span> /&gt;</span></span>;<br>&#125;);<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Form</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> inputRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"></span>) &#123;<br>    inputRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">focus</span>();<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">MyInput</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;inputRef&#125;</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handleClick&#125;</span>&gt;</span></span><br><span class="language-xml">        聚焦输入框</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<img src="focusinput.gif" srcset="/img/loading.gif" lazyload alt="focusinput" style="zoom:50%;" />

<p><mark>使分开的组件中的搜索域获得焦点 </mark>：做到单击“搜索”按钮将焦点放在搜索域上。请注意，每个组件都在单独的文件中定义，并且不能将其移出。</p>
<p>解答：需要向 <code>SearchButton</code> 添加一个<code>onClick</code> 属性，<code>SearchButton</code> 会将其向下传递给浏览器原生 <code>&lt;button&gt;</code>。你还要向下传递一个 ref 给 <code>&lt;SearchInput&gt;</code>，<code>&lt;SearchInput&gt;</code> 将转发 ref 给真正的 <code>&lt;input&gt;</code> 并对它进行赋值。最后，在单击事件处理器中，你将能对存储在该 ref 中的 DOM 节点调用 <code>focus</code>。</p>
<p>SearchInput.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-mhx50ilqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-mhx50ilqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; forwardRef &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">forwardRef</span>(<br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">SearchInput</span>(<span class="hljs-params">props, ref</span>) &#123;<br>    <span class="hljs-keyword">return</span> (<br>      <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;ref&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;找什么呢？&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      /&gt;</span></span><br>    );<br>  &#125;<br>);<br></code></pre></td></tr></table></div></figure>

<p>SearchButton.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-ch18nxlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-ch18nxlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">SearchButton</span>(<span class="hljs-params">&#123; onClick &#125;</span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;onClick&#125;</span>&gt;</span></span><br><span class="language-xml">      搜索</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>App.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-hyvbhqlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-hyvbhqlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useRef &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-title class_">SearchButton</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./SearchButton.js&#x27;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-title class_">SearchInput</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./SearchInput.js&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Page</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> inputRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">nav</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">SearchButton</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> &#123;</span><br><span class="language-xml">          inputRef.current.focus();</span><br><span class="language-xml">        &#125;&#125; /&gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">SearchInput</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;inputRef&#125;</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p class="note note-success" style="border-left: 4px solid #42b983;padding: 10px 15px;color: #777;background-color: rgba(66, 185, 131, .1);">在设计系统中，将低级组件（如按钮、输入框等）的 ref 转发到它们的 DOM 节点是一种常见模式。另一方面，像表单、列表或页面段落这样的高级组件通常不会暴露它们的 DOM 节点，以避免对 DOM 结构的意外依赖。</p>

<p>React 何时添加 refs：在 React 中，每次更新都分为 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/render-and-commit#step-3-react-commits-changes-to-the-dom">两个阶段</a>：</p>
<ul>
<li>在 <strong>渲染</strong> 阶段， React 调用你的组件来确定屏幕上应该显示什么。</li>
<li>在 <strong>提交</strong> 阶段， React 把变更应用于 DOM。</li>
</ul>
<p>通常，你 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/referencing-values-with-refs#best-practices-for-refs">不希望</a> 在渲染期间访问 refs。这也适用于保存 DOM 节点的 refs。在第一次渲染期间，DOM 节点尚未创建，因此 <code>ref.current</code> 将为 <code>null</code>。在渲染更新的过程中，DOM 节点还没有更新。所以读取它们还为时过早。</p>
<p>React 在提交阶段设置 <code>ref.current</code>。在更新 DOM 之前，React 将受影响的 <code>ref.current</code> 值设置为 <code>null</code>。更新 DOM 后，React 立即将它们设置到相应的 DOM 节点。</p>
<p><strong>通常，你将从事件处理器访问 refs。</strong> 如果你想使用 ref 执行某些操作，但没有特定的事件可以执行此操作，你可能需要一个 effect。</p>
<p><mark>用 flushSync 同步更新 state</mark>：添加一个新的待办事项，并将屏幕向下滚动到列表的最后一个子项。请注意，出于某种原因，它总是滚动到最后一个添加 <strong>之前</strong> 的待办事项：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-qvg49jlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-qvg49jlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState, useRef &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">TodoList</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> listRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);<br>  <span class="hljs-keyword">const</span> [text, setText] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;&#x27;</span>);<br>  <span class="hljs-keyword">const</span> [todos, setTodos] = <span class="hljs-title function_">useState</span>(<br>    initialTodos<br>  );<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleAdd</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">const</span> newTodo = &#123; <span class="hljs-attr">id</span>: nextId++, <span class="hljs-attr">text</span>: text &#125;;<br>    <span class="hljs-title function_">setText</span>(<span class="hljs-string">&#x27;&#x27;</span>);<br>    <span class="hljs-title function_">setTodos</span>([ ...todos, newTodo]);<br>    listRef.<span class="hljs-property">current</span>.<span class="hljs-property">lastChild</span>.<span class="hljs-title function_">scrollIntoView</span>(&#123;<br>      <span class="hljs-attr">behavior</span>: <span class="hljs-string">&#x27;smooth&#x27;</span>,<br>      <span class="hljs-attr">block</span>: <span class="hljs-string">&#x27;nearest&#x27;</span><br>    &#125;);<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handleAdd&#125;</span>&gt;</span></span><br><span class="language-xml">        添加</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">input</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;text&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> setText(e.target.value)&#125;</span><br><span class="language-xml">      /&gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;listRef&#125;</span>&gt;</span></span><br><span class="language-xml">        &#123;todos.map(todo =&gt; (</span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;todo.id&#125;</span>&gt;</span>&#123;todo.text&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span><br><span class="language-xml">        ))&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">let</span> nextId = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">let</span> initialTodos = [];<br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">20</span>; i++) &#123;<br>  initialTodos.<span class="hljs-title function_">push</span>(&#123;<br>    <span class="hljs-attr">id</span>: nextId++,<br>    <span class="hljs-attr">text</span>: <span class="hljs-string">&#x27;待办 #&#x27;</span> + (i + <span class="hljs-number">1</span>)<br>  &#125;);<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>问题出在这两行：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-2chogrlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-2chogrlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-title function_">setTodos</span>([ ...todos, newTodo]);<br><br>listRef.<span class="hljs-property">current</span>.<span class="hljs-property">lastChild</span>.<span class="hljs-title function_">scrollIntoView</span>();<br></code></pre></td></tr></table></div></figure>

<p><mark>在 React 中，<a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/queueing-a-series-of-state-updates">state 更新是排队进行的</a></mark>。通常，这就是你想要的。但是，在这个示例中会导致问题，因为 <code>setTodos</code> 不会立即更新 DOM。因此，当你将列表滚动到最后一个元素时，尚未添加待办事项。这就是为什么滚动总是“落后”一项的原因。</p>
<p>要解决此问题，你可以<mark>强制 React 同步更新（“刷新”）DOM</mark>。 为此，从 <code>react-dom</code> 导入 <code>flushSync</code> 并<strong>将 state 更新包裹</strong> 到 <code>flushSync</code> 调用中。这将指示 React 当封装在 <code>flushSync</code> 中的代码执行后，立即同步更新 DOM。因此，当你尝试滚动到最后一个待办事项时，它已经在 DOM 中了：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-v55ubolqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-v55ubolqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; flushSync &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react-dom&#x27;</span><br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">handleAdd</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">const</span> newTodo = &#123; <span class="hljs-attr">id</span>: nextId++, <span class="hljs-attr">text</span>: text &#125;;<br>    <span class="hljs-title function_">flushSync</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>        <span class="hljs-title function_">setText</span>(<span class="hljs-string">&#x27;&#x27;</span>);<br>        <span class="hljs-title function_">setTodos</span>([ ...todos, newTodo]);      <br>    &#125;);<br>    listRef.<span class="hljs-property">current</span>.<span class="hljs-property">lastChild</span>.<span class="hljs-title function_">scrollIntoView</span>(&#123;<br>        <span class="hljs-attr">behavior</span>: <span class="hljs-string">&#x27;smooth&#x27;</span>,<br>        <span class="hljs-attr">block</span>: <span class="hljs-string">&#x27;nearest&#x27;</span><br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>使用 refs 操作 DOM 的最佳实践：Refs 是一个应急方案。你应该只在你必须“跳出 React”时使用它们。这方面的常见示例包括管理焦点、滚动位置或调用 React 未暴露的浏览器 API。</p>
<p>如果你坚持聚焦和滚动等非破坏性操作，应该不会遇到任何问题。但是，如果你尝试手动<strong>修改</strong> DOM，则可能会与 React 所做的更改发生冲突。</p>
<p>为了说明这个问题，这个例子包括一条欢迎消息和两个按钮。第一个按钮使用 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/conditional-rendering">条件渲染</a> 和 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/state-a-components-memory">state</a> 切换它的显示和隐藏，就像你通常在 React 中所做的那样。第二个按钮使用 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/Element/remove"><code>remove()</code> DOM API</a> 将其从 React 控制之外的 DOM 中强行移除.</p>
<p>尝试按几次“通过 setState 切换”。该消息会消失并再次出现。然后按 “从 DOM 中删除”。这将强行删除它。最后，按 “通过 setState 切换”：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-1vedgwlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-1vedgwlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState, useRef &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [show, setShow] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>);<br>  <span class="hljs-keyword">const</span> ref = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> &#123;</span><br><span class="language-xml">          setShow(!show);</span><br><span class="language-xml">        &#125;&#125;&gt;</span><br><span class="language-xml">        通过 setState 切换</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> &#123;</span><br><span class="language-xml">          ref.current.remove();</span><br><span class="language-xml">        &#125;&#125;&gt;</span><br><span class="language-xml">        从 DOM 中删除</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      &#123;show &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;ref&#125;</span>&gt;</span>Hello world<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<img src="ref.gif" srcset="/img/loading.gif" lazyload alt="ref" style="zoom:50%;" />

<p>在你手动删除 DOM 元素后，尝试使用 <code>setState</code> 再次显示它会导致崩溃。这是因为你更改了 DOM，而 React 不知道如何继续正确管理它。</p>
<p><mark>避免更改由 React 管理的 DOM 节点</mark>。 对 React 管理的元素进行修改、添加子元素、从中删除子元素会导致不一致的视觉结果，或与上述类似的崩溃。</p>
<p>但是，这并不意味着你完全不能这样做。它需要谨慎。 <strong>你可以安全地修改 React 没有理由更新的部分 DOM。</strong> 例如，如果某些 <code>&lt;div&gt;</code> 在 JSX 中始终为空，React 将没有理由去变动其子列表。 因此，在那里手动增删元素是安全的。</p>
<hr>
<p>播放和暂停视频：按钮切换 state 变量以在播放和暂停状态之间切换。 然而，为了实际播放或暂停视频，切换状态是不够的。你还需要在 <code>&lt;video&gt;</code> 的 DOM 元素上调用 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/HTMLMediaElement/play"><code>play()</code></a> 和 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/HTMLMediaElement/pause"><code>pause()</code></a>。 向它添加一个 ref，并使按钮起作用。对于额外的挑战，即使用户右键单击视频并使用内置浏览器媒体控件播放，也要使“播放”按钮与视频是否正在播放同步。 您可能需要在视频中监听 <code>onPlay</code> 和 <code>onPause</code> 才能做到这一点。</p>
<p>解答：为了处理内置浏览器控件，您可以将 <code>onPlay</code> 和 <code>onPause</code> 处理程序添加到 <code>&lt;video&gt;</code> 元素，并调用它们的 <code>setIsPlaying</code>。 这样，如果用户使用浏览器控件播放视频，状态将相应调整。</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-yxvopllqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-yxvopllqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState, useRef &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">VideoPlayer</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [isPlaying, setIsPlaying] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);<br>  <span class="hljs-keyword">const</span> ref = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">const</span> nextIsPlaying = !isPlaying;<br>    <span class="hljs-title function_">setIsPlaying</span>(nextIsPlaying);<br><br>    <span class="hljs-keyword">if</span> (nextIsPlaying) &#123;<br>      ref.<span class="hljs-property">current</span>.<span class="hljs-title function_">play</span>();<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      ref.<span class="hljs-property">current</span>.<span class="hljs-title function_">pause</span>();<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handleClick&#125;</span>&gt;</span></span><br><span class="language-xml">        &#123;isPlaying ? &#x27;暂停&#x27; : &#x27;播放&#x27;&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">video</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;250&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;ref&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">onPlay</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> setIsPlaying(true)&#125;</span><br><span class="language-xml">        onPause=&#123;() =&gt; setIsPlaying(false)&#125;</span><br><span class="language-xml">      &gt;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">source</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;video/mp4&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">video</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  )<br>&#125;<br></code></pre></td></tr></table></div></figure>

<img src="play.gif" srcset="/img/loading.gif" lazyload alt="play" style="zoom:50%;" />

<hr>
<p>使搜索域获得焦点：做到单击“搜索”按钮时，使搜索域获得焦点。</p>
<p>解答：向输入框添加一个 ref，并在 DOM 节点上调用 <code>focus()</code> 以使其获得焦点。</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-el483dlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-el483dlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useRef &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Page</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> inputRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">nav</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> &#123;</span><br><span class="language-xml">          inputRef.current.focus();</span><br><span class="language-xml">        &#125;&#125;&gt;</span><br><span class="language-xml">          搜索</span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">input</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;inputRef&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;找什么呢？&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<img src="focus.gif" srcset="/img/loading.gif" lazyload alt="focus" style="zoom:50%;" />

<h2 id="3-使用-Effect-同步"><a href="#3-使用-Effect-同步" class="headerlink" title="3.使用 Effect 同步"></a>3.使用 Effect 同步</h2><p>有些组件需要与外部系统同步。例如，你可能希望根据 React state 控制非 React 组件、设置服务器连接或在组件出现在屏幕上时发送分析日志。Effects 会在渲染后运行一些代码，以便可以将组件与 React 之外的某些系统同步。</p>
<p>React 组件中的两种逻辑类型：</p>
<ul>
<li><strong>渲染逻辑代码</strong>（在 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/describing-the-ui">描述 UI</a> 中有介绍）位于组件的顶层。你将在这里接收 props 和 state，并对它们进行转换，最终返回你想在屏幕上看到的 JSX。<a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/keeping-components-pure">渲染的代码必须是纯粹的</a>——就像数学公式一样，它只应该“计算”结果，而不做其他任何事情。</li>
<li><strong>事件处理程序</strong>（在 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/adding-interactivity">添加交互性</a> 中介绍）是嵌套在组件内部的函数，而不仅仅是计算函数。事件处理程序可能会更新输入字段、提交 HTTP POST 请求以购买产品，或者将用户导航到另一个屏幕。事件处理程序包含由特定用户操作（例如按钮点击或键入）引起的“副作用”（它们改变了程序的状态）。</li>
</ul>
<p>有时这还不够。考虑一个 <code>ChatRoom</code> 组件，它在屏幕上可见时必须连接到聊天服务器。连接到服务器不是一个纯计算（它包含副作用），因此它不能在渲染过程中发生。然而，并没有一个特定的事件（比如点击）导致 <code>ChatRoom</code> 被显示。</p>
<p><mark>Effect 允许你指定由渲染本身，而不是特定事件引起的副作用</mark>。在聊天中发送消息是一个“事件”，因为它直接由用户点击特定按钮引起。然而，建立服务器连接是 Effect，因为它应该发生无论哪种交互导致组件出现。Effect 在屏幕更新后的 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/render-and-commit">提交阶段</a> 运行。这是一个很好的时机，可以将 React 组件与某个外部系统（如网络或第三方库）同步。</p>
<p><code>Effect</code> 在 React 中是专有定义——由渲染引起的副作用，或称为副作用。</p>
<p>编写 Effect 需要遵循以下三个规则：</p>
<ol>
<li><strong>声明 Effect</strong>。默认情况下，Effect 会在每次渲染后都会执行。</li>
<li><strong>指定 Effect 依赖</strong>。大多数 Effect 应该按需执行，而不是在每次渲染后都执行。例如，淡入动画应该只在组件出现时触发。连接和断开服务器的操作只应在组件出现和消失时，或者切换聊天室时执行。</li>
<li><strong>必要时添加清理（cleanup）函数</strong>。有时 Effect 需要指定如何停止、撤销，或者清除它的效果。例如，“连接”操作需要“断连”，“订阅”需要“退订”，“获取”既需要“取消”也需要“忽略”。</li>
</ol>
<p>第一步：声明 Effect ：首先在 React 中引入 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/reference/react/useEffect"><code>useEffect</code> Hook</a>：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-li3nqclqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-li3nqclqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useEffect &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br></code></pre></td></tr></table></div></figure>

<p>然后，在组件顶部调用它，并传入在每次渲染时都需要执行的代码：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-ek3rf1lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-ek3rf1lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">MyComponent</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-comment">// 每次渲染后都会执行此处的代码</span><br>  &#125;);<br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> /&gt;</span></span>;<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>每当你的组件渲染时，React 将更新屏幕，然后运行 <code>useEffect</code> 中的代码。换句话说，**<code>useEffect</code> 会把这段代码放到屏幕更新渲染之后执行**。</p>
<p>让我们看看如何使用 Effect 与外部系统同步。考虑一个 <code>&lt;VideoPlayer&gt;</code> React 组件。通过传递布尔类型的 <code>isPlaying</code> prop 以控制是播放还是暂停：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-suysxclqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-suysxclqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jsx">&lt;<span class="hljs-title class_">VideoPlayer</span> isPlaying=&#123;isPlaying&#125; /&gt;;<br></code></pre></td></tr></table></div></figure>

<p>自定义的 <code>VideoPlayer</code> 组件渲染了内置的 <code>video</code> 标签：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-w44isxlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-w44isxlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">VideoPlayer</span>(<span class="hljs-params">&#123; src, isPlaying &#125;</span>) &#123;<br>  <span class="hljs-comment">// TODO：使用 isPlaying 做一些事情</span><br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">video</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&#123;src&#125;</span> /&gt;</span></span>;<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>但是，浏览器的 <code>&lt;video&gt;</code> 标签没有 <code>isPlaying</code> 属性。控制它的唯一方式是在 DOM 元素上调用 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/HTMLMediaElement/play"><code>play()</code></a> 和 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/HTMLMediaElement/pause"><code>pause()</code></a> 方法。因此，<strong>你需要将 <code>isPlaying</code> prop 的值与 <code>play()</code> 和 <code>pause()</code> 等函数的调用进行同步，该属性用于告知当前视频是否应该播放</strong>。</p>
<p>首先要获取 <code>&lt;video&gt;</code>  DOM 节点的 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/manipulating-the-dom-with-refs">对象引用</a>。</p>
<p>你可能会尝试在渲染期间调用 <code>play()</code> 或 <code>pause()</code>，但这种做法是错的：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-yuitjnlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-yuitjnlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState, useRef, useEffect &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">VideoPlayer</span>(<span class="hljs-params">&#123; src, isPlaying &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> ref = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);<br><br>  <span class="hljs-keyword">if</span> (isPlaying) &#123;<br>    ref.<span class="hljs-property">current</span>.<span class="hljs-title function_">play</span>();  <span class="hljs-comment">// 渲染期间不能调用 `play()`。 </span><br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    ref.<span class="hljs-property">current</span>.<span class="hljs-title function_">pause</span>(); <span class="hljs-comment">// 同样，调用 `pause()` 也不行。</span><br>  &#125;<br><br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">video</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;ref&#125;</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&#123;src&#125;</span> <span class="hljs-attr">loop</span> <span class="hljs-attr">playsInline</span> /&gt;</span></span>;<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [isPlaying, setIsPlaying] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> setIsPlaying(!isPlaying)&#125;&gt;</span><br><span class="language-xml">        &#123;isPlaying ? &#x27;暂停&#x27; : &#x27;播放&#x27;&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">VideoPlayer</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">isPlaying</span>=<span class="hljs-string">&#123;isPlaying&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>报错：</p>
<figure class="highlight pgsql"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-8y2676lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-8y2676lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">Runtime Error<br>App.js: Cannot <span class="hljs-keyword">read</span> properties <span class="hljs-keyword">of</span> <span class="hljs-keyword">null</span> (reading <span class="hljs-string">&#x27;pause&#x27;</span>) (<span class="hljs-number">9</span>:<span class="hljs-number">16</span>)<br><br>   <span class="hljs-number">6</span> |   <span class="hljs-keyword">if</span> (isPlaying) &#123;<br>   <span class="hljs-number">7</span> |     <span class="hljs-keyword">ref</span>.<span class="hljs-keyword">current</span>.play();  // æ¸²ææé´ä¸è½è°ç¨ `play()`ã <br>   <span class="hljs-number">8</span> |   &#125; <span class="hljs-keyword">else</span> &#123;<br>&gt;  <span class="hljs-number">9</span> |     <span class="hljs-keyword">ref</span>.<span class="hljs-keyword">current</span>.pause(); // åæ ·ï¼è°ç¨ `pause()` ä¹ä¸è¡ã<br>                       ^<br>  <span class="hljs-number">10</span> |   &#125;<br>  <span class="hljs-number">11</span> | <br>  <span class="hljs-number">12</span> |   <span class="hljs-keyword">return</span> &lt;video <span class="hljs-keyword">ref</span>=&#123;<span class="hljs-keyword">ref</span>&#125; src=&#123;src&#125; <span class="hljs-keyword">loop</span> playsInline /&gt;;<br></code></pre></td></tr></table></div></figure>

<p>这段代码之所以不正确，是因为它试图在渲染期间对 DOM 节点进行操作。<mark>在 React 中，<a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/keeping-components-pure">JSX 的渲染必须是纯粹操作</a>，不应该包含任何像修改 DOM 的副作用。</mark></p>
<p>而且，当第一次调用 <code>VideoPlayer</code> 时，对应的 DOM 节点甚至还不存在！如果连 DOM 节点都没有，那么如何调用 <code>play()</code> 或 <code>pause()</code> 方法呢！在返回 JSX 之前，React 不知道要创建什么 DOM。</p>
<p>解决办法是 <strong>使用 <code>useEffect</code> 包裹副作用，把它分离到渲染逻辑的计算过程之外</strong>：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-ae4vl3lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-ae4vl3lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useEffect, useRef &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">VideoPlayer</span>(<span class="hljs-params">&#123; src, isPlaying &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> ref = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (isPlaying) &#123;<br>      ref.<span class="hljs-property">current</span>.<span class="hljs-title function_">play</span>();<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      ref.<span class="hljs-property">current</span>.<span class="hljs-title function_">pause</span>();<br>    &#125;<br>  &#125;);<br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">video</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;ref&#125;</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&#123;src&#125;</span> <span class="hljs-attr">loop</span> <span class="hljs-attr">playsInline</span> /&gt;</span></span>;<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>把调用 DOM 方法的操作封装在 Effect 中，你可以让 React 先更新屏幕，确定相关 DOM 创建好了以后然后再运行 Effect。</p>
<p>当 <code>VideoPlayer</code> 组件渲染时（无论是否为首次渲染），都会发生以下事情。首先，React 会刷新屏幕，确保 <code>&lt;video&gt;</code> 元素已经正确地出现在 DOM 中；然后，React 将运行 Effect；最后，Effect 将根据 <code>isPlaying</code> 的值调用 <code>play()</code> 或 <code>pause()</code>。</p>
<p>试试按下几次播放和暂停操作，观察视频播放器的播放、暂停行为是如何与 <code>isPlaying</code> prop 同步的：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-2zogh4lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-2zogh4lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState, useRef, useEffect &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">VideoPlayer</span>(<span class="hljs-params">&#123; src, isPlaying &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> ref = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);<br><br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (isPlaying) &#123;<br>      ref.<span class="hljs-property">current</span>.<span class="hljs-title function_">play</span>();<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      ref.<span class="hljs-property">current</span>.<span class="hljs-title function_">pause</span>();<br>    &#125;<br>  &#125;);<br><br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">video</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;ref&#125;</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&#123;src&#125;</span> <span class="hljs-attr">loop</span> <span class="hljs-attr">playsInline</span> /&gt;</span></span>;<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [isPlaying, setIsPlaying] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> setIsPlaying(!isPlaying)&#125;&gt;</span><br><span class="language-xml">        &#123;isPlaying ? &#x27;暂停&#x27; : &#x27;播放&#x27;&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">VideoPlayer</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">isPlaying</span>=<span class="hljs-string">&#123;isPlaying&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>Effect 会在  <strong>每次</strong> 渲染后执行，<strong>而以下代码会陷入死循环中</strong>：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-etl4eflqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-etl4eflqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>);<br>&#125;);<br></code></pre></td></tr></table></div></figure>

<p>每次渲染结束都会执行 Effect；而更新 state 会触发重新渲染。但是新一轮渲染时又会再次执行 Effect，然后 Effect 再次更新 state……如此周而复始，从而陷入死循环。</p>
<p>Effect 通常应该使组件与 <strong>外部</strong> 系统保持同步。如果没有外部系统，你只想根据其他状态调整一些状态，那么 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/you-might-not-need-an-effect">你也许不需要 Effect</a>。</p>
<hr>
<p>第二步：指定 Effect 依赖：一般来说，Effect 会在 <strong>每次</strong> 渲染时执行。<strong>但更多时候，并不需要每次渲染的时候都执行 Effect</strong>。</p>
<ol>
<li>有时这会拖慢运行速度。因为与外部系统的同步操作总是有一定时耗，在非必要时可能希望跳过它。例如，没有人会希望每次用键盘打字时都重新连接聊天服务器。</li>
<li>有时这会导致程序逻辑错误。例如，组件的淡入动画只需要在第一轮渲染出现时播放一次，而不是每次触发新一轮渲染后都播放。</li>
</ol>
<p>将 <strong>依赖数组</strong> 传入 <code>useEffect</code> 的第二个参数，以告诉 React <strong>跳过不必要地重新运行 Effect</strong>。传入一个空数组 <code>[]</code>：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-k8hnuglqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-k8hnuglqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br><span class="hljs-comment">// ...</span><br>&#125;, []);<br></code></pre></td></tr></table></div></figure>

<p>报错：<code>React Hook useEffect has a missing dependency: &#39;isPlaying&#39;. Either include it or remove the dependency array.</code></p>
<p>问题出现在 Effect 中使用了 <code>isPlaying</code> prop 以控制逻辑，但又没有直接告诉 Effect 需要依赖这个属性。为了解决这个问题，将 <code>isPlaying</code> 添加至依赖数组中：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-xbkinjlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-xbkinjlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (isPlaying) &#123; <span class="hljs-comment">// isPlaying 在此处使用……</span><br>        <span class="hljs-comment">// ...</span><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// ...</span><br>    &#125;<br>&#125;, [isPlaying]); <span class="hljs-comment">// ……所以它必须在此处声明！</span><br></code></pre></td></tr></table></div></figure>

<p>现在所有的依赖都已经声明，所以没有错误了。<mark>指定 <code>[isPlaying]</code> 会告诉 React，如果 <code>isPlaying</code> 在上一次渲染时与当前相同，它应该跳过重新运行 Effect</mark>。通过这个改变，输入框的输入不会导致 Effect 重新运行，但是按下播放&#x2F;暂停按钮会重新运行 Effect。</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-26d48clqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-26d48clqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState, useRef, useEffect &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">VideoPlayer</span>(<span class="hljs-params">&#123; src, isPlaying &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> ref = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);<br><br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (isPlaying) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Calling video.play()&#x27;</span>);<br>      ref.<span class="hljs-property">current</span>.<span class="hljs-title function_">play</span>();<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Calling video.pause()&#x27;</span>);<br>      ref.<span class="hljs-property">current</span>.<span class="hljs-title function_">pause</span>();<br>    &#125;<br>  &#125;, [isPlaying]);<br><br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">video</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;ref&#125;</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&#123;src&#125;</span> <span class="hljs-attr">loop</span> <span class="hljs-attr">playsInline</span> /&gt;</span></span>;<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [isPlaying, setIsPlaying] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);<br>  <span class="hljs-keyword">const</span> [text, setText] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;&#x27;</span>);<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;text&#125;</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> setText(e.target.value)&#125; /&gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> setIsPlaying(!isPlaying)&#125;&gt;</span><br><span class="language-xml">        &#123;isPlaying ? &#x27;Pause&#x27; : &#x27;Play&#x27;&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">VideoPlayer</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">isPlaying</span>=<span class="hljs-string">&#123;isPlaying&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>依赖数组可以包含多个依赖项。当指定的所有依赖项在上一次渲染期间的值与当前值完全相同时，React 会跳过重新运行该 Effect。React 使用 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/is"><code>Object.is</code></a> 比较依赖项的值。</p>
<p>请注意，<mark>不能随意选择依赖项</mark>。如果你指定的依赖项不能与 Effect 代码所期望的相匹配时，lint 将会报错，这将帮助你找到代码中的问题。如果你不希望某些代码重新运行，<a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/lifecycle-of-reactive-effects#what-to-do-when-you-dont-want-to-re-synchronize">那么你应当 <strong>重新编辑 Effect 代码本身</strong>，使其不需要该依赖项</a>。</p>
<p><mark>没有依赖数组作为第二个参数，与依赖数组位空数组 <code>[]</code> 的行为是不一致的</mark>：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-oub9i9lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-oub9i9lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-comment">// 这里的代码会在每次渲染后执行</span><br>&#125;);<br><br><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-comment">// 这里的代码只会在组件挂载后执行</span><br>&#125;, []);<br><br><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-comment">//这里的代码只会在每次渲染后，并且 a 或 b 的值与上次渲染不一致时执行</span><br>&#125;, [a, b]);<br></code></pre></td></tr></table></div></figure>

<p>为什么依赖数组中可以省略 ref? </p>
<p>下面的 Effect 同时使用了 <code>ref</code> 与 <code>isPlaying</code> prop，但是只有 <code>isPlaying</code> 被声明为了依赖项：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-2plb6rlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-2plb6rlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">VideoPlayer</span>(<span class="hljs-params">&#123; src, isPlaying &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> ref = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (isPlaying) &#123;<br>      ref.<span class="hljs-property">current</span>.<span class="hljs-title function_">play</span>();<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      ref.<span class="hljs-property">current</span>.<span class="hljs-title function_">pause</span>();<br>    &#125;<br>  &#125;, [isPlaying]);<br></code></pre></td></tr></table></div></figure>

<p>这是因为 <code>ref</code> 具有 <strong>稳定</strong> 的标识：React 保证 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/reference/react/useRef#returns">每轮渲染中调用 <code>useRef</code> 所产生的引用对象时，获取到的对象引用总是相同的</a>，即获取到的对象引用永远不会改变，所以它不会导致重新运行 Effect。因此，依赖数组中是否包含它并不重要。当然也可以包括它，这样也可以：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-6fbjn0lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-6fbjn0lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">VideoPlayer</span>(<span class="hljs-params">&#123; src, isPlaying &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> ref = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (isPlaying) &#123;<br>      ref.<span class="hljs-property">current</span>.<span class="hljs-title function_">play</span>();<br>    &#125; <span class="hljs-keyword">else</span> &#123;      ref.<span class="hljs-property">current</span>.<span class="hljs-title function_">pause</span>();<br>    &#125;<br>  &#125;, [isPlaying, ref]);<br></code></pre></td></tr></table></div></figure>

<p><code>useState</code> 返回的 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/reference/react/useState#setstate"><code>set</code> 函数</a> 也有稳定的标识符，所以也可以把它从依赖数组中忽略掉。如果在忽略某个依赖项时 linter 不会报错，那么这么做就是安全的。</p>
<p>但是，仅在 linter 可以“看到”对象稳定时，忽略稳定依赖项的规则才会起作用。例如，如果 <code>ref</code> 是从父组件传递的，则必须在依赖项数组中指定它。这样做是合适的，因为无法确定父组件是否始终是传递相同的 ref，或者可能是有条件地传递几个 ref 之一。因此，你的 Effect 将取决于传递的是哪个 ref。</p>
<hr>
<p>第三步：按需添加清理（cleanup）函数 </p>
<p>考虑一个不同的例子。你正在编写一个 <code>ChatRoom</code> 组件，该组件出现时需要连接到聊天服务器。现在为你提供了 <code>createConnection()</code> API，该 API 返回一个包含 <code>connect()</code> 与 <code>disconnection()</code> 方法的对象。考虑当组件展示给用户时，应该如何保持连接？</p>
<p>从编写 Effect 逻辑开始：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-kv2w0blqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-kv2w0blqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> connection = <span class="hljs-title function_">createConnection</span>();<br>  connection.<span class="hljs-title function_">connect</span>();<br>&#125;);<br></code></pre></td></tr></table></div></figure>

<p>每次重新渲染后连接到聊天室会很慢，因此可以添加依赖数组：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-v2yyidlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-v2yyidlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> connection = <span class="hljs-title function_">createConnection</span>();<br>  connection.<span class="hljs-title function_">connect</span>();<br>&#125;, []);<br></code></pre></td></tr></table></div></figure>

<p>Effect 中的代码没有使用任何 props 或 state，此时指定依赖数组为空数组 <code>[]</code>。这告诉 React 仅在组件“挂载”时运行此代码，即首次出现在屏幕上这一阶段。</p>
<p>chat.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-ogthwalqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-ogthwalqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createConnection</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-comment">// 真实的实现会将其连接到服务器，此处代码只是示例</span><br>  <span class="hljs-keyword">return</span> &#123;<br>    <span class="hljs-title function_">connect</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;✅ 连接中……&#x27;</span>);<br>    &#125;,<br>    <span class="hljs-title function_">disconnect</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;❌ 连接断开。&#x27;</span>);<br>    &#125;<br>  &#125;;<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>App.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-9n5vp6lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-9n5vp6lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useEffect &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; createConnection &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./chat.js&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatRoom</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> connection = <span class="hljs-title function_">createConnection</span>();<br>    connection.<span class="hljs-title function_">connect</span>();<br>  &#125;, []);<br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>欢迎来到聊天室！<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>;<br>&#125;<br></code></pre></td></tr></table></div></figure>

<img src="image-20231114171125599.png" srcset="/img/loading.gif" lazyload alt="image-20231114171125599" style="zoom:50%;" />

<p>这里的 Effect 仅在组件挂载时执行，所以 <code>&quot;✅ 连接中……&quot;</code> 在控制台中只会打印一次。<strong>然而控制台实际打印 <code>&quot;✅ 连接中……&quot;</code> 了两次！为什么会这样</strong>？</p>
<p>想象 <code>ChatRoom</code> 组件是一个大规模的 App 中许多界面中的一部分。用户切换到含有 <code>ChatRoom</code> 组件的页面上时，该组件被挂载，并调用 <code>connection.connect()</code> 方法连接服务器。然后想象用户此时突然导航到另一个页面，比如切换到“设置”页面。这时，<code>ChatRoom</code> 组件就被卸载了。接下来，用户在“设置”页面忙完后，单击“返回”，回到上一个页面，并再次挂载 <code>ChatRoom</code>。这将建立第二次连接，但是，第一次时创建的连接从未被销毁！当用户在应用程序中不断切换界面再返回时，与服务器的连接会不断堆积。</p>
<p>如果不进行大量的手动测试，这样的错误很容易被遗漏。<mark>为了帮助你快速发现它们，在开发环境中，React 会在初始挂载组件后，立即再挂载一次</mark>。</p>
<p>观察到 <code>&quot;✅ 连接中……&quot;</code> 出现了两次，可以帮助找到问题所在：在代码中，组件被卸载时没有关闭连接。</p>
<p>为了解决这个问题，可以在 Effect 中返回一个 <strong>清理（cleanup）</strong> 函数。</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-9hm1vllqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-9hm1vllqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> connection = <span class="hljs-title function_">createConnection</span>();<br>    connection.<span class="hljs-title function_">connect</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> &#123;<br>        connection.<span class="hljs-title function_">disconnect</span>();<br>    &#125;;<br>&#125;, []);<br></code></pre></td></tr></table></div></figure>

<p>每次重新执行 Effect 之前，React 都会调用清理函数；组件被卸载时，也会调用清理函数。让我们看看执行清理函数会做些什么：</p>
<img src="image-20231114171713151.png" srcset="/img/loading.gif" lazyload alt="image-20231114171713151" style="zoom:50%;" />

<ol>
<li><strong>在开发环境下，出现这样的结果才是符合预期的</strong>。重复挂载组件，可以确保在 React 中离开和返回页面时不会导致代码运行出现问题。上面的代码中规定了挂载组件时连接服务器、卸载组件时断连服务器。所以断开、连接再重新连接是符合预期的行为。当为 Effect 正确实现清理函数时，无论 Effect 执行一次，还是执行、清理、再执行，用户都不会感受到明显的差异。所以，在开发环境下，出现额外的连接、断连时，这是 React 正在调试你的代码。这是很正常的现象，不要试图消除它！</li>
<li><strong>在生产环境下，<code>&quot;✅ 连接中……&quot;</code> 只会被打印一次</strong>。也就是说仅在开发环境下才会重复挂载组件，以帮助你找到需要清理的 Effect。你可以选择关闭 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/reference/react/StrictMode">严格模式</a> 来关闭开发环境下特有的行为，但我们建议保留它。这可以帮助发现许多上面这样的错误。</li>
</ol>
<p>如何处理在开发环境中 Effect 执行两次？ </p>
<ul>
<li>在开发环境中，React 有意重复挂载你的组件，以查找像上面示例中的错误。<strong>正确的态度是“如何修复 Effect 以便它在重复挂载后能正常工作”，而不是“如何只运行一次 Effect”</strong>。</li>
<li>通常的解决办法是实现清理函数。清理函数应该停止或撤销 Effect 正在执行的任何操作。简单来说，用户不应该感受到 Effect 只执行一次（如在生产环境中）和执行“挂载 → 清理 → 挂载”过程（如在开发环境中）之间的差异。</li>
</ul>
<p>常用的 Effect 应用模式：</p>
<ol>
<li><p><mark>控制非 React 组件</mark>：有时需要添加不是使用 React 编写的 UI 小部件。例如，假设你要向页面添加地图组件，并且它有一个 <code>setZoomLevel()</code> 方法，你希望调整缩放级别（zoom level）并与 React 代码中的 <code>zoomLevel</code> state 变量保持同步。Effect 看起来应该与下面类似：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-trptbplqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-trptbplqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> map = mapRef.<span class="hljs-property">current</span>;  map.<span class="hljs-title function_">setZoomLevel</span>(zoomLevel);<br>&#125;, [zoomLevel]);<br></code></pre></td></tr></table></div></figure>

<p>请注意，在这种情况下不需要清理。在开发环境中，React 会调用 Effect 两次，但这两次挂载时依赖项 <code>zoomLevel</code> 都是相同的，所以会跳过执行第二次挂载时的 Effect。开发环境中它可能会稍微慢一些，但这问题不大，因为它在生产中不会进行不必要的重复挂载。</p>
<p>某些 API 可能不允许连续调用两次。例如，内置的 <code>showModal</code>方法在连续调用两次时会抛出异常，此时实现清理函数并使其关闭对话框：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-f10ymnlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-f10ymnlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> dialog = dialogRef.<span class="hljs-property">current</span>;<br>  dialog.<span class="hljs-title function_">showModal</span>();<br>  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> dialog.<span class="hljs-title function_">close</span>();<br>&#125;, []);<br></code></pre></td></tr></table></div></figure>

<p>在开发环境中，Effect 将调用 <code>showModal()</code>，然后立即调用 <code>close()</code>，然后再次调用 <code>showModal()</code>。这与调用只一次 <code>showModal()</code> 的效果相同。也正如在生产环境中看到的那样。</p>
</li>
<li><p><mark>订阅事件</mark>：如果 Effect 订阅了某些事件，清理函数应该退订这些事件：</p>
</li>
</ol>
   <figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-indclylqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-indclylqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleScroll</span>(<span class="hljs-params">e</span>) &#123;    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">scrollX</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">scrollY</span>);<br><br>  &#125; <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;scroll&#x27;</span>, handleScroll);<br>  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">&#x27;scroll&#x27;</span>, handleScroll);<br>&#125;, []);<br></code></pre></td></tr></table></div></figure>

<p>   在开发环境中，Effect 会调用 <code>addEventListener()</code>，然后立即调用 <code>removeEventListener()</code>，然后再调用相同的 <code>addEventListener()</code>，这与只订阅一次事件的 Effect 等效；这也与用户在生产环境中只调用一次 <code>addEventListener()</code> 具有相同的感知效果。</p>
<ol start="3">
<li><p><mark>触发动画</mark>：如果 Effect 对某些内容加入了动画，清理函数应将动画重置：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-nulxb4lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-nulxb4lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> node = ref.<span class="hljs-property">current</span>;<br>  node.<span class="hljs-property">style</span>.<span class="hljs-property">opacity</span> = <span class="hljs-number">1</span>; <span class="hljs-comment">// 触发动画</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> &#123;    node.<span class="hljs-property">style</span>.<span class="hljs-property">opacity</span> = <span class="hljs-number">0</span>; <span class="hljs-comment">// 重置为初始值</span><br>  &#125;;<br>&#125;, []);<br></code></pre></td></tr></table></div></figure>

<p>在开发环境中，透明度由 <code>1</code> 变为 <code>0</code>，再变为 <code>1</code>。这与在生产环境中，直接将其设置为 <code>1</code> 具有相同的感知效果，如果你使用支持过渡的第三方动画库，你的清理函数应将时间轴重置为其初始状态。</p>
</li>
<li><p><mark>获取数据</mark>：如果 Effect 将会获取数据，清理函数应该要么 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/AbortController">中止该数据获取操作</a>，要么忽略其结果：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-2y945plqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-2y945plqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">let</span> ignore = <span class="hljs-literal">false</span>;<br>  <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">startFetching</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">const</span> json = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchTodos</span>(userId);<br>    <span class="hljs-keyword">if</span> (!ignore) &#123;<br>      <span class="hljs-title function_">setTodos</span>(json);<br>    &#125;<br>  &#125;<br>  <span class="hljs-title function_">startFetching</span>();<br>  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> &#123;<br>    ignore = <span class="hljs-literal">true</span>;<br>  &#125;;<br>&#125;, [userId]);<br></code></pre></td></tr></table></div></figure>

<p>我们无法撤消已经发生的网络请求，但是清理函数应当确保获取数据的过程以及获取到的结果不会继续影响程序运行。如果 <code>userId</code> 从 <code>&#39;Alice&#39;</code> 变为 <code>&#39;Bob&#39;</code>，那么请确保 <code>&#39;Alice&#39;</code> 响应数据被忽略，即使它在 <code>&#39;Bob&#39;</code> 之后到达。</p>
<p><strong>在开发环境中，浏览器调试工具的“网络”选项卡中会出现两个 fetch 请求</strong>。这是正常的。使用上述方法，第一个 Effect 将立即被清理，而 <code>ignore</code> 将被设置为 <code>true</code>。因此，即使有额外的请求，由于有 <code>if (!ignore)</code> 判断检查，也不会影响程序状态。</p>
<p><strong>在生产环境中，只会显示发送了一条获取请求</strong>。如果开发环境中，第二次请求给你造成了困扰，最好的方法是使用一种可以删除重复请求、并缓存请求响应的解决方案：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-tkrtw9lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-tkrtw9lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">TodoList</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> todos = <span class="hljs-title function_">useSomeDataLibrary</span>(<span class="hljs-string">`/api/user/<span class="hljs-subst">$&#123;userId&#125;</span>/todos`</span>);<br>  <span class="hljs-comment">// ...</span><br></code></pre></td></tr></table></div></figure>

<p>这不仅可以提高开发体验，还可以让你的应用程序速度更快。例如，用户按下按钮时，如果数据已经被缓存了，那么就不必再次等待加载。你可以自己构建这样的缓存，也可以使用很多在 Effect 中手动加载数据的替代方法。</p>
<ul>
<li><p>Effect 中有哪些好的数据获取替代方案？</p>
<p>在 Effect 中调用 <code>fetch</code> 请求数据 <a target="_blank" rel="noopener" href="https://www.robinwieruch.de/react-hooks-fetch-data/">是一种非常受欢迎的方式</a>，特别是在客户端应用中。然而，它非常依赖手动操作，有很多的缺点：</p>
<ul>
<li><strong>Effect 不能在服务端执行</strong>。这意味着服务器最初传递的 HTML 不会包含任何数据。客户端的浏览器必须下载所有 JavaScript 脚本来渲染应用程序，然后才能加载数据——这并不搞笑。</li>
<li><strong>直接在 Effect 中获取数据容易产生网络瀑布（network waterfall）</strong>。首先渲染了父组件，它会获取一些数据并进行渲染；然后渲染子组件，接着子组件开始获取它们的数据。如果网络速度不够快，这种方式比同时获取所有数据要慢得多。</li>
<li><strong>直接在 Effect 中获取数据通常意味着无法预加载或缓存数据</strong>。例如，在组件卸载后然后再次挂载，那么它必须再次获取数据。</li>
<li><strong>这不是很符合人机交互原则</strong>。如果你不想出现像 <a target="_blank" rel="noopener" href="https://maxrozen.com/race-conditions-fetching-data-react-with-useeffect">条件竞争（race condition）</a> 之类的问题，那么你需要编写更多的样板代码。</li>
</ul>
<p>以上所列出来的缺点并不是 React 特有的。在任何框架或者库上的组件挂载过程中获取数据，都会遇到这些问题。与路由一样，要做好数据获取并非易事，因此我们推荐以下方法：</p>
<ul>
<li><strong>如果你正在使用 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/start-a-new-react-project#production-grade-react-frameworks">框架</a> ，使用其内置的数据获取机制</strong>。现代 React 框架集成了高效的数据获取机制，不会出现上述问题。</li>
<li><strong>否则，请考虑使用或构建客户端缓存</strong>。目前受欢迎的开源解决方案是 <a target="_blank" rel="noopener" href="https://tanstack.com/query/latest">React Query</a>、<a target="_blank" rel="noopener" href="https://swr.vercel.app/">useSWR</a> 和 <a target="_blank" rel="noopener" href="https://beta.reactrouter.com/en/main/start/overview">React Router v6.4+</a>。你也可以构建自己的解决方案，在这种情况下，你可以在幕后使用 Effect，但是请注意添加用于删除重复请求、缓存响应和避免网络瀑布（通过预加载数据或将数据需求提升到路由）的逻辑。</li>
</ul>
<p>如果这些方法都不适合你，你可以继续直接在 Effect 中获取数据。</p>
</li>
</ul>
</li>
<li><p><mark>发送分析报告</mark>：考虑在访问页面时发送日志分析：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-tqmerylqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-tqmerylqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-title function_">logVisit</span>(url); <span class="hljs-comment">// 发送 POST 请求</span><br>&#125;, [url]);<br></code></pre></td></tr></table></div></figure>

<p>在开发环境中，<code>logVisit</code> 会为每个 URL 发送两次请求，所以你可能会想尝试解决这个问题。<strong>不过我们建议不必修改此处代码</strong>，与前面的示例一样，从用户的角度来看，运行一次和运行两次之间不会 <strong>感知</strong> 到行为差异。从实际的角度来看，<code>logVisit</code> 不应该在开发环境中做任何影响生产事情。由于每次保存代码文件时都会重新挂载组件，因此在开发环境中会额外记录访问次数。</p>
<p><strong>在生产环境中，不会产生有重复的访问日志</strong>。</p>
<p>为了调试发送的分析事件，可以将应用部署到一个运行在生产模式下的暂存环境，或者暂时取消 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/reference/react/StrictMode">严格模式</a> 及其仅在开发环境中重新加载检查；还可以从路由变更事件处理程序中发送分析数据，而不是从 Effect 中发送。为了更精确的分析，可以使用 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/Intersection_Observer_API">Intersection Observer</a> 来跟踪哪些组件位于视口中以及它们保持可见的时间。</p>
</li>
<li><p><mark>初始化应用时不需要使用 Effect 的情形</mark>：某些逻辑应该只在应用程序启动时运行一次。比如，验证登陆状态和加载本地程序数据。你可以将其放在组件之外：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-302nzolqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-302nzolqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> !== <span class="hljs-string">&#x27;undefined&#x27;</span>) &#123; <span class="hljs-comment">// 检查是否在浏览器中运行</span><br>  <span class="hljs-title function_">checkAuthToken</span>();  <span class="hljs-title function_">loadDataFromLocalStorage</span>();<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-comment">// ……</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>这保证了这种逻辑在浏览器加载页面后只运行一次。</p>
</li>
<li><p><mark>不要在 Effect 中执行购买商品一类的操作</mark>：有时，即使编写了一个清理函数，也不能避免执行两次 Effect。例如，Effect 包含会发送 POST 请求以执行购买操作：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-5a3afulqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-5a3afulqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-comment">// 🔴 错误：此处的 Effect 会在开发环境中执行两次，这在代码中是有问题的。</span><br>  <span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;/api/buy&#x27;</span>, &#123; <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span> &#125;);<br>&#125;, []);<br></code></pre></td></tr></table></div></figure>

<p>一方面，开发环境下，Effect 会执行两次，这意味着购买操作执行了两次，但是这并非是预期的结果，所以不应该把这个业务逻辑放在 Effect 中。另一方面，如果用户转到另一个页面，然后按“后退”按钮回到了这个界面，该怎么办？Effect 会随着组件再次挂载而再次执行。所以，当用户重新访问某个页面时，不应当执行购买操作；当只有用户点击“购买”按钮时，才执行购买操作。</p>
<p>因此，“购买”的操作不应由组件的挂载、渲染引起的；它是由特定的交互作用引起的，它应该只在用户按下按钮时运行。因此，<strong>它不应该写在 Effect 中，应当把 <code>/api/buy</code> 请求操作移动到购买按钮事件处理程序中</strong>：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-hx18q6lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-hx18q6lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-comment">// ✅ 购买商品应当在事件中执行，因为这是由特定的操作引起的。</span><br>  <span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;/api/buy&#x27;</span>, &#123; <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span> &#125;);<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p><strong>这个例子说明如果重新挂载破坏了应用程序的逻辑，则通常含有未被发现的错误</strong>。从用户的角度来看，访问一个页面不应该与访问它、点击链接然后按下返回键再次查看页面有什么不同。React 通过在开发环境中重复挂载组件以验证组件是否遵守此原则。</p>
</li>
</ol>
<p>使用 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/setTimeout"><code>setTimeout</code></a> 来安排控制台日志，在 Effect 运行后三秒钟显示输入文本。清理函数会取消挂起的超时。从按下“挂载组件”开始：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-m7cg6jlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-m7cg6jlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState, useEffect &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Playground</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [text, setText] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;a&#x27;</span>);<br><br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">function</span> <span class="hljs-title function_">onTimeout</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;⏰ &#x27;</span> + text);<br>    &#125;<br><br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;🔵 安排 &quot;&#x27;</span> + text + <span class="hljs-string">&#x27;&quot; 日志&#x27;</span>);<br>    <span class="hljs-keyword">const</span> timeoutId = <span class="hljs-built_in">setTimeout</span>(onTimeout, <span class="hljs-number">3000</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;🟡 取消 &quot;&#x27;</span> + text + <span class="hljs-string">&#x27;&quot; 日志&#x27;</span>);<br>      <span class="hljs-built_in">clearTimeout</span>(timeoutId);<br>    &#125;;<br>  &#125;, [text]);<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">        日志内容：&#123;&#x27; &#x27;&#125;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">input</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;text&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> setText(e.target.value)&#125;</span><br><span class="language-xml">        /&gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>&#123;text&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [show, setShow] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> setShow(!show)&#125;&gt;</span><br><span class="language-xml">        &#123;show ? &#x27;卸载&#x27; : &#x27;挂载&#x27;&#125; 组件</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      &#123;show &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">hr</span> /&gt;</span>&#125;</span><br><span class="language-xml">      &#123;show &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">Playground</span> /&gt;</span>&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>在最开始时可以看到三个日志输出：<code>安排 &quot;a&quot; 日志</code>，<code>取消 &quot;a&quot; 日志</code>，还有一个 <code>安排 &quot;a&quot; 日志</code>。三秒后，还会有一条日志显示：<code>a</code>。正如之前所说，额外的安排&#x2F;取消动作产生的原因是因为 React 在开发环境中，会重新挂载组件一次，以验证你是否正确地实现了清理函数。</p>
<p>现在编辑输入框，输入 <code>abc</code>。如果输入速度足够快，你会看到 <code>安排 &quot;ab&quot; 日志</code>，紧接着的是 <code>取消 &quot;ab&quot; 日志</code> 和 <code>安排 &quot;abc&quot; 日志</code>。<strong>React 总是在执行下一轮渲染的 Effect 之前清理上一轮渲染的 Effect</strong>。这就是为什么即使你快速输入，最多也只有一个安排操作。</p>
<p>在输入框中输入一些内容，然后立即按下“卸载组件”按钮。注意卸载时如何清理最后一轮渲染的 Effect。在这里，它在触发卸载之前，清除了最后一次安排操作。</p>
<p>最后，在上面的代码中注释掉清理函数，这样安排操作就不会被取消。尝试快速输入 <code>abcde</code>。你预期三秒钟内会发生什么？计时器安排内的 <code>console.log(text)</code> 会打印 <strong>最新</strong> 的 <code>text</code> 并产生五个 <code>abcde</code> 日志吗？验证你的直觉吧！</p>
<p>三秒后，你应该看到一系列日志：<code>a</code>、<code>ab</code>、<code>abc</code>、<code>abcd</code> 与 <code>abcde</code>，而不是五个 <code>abcde</code>。<strong>每个 Effect 都会“捕获”其对应渲染的 <code>text</code> 值</strong>。<code>text</code> state 发生变化并不重要：来自 <code>text = &#39;ab&#39;</code> 的渲染的 Effect 始终会得到 <code>&#39;ab&#39;</code>。换句话说，每个渲染的 Effect 都是相互隔离的。如果你对这是如何工作的感到好奇，你可以阅读有关 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Closures">闭包</a> 的内容。</p>
<hr>
<p>挂载后聚焦于表单字段：表单中渲染了一个 <code>&lt;MyInput /&gt;</code> 组件。</p>
<p>使用输入框的 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/HTMLElement/focus"><code>focus()</code></a> 方法，以在 <code>MyInput</code> 出现在屏幕上时自动聚焦。如果你熟悉 <code>autoFocus</code> 属性，请假装它不存在：我们正在从头开始重新实现相同的功能。</p>
<p>解答：<mark>在渲染期间调用 <code>ref.current.focus()</code> 本身是不正确的。因为这会产生“副作用”。副作用要么应该放在事件处理程序里面，要么在 <code>useEffect</code> 中</mark>。在这种情况下，副作用是组件渲染引起的，而不是任何特定的交互引起的，因此应该将它放在 Effect 中。</p>
<p>为了修复这个错误，可以对 <code>ref.current.focus()</code> 的调用包裹在 Effect 中。然后确保这个 Effect 只在组件挂载时执行而不是在每一轮渲染时都执行，可以为 Effect 的声明加一个空的依赖数组 <code>[]</code>。</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-dsi494lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-dsi494lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useEffect, useRef &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">MyInput</span>(<span class="hljs-params">&#123; value, onChange &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> ref = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);<br><br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    ref.<span class="hljs-property">current</span>.<span class="hljs-title function_">focus</span>();<br>  &#125;, []);<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;ref&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;value&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;onChange&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">    /&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<img src="form.gif" srcset="/img/loading.gif" lazyload alt="form" style="zoom:50%;" />

<hr>
<p><mark>有条件地聚焦于表单</mark>：下面的表单渲染两个 <code>&lt;MyInput /&gt;</code> 组件。</p>
<p>按下“展示表单”，同时注意自动聚焦于第二个输入框，这是因为两个 <code>&lt;MyInput /&gt;</code> 组件都在试图把焦点往自身上转移。<mark>当你连续为两个输入框调用 <code>focus()</code> 时，总是聚焦于最后面的输入框</mark>。</p>
<p>假设聚焦于第一个输入框，那么，第一个 <code>MyInput</code> 组件现在接收到 <code>shouldFocus</code> 属性，并且应当被设置为 <code>true</code>。更改下程序逻辑，规定仅当 <code>MyInput</code> 接收到的 <code>shouldFocus</code> 属性为 <code>true</code> 时才调用 <code>focus()</code> 。</p>
<p>解答：向 Effect 中加入条件逻辑。由于 Effect 使用了 <code>shouldFocus</code>，你需要为 Effect 指定 <code>shouldFocus</code> 这个依赖项。这也意味着如果输入框的 <code>shouldFocus</code> 由 <code>false</code> 变为 <code>true</code> 时，它才会在下次渲染时获得焦点。</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-oggngllqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-oggngllqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useEffect, useRef &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">MyInput</span>(<span class="hljs-params">&#123; shouldFocus, value, onChange &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> ref = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);<br><br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (shouldFocus) &#123;<br>      ref.<span class="hljs-property">current</span>.<span class="hljs-title function_">focus</span>();<br>    &#125;<br>  &#125;, [shouldFocus]);<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;ref&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;value&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;onChange&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">    /&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<img src="form2.gif" srcset="/img/loading.gif" lazyload alt="form2" style="zoom:50%;" />

<hr>
<p><mark>修复计时器触发两次的问题</mark>：下面的 <code>Counter</code> 组件显示一个计数器，应该每秒递增一次。在组件挂载时，它调用 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/setInterval"><code>setInterval</code></a>。这会导致 <code>onTick</code> 每秒运行一次。<code>onTick</code> 函数会递增计数器。</p>
<p>然而，计数器不是每秒递增一次，而是两次。这是为什么呢？找出错误的原因并修复它。</p>
<p>解答：在 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/reference/react/StrictMode">严格模式</a> 下，React 在开发模式中，每个组件都会重复挂载一次。这也就导致计数器组件被挂载了两次。所以，计时器也被设立了两次，这就是为什么计数器每秒递增两次的原因。</p>
<p>然而，这并不是 React 本身的错：而是 Effect 代码中本身就存在问题。React 只不过把这个问题放大了。真正的错误原因是这样的 Effect 启动后，但没有提供清理函数，所以上一次的 Effect 残留就没有被除去。</p>
<p>要修复这个问题，保存 <code>setInterval</code> 返回的 interval ID，并使用 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/clearInterval"><code>clearInterval</code></a> 实现一个清理函数：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-nvafj0lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-nvafj0lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState, useEffect &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br><br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">function</span> <span class="hljs-title function_">onTick</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span> c + <span class="hljs-number">1</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">const</span> intervalId = <span class="hljs-built_in">setInterval</span>(onTick, <span class="hljs-number">1000</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(intervalId);<br>  &#125;, []);<br><br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>&#123;count&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>;<br>&#125;<br></code></pre></td></tr></table></div></figure>

<img src="count.gif" srcset="/img/loading.gif" lazyload alt="count" style="zoom:50%;" />

<p>在开发环境中，React 仍然会重复挂载一次组件，通过放大问题，以确保已经正确地实现了清理函数。这样，调用一次 <code>setInterval</code> 后就紧接着调用 <code>clearInterval</code>，然后再调用 <code>setInterval</code>。在生产环境中与开发环境不同，React 只挂载一次组件，即只调用一次 <code>setInterval</code>。两种情况下用户感知的效果是相同的：计数器每秒递增一次。</p>
<hr>
<p>修复在 Effect 中获取数据的问题：下面这个组件显示所选人物的传记。它在挂载时和每当 <code>person</code> 改变时通过调用一个异步函数 <code>fetchBio(person)</code> 来加载传记。该异步函数返回一个 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise">Promise</a>，最终解析为一个字符串。当获取完成时，它调用 <code>setBio</code> 以将该字符串显示在选择框下方。</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-1bpdjilqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-1bpdjilqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState, useEffect &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; fetchBio &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./api.js&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Page</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [person, setPerson] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;Alice&#x27;</span>);<br>  <span class="hljs-keyword">const</span> [bio, setBio] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);<br><br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-title function_">setBio</span>(<span class="hljs-literal">null</span>);<br>    <span class="hljs-title function_">fetchBio</span>(person).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> &#123;<br>      <span class="hljs-title function_">setBio</span>(result);<br>    &#125;);<br>  &#125;, [person]);<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;person&#125;</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> &#123;</span><br><span class="language-xml">        setPerson(e.target.value);</span><br><span class="language-xml">      &#125;&#125;&gt;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;Alice&quot;</span>&gt;</span>Alice<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;Bob&quot;</span>&gt;</span>Bob<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;Taylor&quot;</span>&gt;</span>Taylor<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">hr</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span>&gt;</span>&#123;bio ?? &#x27;加载中……&#x27;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<img src="bio.gif" srcset="/img/loading.gif" lazyload alt="bio" style="zoom:50%;" />

<p>这段代码中有一个错误。试试首先选择 <code>Alice</code>，然后选择 <code>Bob</code>，然后紧接着选择 <code>Taylor</code>。如果操作得足够快，会注意到这个错误：Taylor 被选中了，但下面的一段却说：“这是Bob的传记。”</p>
<p class="note note-success" style="border-left: 4px solid #42b983;padding: 10px 15px;color: #777;background-color: rgba(66, 185, 131, .1);">如果 Effect 需要异步获取某些数据，它通常需要清理函数。</p>

<p>解答：触发问题时，程序的指令序列是这样的：</p>
<ul>
<li>选中 <code>&#39;Bob&#39;</code> 触发 <code>fetchBio(&#39;Bob&#39;)</code></li>
<li>选中 <code>&#39;Taylor&#39;</code> 触发 <code>fetchBio(&#39;Taylor&#39;)</code></li>
<li><strong>在 <code>&#39;Bob&#39;</code> 的数据完成加载之前，就已经完成了对 <code>&#39;Taylor&#39;</code> 的数据的加载</strong></li>
<li>加载 <code>&#39;Taylor&#39;</code> 数据的 Effect 调用了 <code>setBio(&#39;这是Taylor的传记&#39;)</code></li>
<li>加载完成 <code>&#39;Bob&#39;</code> 的数据</li>
<li>加载 <code>&#39;Bob&#39;</code> 数据的 Effect 调用了 <code>setBio(&#39;这是Bob的传记&#39;)</code></li>
</ul>
<p>这就是为什么即使 Taylor 被选中了，但显示的仍然是 Bob 的数据。这种问题被称之为 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Race_condition">条件竞争</a>，因为两个异步操作都在彼此竞争，谁先谁后是不可预期的。</p>
<p>为了修复这种问题，在 Effect 中添加清理函数：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-f07keclqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-f07keclqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">let</span> ignore = <span class="hljs-literal">false</span>;<br>    <span class="hljs-title function_">setBio</span>(<span class="hljs-literal">null</span>);<br>    <span class="hljs-title function_">fetchBio</span>(person).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> &#123;<br>        <span class="hljs-keyword">if</span> (!ignore) &#123;<br>            <span class="hljs-title function_">setBio</span>(result);<br>        &#125;<br>    &#125;);<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> &#123;<br>        ignore = <span class="hljs-literal">true</span>;<br>    &#125;<br>&#125;, [person]);<br></code></pre></td></tr></table></div></figure>

<p>其实，每个 Effect 都可以在里面设置一个 <code>ignore</code> 标记变量。在最开始，<code>ignore</code> 被设置为 <code>false</code>。然而，当 Effect 执行清理函数后（就像你选中了列表中不同的人时），<code>ignore</code> 就会被设置为 <code>true</code>。所以此时请求完成的顺序并不重要。只有最后选中的人在执行它的 Effect 时，<code>ignore</code> 会被设为 <code>false</code>，所以它会调用 <code>setBio(result)</code>。而之前的 Effect 都被清理掉了。所以检查 <code>if (!ignore)</code> 会阻止调用 <code>setBio</code>：</p>
<ul>
<li>选中 <code>&#39;Bob&#39;</code> 触发 <code>fetchBio(&#39;Bob&#39;)</code></li>
<li>选中 <code>&#39;Taylor&#39;</code> 触发 <code>fetchBio(&#39;Taylor&#39;)</code>，<strong>然后清理之前加载（Bob）数据时的 Effect</strong></li>
<li>在加载完 <code>&#39;Bob&#39;</code> 的数据 <strong>之前</strong>，就已经完成加载 <code>&#39;Taylor&#39;</code> 的数据</li>
<li>渲染 <code>&#39;Taylor&#39;</code> 时的 Effect 调用 <code>setBio(&#39;这是Taylor的传记&#39;)</code></li>
<li>加载完成 <code>&#39;Bob&#39;</code> 的数据</li>
<li>渲染 <code>&#39;Bob&#39;</code> 时的 Effect 不会做任何事情，因为 <code>ignore</code> 已经被设为了 <code>true</code>。</li>
</ul>
<p>除了忽略过时 API 调用的结果外，你还可以使用 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/AbortController"><code>AbortController</code></a> 来取消不再需要的请求。然而，仅靠这个还不足以防止竞态-条件。更多的异步步骤可能会在获取之后链接起来，因此使用显式标记，如 <code>ignore</code> 变量，是修复这类问题最可靠的方法。</p>
<h2 id="4-你可能不需要-Effect"><a href="#4-你可能不需要-Effect" class="headerlink" title="4.你可能不需要 Effect"></a>4.你可能不需要 Effect</h2><p>Effect 是 React 范式中的一个逃脱方案。它们让你可以 “逃出” React 并使组件和一些外部系统同步，比如非 React 组件、网络和浏览器 DOM。如果没有涉及到外部系统（例如，你想根据 props 或 state 的变化来更新一个组件的 state），你就不应该使用 Effect。移除不必要的 Effect 可以让你的代码更容易理解，运行得更快，并且更少出错。</p>
<p>有两种不必使用 Effect 的常见情况：</p>
<ul>
<li><strong>你不必使用 Effect 来转换渲染所需的数据</strong>。例如，你想在展示一个列表前先做筛选。你的直觉可能是写一个当列表变化时更新 state 变量的 Effect。然而，这是低效的。当你更新这个 state 时，React 首先会调用你的组件函数来计算应该显示在屏幕上的内容。然后 React 会把这些变化“<a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/render-and-commit">提交</a>”到 DOM 中来更新屏幕。然后 React 会执行你的 Effect。如果你的 Effect 也立即更新了这个 state，就会重新执行整个流程。为了避免不必要的渲染流程，应在你的组件顶层转换数据。这些代码会在你的 props 或 state 变化时自动重新执行。</li>
<li><strong>你不必使用 Effect 来处理用户事件</strong>。例如，你想在用户购买一个产品时发送一个 <code>/api/buy</code> 的 POST 请求并展示一个提示。在这个购买按钮的点击事件处理函数中，你确切地知道会发生什么。但是当一个 Effect 运行时，你却不知道用户做了什么（例如，点击了哪个按钮）。这就是为什么你通常应该在相应的事件处理函数中处理用户事件。</li>
</ul>
<p>你 <strong>的确</strong> 可以使用 Effect 来和外部系统 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/synchronizing-with-effects#what-are-effects-and-how-are-they-different-from-events">同步</a> 。例如，你可以写一个 Effect 来保持一个 jQuery 的组件和 React state 之间的同步。你也可以使用 Effect 来获取数据：例如，你可以同步当前的查询搜索和查询结果。请记住，比起直接在你的组件中写 Effect，现代 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/start-a-new-react-project#production-grade-react-frameworks">框架</a> 提供了更加高效的，内置的数据获取机制。</p>
<hr>
<p><mark>根据 props 或 state 来更新 state</mark>：假设你有一个包含了两个 state 变量的组件：<code>firstName</code> 和 <code>lastName</code>。你想通过把它们联结起来计算出 <code>fullName</code>。此外，每当 <code>firstName</code> 和 <code>lastName</code> 变化时，你希望 <code>fullName</code> 都能更新。你的第一直觉可能是添加一个 state 变量：<code>fullName</code>，并在一个 Effect 中更新它：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-cvtvfqlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-cvtvfqlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Form</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [firstName, setFirstName] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;Taylor&#x27;</span>);<br>  <span class="hljs-keyword">const</span> [lastName, setLastName] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;Swift&#x27;</span>);<br>  <span class="hljs-comment">// 🔴 避免：多余的 state 和不必要的 Effect</span><br>  <span class="hljs-keyword">const</span> [fullName, setFullName] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;&#x27;</span>);<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-title function_">setFullName</span>(firstName + <span class="hljs-string">&#x27; &#x27;</span> + lastName);<br>  &#125;, [firstName, lastName]);<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>大可不必这么复杂。而且这样效率也不高：它先是用 <code>fullName</code> 的旧值执行了整个渲染流程，然后立即使用更新后的值又重新渲染了一遍。让我们移除 state 变量和 Effect：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-lr28cvlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-lr28cvlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Form</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [firstName, setFirstName] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;Taylor&#x27;</span>);<br>  <span class="hljs-keyword">const</span> [lastName, setLastName] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;Swift&#x27;</span>);<br>  <span class="hljs-comment">// ✅ 非常好：在渲染期间进行计算</span><br>  <span class="hljs-keyword">const</span> fullName = firstName + <span class="hljs-string">&#x27; &#x27;</span> + lastName;<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p><strong>如果一个值可以基于现有的 props 或 state 计算得出，<a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/choosing-the-state-structure#avoid-redundant-state">不要把它作为一个 state</a>，而是在渲染期间直接计算这个值</strong>。这将使你的代码更快（避免了多余的 “级联” 更新）、更简洁（移除了一些代码）以及更少出错（避免了一些因为不同的 state 变量之间没有正确同步而导致的问题）。如果这个观点对你来说很新奇，<a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/thinking-in-react#step-3-find-the-minimal-but-complete-representation-of-ui-state">React 哲学</a> 中解释了什么值应该作为 state。</p>
<hr>
<p><mark>缓存昂贵的计算</mark>：这个组件使用它接收到的 props 中的 <code>filter</code> 对另一个 prop <code>todos</code> 进行筛选，计算得出 <code>visibleTodos</code>。你的直觉可能是把结果存到一个 state 中，并在 Effect 中更新它：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-u0unq7lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-u0unq7lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">TodoList</span>(<span class="hljs-params">&#123; todos, filter &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> [newTodo, setNewTodo] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;&#x27;</span>);<br>  <span class="hljs-comment">// 🔴 避免：多余的 state 和不必要的 Effect</span><br>  <span class="hljs-keyword">const</span> [visibleTodos, setVisibleTodos] = <span class="hljs-title function_">useState</span>([]);<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-title function_">setVisibleTodos</span>(<span class="hljs-title function_">getFilteredTodos</span>(todos, filter));<br>  &#125;, [todos, filter]);<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>就像之前的例子一样，这既没有必要，也很低效。首先，移除 state 和 Effect：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-85tjdklqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-85tjdklqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">TodoList</span>(<span class="hljs-params">&#123; todos, filter &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> [newTodo, setNewTodo] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;&#x27;</span>);<br>  <span class="hljs-comment">// ✅ 如果 getFilteredTodos() 的耗时不长，这样写就可以了。</span><br>  <span class="hljs-keyword">const</span> visibleTodos = <span class="hljs-title function_">getFilteredTodos</span>(todos, filter);<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>一般来说，这段代码没有问题！但是，<code>getFilteredTodos()</code> 的耗时可能会很长，或者你有很多 <code>todos</code>。这些情况下，当 <code>newTodo</code> 这样不相关的 state 变量变化时，你并不想重新执行 <code>getFilteredTodos()</code>。</p>
<p>你可以使用 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/reference/react/useMemo"><code>useMemo</code></a> Hook 缓存（或者说 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Memoization">记忆（memoize）</a>）一个昂贵的计算。</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-o7dacvlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-o7dacvlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useMemo, useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">TodoList</span>(<span class="hljs-params">&#123; todos, filter &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> [newTodo, setNewTodo] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;&#x27;</span>);<br>  <span class="hljs-keyword">const</span> visibleTodos = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-comment">// ✅ 除非 todos 或 filter 生变化，否则不会重新执行</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_">getFilteredTodos</span>(todos, filter);<br>  &#125;, [todos, filter]);<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>或者写成一行：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-nd6derlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-nd6derlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useMemo, useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">TodoList</span>(<span class="hljs-params">&#123; todos, filter &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> [newTodo, setNewTodo] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;&#x27;</span>);<br>  <span class="hljs-comment">// ✅ 除非 todos 或 filter 发生变化，否则不会重新执行 getFilteredTodos()</span><br>  <span class="hljs-keyword">const</span> visibleTodos = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">getFilteredTodos</span>(todos, filter), [todos, filter]);<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p><strong>这会告诉 React，除非 <code>todos</code> 或 <code>filter</code> 发生变化，否则不要重新执行传入的函数</strong>。React 会在初次渲染的时候记住 <code>getFilteredTodos()</code> 的返回值。在下一次渲染中，它会检查 <code>todos</code> 或 <code>filter</code> 是否发生了变化。如果它们跟上次渲染时一样，<code>useMemo</code> 会直接返回它最后保存的结果。如果不一样，React 将再次调用传入的函数（并保存它的结果）。</p>
<p>你传入 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/reference/react/useMemo"><code>useMemo</code></a> 的函数会在渲染期间执行，所以它仅适用于 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/keeping-components-pure">纯函数</a> 场景。</p>
<hr>
<p><mark>当 props 变化时重置所有 state </mark>：<code>ProfilePage</code> 组件接收一个 prop：<code>userId</code>。页面上有一个评论输入框，你用了一个 state：<code>comment</code> 来保存它的值。有一天，你发现了一个问题：当你从一个人的个人资料导航到另一个时，<code>comment</code> 没有被重置。这导致很容易不小心把评论发送到不正确的个人资料。为了解决这个问题，你想在 <code>userId</code> 变化时，清除 <code>comment</code> 变量：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-xr79ovlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-xr79ovlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ProfilePage</span>(<span class="hljs-params">&#123; userId &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> [comment, setComment] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;&#x27;</span>);<br><br>  <span class="hljs-comment">// 🔴 避免：当 prop 变化时，在 Effect 中重置 state</span><br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-title function_">setComment</span>(<span class="hljs-string">&#x27;&#x27;</span>);<br>  &#125;, [userId]);<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>但这是低效的，因为 <code>ProfilePage</code> 和它的子组件首先会用旧值渲染，然后再用新值重新渲染。并且这样做也很复杂，因为你需要在 <code>ProfilePage</code> 里面 <strong>所有</strong> 具有 state 的组件中都写这样的代码。例如，如果评论区的 UI 是嵌套的，你可能也想清除嵌套的 comment state。</p>
<p>取而代之的是，你可以通过为每个用户的个人资料组件提供一个明确的键来告诉 React 它们原则上是 <strong>不同</strong> 的个人资料组件。将你的组件拆分为两个组件，并从外部的组件传递一个 <code>key</code> 属性给内部的组件：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-z7ot5glqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-z7ot5glqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ProfilePage</span>(<span class="hljs-params">&#123; userId &#125;</span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Profile</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">userId</span>=<span class="hljs-string">&#123;userId&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;userId&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">    /&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Profile</span>(<span class="hljs-params">&#123; userId &#125;</span>) &#123;<br>  <span class="hljs-comment">// ✅ 当 key 变化时，该组件内的 comment 或其他 state 会自动被重置</span><br>  <span class="hljs-keyword">const</span> [comment, setComment] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;&#x27;</span>);<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>通常，当在相同的位置渲染相同的组件时，React 会保留状态。<strong>通过将 <code>userId</code> 作为 <code>key</code> 传递给 <code>Profile</code> 组件，使  React 将具有不同 <code>userId</code> 的两个 <code>Profile</code> 组件视为两个不应共享任何状态的不同组件</strong>。每当 key（这里是 <code>userId</code>）变化时，React 将重新创建 DOM，并 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/preserving-and-resetting-state#option-2-resetting-state-with-a-key">重置</a> <code>Profile</code> 组件和它的所有子组件的 state。现在，当在不同的个人资料之间导航时，<code>comment</code> 区域将自动被清空。</p>
<p>请注意，在这个例子中，只有外部的 <code>ProfilePage</code> 组件被导出并在项目中对其他文件可见。渲染 <code>ProfilePage</code> 的那些组件不用传递 <code>key</code> 给它：它们只需把 <code>userId</code> 作为常规 prop 传入即可。而 <code>ProfilePage</code> 将其作为 <code>key</code> 传递给内部的 <code>Profile</code> 组件是它的实现细节而已。</p>
<hr>
<p><mark>当 prop 变化时调整部分 state </mark>：有时候，当 prop 变化时，你可能只想重置或调整部分 state ，而不是所有 state。</p>
<p><code>List</code> 组件接收一个 <code>items</code> 列表作为 prop，然后用 state 变量 <code>selection</code> 来保持已选中的项。当 <code>items</code> 接收到一个不同的数组时，你想将 <code>selection</code> 重置为 <code>null</code>：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-89kt0elqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-89kt0elqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">List</span>(<span class="hljs-params">&#123; items &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> [isReverse, setIsReverse] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);<br>  <span class="hljs-keyword">const</span> [selection, setSelection] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);<br>  <span class="hljs-comment">// 🔴 避免：当 prop 变化时，在 Effect 中调整 state</span><br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-title function_">setSelection</span>(<span class="hljs-literal">null</span>);<br>  &#125;, [items]);<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>这不太理想。每当 <code>items</code> 变化时，<code>List</code> 及其子组件会先使用旧的 <code>selection</code> 值渲染。然后 React 会更新 DOM 并执行 Effect。最后，调用 <code>setSelection(null)</code> 将导致 <code>List</code> 及其子组件重新渲染，重新启动整个流程。</p>
<p>让我们从删除 Effect 开始。取而代之的是在渲染期间直接调整 state：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-v6mnmdlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-v6mnmdlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">List</span>(<span class="hljs-params">&#123; items &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> [isReverse, setIsReverse] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);<br>  <span class="hljs-keyword">const</span> [selection, setSelection] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);<br>  <span class="hljs-comment">// 好一些：在渲染期间调整 state</span><br>  <span class="hljs-keyword">const</span> [prevItems, setPrevItems] = <span class="hljs-title function_">useState</span>(items);<br>  <span class="hljs-keyword">if</span> (items !== prevItems) &#123;<br>    <span class="hljs-title function_">setPrevItems</span>(items);<br>    <span class="hljs-title function_">setSelection</span>(<span class="hljs-literal">null</span>);<br>  &#125;<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>像这样 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/reference/react/useState#storing-information-from-previous-renders">存储前序渲染的信息</a> 可能很难理解，但它比在 Effect 中更新这个 state 要好。上面的例子中，在渲染过程中直接调用了 <code>setSelection</code>。当它执行到 <code>return</code> 语句退出后，React 将 <strong>立即</strong> 重新渲染 <code>List</code>。此时 React 还没有渲染 <code>List</code> 的子组件或更新 DOM，这使得 <code>List</code> 的子组件可以跳过渲染旧的 <code>selection</code> 值。</p>
<p>在渲染期间更新组件时，React 会丢弃已经返回的 JSX 并立即尝试重新渲染。为了避免非常缓慢的级联重试，React 只允许在渲染期间更新 <strong>同一</strong> 组件的状态。如果你在渲染期间更新另一个组件的状态，你会看到一条报错信息。条件判断 <code>items !== prevItems</code> 是必要的，它可以避免无限循环。你可以像这样调整 state，但任何其他副作用（比如变化 DOM 或设置的延时）应该留在事件处理函数或 Effect 中，以 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/keeping-components-pure">保持组件纯粹</a>。</p>
<p><strong>虽然这种方式比 Effect 更高效，但大多数组件也不需要它</strong>。无论你怎么做，根据 props 或其他 state 来调整 state 都会使数据流更难理解和调试。总是检查是否可以通过添加 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/you-might-not-need-an-effect#resetting-all-state-when-a-prop-changes">key 来重置所有 state</a>，或者 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/you-might-not-need-an-effect#updating-state-based-on-props-or-state">在渲染期间计算所需内容</a>。例如，你可以存储已选中的 <strong>item ID</strong> 而不是存储（并重置）已选中的 <strong>item</strong>：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-w59t7ylqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-w59t7ylqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">List</span>(<span class="hljs-params">&#123; items &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> [isReverse, setIsReverse] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);<br>  <span class="hljs-keyword">const</span> [selectedId, setSelectedId] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);<br>  <span class="hljs-comment">// ✅ 非常好：在渲染期间计算所需内容</span><br>  <span class="hljs-keyword">const</span> selection = items.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">id</span> === selectedId) ?? <span class="hljs-literal">null</span>;<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>现在完全不需要 “调整” state 了。如果包含已选中 ID 的项出现在列表中，则仍然保持选中状态。如果没有找到匹配的项，则在渲染期间计算的 <code>selection</code> 将会是 <code>null</code>。行为不同了，但可以说更好了，因为大多数对 <code>items</code> 的更改仍可以保持选中状态。</p>
<hr>
<p><mark>在事件处理函数中共享逻辑</mark>：假设你有一个产品页面，上面有两个按钮（购买和付款），都可以让你购买该产品。当用户将产品添加进购物车时，你想显示一个通知。在两个按钮的 click 事件处理函数中都调用 <code>showNotification()</code> 感觉有点重复，所以你可能想把这个逻辑放在一个 Effect 中：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-q699mklqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-q699mklqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ProductPage</span>(<span class="hljs-params">&#123; product, addToCart &#125;</span>) &#123;<br>  <span class="hljs-comment">// 🔴 避免：在 Effect 中处理属于事件特定的逻辑</span><br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (product.<span class="hljs-property">isInCart</span>) &#123;<br>      <span class="hljs-title function_">showNotification</span>(<span class="hljs-string">`已添加 <span class="hljs-subst">$&#123;product.name&#125;</span> 进购物车！`</span>);<br>    &#125;<br>  &#125;, [product]);<br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleBuyClick</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">addToCart</span>(product);<br>  &#125;<br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleCheckoutClick</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">addToCart</span>(product);<br>    <span class="hljs-title function_">navigateTo</span>(<span class="hljs-string">&#x27;/checkout&#x27;</span>);<br>  &#125;<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>这个 Effect 是多余的。而且很可能会导致问题。例如，假设你的应用在页面重新加载之前 “记住” 了购物车中的产品。如果你把一个产品添加到购物车中并刷新页面，通知将再次出现。每次刷新该产品页面时，它都会出现。这是因为 <code>product.isInCart</code> 在页面加载时已经是 <code>true</code> 了，所以上面的 Effect 每次都会调用 <code>showNotification()</code>。</p>
<p><strong>当你不确定某些代码应该放在 Effect 中还是事件处理函数中时，先自问 为什么 要执行这些代码。Effect 只用来执行那些显示给用户时组件 需要执行 的代码</strong>。在这个例子中，通知应该在用户 <strong>按下按钮</strong> 后出现，而不是因为页面显示出来时！删除 Effect 并将共享的逻辑放入一个被两个事件处理程序调用的函数中：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-gt1988lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-gt1988lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ProductPage</span>(<span class="hljs-params">&#123; product, addToCart &#125;</span>) &#123;<br>  <span class="hljs-comment">// ✅ 非常好：事件特定的逻辑在事件处理函数中处理</span><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">buyProduct</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">addToCart</span>(product);<br>    <span class="hljs-title function_">showNotification</span>(<span class="hljs-string">`已添加 <span class="hljs-subst">$&#123;product.name&#125;</span> 进购物车！`</span>);<br>  &#125;<br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleBuyClick</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">buyProduct</span>();<br>  &#125;<br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleCheckoutClick</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">buyProduct</span>();<br>    <span class="hljs-title function_">navigateTo</span>(<span class="hljs-string">&#x27;/checkout&#x27;</span>);<br>  &#125;<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>这既移除了不必要的 Effect，又修复了问题。</p>
<hr>
<p><mark>发送 POST 请求 </mark>：这个 <code>Form</code> 组件会发送两种 POST 请求。它在页面加载之际会发送一个分析请求。当你填写表格并点击提交按钮时，它会向 <code>/api/register</code> 接口发送一个 POST 请求：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-j8qgfzlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-j8qgfzlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Form</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [firstName, setFirstName] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;&#x27;</span>);<br>  <span class="hljs-keyword">const</span> [lastName, setLastName] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;&#x27;</span>);<br>  <span class="hljs-comment">// ✅ 非常好：这个逻辑应该在组件显示时执行</span><br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/analytics/event&#x27;</span>, &#123; <span class="hljs-attr">eventName</span>: <span class="hljs-string">&#x27;visit_form&#x27;</span> &#125;);<br>  &#125;, []);<br>  <span class="hljs-comment">// 🔴 避免：在 Effect 中处理属于事件特定的逻辑</span><br>  <span class="hljs-keyword">const</span> [jsonToSubmit, setJsonToSubmit] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (jsonToSubmit !== <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/api/register&#x27;</span>, jsonToSubmit);<br>    &#125;<br>  &#125;, [jsonToSubmit]);<br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleSubmit</span>(<span class="hljs-params">e</span>) &#123;<br>    e.<span class="hljs-title function_">preventDefault</span>();<br>    <span class="hljs-title function_">setJsonToSubmit</span>(&#123; firstName, lastName &#125;);<br>  &#125;<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>让我们应用与之前示例相同的准则。</p>
<p>分析请求应该保留在 Effect 中。这是 <strong>因为</strong> 发送分析请求是表单显示时就需要执行的（在开发环境中它会发送两次，请 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/synchronizing-with-effects#sending-analytics">参考这里</a> 了解如何处理）。</p>
<p>然而，发送到 <code>/api/register</code> 的 POST 请求并不是由表单 <strong>显示</strong> 时引起的。你只想在一个特定的时间点发送请求：当用户按下按钮时。它应该只在这个 <strong>特定的交互</strong> 中发生。删除第二个 Effect，将该 POST 请求移入事件处理函数中：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-mzhz1ulqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-mzhz1ulqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Form</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [firstName, setFirstName] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;&#x27;</span>);<br>  <span class="hljs-keyword">const</span> [lastName, setLastName] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;&#x27;</span>);<br>  <span class="hljs-comment">// ✅ 非常好：这个逻辑应该在组件显示时执行</span><br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/analytics/event&#x27;</span>, &#123; <span class="hljs-attr">eventName</span>: <span class="hljs-string">&#x27;visit_form&#x27;</span> &#125;);<br>  &#125;, []);<br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleSubmit</span>(<span class="hljs-params">e</span>) &#123;<br>    e.<span class="hljs-title function_">preventDefault</span>();<br>    <span class="hljs-comment">// ✅ 非常好：事件特定的逻辑在事件处理函数中处理</span><br>    <span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/api/register&#x27;</span>, &#123; firstName, lastName &#125;);<br>  &#125;<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>当你决定将某些逻辑放入事件处理函数还是 Effect 中时，你需要回答的主要问题是：从用户的角度来看它是 <strong>怎样的逻辑</strong>。如果这个逻辑是由某个特定的交互引起的，请将它保留在相应的事件处理函数中。如果是由用户在屏幕上 <strong>看到</strong> 组件时引起的，请将它保留在 Effect 中。</p>
<hr>
<p><mark>链式计算</mark>：有时候你可能想链接多个 Effect，每个 Effect 都基于某些 state 来调整其他的 state：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-qcaeurlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-qcaeurlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Game</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [card, setCard] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);<br>  <span class="hljs-keyword">const</span> [goldCardCount, setGoldCardCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">const</span> [round, setRound] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">1</span>);<br>  <span class="hljs-keyword">const</span> [isGameOver, setIsGameOver] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);<br>  <span class="hljs-comment">// 🔴 避免：链接多个 Effect 仅仅为了相互触发调整 state</span><br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (card !== <span class="hljs-literal">null</span> &amp;&amp; card.<span class="hljs-property">gold</span>) &#123;<br>      <span class="hljs-title function_">setGoldCardCount</span>(<span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span> c + <span class="hljs-number">1</span>);<br>    &#125;<br>  &#125;, [card]);<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (goldCardCount &gt; <span class="hljs-number">3</span>) &#123;<br>      <span class="hljs-title function_">setRound</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> r + <span class="hljs-number">1</span>)<br>      <span class="hljs-title function_">setGoldCardCount</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>  &#125;, [goldCardCount]);<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (round &gt; <span class="hljs-number">5</span>) &#123;<br>      <span class="hljs-title function_">setIsGameOver</span>(<span class="hljs-literal">true</span>);<br>    &#125;<br>  &#125;, [round]);<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-title function_">alert</span>(<span class="hljs-string">&#x27;游戏结束！&#x27;</span>);<br>  &#125;, [isGameOver]);<br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handlePlaceCard</span>(<span class="hljs-params">nextCard</span>) &#123;<br>    <span class="hljs-keyword">if</span> (isGameOver) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;游戏已经结束了。&#x27;</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-title function_">setCard</span>(nextCard);<br>    &#125;<br>  &#125;<br>  <span class="hljs-comment">// ...</span><br></code></pre></td></tr></table></div></figure>

<p>这段代码里有两个问题。</p>
<p>一个问题是它非常低效：在链式的每个 <code>set</code> 调用之间，组件（及其子组件）都不得不重新渲染。在上面的例子中，在最坏的情况下（<code>setCard</code> → 渲染 → <code>setGoldCardCount</code> → 渲染 → <code>setRound</code> → 渲染 → <code>setIsGameOver</code> → 渲染）有三次不必要的重新渲染。</p>
<p>即使不考虑渲染效率问题，随着代码不断扩展，你会遇到这条 “链式” 调用不符合新需求的情况。试想一下，你现在需要添加一种方法来回溯游戏的历史记录，可以通过更新每个 state 变量到之前的值来实现。然而，将 <code>card</code> 设置为之前的的某个值会再次触发 Effect 链并更改你正在显示的数据。这样的代码往往是僵硬而脆弱的。</p>
<p>在这个例子中，更好的做法是：尽可能在渲染期间进行计算，以及在事件处理函数中调整 state：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-37sdv2lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-37sdv2lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Game</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [card, setCard] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);<br>  <span class="hljs-keyword">const</span> [goldCardCount, setGoldCardCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">const</span> [round, setRound] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">1</span>);<br>  <span class="hljs-comment">// ✅ 尽可能在渲染期间进行计算</span><br>  <span class="hljs-keyword">const</span> isGameOver = round &gt; <span class="hljs-number">5</span>;<br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handlePlaceCard</span>(<span class="hljs-params">nextCard</span>) &#123;<br>    <span class="hljs-keyword">if</span> (isGameOver) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;游戏已经结束了。&#x27;</span>);<br>    &#125;<br>    <span class="hljs-comment">// ✅ 在事件处理函数中计算剩下的所有 state</span><br>    <span class="hljs-title function_">setCard</span>(nextCard);<br>    <span class="hljs-keyword">if</span> (nextCard.<span class="hljs-property">gold</span>) &#123;<br>      <span class="hljs-keyword">if</span> (goldCardCount &lt;= <span class="hljs-number">3</span>) &#123;<br>        <span class="hljs-title function_">setGoldCardCount</span>(goldCardCount + <span class="hljs-number">1</span>);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>     <span class="hljs-title function_">setGoldCardCount</span>(<span class="hljs-number">0</span>);<br>        <span class="hljs-title function_">setRound</span>(round + <span class="hljs-number">1</span>);<br>        <span class="hljs-keyword">if</span> (round === <span class="hljs-number">5</span>) &#123;<br>          <span class="hljs-title function_">alert</span>(<span class="hljs-string">&#x27;游戏结束！&#x27;</span>);<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>  <span class="hljs-comment">// ...</span><br></code></pre></td></tr></table></div></figure>

<p>这高效得多。此外，如果你实现了一个回溯游戏历史的方法，现在你可以将每个 state 变量设置为之前的任何的一个值，而不会触发每个调整其他值的 Effect 链。如果你需要在多个事件处理函数之间复用逻辑，可以 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/you-might-not-need-an-effect#sharing-logic-between-event-handlers">提取成一个函数</a> 并在这些事件处理函数中调用它。</p>
<p>请记住，在事件处理函数内部，<a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/state-as-a-snapshot">state 的行为类似快照</a>。例如，即使你调用了 <code>setRound(round + 1)</code>，<code>round</code> 变量仍然是用户点击按钮时的值。如果你需要使用下一个值进行计算，则需要像这样手动定义它：<code>const nextRound = round + 1</code>。</p>
<p>在某些情况下，你 <strong>无法</strong> 在事件处理函数中直接计算出下一个 state。例如，试想一个具有多个下拉菜单的表单，如果下一个下拉菜单的选项取决于前一个下拉菜单选择的值。这时，Effect 链是合适的，因为你需要与网络进行同步。</p>
<hr>
<p><mark>初始化应用 </mark>：有些逻辑只需要在应用加载时执行一次。</p>
<p>你可能想把它放在一个顶层组件的 Effect 中：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-u6mguflqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-u6mguflqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-comment">// 🔴 避免：把只需要执行一次的逻辑放在 Effect 中</span><br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-title function_">loadDataFromLocalStorage</span>();<br>    <span class="hljs-title function_">checkAuthToken</span>();<br>  &#125;, []);<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>然后，你很快就会发现它在 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/synchronizing-with-effects#how-to-handle-the-effect-firing-twice-in-development">开发环境会执行两次</a>。这会导致一些问题——例如，它可能使身份验证 token 无效，因为该函数不是为被调用两次而设计的。一般来说，当组件重新挂载时应该具有一致性。包括你的顶层 <code>App</code> 组件。</p>
<p>尽管在实际的生产环境中它可能永远不会被重新挂载，但在所有组件中遵循相同的约束条件可以更容易地移动和复用代码。如果某些逻辑必须在 <strong>每次应用加载时执行一次</strong>，而不是在 <strong>每次组件挂载时执行一次</strong>，可以添加一个顶层变量来记录它是否已经执行过了：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-cc0yyrlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-cc0yyrlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">let</span> didInit = <span class="hljs-literal">false</span>;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (!didInit) &#123;<br>      didInit = <span class="hljs-literal">true</span>;<br>      <span class="hljs-comment">// ✅ 只在每次应用加载时执行一次</span><br>      <span class="hljs-title function_">loadDataFromLocalStorage</span>();<br>      <span class="hljs-title function_">checkAuthToken</span>();<br>    &#125;<br>  &#125;, []);<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>你也可以在模块初始化和应用渲染之前执行它：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-xogz6ulqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-xogz6ulqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> !== <span class="hljs-string">&#x27;undefined&#x27;</span>) &#123; <span class="hljs-comment">// 检测我们是否在浏览器环境</span><br>   <span class="hljs-comment">// ✅ 只在每次应用加载时执行一次</span><br>  <span class="hljs-title function_">checkAuthToken</span>(); <span class="hljs-title function_">loadDataFromLocalStorage</span>();<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>顶层代码会在组件被导入时执行一次——即使它最终并没有被渲染。为了避免在导入任意组件时降低性能或产生意外行为，请不要过度使用这种方法。将应用级别的初始化逻辑保留在像 <code>App.js</code> 这样的根组件模块或你的应用入口中。</p>
<p><mark>通知父组件有关 state 变化的信息 </mark>：假设你正在编写一个有具有内部 state <code>isOn</code> 的 <code>Toggle</code> 组件，该 state 可以是 <code>true</code> 或 <code>false</code>。有几种不同的方式来进行切换（通过点击或拖动）。你希望在 <code>Toggle</code> 的 state 变化时通知父组件，因此你暴露了一个 <code>onChange</code> 事件并在 <code>Effect</code> 中调用它：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-9diicllqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-9diicllqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Toggle</span>(<span class="hljs-params">&#123; onChange &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> [isOn, setIsOn] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);<br>  <span class="hljs-comment">// 🔴 避免：onChange 处理函数执行的时间太晚了</span><br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-title function_">onChange</span>(isOn);<br>  &#125;, [isOn, onChange])<br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">setIsOn</span>(!isOn);<br>  &#125;<br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleDragEnd</span>(<span class="hljs-params">e</span>) &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isCloserToRightEdge</span>(e)) &#123;<br>      <span class="hljs-title function_">setIsOn</span>(<span class="hljs-literal">true</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-title function_">setIsOn</span>(<span class="hljs-literal">false</span>);<br>    &#125;<br>  &#125;<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>和之前一样，这不太理想。<code>Toggle</code> 首先更新它的 state，然后 React 会更新屏幕。然后 React 执行 Effect 中的代码，调用从父组件传入的 <code>onChange</code> 函数。现在父组件开始更新它自己的 state，开启另一个渲染流程。更好的方式是在单个流程中完成所有操作。</p>
<p>删除 Effect，并在同一个事件处理函数中更新 <strong>两个</strong> 组件的 state：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-42a4rglqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-42a4rglqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Toggle</span>(<span class="hljs-params">&#123; onChange &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> [isOn, setIsOn] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);<br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">updateToggle</span>(<span class="hljs-params">nextIsOn</span>) &#123;<br>    <span class="hljs-comment">// ✅ 非常好：在触发它们的事件中执行所有更新</span><br>    <span class="hljs-title function_">setIsOn</span>(nextIsOn);<br>    <span class="hljs-title function_">onChange</span>(nextIsOn);<br>  &#125;<br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">updateToggle</span>(!isOn);<br>  &#125;<br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleDragEnd</span>(<span class="hljs-params">e</span>) &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isCloserToRightEdge</span>(e)) &#123;<br>      <span class="hljs-title function_">updateToggle</span>(<span class="hljs-literal">true</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-title function_">updateToggle</span>(<span class="hljs-literal">false</span>);<br>    &#125;<br>  &#125;<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>通过这种方式，<code>Toggle</code> 组件及其父组件都在事件处理期间更新了各自的 state。React 会 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/queueing-a-series-of-state-updates">批量</a> 处理来自不同组件的更新，所以只会有一个渲染流程。</p>
<p>你也可以完全移除该 state，并从父组件中接收 <code>isOn</code>：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-g3t6k6lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-g3t6k6lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-comment">// ✅ 也很好：该组件完全由它的父组件控制</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Toggle</span>(<span class="hljs-params">&#123; isOn, onChange &#125;</span>) &#123;<br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">onChange</span>(!isOn);<br>  &#125;<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleDragEnd</span>(<span class="hljs-params">e</span>) &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isCloserToRightEdge</span>(e)) &#123;<br>      <span class="hljs-title function_">onChange</span>(<span class="hljs-literal">true</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-title function_">onChange</span>(<span class="hljs-literal">false</span>);<br>    &#125;<br>  &#125;<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>“<a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/sharing-state-between-components">状态提升</a>” 允许父组件通过切换自身的 state 来完全控制 <code>Toggle</code> 组件。这意味着父组件会包含更多的逻辑，但整体上需要关心的状态变少了。每当你尝试保持两个不同的 state 变量之间的同步时，试试状态提升！</p>
<p><mark>将数据传递给父组件</mark>：<code>Child</code> 组件获取了一些数据并在 Effect 中传递给 <code>Parent</code> 组件：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-wqlv3xlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-wqlv3xlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [data, setData] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);<br>  <span class="hljs-comment">// ...</span><br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Child</span> <span class="hljs-attr">onFetched</span>=<span class="hljs-string">&#123;setData&#125;</span> /&gt;</span></span>;<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Child</span>(<span class="hljs-params">&#123; onFetched &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> data = <span class="hljs-title function_">useSomeAPI</span>();<br>  <span class="hljs-comment">// 🔴 避免：在 Effect 中传递数据给父组件</span><br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (data) &#123;<br>      <span class="hljs-title function_">onFetched</span>(data);<br>    &#125;<br>  &#125;, [onFetched, data]);<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>在 React 中，数据从父组件流向子组件。当你在屏幕上看到了一些错误时，你可以通过一路追踪组件树来寻找错误信息是从哪个组件传递下来的，从而找到传递了错误的 prop 或具有错误的 state 的组件。当子组件在 Effect 中更新其父组件的 state 时，数据流变得非常难以追踪。既然子组件和父组件都需要相同的数据，那么可以让父组件获取那些数据，并将其 <strong>向下传递</strong> 给子组件：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-ntvt16lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-ntvt16lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> data = <span class="hljs-title function_">useSomeAPI</span>();<br>  <span class="hljs-comment">// ...</span><br>  <span class="hljs-comment">// ✅ 非常好：向子组件传递数据</span><br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Child</span> <span class="hljs-attr">data</span>=<span class="hljs-string">&#123;data&#125;</span> /&gt;</span></span>;<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Child</span>(<span class="hljs-params">&#123; data &#125;</span>) &#123;<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>这更简单，并且可以保持数据流的可预测性：数据从父组件流向子组件。</p>
<p><mark>订阅外部 store </mark>：有时候，你的组件可能需要订阅 React state 之外的一些数据。这些数据可能来自第三方库或内置浏览器 API。由于这些数据可能在 React 无法感知的情况下发变化，你需要在你的组件中手动订阅它们。这经常使用 Effect 来实现，例如：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-fz9xqglqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-fz9xqglqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">useOnlineStatus</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-comment">// 不理想：在 Effect 中手动订阅 store</span><br>  <span class="hljs-keyword">const</span> [isOnline, setIsOnline] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>);<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">function</span> <span class="hljs-title function_">updateState</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-title function_">setIsOnline</span>(navigator.<span class="hljs-property">onLine</span>);<br>    &#125;<br>    <span class="hljs-title function_">updateState</span>();<br>    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;online&#x27;</span>, updateState);<br>    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;offline&#x27;</span>, updateState);<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">&#x27;online&#x27;</span>, updateState);<br>      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">&#x27;offline&#x27;</span>, updateState);<br>    &#125;;<br>  &#125;, []);<br>  <span class="hljs-keyword">return</span> isOnline;<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatIndicator</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> isOnline = <span class="hljs-title function_">useOnlineStatus</span>();<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>这个组件订阅了一个外部的 store 数据（在这里，是浏览器的 <code>navigator.onLine</code> API）。由于这个 API 在服务端不存在（因此不能用于初始的 HTML），因此 state 最初被设置为 <code>true</code>。每当浏览器 store 中的值发生变化时，组件都会更新它的 state。</p>
<p>尽管通常可以使用 Effect 来实现此功能，但 React 为此针对性地提供了一个 Hook 用于订阅外部 store。删除 Effect 并将其替换为调用 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/reference/react/useSyncExternalStore"><code>useSyncExternalStore</code></a>：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-6wacb7lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-6wacb7lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">subscribe</span>(<span class="hljs-params">callback</span>) &#123;<br>  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;online&#x27;</span>, callback); <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;offline&#x27;</span>, callback);<br>  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">&#x27;online&#x27;</span>, callback);    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">&#x27;offline&#x27;</span>, callback);<br>  &#125;;<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">useOnlineStatus</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-comment">// ✅ 非常好：用内置的 Hook 订阅外部 store</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-title function_">useSyncExternalStore</span>(<br>    subscribe, <span class="hljs-comment">// 只要传递的是同一个函数，React 不会重新订阅</span><br>    <span class="hljs-function">() =&gt;</span> navigator.<span class="hljs-property">onLine</span>, <span class="hljs-comment">// 如何在客户端获取值</span><br>    <span class="hljs-function">() =&gt;</span> <span class="hljs-literal">true</span> <span class="hljs-comment">// 如何在服务端获取值</span><br>  );<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatIndicator</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> isOnline = <span class="hljs-title function_">useOnlineStatus</span>();<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>与手动使用 Effect 将可变数据同步到 React state 相比，这种方法能减少错误。通常，你可以写一个像上面的 <code>useOnlineStatus()</code> 这样的自定义 Hook，这样你就不需要在各个组件中重复写这些代码。<a target="_blank" rel="noopener" href="https://zh-hans.react.dev/reference/react/useSyncExternalStore">阅读更多关于在 React 组件中订阅外部数据 store 的信息</a>。</p>
<p>获取数据：许多应用使用 Effect 来发起数据获取请求。像这样在 Effect 中写一个数据获取请求是相当常见的：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-4px5urlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-4px5urlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">SearchResults</span>(<span class="hljs-params">&#123; query &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> [results, setResults] = <span class="hljs-title function_">useState</span>([]);<br>  <span class="hljs-keyword">const</span> [page, setPage] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">1</span>);<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-comment">// 🔴 避免：没有清除逻辑的获取数据</span><br>    <span class="hljs-title function_">fetchResults</span>(query, page).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">json</span> =&gt;</span> &#123;<br>      <span class="hljs-title function_">setResults</span>(json);<br>    &#125;);<br>  &#125;, [query, page]);<br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleNextPageClick</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">setPage</span>(page + <span class="hljs-number">1</span>);<br>  &#125;<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>你 <strong>不需要</strong> 把这个数据获取逻辑迁移到一个事件处理函数中。</p>
<p>这可能看起来与之前需要将逻辑放入事件处理函数中的示例相矛盾！但是，考虑到这并不是 <strong>键入事件</strong>，这是在这里获取数据的主要原因。搜索输入框的值经常从 URL 中预填充，用户可以在不关心输入框的情况下导航到后退和前进页面。</p>
<p><code>page</code> 和 <code>query</code> 的来源其实并不重要。只要该组件可见，你就需要通过当前 <code>page</code> 和 <code>query</code> 的值，保持 <code>results</code> 和网络数据的 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/synchronizing-with-effects">同步</a>。这就是为什么这里是一个 Effect 的原因。</p>
<p>然而，上面的代码有一个问题。假设你快速地输入 <code>“hello”</code>。那么 <code>query</code> 会从 <code>“h”</code> 变成 <code>“he”</code>，<code>“hel”</code>，<code>“hell”</code> 最后是 <code>“hello”</code>。这会触发一连串不同的数据获取请求，但无法保证对应的返回顺序。例如，<code>“hell”</code> 的响应可能在 <code>“hello”</code> 的响应 <strong>之后</strong> 返回。由于它的 <code>setResults()</code> 是在最后被调用的，你将会显示错误的搜索结果。这种情况被称为 “<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Race_condition">竞态条件</a>”：两个不同的请求 “相互竞争”，并以与你预期不符的顺序返回。</p>
<p><strong>为了修复这个问题，你需要添加一个 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/synchronizing-with-effects#fetching-data">清理函数</a> 来忽略较早的返回结果：</strong></p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-lu4wmklqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-lu4wmklqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">SearchResults</span>(<span class="hljs-params">&#123; query &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> [results, setResults] = <span class="hljs-title function_">useState</span>([]);<br>  <span class="hljs-keyword">const</span> [page, setPage] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">1</span>);<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">let</span> ignore = <span class="hljs-literal">false</span>;<br>    <span class="hljs-title function_">fetchResults</span>(query, page).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">json</span> =&gt;</span> &#123;<br>      <span class="hljs-keyword">if</span> (!ignore) &#123;<br>        <span class="hljs-title function_">setResults</span>(json);<br>      &#125;<br>    &#125;);<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> &#123;<br>      ignore = <span class="hljs-literal">true</span>;<br>    &#125;;<br>  &#125;, [query, page]);<br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleNextPageClick</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">setPage</span>(page + <span class="hljs-number">1</span>);<br>  &#125;<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>这确保了当你在 Effect 中获取数据时，除了最后一次请求的所有返回结果都将被忽略。</p>
<p>处理竞态条件并不是实现数据获取的唯一难点。你可能还需要考虑缓存响应结果（使用户点击后退按钮时可以立即看到先前的屏幕内容），如何在服务端获取数据（使服务端初始渲染的 HTML 中包含获取到的内容而不是加载动画），以及如何避免网络瀑布（使子组件不必等待每个父组件的数据获取完毕后才开始获取数据）。</p>
<p><strong>这些问题适用于任何 UI 库，而不仅仅是 React。解决这些问题并不容易，这也是为什么现代 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/start-a-new-react-project#production-grade-react-frameworks">框架</a> 提供了比在 Effect 中获取数据更有效的内置数据获取机制的原因。</strong></p>
<p>如果你不使用框架（也不想开发自己的框架），但希望使从 Effect 中获取数据更符合人类直觉，请考虑像这个例子一样，将获取逻辑提取到一个自定义 Hook 中：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-j7wlf0lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-j7wlf0lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">SearchResults</span>(<span class="hljs-params">&#123; query &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> [page, setPage] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">1</span>);<br>  <span class="hljs-keyword">const</span> params = <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLSearchParams</span>(&#123; query, page &#125;);<br>  <span class="hljs-keyword">const</span> results = <span class="hljs-title function_">useData</span>(<span class="hljs-string">`/api/search?<span class="hljs-subst">$&#123;params&#125;</span>`</span>);<br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleNextPageClick</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">setPage</span>(page + <span class="hljs-number">1</span>);<br>  &#125;<br>  <span class="hljs-comment">// ...</span><br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">useData</span>(<span class="hljs-params">url</span>) &#123;<br>  <span class="hljs-keyword">const</span> [data, setData] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">let</span> ignore = <span class="hljs-literal">false</span>;<br>    <span class="hljs-title function_">fetch</span>(url)<br>      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> response.<span class="hljs-title function_">json</span>())<br>      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">json</span> =&gt;</span> &#123;<br>        <span class="hljs-keyword">if</span> (!ignore) &#123;<br>          <span class="hljs-title function_">setData</span>(json);<br>        &#125;<br>      &#125;);<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> &#123;<br>      ignore = <span class="hljs-literal">true</span>;<br>    &#125;;<br>  &#125;, [url]);<br>  <span class="hljs-keyword">return</span> data;<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>你可能还想添加一些错误处理逻辑以及跟踪内容是否处于加载中。你可以自己编写这样的 Hook，也可以使用 React 生态中已经存在的许多解决方案。<strong>虽然仅仅使用自定义 Hook 不如使用框架内置的数据获取机制高效，但将数据获取逻辑移动到自定义 Hook 中将使后续采用高效的数据获取策略更加容易。</strong></p>
<p>一般来说，当你不得不编写 Effect 时，请留意是否可以将某段功能提取到专门的内置 API 或一个更具声明性的自定义 Hook 中，比如上面的 <code>useData</code>。你会发现组件中的原始 <code>useEffect</code> 调用越少，维护应用将变得更加容易。</p>
<h2 id="5-响应式-Effect-的生命周期"><a href="#5-响应式-Effect-的生命周期" class="headerlink" title="5.响应式 Effect 的生命周期"></a>5.响应式 Effect 的生命周期</h2><p>Effect 与组件有不同的生命周期。组件可以挂载、更新或卸载。Effect 只能做两件事：开始同步某些东西，然后停止同步它。如果 Effect 依赖于随时间变化的 props 和 state，这个循环可能会发生多次。React 提供了代码检查规则来检查是否正确地指定了 Effect 的依赖项，这能够使 Effect 与最新的 props 和 state 保持同步。</p>
<p><mark>每个 React 组件都经历相同的生命周期</mark>：</p>
<ol>
<li>当组件被添加到屏幕上时，它会进行组件的 <strong>挂载</strong>。</li>
<li>当组件接收到新的 props 或 state 时，通常是作为对交互的响应，它会进行组件的 <strong>更新</strong>。</li>
<li>当组件从屏幕上移除时，它会进行组件的 <strong>卸载</strong>。</li>
</ol>
<p><strong>这是一种很好的思考组件的方式，但并不适用于 Effect</strong>。相反，尝试从组件生命周期中跳脱出来，独立思考 Effect。Effect 描述了如何将外部系统与当前的 props 和 state 同步。随着代码的变化，同步的频率可能会增加或减少。</p>
<p>为了说明这一点，考虑下面这个示例。Effect 将组件连接到聊天服务器：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-4z56aplqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-4z56aplqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> serverUrl = <span class="hljs-string">&#x27;https://localhost:1234&#x27;</span>;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatRoom</span>(<span class="hljs-params">&#123; roomId &#125;</span>) &#123;<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> connection = <span class="hljs-title function_">createConnection</span>(serverUrl, roomId);<br>    connection.<span class="hljs-title function_">connect</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> &#123;<br>      connection.<span class="hljs-title function_">disconnect</span>();<br>    &#125;;<br>  &#125;, [roomId]);<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>Effect 的主体部分指定了如何 <strong>开始同步</strong>：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-slka7tlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-slka7tlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-comment">// ...</span><br><span class="hljs-keyword">const</span> connection = <span class="hljs-title function_">createConnection</span>(serverUrl, roomId);<br>connection.<span class="hljs-title function_">connect</span>();<br></code></pre></td></tr></table></div></figure>

<p>Effect 返回的清理函数指定了如何 <strong>停止同步</strong>：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-1xtetzlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-1xtetzlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jsx">connection.<span class="hljs-title function_">disconnect</span>();<br></code></pre></td></tr></table></div></figure>

<p>你可能会直观地认为当组件挂载时 React 会 <strong>开始同步</strong>，而当组件卸载时会 <strong>停止同步</strong>。然而，事情并没有这么简单！有时，在组件保持挂载状态的同时，可能还需要 <strong>多次开始和停止同步</strong>。</p>
<p>有些 Effect 根本不返回清理函数。<a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/synchronizing-with-effects#how-to-handle-the-effect-firing-twice-in-development">在大多数情况下</a>，可能希望返回一个清理函数，但如果没有返回，React 将表现得好像返回了一个空的清理函数。</p>
<hr>
<p><mark>为什么同步可能需要多次进行</mark>：想象一下，这个 <code>ChatRoom</code> 组件接收 <code>roomId</code> 属性，用户可以在下拉菜单中选择。假设初始时，用户选择了 <code>&quot;general&quot;</code> 作为 <code>roomId</code>。应用程序会显示 <code>&quot;general&quot;</code> 聊天室：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-c4lsb7lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-c4lsb7lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> serverUrl = <span class="hljs-string">&#x27;https://localhost:1234&#x27;</span>;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatRoom</span>(<span class="hljs-params">&#123; roomId /* <span class="hljs-string">&quot;general&quot;</span> */ &#125;</span>) &#123;<br>  <span class="hljs-comment">// ...</span><br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>欢迎来到 &#123;roomId&#125; 房间！<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>;<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>在 UI 显示之后，React 将运行 Effect 来 <strong>开始同步</strong>。它连接到 <code>&quot;general&quot;</code> 聊天室：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-80v8iulqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-80v8iulqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatRoom</span>(<span class="hljs-params">&#123; roomId /* <span class="hljs-string">&quot;general&quot;</span> */ &#125;</span>) &#123;<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> connection = <span class="hljs-title function_">createConnection</span>(serverUrl, roomId); <span class="hljs-comment">// 连接到 &quot;general&quot; 聊天室</span><br>    connection.<span class="hljs-title function_">connect</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> &#123;<br>      connection.<span class="hljs-title function_">disconnect</span>(); <span class="hljs-comment">// 断开与 &quot;general&quot; 聊天室的连接</span><br>    &#125;;<br>  &#125;, [roomId]);<br>  <span class="hljs-comment">// ...</span><br></code></pre></td></tr></table></div></figure>

<p>到目前为止，一切都很顺利。</p>
<p>之后，用户在下拉菜单中选择了不同的房间（例如 <code>&quot;travel&quot;</code> ）。首先，React 会更新 UI：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-mqqxqylqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-mqqxqylqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatRoom</span>(<span class="hljs-params">&#123; roomId /* <span class="hljs-string">&quot;travel&quot;</span> */ &#125;</span>) &#123;<br>  <span class="hljs-comment">// ...</span><br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>欢迎来到 &#123;roomId&#125; 房间！<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>;<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>思考接下来应该发生什么。用户在界面中看到 <code>&quot;travel&quot;</code> 是当前选定的聊天室。然而，上次运行的 Effect 仍然连接到 <code>&quot;general&quot;</code> 聊天室。**<code>roomId</code> 属性已经发生了变化，所以之前 Effect 所做的事情（连接到 <code>&quot;general&quot;</code> 聊天室）不再与 UI 匹配**。</p>
<p>此时，你希望 React 执行两个操作：</p>
<ol>
<li>停止与旧的 <code>roomId</code> 同步（断开与 <code>&quot;general&quot;</code> 聊天室的连接）</li>
<li>开始与新的 <code>roomId</code> 同步（连接到 <code>&quot;travel&quot;</code> 聊天室）</li>
</ol>
<p><strong>幸运的是，你已经教会了 React 如何执行这两个操作</strong>！Effect 的主体部分指定了如何开始同步，而清理函数指定了如何停止同步。现在，React 只需要按照正确的顺序和正确的 props 和 state 来调用它们。让我们看看具体是如何实现的。</p>
<hr>
<p><mark>React 如何重新同步 Effect </mark>：回想一下，<code>ChatRoom</code> 组件已经接收到了 <code>roomId</code> 属性的新值。之前它是 <code>&quot;general&quot;</code>，现在变成了 <code>&quot;travel&quot;</code>。React 需要重新同步 Effect，以重新连接到不同的聊天室。</p>
<p>为了 <strong>停止同步</strong>，React 将调用 Effect 返回的清理函数，该函数在连接到 <code>&quot;general&quot;</code> 聊天室后返回。由于 <code>roomId</code> 为 <code>&quot;general&quot;</code>，清理函数将断开与 <code>&quot;general&quot;</code> 聊天室的连接：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-9vupxnlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-9vupxnlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatRoom</span>(<span class="hljs-params">&#123; roomId /* <span class="hljs-string">&quot;general&quot;</span> */ &#125;</span>) &#123;<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> connection = <span class="hljs-title function_">createConnection</span>(serverUrl, roomId); <span class="hljs-comment">// 连接到 &quot;general&quot; 聊天室</span><br>    connection.<span class="hljs-title function_">connect</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> &#123;<br>      connection.<span class="hljs-title function_">disconnect</span>(); <span class="hljs-comment">// 断开与 &quot;general&quot; 聊天室的连接</span><br>    &#125;;<br>    <span class="hljs-comment">// ...</span><br></code></pre></td></tr></table></div></figure>

<p>然后，React 将运行在此渲染期间提供的 Effect。这次，<code>roomId</code> 为 <code>&quot;travel&quot;</code>，因此它将 <strong>开始同步</strong> 到 <code>&quot;travel&quot;</code> 聊天室（直到最终也调用了清理函数）：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-ixopx0lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-ixopx0lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatRoom</span>(<span class="hljs-params">&#123; roomId /* <span class="hljs-string">&quot;travel&quot;</span> */ &#125;</span>) &#123;<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> connection = <span class="hljs-title function_">createConnection</span>(serverUrl, roomId); <span class="hljs-comment">// 连接到 &quot;travel&quot; 聊天室</span><br>    connection.<span class="hljs-title function_">connect</span>();<br>    <span class="hljs-comment">// ...</span><br></code></pre></td></tr></table></div></figure>

<p>多亏了这一点，现在已经连接到了用户在 UI 中选择的同一个聊天室。避免了灾难！</p>
<p>每当组件使用不同的 <code>roomId</code> 重新渲染后，Effect 将重新进行同步。例如，假设用户将 <code>roomId</code> 从 <code>&quot;travel&quot;</code> 更改为 <code>&quot;music&quot;</code>。React 将再次通过调用清理函数 <strong>停止同步</strong> Effect（断开与 <code>&quot;travel&quot;</code> 聊天室的连接）。然后，它将通过使用新的 <code>roomId</code> 属性再次运行 Effect 的主体部分 <strong>开始同步</strong>（连接到 <code>&quot;music&quot;</code> 聊天室）。</p>
<p>最后，当用户切换到不同的屏幕时，<code>ChatRoom</code> 组件将被卸载。现在没有必要保持连接了。React 将 <strong>最后一次停止同步</strong> Effect，并从 <code>&quot;music&quot;</code> 聊天室断开连接。 </p>
<p>让我们总结一下从 <code>ChatRoom</code> 组件的角度所发生的一切：</p>
<ol>
<li><code>ChatRoom</code> 组件挂载，<code>roomId</code> 设置为 <code>&quot;general&quot;</code></li>
<li><code>ChatRoom</code> 组件更新，<code>roomId</code> 设置为 <code>&quot;travel&quot;</code></li>
<li><code>ChatRoom</code> 组件更新，<code>roomId</code> 设置为 <code>&quot;music&quot;</code></li>
<li><code>ChatRoom</code> 组件卸载</li>
</ol>
<p>在组件生命周期的每个阶段，Effect 执行了不同的操作：</p>
<ol>
<li>Effect 连接到了 <code>&quot;general&quot;</code> 聊天室</li>
<li>Effect 断开了与 <code>&quot;general&quot;</code> 聊天室的连接，并连接到了 <code>&quot;travel&quot;</code> 聊天室</li>
<li>Effect 断开了与 <code>&quot;travel&quot;</code> 聊天室的连接，并连接到了 <code>&quot;music&quot;</code> 聊天室</li>
<li>Effect 断开了与 <code>&quot;music&quot;</code> 聊天室的连接</li>
</ol>
<p>现在让我们从 Effect 本身的角度来思考所发生的事情：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-yew863lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-yew863lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-comment">// Effect 连接到了通过 roomId 指定的聊天室...</span><br>  <span class="hljs-keyword">const</span> connection = <span class="hljs-title function_">createConnection</span>(serverUrl, roomId);<br>  connection.<span class="hljs-title function_">connect</span>();<br>  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-comment">// ...直到它断开连接</span><br>    connection.<span class="hljs-title function_">disconnect</span>();<br>  &#125;;<br>&#125;, [roomId]);<br></code></pre></td></tr></table></div></figure>

<p>这段代码的结构可能会将所发生的事情看作是一系列不重叠的时间段：</p>
<ol>
<li>Effect 连接到了 <code>&quot;general&quot;</code> 聊天室（直到断开连接）</li>
<li>Effect 连接到了 <code>&quot;travel&quot;</code> 聊天室（直到断开连接）</li>
<li>Effect 连接到了 <code>&quot;music&quot;</code> 聊天室（直到断开连接）</li>
</ol>
<p>之前，你是从组件的角度思考的。当你从组件的角度思考时，很容易将 Effect 视为在特定时间点触发的“回调函数”或“生命周期事件”，例如“渲染后”或“卸载前”。这种思维方式很快变得复杂，所以最好避免使用。</p>
<p><strong>相反，始终专注于单个启动&#x2F;停止周期。无论组件是挂载、更新还是卸载，都不应该有影响。只需要描述如何开始同步和如何停止。如果做得好，Effect 将能够在需要时始终具备启动和停止的弹性</strong>。</p>
<p>这可能会让你想起当编写创建 JSX 的渲染逻辑时，并不考虑组件是挂载还是更新。描述的是应该显示在屏幕上的内容，而 React 会 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/reacting-to-input-with-state">解决其余的问题</a>。</p>
<hr>
<p><mark>React 如何验证 Effect 可以重新进行同步 </mark>：这里有一个可以互动的实时示例。点击“打开聊天”来挂载 <code>ChatRoom</code> 组件：</p>
<p>App.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-sd6efilqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-sd6efilqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState, useEffect &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; createConnection &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./chat.js&#x27;</span>;<br><br><span class="hljs-keyword">const</span> serverUrl = <span class="hljs-string">&#x27;https://localhost:1234&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatRoom</span>(<span class="hljs-params">&#123; roomId &#125;</span>) &#123;<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> connection = <span class="hljs-title function_">createConnection</span>(serverUrl, roomId);<br>    connection.<span class="hljs-title function_">connect</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> connection.<span class="hljs-title function_">disconnect</span>();<br>  &#125;, [roomId]);<br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>欢迎来到 &#123;roomId&#125; 房间！<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>;<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [roomId, setRoomId] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;general&#x27;</span>);<br>  <span class="hljs-keyword">const</span> [show, setShow] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">        选择聊天室：&#123;&#x27; &#x27;&#125;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">select</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;roomId&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> setRoomId(e.target.value)&#125;</span><br><span class="language-xml">        &gt;</span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;general&quot;</span>&gt;</span>所有<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;travel&quot;</span>&gt;</span>旅游<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;music&quot;</span>&gt;</span>音乐<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> setShow(!show)&#125;&gt;</span><br><span class="language-xml">        &#123;show ? &#x27;关闭聊天&#x27; : &#x27;打开聊天&#x27;&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      &#123;show &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">hr</span> /&gt;</span>&#125;</span><br><span class="language-xml">      &#123;show &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">ChatRoom</span> <span class="hljs-attr">roomId</span>=<span class="hljs-string">&#123;roomId&#125;</span> /&gt;</span>&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>chat.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-g9nfivlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-g9nfivlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createConnection</span>(<span class="hljs-params">serverUrl, roomId</span>) &#123;<br>  <span class="hljs-comment">// 实际的实现将会连接到服务器</span><br>  <span class="hljs-keyword">return</span> &#123;<br>    <span class="hljs-title function_">connect</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;✅ 连接到 &quot;&#x27;</span> + roomId + <span class="hljs-string">&#x27;&quot; 房间，位于&#x27;</span> + serverUrl + <span class="hljs-string">&#x27;...&#x27;</span>);<br>    &#125;,<br>    <span class="hljs-title function_">disconnect</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;❌ 断开 &quot;&#x27;</span> + roomId + <span class="hljs-string">&#x27;&quot; 房间，位于&#x27;</span> + serverUrl);<br>    &#125;<br>  &#125;;<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>请注意，当组件首次挂载时，会看到三个日志：</p>
<ol>
<li><code>✅ 连接到 &quot;general&quot; 聊天室，位于 https://localhost:1234...</code> <em>(仅限开发环境)</em></li>
<li><code>❌ 从 &quot;general&quot; 聊天室断开连接，位于 https://localhost:1234.</code> <em>(仅限开发环境)</em></li>
<li><code>✅ 连接到 &quot;general&quot; 聊天室，位于 https://localhost:1234...</code></li>
</ol>
<p>前两个日志仅适用于开发环境。在开发环境中，React 总是会重新挂载每个组件一次。</p>
<p><strong>React 通过在开发环境中立即强制 Effect 重新进行同步来验证其是否能够重新同步</strong>。这可能让你想起打开门并额外关闭它以检查门锁是否有效的情景。React 在开发环境中额外启动和停止 Effect 一次，以检查 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/synchronizing-with-effects#how-to-handle-the-effect-firing-twice-in-development">是否正确实现了它的清理功能</a>。</p>
<p>实际上，Effect 重新进行同步的主要原因是它所使用的某些数据发生了变化。在上面的示例中，更改所选的聊天室。注意当 <code>roomId</code> 发生变化时，Effect 会重新进行同步。</p>
<p>然而，还存在其他一些不寻常的情况需要重新进行同步。例如，在上面的示例中，尝试在聊天打开时编辑 <code>serverUrl</code>。注意当修改代码时，Effect会重新进行同步。将来，React 可能会添加更多依赖于重新同步的功能。</p>
<hr>
<p><mark>React 如何知道需要重新进行 Effect 的同步 </mark>：你可能想知道 React 是如何知道在 <code>roomId</code> 更改后需要重新同步 Effect。这是因为 <strong>你告诉了 React</strong> 它的代码依赖于 <code>roomId</code>，通过将其包含在 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/synchronizing-with-effects#step-2-specify-the-effect-dependencies">依赖列表</a> 中。</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-a1gdy3lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-a1gdy3lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatRoom</span>(<span class="hljs-params">&#123; roomId &#125;</span>) &#123; <span class="hljs-comment">// roomId 属性可能会随时间变化。</span><br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> connection = <span class="hljs-title function_">createConnection</span>(serverUrl, roomId); <span class="hljs-comment">// 这个 Effect 读取了 roomId</span><br>    connection.<span class="hljs-title function_">connect</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> &#123;<br>      connection.<span class="hljs-title function_">disconnect</span>();<br>    &#125;;<br>  &#125;, [roomId]); <span class="hljs-comment">// 因此，你告诉 React 这个 Effect &quot;依赖于&quot; roomId</span><br>  <span class="hljs-comment">// ...</span><br></code></pre></td></tr></table></div></figure>

<p>下面是它的工作原理：</p>
<ol>
<li>你知道 <code>roomId</code> 是 prop，这意味着它可能会随着时间的推移发生变化。</li>
<li>你知道 Effect 读取了 <code>roomId</code>（因此其逻辑依赖于可能会在之后发生变化的值）。</li>
<li>这就是为什么你将其指定为 Effect 的依赖项（以便在 <code>roomId</code> 发生变化时重新进行同步）。</li>
</ol>
<p>每次在组件重新渲染后，React 都会查看传递的依赖项数组。如果数组中的任何值与上一次渲染时在相同位置传递的值不同，React 将重新同步 Effect。</p>
<p>例如，如果在初始渲染时传递了 <code>[&quot;general&quot;]</code>，然后在下一次渲染时传递了 <code>[&quot;travel&quot;]</code>，React 将比较 <code>&quot;general&quot;</code> 和 <code>&quot;travel&quot;</code>。这些是不同的值（使用 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/is"><code>Object.is</code></a> 进行比较），因此 React 将重新同步 Effect。另一方面，如果组件重新渲染但 <code>roomId</code> 没有发生变化，Effect 将继续连接到相同的房间。</p>
<hr>
<p>每个 Effect 表示一个独立的同步过程。 </p>
<p>抵制将与 Effect 无关的逻辑添加到已经编写的 Effect 中，仅仅因为这些逻辑需要与 Effect 同时运行。例如，假设你想在用户访问房间时发送一个分析事件。你已经有一个依赖于 <code>roomId</code> 的 Effect，所以你可能会想要将分析调用添加到那里：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-izbydvlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-izbydvlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatRoom</span>(<span class="hljs-params">&#123; roomId &#125;</span>) &#123;<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-title function_">logVisit</span>(roomId);<br>    <span class="hljs-keyword">const</span> connection = <span class="hljs-title function_">createConnection</span>(serverUrl, roomId);<br>    connection.<span class="hljs-title function_">connect</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> &#123;<br>      connection.<span class="hljs-title function_">disconnect</span>();<br>    &#125;;<br>  &#125;, [roomId]);<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>但是想象一下，如果以后给这个 Effect 添加了另一个需要重新建立连接的依赖项。如果这个 Effect 重新进行同步，它将为相同的房间调用 <code>logVisit(roomId)</code>，而这不是你的意图。记录访问行为是 <strong>一个独立的过程</strong>，与连接不同。将它们作为两个单独的 Effect 编写：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-uz193nlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-uz193nlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatRoom</span>(<span class="hljs-params">&#123; roomId &#125;</span>) &#123;<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-title function_">logVisit</span>(roomId);<br>  &#125;, [roomId]);<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> connection = <span class="hljs-title function_">createConnection</span>(serverUrl, roomId);<br>    <span class="hljs-comment">// ...</span><br>  &#125;, [roomId]);<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p><strong>代码中的每个 Effect 应该代表一个独立的同步过程。</strong></p>
<p>在上面的示例中，删除一个 Effect 不会影响另一个 Effect 的逻辑。这表明它们同步不同的内容，因此将它们拆分开是有意义的。另一方面，如果将一个内聚的逻辑拆分成多个独立的 Effects，代码可能会看起来更加“清晰”，但 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/you-might-not-need-an-effect#chains-of-computations">维护起来会更加困难</a>。这就是为什么你应该考虑这些过程是相同还是独立的，而不是只考虑代码是否看起来更整洁。</p>
<hr>
<p><mark>Effect 会“响应”于响应式值 </mark>：Effect 读取了两个变量（<code>serverUrl</code> 和 <code>roomId</code>），但是只将 <code>roomId</code> 指定为依赖项：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-e14t7olqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-e14t7olqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> serverUrl = <span class="hljs-string">&#x27;https://localhost:1234&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatRoom</span>(<span class="hljs-params">&#123; roomId &#125;</span>) &#123;<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> connection = <span class="hljs-title function_">createConnection</span>(serverUrl, roomId);<br>    connection.<span class="hljs-title function_">connect</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> &#123;<br>      connection.<span class="hljs-title function_">disconnect</span>();<br>    &#125;;<br>  &#125;, [roomId]);<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>为什么 <code>serverUrl</code> 不需要作为依赖项呢？</p>
<p>这是因为 <code>serverUrl</code> 永远不会因为重新渲染而发生变化。无论组件重新渲染多少次以及原因是什么，<code>serverUrl</code> 都保持不变。既然 <code>serverUrl</code> 从不变化，将其指定为依赖项就没有意义。毕竟，依赖项只有在随时间变化时才会起作用！</p>
<p>另一方面，<code>roomId</code> 在重新渲染时可能会不同。<strong>在组件内部声明的 props、state 和其他值都是 响应式 的，因为它们是在渲染过程中计算的，并参与了 React 的数据流</strong>。</p>
<p>如果 <code>serverUrl</code> 是状态变量，那么它就是响应式的。响应式值必须包含在依赖项中：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-y9sh4klqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-y9sh4klqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatRoom</span>(<span class="hljs-params">&#123; roomId &#125;</span>) &#123; <span class="hljs-comment">// Props 随时间变化</span><br>  <span class="hljs-keyword">const</span> [serverUrl, setServerUrl] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;https://localhost:1234&#x27;</span>); <span class="hljs-comment">// State 可能随时间变化</span><br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> connection = <span class="hljs-title function_">createConnection</span>(serverUrl, roomId); <span class="hljs-comment">// Effect 读取 props 和 state</span><br>    connection.<span class="hljs-title function_">connect</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> &#123;<br>      connection.<span class="hljs-title function_">disconnect</span>();<br>    &#125;;<br>  &#125;, [roomId, serverUrl]); <span class="hljs-comment">// 因此，你告诉 React 这个 Effect &quot;依赖于&quot; props 和 state</span><br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>通过将 <code>serverUrl</code> 包含在依赖项中，确保 Effect 在其发生变化后重新同步。</p>
<p>尝试在此沙盒中更改所选的聊天室或编辑服务器 URL：</p>
<p>App.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-3k72p1lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-3k72p1lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState, useEffect &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; createConnection &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./chat.js&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatRoom</span>(<span class="hljs-params">&#123; roomId &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> [serverUrl, setServerUrl] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;https://localhost:1234&#x27;</span>);<br><br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> connection = <span class="hljs-title function_">createConnection</span>(serverUrl, roomId);<br>    connection.<span class="hljs-title function_">connect</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> connection.<span class="hljs-title function_">disconnect</span>();<br>  &#125;, [roomId, serverUrl]);<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">        服务器 URL：&#123;&#x27; &#x27;&#125;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">input</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;serverUrl&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> setServerUrl(e.target.value)&#125;</span><br><span class="language-xml">        /&gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>欢迎来到 &#123;roomId&#125; 房间！<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [roomId, setRoomId] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;general&#x27;</span>);<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">        选择聊天室：&#123;&#x27; &#x27;&#125;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">select</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;roomId&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> setRoomId(e.target.value)&#125;</span><br><span class="language-xml">        &gt;</span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;general&quot;</span>&gt;</span>所有<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;travel&quot;</span>&gt;</span>旅游<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;music&quot;</span>&gt;</span>音乐<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">hr</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ChatRoom</span> <span class="hljs-attr">roomId</span>=<span class="hljs-string">&#123;roomId&#125;</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>chat.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-8whhfhlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-8whhfhlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createConnection</span>(<span class="hljs-params">serverUrl, roomId</span>) &#123;<br>  <span class="hljs-comment">// 实际的实现将会连接到服务器</span><br>  <span class="hljs-keyword">return</span> &#123;<br>    <span class="hljs-title function_">connect</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;✅ 连接到 &quot;&#x27;</span> + roomId + <span class="hljs-string">&#x27;&quot; 房间，位于&#x27;</span> + serverUrl + <span class="hljs-string">&#x27;...&#x27;</span>);<br>    &#125;,<br>    <span class="hljs-title function_">disconnect</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;❌ 断开 &quot;&#x27;</span> + roomId + <span class="hljs-string">&#x27;&quot; 房间，位于&#x27;</span> + serverUrl);<br>    &#125;<br>  &#125;;<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>无论何时更改一个类似 <code>roomId</code> 或 <code>serverUrl</code> 的响应式值，该 Effect 都会重新连接到聊天服务器。</p>
<hr>
<p><mark>没有依赖项的 Effect 的含义 </mark>：如果将 <code>serverUrl</code> 和 <code>roomId</code> 都移出组件会发生什么？</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-500ty6lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-500ty6lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> serverUrl = <span class="hljs-string">&#x27;https://localhost:1234&#x27;</span>;<br><span class="hljs-keyword">const</span> roomId = <span class="hljs-string">&#x27;general&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatRoom</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> connection = <span class="hljs-title function_">createConnection</span>(serverUrl, roomId);<br>    connection.<span class="hljs-title function_">connect</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> &#123;<br>      connection.<span class="hljs-title function_">disconnect</span>();<br>    &#125;;<br>  &#125;, []); <span class="hljs-comment">// ✅ 声明的所有依赖</span><br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>现在 Effect 的代码不使用任何响应式值，因此它的依赖可以是空的 (<code>[]</code>)。</p>
<p>从组件的角度来看，空的 <code>[]</code> 依赖数组意味着这个 Effect 仅在组件挂载时连接到聊天室，并在组件卸载时断开连接。（请记住，在开发环境中，React 仍会 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/lifecycle-of-reactive-effects#how-react-verifies-that-your-effect-can-re-synchronize">额外执行一次</a> 来对逻辑进行压力测试。）</p>
<p>App.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-skahg8lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-skahg8lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState, useEffect &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; createConnection &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./chat.js&#x27;</span>;<br><br><span class="hljs-keyword">const</span> serverUrl = <span class="hljs-string">&#x27;https://localhost:1234&#x27;</span>;<br><span class="hljs-keyword">const</span> roomId = <span class="hljs-string">&#x27;general&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatRoom</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> connection = <span class="hljs-title function_">createConnection</span>(serverUrl, roomId);<br>    connection.<span class="hljs-title function_">connect</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> connection.<span class="hljs-title function_">disconnect</span>();<br>  &#125;, []);<br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>欢迎来到 &#123;roomId&#125; 房间！<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>;<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [show, setShow] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> setShow(!show)&#125;&gt;</span><br><span class="language-xml">        &#123;show ? &#x27;关闭聊天&#x27; : &#x27;打开聊天&#x27;&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      &#123;show &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">hr</span> /&gt;</span>&#125;</span><br><span class="language-xml">      &#123;show &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">ChatRoom</span> /&gt;</span>&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>chat.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-9swhs6lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-9swhs6lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createConnection</span>(<span class="hljs-params">serverUrl, roomId</span>) &#123;<br>  <span class="hljs-comment">// 实际的实现将会连接到服务器</span><br>  <span class="hljs-keyword">return</span> &#123;<br>    <span class="hljs-title function_">connect</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;✅ 连接到 &quot;&#x27;</span> + roomId + <span class="hljs-string">&#x27;&quot; 房间，位于&#x27;</span> + serverUrl + <span class="hljs-string">&#x27;...&#x27;</span>);<br>    &#125;,<br>    <span class="hljs-title function_">disconnect</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;❌ 断开 &quot;&#x27;</span> + roomId + <span class="hljs-string">&#x27;&quot; 房间，位于&#x27;</span> + serverUrl);<br>    &#125;<br>  &#125;;<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>然而，如果你 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/lifecycle-of-reactive-effects#thinking-from-the-effects-perspective">从 Effect 的角度思考</a>，根本不需要考虑挂载和卸载。重要的是，你已经指定了 Effect 如何开始和停止同步。目前，它没有任何响应式依赖。但是，如果希望用户随时间改变 <code>roomId</code> 或 <code>serverUrl</code>（它们将变为响应式），Effect 的代码不需要改变。只需要将它们添加到依赖项中即可。</p>
<hr>
<p><mark>在组件主体中声明的所有变量都是响应式的</mark>：Props 和 state 并不是唯一的响应式值。从它们计算出的值也是响应式的。如果 props 或 state 发生变化，组件将重新渲染，从中计算出的值也会随之改变。这就是为什么 Effect 使用的组件主体中的所有变量都应该在依赖列表中。</p>
<p>假设用户可以在下拉菜单中选择聊天服务器，但他们还可以在设置中配置默认服务器。假设你已经将设置状态放入了 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/scaling-up-with-reducer-and-context">上下文</a>，因此从该上下文中读取 <code>settings</code>。现在，可以根据 props 中选择的服务器和默认服务器来计算 <code>serverUrl</code>：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-pkloptlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-pkloptlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatRoom</span>(<span class="hljs-params">&#123; roomId, selectedServerUrl &#125;</span>) &#123; <span class="hljs-comment">// roomId 是响应式的</span><br>  <span class="hljs-keyword">const</span> settings = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">SettingsContext</span>); <span class="hljs-comment">// settings 是响应式的</span><br>  <span class="hljs-keyword">const</span> serverUrl = selectedServerUrl ?? settings.<span class="hljs-property">defaultServerUrl</span>; <span class="hljs-comment">// serverUrl 是响应式的</span><br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> connection = <span class="hljs-title function_">createConnection</span>(serverUrl, roomId); <span class="hljs-comment">// Effect 读取了 roomId 和 serverUrl</span><br>    connection.<span class="hljs-title function_">connect</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> &#123;<br>      connection.<span class="hljs-title function_">disconnect</span>();<br>    &#125;;<br>  &#125;, [roomId, serverUrl]); <span class="hljs-comment">// 因此，当它们中的任何一个发生变化时，它需要重新同步！</span><br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>在这个例子中，<code>serverUrl</code> 不是 prop 或 state 变量。它是在渲染过程中计算的普通变量。但是它是在渲染过程中计算的，所以它可能会因为重新渲染而改变。这就是为什么它是响应式的。</p>
<p><strong>组件内部的所有值（包括 props、state 和组件体内的变量）都是响应式的。任何响应式值都可以在重新渲染时发生变化，所以需要将响应式值包括在 Effect 的依赖项中</strong>。</p>
<p>换句话说，Effect 对组件体内的所有值都会“react”。</p>
<hr>
<p><mark>React 会验证是否将每个响应式值都指定为了依赖项</mark>：如果检查工具 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/editor-setup#linting">配置了 React</a>，它将检查 Effect 代码中使用的每个响应式值是否已声明为其依赖项。例如，以下示例是一个 lint 错误，因为 <code>roomId</code> 和 <code>serverUrl</code> 都是响应式的：</p>
<p>App.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-s3kbvjlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-s3kbvjlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState, useEffect &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; createConnection &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./chat.js&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatRoom</span>(<span class="hljs-params">&#123; roomId &#125;</span>) &#123; <span class="hljs-comment">// roomId 是响应式的</span><br>  <span class="hljs-keyword">const</span> [serverUrl, setServerUrl] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;https://localhost:1234&#x27;</span>); <span class="hljs-comment">// serverUrl 是响应式的</span><br><br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> connection = <span class="hljs-title function_">createConnection</span>(serverUrl, roomId);<br>    connection.<span class="hljs-title function_">connect</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> connection.<span class="hljs-title function_">disconnect</span>();<br>  &#125;, []); <span class="hljs-comment">// &lt;-- 这里有些问题！</span><br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">        服务器 URL：&#123;&#x27; &#x27;&#125;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">input</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;serverUrl&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> setServerUrl(e.target.value)&#125;</span><br><span class="language-xml">        /&gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>欢迎来到 &#123;roomId&#125; 房间！<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [roomId, setRoomId] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;general&#x27;</span>);<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">        选择聊天室：&#123;&#x27; &#x27;&#125;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">select</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;roomId&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> setRoomId(e.target.value)&#125;</span><br><span class="language-xml">        &gt;</span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;general&quot;</span>&gt;</span>所有<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;travel&quot;</span>&gt;</span>旅游<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;music&quot;</span>&gt;</span>音乐<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">hr</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ChatRoom</span> <span class="hljs-attr">roomId</span>=<span class="hljs-string">&#123;roomId&#125;</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>chat.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-ecygo0lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-ecygo0lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createConnection</span>(<span class="hljs-params">serverUrl, roomId</span>) &#123;<br>  <span class="hljs-comment">// 实际的实现将会连接到服务器</span><br>  <span class="hljs-keyword">return</span> &#123;<br>    <span class="hljs-title function_">connect</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;✅ 连接到 &quot;&#x27;</span> + roomId + <span class="hljs-string">&#x27;&quot; 房间，位于&#x27;</span> + serverUrl + <span class="hljs-string">&#x27;...&#x27;</span>);<br>    &#125;,<br>    <span class="hljs-title function_">disconnect</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;❌ 断开 &quot;&#x27;</span> + roomId + <span class="hljs-string">&#x27;&quot; 房间，位于&#x27;</span> + serverUrl);<br>    &#125;<br>  &#125;;<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>这可能看起来像是 React 错误，但实际上 React 是在指出代码中的 bug。<code>roomId</code> 和 <code>serverUrl</code> 都可能随时间改变，但忘记了在它们改变时重新同步 Effect。即使用户在 UI 中选择了不同的值，仍然保持连接到初始的 <code>roomId</code> 和 <code>serverUrl</code>。</p>
<p>要修复这个 bug，请按照检查工具的建议将 <code>roomId</code> 和 <code>serverUrl</code> 作为 Effect 的依赖进行指定：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-y4xbf4lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-y4xbf4lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatRoom</span>(<span class="hljs-params">&#123; roomId &#125;</span>) &#123; <span class="hljs-comment">// roomId 是响应式的</span><br>  <span class="hljs-keyword">const</span> [serverUrl, setServerUrl] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;https://localhost:1234&#x27;</span>); <span class="hljs-comment">// serverUrl 是响应式的</span><br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> connection = <span class="hljs-title function_">createConnection</span>(serverUrl, roomId);<br>    connection.<span class="hljs-title function_">connect</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> &#123;<br>      connection.<span class="hljs-title function_">disconnect</span>();<br>    &#125;;<br>  &#125;, [serverUrl, roomId]); <span class="hljs-comment">// ✅ 声明的所有依赖</span><br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>在上面的沙盒中尝试这个修复方法。验证一下是否消除了检查工具的错误，并且在需要时聊天会重新连接。</p>
<p>在某些情况下，React <strong>知道</strong> 一个值永远不会改变，即使它在组件内部声明。例如，从 <code>useState</code> 返回的 <code>set</code> 函数和从 <code>useRef</code> 返回的 ref 对象是 <strong>稳定的</strong> ——它们保证在重新渲染时不会改变。稳定值不是响应式的，因此可以从列表中省略它们。包括它们是允许的：它们不会改变，所以无关紧要。</p>
<hr>
<p><mark>当你不想进行重新同步时该怎么办 </mark>：在上一个示例中，通过将 <code>roomId</code> 和 <code>serverUrl</code> 列为依赖项来修复了 lint 错误。</p>
<p>然而，可以通过向检查工具“证明”这些值不是响应式值，即它们 <strong>不会</strong> 因为重新渲染而改变。例如，如果 <code>serverUrl</code> 和 <code>roomId</code> 不依赖于渲染并且始终具有相同的值，可以将它们移到组件外部。现在它们不需要成为依赖项：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-41nn0llqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-41nn0llqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> serverUrl = <span class="hljs-string">&#x27;https://localhost:1234&#x27;</span>; <span class="hljs-comment">// serverUrl 不是响应式的</span><br><span class="hljs-keyword">const</span> roomId = <span class="hljs-string">&#x27;general&#x27;</span>; <span class="hljs-comment">// roomId 不是响应式的</span><br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatRoom</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> connection = <span class="hljs-title function_">createConnection</span>(serverUrl, roomId);<br>    connection.<span class="hljs-title function_">connect</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> &#123;<br>      connection.<span class="hljs-title function_">disconnect</span>();<br>    &#125;;<br>  &#125;, []); <span class="hljs-comment">// ✅ 声明的所有依赖</span><br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>也可以将它们 <strong>移动到 Effect 内部</strong>。它们不是在渲染过程中计算的，因此它们不是响应式的：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-y05wtjlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-y05wtjlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatRoom</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> serverUrl = <span class="hljs-string">&#x27;https://localhost:1234&#x27;</span>; <span class="hljs-comment">// serverUrl 不是响应式的</span><br>    <span class="hljs-keyword">const</span> roomId = <span class="hljs-string">&#x27;general&#x27;</span>; <span class="hljs-comment">// roomId 不是响应式的</span><br>    <span class="hljs-keyword">const</span> connection = <span class="hljs-title function_">createConnection</span>(serverUrl, roomId);<br>    connection.<span class="hljs-title function_">connect</span>()<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> &#123;<br>      connection.<span class="hljs-title function_">disconnect</span>();<br>    &#125;;<br>  &#125;, []); <span class="hljs-comment">// ✅ 声明的所有依赖</span><br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p><strong>Effect 是一段响应式的代码块</strong>。它们在读取的值发生变化时重新进行同步。与事件处理程序不同，事件处理程序只在每次交互时运行一次，而 Effect 则在需要进行同步时运行。</p>
<p><strong>不能“选择”依赖项</strong>。依赖项必须包括 Effect 中读取的每个 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/lifecycle-of-reactive-effects#all-variables-declared-in-the-component-body-are-reactive">响应式值</a>。代码检查工具会强制执行此规则。有时，这可能会导致出现无限循环的问题，或者 Effect 过于频繁地重新进行同步。不要通过禁用代码检查来解决这些问题！下面是一些解决方案：</p>
<ul>
<li><strong>检查 Effect 是否表示了独立的同步过程</strong>。如果 Effect 没有进行任何同步操作，<a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/you-might-not-need-an-effect">可能是不必要的</a>。如果它同时进行了几个独立的同步操作，<a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/lifecycle-of-reactive-effects#each-effect-represents-a-separate-synchronization-process">将其拆分为多个 Effect</a>。</li>
<li><strong>如果想读取 props 或 state 的最新值，但又不想对其做出反应并重新同步 Effect</strong>，可以将 Effect 拆分为具有反应性的部分（保留在 Effect 中）和非反应性的部分（提取为名为 “Effect Event” 的内容）。<a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/separating-events-from-effects">阅读关于将事件与 Effect 分离的内容</a>。</li>
<li><strong>避免将对象和函数作为依赖项</strong>。如果在渲染过程中创建对象和函数，然后在 Effect 中读取它们，它们将在每次渲染时都不同。这将导致 Effect 每次都重新同步。<a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/removing-effect-dependencies">阅读有关从 Effect 中删除不必要依赖项的更多内容</a>。</li>
</ul>
<p>检查工具是你的朋友，但它们的能力是有限的。检查工具只知道依赖关系是否 <strong>错误</strong>。它并不知道每种情况下的 <strong>最佳</strong> 解决方法。如果静态代码分析工具建议添加某个依赖关系，但添加该依赖关系会导致循环，这并不意味着应该忽略静态代码分析工具。需要修改 Effect 内部（或外部）的代码，使得该值不是响应式的，也不 <strong>需要</strong> 成为依赖项。</p>
<p>如果有一个现有的代码库，可能会有一些像这样禁用了检查工具的 Effect：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-ynrgb7lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-ynrgb7lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-comment">// ...</span><br>  <span class="hljs-comment">// 🔴 避免这样禁用静态代码分析工具：</span><br>  <span class="hljs-comment">// eslint-ignore-next-line react-hooks/exhaustive-deps</span><br>&#125;, []);<br></code></pre></td></tr></table></div></figure>

<h2 id="6-将事件从-Effect-中分开"><a href="#6-将事件从-Effect-中分开" class="headerlink" title="6.将事件从 Effect 中分开"></a>6.将事件从 Effect 中分开</h2><p>事件处理函数只有在你再次执行同样的交互时才会重新运行。Effect 和事件处理函数不一样，它只有在读取的 props 或 state 值和上一次渲染不一样时才会重新同步。有时你需要这两种行为的混合体：即一个 Effect 只在响应某些值时重新运行，但是在其他值变化时不重新运行。</p>
<p>首先让我们回顾一下事件处理函数和 Effect 的区别。</p>
<p>假设你正在实现一个聊天室组件，需求如下：</p>
<ol>
<li>组件应该自动连接选中的聊天室。</li>
<li>每当你点击“Send”按钮，组件应该在当前聊天界面发送一条消息。</li>
</ol>
<p>假设你已经实现了这部分代码，但是还没有确定应该放在哪里。你是应该用事件处理函数还是 Effect 呢？每当你需要回答这个问题时，请考虑一下 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/synchronizing-with-effects#what-are-effects-and-how-are-they-different-from-events">为什么代码需要运行</a>。</p>
<hr>
<p><mark>事件处理函数只在响应特定的交互操作时运行</mark>：从用户角度出发，发送消息是 <strong>因为</strong> 他点击了特定的“Send”按钮。如果在任意时间或者因为其他原因发送消息，用户会觉得非常混乱。这就是为什么发送消息应该使用事件处理函数。事件处理函数是让你处理特定的交互操作的：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-9tyo1slqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-9tyo1slqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatRoom</span>(<span class="hljs-params">&#123; roomId &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> [message, setMessage] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;&#x27;</span>);<br>  <span class="hljs-comment">// ...</span><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleSendClick</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">sendMessage</span>(message);<br>  &#125;<br>  <span class="hljs-comment">// ...</span><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;message&#125;</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> setMessage(e.target.value)&#125; /&gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handleSendClick&#125;</span>&gt;</span>Send<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>借助事件处理函数，你可以确保 <code>sendMessage(message)</code> <strong>只</strong> 在用户点击按钮的时候运行。</p>
<hr>
<p><mark>每当需要同步，Effect 就会运行 </mark>：回想一下，你还需要让组件和聊天室保持连接。代码放哪里呢？</p>
<p>运行这个代码的 <strong>原因</strong> 不是特定的交互操作。用户为什么或怎么导航到聊天室屏幕的都不重要。既然用户正在看它并且能够和它交互，组件就要和选中的聊天服务器保持连接。即使聊天室组件显示的是应用的初始屏幕，用户根本还没有执行任何交互，仍然应该需要保持连接。这就是这里用 Effect 的原因：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-kpgxwflqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-kpgxwflqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatRoom</span>(<span class="hljs-params">&#123; roomId &#125;</span>) &#123;<br>  <span class="hljs-comment">// ...</span><br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> connection = <span class="hljs-title function_">createConnection</span>(serverUrl, roomId);<br>    connection.<span class="hljs-title function_">connect</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> &#123;<br>      connection.<span class="hljs-title function_">disconnect</span>();<br>    &#125;;<br>  &#125;, [roomId]);<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p><strong>无论</strong> 用户是否执行指定交互操作，这段代码都可以保证当前选中的聊天室服务器一直有一个活跃连接。用户是否只启动了应用，或选中了不同的聊天室，又或者导航到另一个屏幕后返回，Effect 都可以确保组件和当前选中的聊天室保持同步，并在必要时 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/lifecycle-of-reactive-effects#why-synchronization-may-need-to-happen-more-than-once">重新连接</a>。</p>
<p>App.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-jk85gllqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-jk85gllqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState, useEffect &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; createConnection, sendMessage &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./chat.js&#x27;</span>;<br><br><span class="hljs-keyword">const</span> serverUrl = <span class="hljs-string">&#x27;https://localhost:1234&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatRoom</span>(<span class="hljs-params">&#123; roomId &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> [message, setMessage] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;&#x27;</span>);<br><br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> connection = <span class="hljs-title function_">createConnection</span>(serverUrl, roomId);<br>    connection.<span class="hljs-title function_">connect</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> connection.<span class="hljs-title function_">disconnect</span>();<br>  &#125;, [roomId]);<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleSendClick</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">sendMessage</span>(message);<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Welcome to the &#123;roomId&#125; room!<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;message&#125;</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> setMessage(e.target.value)&#125; /&gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handleSendClick&#125;</span>&gt;</span>Send<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [roomId, setRoomId] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;general&#x27;</span>);<br>  <span class="hljs-keyword">const</span> [show, setShow] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">        Choose the chat room:&#123;&#x27; &#x27;&#125;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">select</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;roomId&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> setRoomId(e.target.value)&#125;</span><br><span class="language-xml">        &gt;</span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;general&quot;</span>&gt;</span>general<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;travel&quot;</span>&gt;</span>travel<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;music&quot;</span>&gt;</span>music<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> setShow(!show)&#125;&gt;</span><br><span class="language-xml">        &#123;show ? &#x27;Close chat&#x27; : &#x27;Open chat&#x27;&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      &#123;show &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">hr</span> /&gt;</span>&#125;</span><br><span class="language-xml">      &#123;show &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">ChatRoom</span> <span class="hljs-attr">roomId</span>=<span class="hljs-string">&#123;roomId&#125;</span> /&gt;</span>&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>chat.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-r945w7lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-r945w7lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">sendMessage</span>(<span class="hljs-params">message</span>) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;🔵 You sent: &#x27;</span> + message);<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createConnection</span>(<span class="hljs-params">serverUrl, roomId</span>) &#123;<br>  <span class="hljs-comment">// 真正的实现实际上会连接到服务器</span><br>  <span class="hljs-keyword">return</span> &#123;<br>    <span class="hljs-title function_">connect</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;✅ Connecting to &quot;&#x27;</span> + roomId + <span class="hljs-string">&#x27;&quot; room at &#x27;</span> + serverUrl + <span class="hljs-string">&#x27;...&#x27;</span>);<br>    &#125;,<br>    <span class="hljs-title function_">disconnect</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;❌ Disconnected from &quot;&#x27;</span> + roomId + <span class="hljs-string">&#x27;&quot; room at &#x27;</span> + serverUrl);<br>    &#125;<br>  &#125;;<br>&#125;<br></code></pre></td></tr></table></div></figure>

<hr>
<p><mark>响应式值和响应式逻辑 </mark>：直观上，你可以说事件处理函数总是“手动”触发的，例如点击按钮。另一方面， Effect 是自动触发：每当需要保持同步的时候他们就会开始运行和重新运行。</p>
<p>有一个更精确的方式来考虑这个问题。</p>
<p>组件内部声明的 state 和 props 变量被称为  响应式值。本示例中的 <code>serverUrl</code> 不是响应式值，但 <code>roomId</code> 和 <code>message</code> 是。他们参与组件的渲染数据流：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-dtpq5llqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-dtpq5llqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> serverUrl = <span class="hljs-string">&#x27;https://localhost:1234&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatRoom</span>(<span class="hljs-params">&#123; roomId &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> [message, setMessage] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;&#x27;</span>);<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>像这样的响应式值可以因为重新渲染而变化。例如用户可能会编辑 <code>message</code> 或者在下拉菜单中选中不同的 <code>roomId</code>。事件处理函数和 Effect 对于变化的响应是不一样的：</p>
<ul>
<li><strong>事件处理函数内部的逻辑是非响应式的</strong>。除非用户又执行了同样的操作（例如点击），否则这段逻辑不会再运行。事件处理函数可以在“不响应”他们变化的情况下读取响应式值。</li>
<li><strong>Effect 内部的逻辑是响应式的</strong>。如果 Effect 要读取响应式值，<a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/lifecycle-of-reactive-effects#effects-react-to-reactive-values">你必须将它指定为依赖项</a>。如果接下来的重新渲染引起那个值变化，React 就会使用新值重新运行 Effect 内的逻辑。</li>
</ul>
<p>让我们重新看看前面的示例来说明差异。</p>
<p><mark>事件处理函数内部的逻辑是非响应式的</mark>：看这行代码。这个逻辑是响应式的吗？</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-n34t3ilqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-n34t3ilqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-comment">// ...</span><br><br><span class="hljs-title function_">sendMessage</span>(message);<br><br><span class="hljs-comment">// ...</span><br></code></pre></td></tr></table></div></figure>

<p>从用户角度出发，**<code>message</code> 的变化并不意味着他们想要发送消息**。它只能表明用户正在输入。换句话说，发送消息的逻辑不应该是响应式的。它不应该仅仅因为 响应式值 变化而再次运行。这就是应该把它归入事件处理函数的原因：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-pzclxdlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-pzclxdlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">handleSendClick</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">sendMessage</span>(message);<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>事件处理函数是非响应式的，所以 <code>sendMessage(message)</code> 只会在用户点击“Send”按钮的时候运行。</p>
<p><mark>Effect 内部的逻辑是响应式的 </mark>：现在让我们返回这几行代码：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-ru63o3lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-ru63o3lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-comment">// ...</span><br><span class="hljs-keyword">const</span> connection = <span class="hljs-title function_">createConnection</span>(serverUrl, roomId);<br>connection.<span class="hljs-title function_">connect</span>();<br><span class="hljs-comment">// ...</span><br></code></pre></td></tr></table></div></figure>

<p>从用户角度出发，**<code>roomId</code> 的变化意味着他们的确想要连接到不同的房间**。换句话说，连接房间的逻辑应该是响应式的。你 <strong>需要</strong> 这几行代码和响应式值“保持同步”，并在值不同时再次运行。这就是它被归入 Effect 的原因：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-u2i0uqlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-u2i0uqlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> connection = <span class="hljs-title function_">createConnection</span>(serverUrl, roomId);<br>    connection.<span class="hljs-title function_">connect</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> &#123;<br>        connection.<span class="hljs-title function_">disconnect</span>()<br>    &#125;;<br>&#125;, [roomId]);<br></code></pre></td></tr></table></div></figure>

<p>Effect 是响应式的，所以 <code>createConnection(serverUrl, roomId)</code> 和 <code>connection.connect()</code> 会因为 <code>roomId</code> 每个不同的值而运行。Effect 让聊天室连接和当前选中的房间保持了同步。</p>
<hr>
<p><mark>从 Effect 中提取非响应式逻辑 </mark>：当你想混合使用响应式逻辑和非响应式逻辑时，事情变得更加棘手。</p>
<p>例如，假设你想在用户连接到聊天室时展示一个通知。并且通过从 props 中读取当前 theme（dark 或者 light）来展示对应颜色的通知：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-it2670lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-it2670lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatRoom</span>(<span class="hljs-params">&#123; roomId, theme &#125;</span>) &#123;<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> connection = <span class="hljs-title function_">createConnection</span>(serverUrl, roomId);<br>    connection.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;connected&#x27;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-title function_">showNotification</span>(<span class="hljs-string">&#x27;Connected!&#x27;</span>, theme);<br>    &#125;);<br>    connection.<span class="hljs-title function_">connect</span>();<br>    <span class="hljs-comment">// ...</span><br></code></pre></td></tr></table></div></figure>

<p>但是 <code>theme</code> 是一个响应式值（它会由于重新渲染而变化），并且 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/lifecycle-of-reactive-effects#react-verifies-that-you-specified-every-reactive-value-as-a-dependency">Effect 读取的每一个响应式值都必须在其依赖项中声明</a>。现在你必须把 <code>theme</code> 作为 Effect 的依赖项之一：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-1wqtyklqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-1wqtyklqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatRoom</span>(<span class="hljs-params">&#123; roomId, theme &#125;</span>) &#123;<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> connection = <span class="hljs-title function_">createConnection</span>(serverUrl, roomId);<br>    connection.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;connected&#x27;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-title function_">showNotification</span>(<span class="hljs-string">&#x27;Connected!&#x27;</span>, theme);<br>    &#125;);<br>    connection.<span class="hljs-title function_">connect</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> &#123;<br>      connection.<span class="hljs-title function_">disconnect</span>()<br>    &#125;;<br>  &#125;, [roomId, theme]); <span class="hljs-comment">// ✅ 声明所有依赖项</span><br>  <span class="hljs-comment">// ...</span><br></code></pre></td></tr></table></div></figure>

<p>用这个例子试一下，看你能否看出这个用户体验问题：</p>
<p>App.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-tdhh84lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-tdhh84lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState, useEffect &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; createConnection, sendMessage &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./chat.js&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; showNotification &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./notifications.js&#x27;</span>;<br><br><span class="hljs-keyword">const</span> serverUrl = <span class="hljs-string">&#x27;https://localhost:1234&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatRoom</span>(<span class="hljs-params">&#123; roomId, theme &#125;</span>) &#123;<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> connection = <span class="hljs-title function_">createConnection</span>(serverUrl, roomId);<br>    connection.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;connected&#x27;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-title function_">showNotification</span>(<span class="hljs-string">&#x27;Connected!&#x27;</span>, theme);<br>    &#125;);<br>    connection.<span class="hljs-title function_">connect</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> connection.<span class="hljs-title function_">disconnect</span>();<br>  &#125;, [roomId, theme]);<br><br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Welcome to the &#123;roomId&#125; room!<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [roomId, setRoomId] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;general&#x27;</span>);<br>  <span class="hljs-keyword">const</span> [isDark, setIsDark] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">        Choose the chat room:&#123;&#x27; &#x27;&#125;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">select</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;roomId&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> setRoomId(e.target.value)&#125;</span><br><span class="language-xml">        &gt;</span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;general&quot;</span>&gt;</span>general<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;travel&quot;</span>&gt;</span>travel<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;music&quot;</span>&gt;</span>music<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">input</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;checkbox&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">checked</span>=<span class="hljs-string">&#123;isDark&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> setIsDark(e.target.checked)&#125;</span><br><span class="language-xml">        /&gt;</span><br><span class="language-xml">        Use dark theme</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">hr</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ChatRoom</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">roomId</span>=<span class="hljs-string">&#123;roomId&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">theme</span>=<span class="hljs-string">&#123;isDark</span> ? &#x27;<span class="hljs-attr">dark</span>&#x27; <span class="hljs-attr">:</span> &#x27;<span class="hljs-attr">light</span>&#x27;&#125;</span></span><br><span class="hljs-tag"><span class="language-xml">      /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>chat.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-vjj635lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-vjj635lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createConnection</span>(<span class="hljs-params">serverUrl, roomId</span>) &#123;<br>  <span class="hljs-comment">// 真正的实现实际上会连接到服务器</span><br>  <span class="hljs-keyword">let</span> connectedCallback;<br>  <span class="hljs-keyword">let</span> timeout;<br>  <span class="hljs-keyword">return</span> &#123;<br>    <span class="hljs-title function_">connect</span>(<span class="hljs-params"></span>) &#123;<br>      timeout = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>        <span class="hljs-keyword">if</span> (connectedCallback) &#123;<br>          <span class="hljs-title function_">connectedCallback</span>();<br>        &#125;<br>      &#125;, <span class="hljs-number">100</span>);<br>    &#125;,<br>    <span class="hljs-title function_">on</span>(<span class="hljs-params">event, callback</span>) &#123;<br>      <span class="hljs-keyword">if</span> (connectedCallback) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;Cannot add the handler twice.&#x27;</span>);<br>      &#125;<br>      <span class="hljs-keyword">if</span> (event !== <span class="hljs-string">&#x27;connected&#x27;</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;Only &quot;connected&quot; event is supported.&#x27;</span>);<br>      &#125;<br>      connectedCallback = callback;<br>    &#125;,<br>    <span class="hljs-title function_">disconnect</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-built_in">clearTimeout</span>(timeout);<br>    &#125;<br>  &#125;;<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>notifications.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-w6j887lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-w6j887lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Toastify</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;toastify-js&#x27;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;toastify-js/src/toastify.css&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">showNotification</span>(<span class="hljs-params">message, theme</span>) &#123;<br>  <span class="hljs-title class_">Toastify</span>(&#123;<br>    <span class="hljs-attr">text</span>: message,<br>    <span class="hljs-attr">duration</span>: <span class="hljs-number">2000</span>,<br>    <span class="hljs-attr">gravity</span>: <span class="hljs-string">&#x27;top&#x27;</span>,<br>    <span class="hljs-attr">position</span>: <span class="hljs-string">&#x27;right&#x27;</span>,<br>    <span class="hljs-attr">style</span>: &#123;<br>      <span class="hljs-attr">background</span>: theme === <span class="hljs-string">&#x27;dark&#x27;</span> ? <span class="hljs-string">&#x27;black&#x27;</span> : <span class="hljs-string">&#x27;white&#x27;</span>,<br>      <span class="hljs-attr">color</span>: theme === <span class="hljs-string">&#x27;dark&#x27;</span> ? <span class="hljs-string">&#x27;white&#x27;</span> : <span class="hljs-string">&#x27;black&#x27;</span>,<br>    &#125;,<br>  &#125;).<span class="hljs-title function_">showToast</span>();<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>当 <code>roomId</code> 变化时，聊天会和预期一样重新连接。但是由于 <code>theme</code> 也是一个依赖项，所以每次你在 dark 和 light 主题间切换时，聊天 <strong>也会</strong> 重连。这不是很好！</p>
<p>换言之，即使它在 Effect 内部（这是响应式的），你也不想让这行代码变成响应式：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-c528y9lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-c528y9lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-comment">// ...</span><br><br><span class="hljs-title function_">showNotification</span>(<span class="hljs-string">&#x27;Connected!&#x27;</span>, theme);<br><br><span class="hljs-comment">// ...</span><br></code></pre></td></tr></table></div></figure>

<p>你需要一个将这个非响应式逻辑和周围响应式 Effect 隔离开来的方法。</p>
<h2 id="7-移除-Effect-依赖"><a href="#7-移除-Effect-依赖" class="headerlink" title="7.移除 Effect 依赖"></a>7.移除 Effect 依赖</h2><p>当编写 Effect 时，linter 会验证是否已经将 Effect 读取的每一个响应式值（如 props 和 state）包含在 Effect 的依赖中。这可以确保 Effect 与组件的 props 和 state 保持同步。不必要的依赖可能会导致 Effect 运行过于频繁，甚至产生无限循环。请按照本指南审查并移除 Effect 中不必要的依赖。</p>
<p><mark>依赖应该和代码保持一致 </mark>：当你编写 Effect 时，无论这个 Effect 要做什么，你首先要明确其 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/lifecycle-of-reactive-effects#the-lifecycle-of-an-effect">生命周期</a>：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-yqnr9plqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-yqnr9plqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> serverUrl = <span class="hljs-string">&#x27;https://localhost:1234&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatRoom</span>(<span class="hljs-params">&#123; roomId &#125;</span>) &#123;<br>    <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>        <span class="hljs-keyword">const</span> connection = <span class="hljs-title function_">createConnection</span>(serverUrl, roomId);<br>        connection.<span class="hljs-title function_">connect</span>();<br>        <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> connection.<span class="hljs-title function_">disconnect</span>();<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>如果你设置 Effect 的依赖是空数组（<code>[]</code>），那么 linter 将会建议合适的依赖：</p>
<p>App.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-l1e5cdlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-l1e5cdlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState, useEffect &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; createConnection &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./chat.js&#x27;</span>;<br><br><span class="hljs-keyword">const</span> serverUrl = <span class="hljs-string">&#x27;https://localhost:1234&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatRoom</span>(<span class="hljs-params">&#123; roomId &#125;</span>) &#123;<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> connection = <span class="hljs-title function_">createConnection</span>(serverUrl, roomId);<br>    connection.<span class="hljs-title function_">connect</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> connection.<span class="hljs-title function_">disconnect</span>();<br>  &#125;, []); <span class="hljs-comment">// &lt;-- 修复这里的依赖！</span><br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>欢迎来到 &#123;roomId&#125; 房间！<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>;<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [roomId, setRoomId] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;所有&#x27;</span>);<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">        选择聊天室：</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">select</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;roomId&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> setRoomId(e.target.value)&#125;</span><br><span class="language-xml">        &gt;</span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;所有&quot;</span>&gt;</span>所有<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;旅游&quot;</span>&gt;</span>旅游<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;音乐&quot;</span>&gt;</span>音乐<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">hr</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ChatRoom</span> <span class="hljs-attr">roomId</span>=<span class="hljs-string">&#123;roomId&#125;</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>chat.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-i0cpajlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-i0cpajlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createConnection</span>(<span class="hljs-params">serverUrl, roomId</span>) &#123;<br>  <span class="hljs-comment">// 真正的实现实际上会连接到服务器</span><br>  <span class="hljs-keyword">return</span> &#123;<br>    <span class="hljs-title function_">connect</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;✅ 连接到“&#x27;</span> + roomId + <span class="hljs-string">&#x27;”房间，在 &#x27;</span> + serverUrl + <span class="hljs-string">&#x27;...&#x27;</span>);<br>    &#125;,<br>    <span class="hljs-title function_">disconnect</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;❌ 断开“&#x27;</span> + roomId + <span class="hljs-string">&#x27;”房间，在 &#x27;</span> + serverUrl);<br>    &#125;<br>  &#125;;<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>按照 linter 的建议，把它们填进去：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-jtvm0jlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-jtvm0jlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatRoom</span>(<span class="hljs-params">&#123; roomId &#125;</span>) &#123;<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> connection = <span class="hljs-title function_">createConnection</span>(serverUrl, roomId);<br>    connection.<span class="hljs-title function_">connect</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> connection.<span class="hljs-title function_">disconnect</span>();<br>  &#125;, [roomId]); <span class="hljs-comment">// ✅ 所有依赖已声明</span><br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p><a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/lifecycle-of-reactive-effects#effects-react-to-reactive-values">Effect “反应”响应式值</a> 因为这里的 <code>roomId</code> 是一个响应式值（它可能随重新渲染而改变），所以 linter 会验证你是否将它指定为依赖。如果 <code>roomId</code> 变成不同的值，React 将重新运行 Effect。这可以确保聊天界面与所选房间保持一致，并把变化“反馈”给下拉菜单：</p>
<p>App.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-374p40lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-374p40lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState, useEffect &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; createConnection &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./chat.js&#x27;</span>;<br><br><span class="hljs-keyword">const</span> serverUrl = <span class="hljs-string">&#x27;https://localhost:1234&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatRoom</span>(<span class="hljs-params">&#123; roomId &#125;</span>) &#123;<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> connection = <span class="hljs-title function_">createConnection</span>(serverUrl, roomId);<br>    connection.<span class="hljs-title function_">connect</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> connection.<span class="hljs-title function_">disconnect</span>();<br>  &#125;, [roomId]);<br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>欢迎来到 &#123;roomId&#125; 房间！<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>;<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [roomId, setRoomId] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;所有&#x27;</span>);<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">        选择聊天室：</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">select</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;roomId&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> setRoomId(e.target.value)&#125;</span><br><span class="language-xml">        &gt;</span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;所有&quot;</span>&gt;</span>所有<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;旅游&quot;</span>&gt;</span>旅游<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;音乐&quot;</span>&gt;</span>音乐<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">hr</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ChatRoom</span> <span class="hljs-attr">roomId</span>=<span class="hljs-string">&#123;roomId&#125;</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>chat.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-xd5duilqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-xd5duilqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createConnection</span>(<span class="hljs-params">serverUrl, roomId</span>) &#123;<br>  <span class="hljs-comment">// 真正的实现实际上会连接到服务器</span><br>  <span class="hljs-keyword">return</span> &#123;<br>    <span class="hljs-title function_">connect</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;✅ 连接到“&#x27;</span> + roomId + <span class="hljs-string">&#x27;”房间，在 &#x27;</span> + serverUrl + <span class="hljs-string">&#x27;...&#x27;</span>);<br>    &#125;,<br>    <span class="hljs-title function_">disconnect</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;❌ 断开“&#x27;</span> + roomId + <span class="hljs-string">&#x27;”房间，在 &#x27;</span> + serverUrl);<br>    &#125;<br>  &#125;;<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p><mark>当要移除一个依赖时，请证明它不是一个依赖</mark>：注意，你不能“选择” Effect 的依赖。每个被 Effect 所使用的响应式值，必须在依赖中声明。依赖是由 Effect 的代码决定的：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-a5t5nllqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-a5t5nllqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> serverUrl = <span class="hljs-string">&#x27;https://localhost:1234&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatRoom</span>(<span class="hljs-params">&#123; roomId &#125;</span>) &#123; <span class="hljs-comment">// 这是一个响应式值</span><br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> connection = <span class="hljs-title function_">createConnection</span>(serverUrl, roomId); <span class="hljs-comment">// Effect 在这里读取响应式值</span><br>    connection.<span class="hljs-title function_">connect</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> connection.<span class="hljs-title function_">disconnect</span>();<br>  &#125;, [roomId]); <span class="hljs-comment">// ✅ 所以你必须在依赖中声明 Effect 使用的响应式值</span><br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p><a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/lifecycle-of-reactive-effects#all-variables-declared-in-the-component-body-are-reactive">响应式值</a> 包括 props 以及所有你直接在组件中声明的变量和函数。由于 <code>roomId</code> 是响应式值，你不能把它从依赖中移除。linter 不允许这样做：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-u4nwkolqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-u4nwkolqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> serverUrl = <span class="hljs-string">&#x27;https://localhost:1234&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatRoom</span>(<span class="hljs-params">&#123; roomId &#125;</span>) &#123;<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> connection = <span class="hljs-title function_">createConnection</span>(serverUrl, roomId);<br>    connection.<span class="hljs-title function_">connect</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> connection.<span class="hljs-title function_">disconnect</span>();<br>  &#125;, []); <span class="hljs-comment">// 🔴 React Hook useEffect 缺失依赖: &#x27;roomId&#x27;</span><br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>linter 是对的！ 由于 <code>roomId</code> 可能会随时间变化，这会在代码中引入错误。</p>
<p><strong>移除一个依赖，你需要向 linter 证明其不需要这个依赖</strong>。例如，你可以将 <code>roomId</code> 移出组件，以证明它不是响应的，也不会在重新渲染时改变：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-bhwcrplqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-bhwcrplqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> serverUrl = <span class="hljs-string">&#x27;https://localhost:1234&#x27;</span>;<br><span class="hljs-keyword">const</span> roomId = <span class="hljs-string">&#x27;音乐&#x27;</span>; <span class="hljs-comment">// 不再是响应式值</span><br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatRoom</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> connection = <span class="hljs-title function_">createConnection</span>(serverUrl, roomId);<br>    connection.<span class="hljs-title function_">connect</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> connection.<span class="hljs-title function_">disconnect</span>();<br>  &#125;, []); <span class="hljs-comment">// ✅ 所有依赖已声明</span><br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>现在 <code>roomId</code> 不是响应式值（并且不能在重新渲染时改变），那它不就不是依赖：</p>
<p>App.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-rq4f1blqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-rq4f1blqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState, useEffect &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; createConnection &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./chat.js&#x27;</span>;<br><br><span class="hljs-keyword">const</span> serverUrl = <span class="hljs-string">&#x27;https://localhost:1234&#x27;</span>;<br><span class="hljs-keyword">const</span> roomId = <span class="hljs-string">&#x27;音乐&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatRoom</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> connection = <span class="hljs-title function_">createConnection</span>(serverUrl, roomId);<br>    connection.<span class="hljs-title function_">connect</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> connection.<span class="hljs-title function_">disconnect</span>();<br>  &#125;, []);<br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>欢迎来到 &#123;roomId&#125; 房间！<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>;<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>chat.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-tzemg7lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-tzemg7lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createConnection</span>(<span class="hljs-params">serverUrl, roomId</span>) &#123;<br>  <span class="hljs-comment">// 真正的实现实际上会连接到服务器</span><br>  <span class="hljs-keyword">return</span> &#123;<br>    <span class="hljs-title function_">connect</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;✅ 连接到“&#x27;</span> + roomId + <span class="hljs-string">&#x27;”房间，在 &#x27;</span> + serverUrl + <span class="hljs-string">&#x27;...&#x27;</span>);<br>    &#125;,<br>    <span class="hljs-title function_">disconnect</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;❌ 断开“&#x27;</span> + roomId + <span class="hljs-string">&#x27;”房间，在 &#x27;</span> + serverUrl);<br>    &#125;<br>  &#125;;<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>这就是为什么你现在可以指定 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/lifecycle-of-reactive-effects#what-an-effect-with-empty-dependencies-means">空（<code>[]</code>）依赖</a>。Effect <strong>真的不</strong> 依赖任何响应式值了，也 <strong>真的不</strong> 需要在组件的 props 或 state 改变时重新运行。</p>
<p>你可能已经注意到工作流程中有一个模式：</p>
<ol>
<li>首先，你 <strong>改变 Effect 的代码</strong> 或响应式值的声明方式。</li>
<li>然后，你采纳 linter 的建议，调整依赖，以 <strong>匹配你所改变的代码</strong>。</li>
<li>如果你对依赖不满意，你可以 <strong>回到第一步</strong>（并再次修改代码）。</li>
</ol>
<p>最后一部分很重要。<strong>如果你想改变依赖，首先要改变所涉及到的代码</strong>。你可以把依赖看作是 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/lifecycle-of-reactive-effects#react-verifies-that-you-specified-every-reactive-value-as-a-dependency">Effect的代码所依赖的所有响应式值的列表</a>。你不要 <strong>选择</strong> 把什么放在这个列表上。该列表 <strong>描述了</strong> 代码。要改变依赖，请改变代码。</p>
<p>这可能感觉就像解方程一样。你有一个目标（例如，移除一个依赖），你需要“找到”与该目标相匹配的代码。不是每个人都觉得解方程很有趣，写 Effect 也是如此！幸运的是，下面有一些常见的解决方案你可以去尝试。</p>
<p>如果你有一个已经存在的代码库，你可能会有一些像这样抑制 linter 的代码：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-krlow7lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-krlow7lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-comment">// ...</span><br>  <span class="hljs-comment">// 🔴 避免像这样抑制 linter 的警告或错误提示：</span><br>  <span class="hljs-comment">// eslint-ignore-next-line react-hooks/exhaustive-deps</span><br>&#125;, []);<br></code></pre></td></tr></table></div></figure>

<p><strong>当依赖与代码不匹配时，极有可能引入 bug</strong>。通过抑制 linter，你是在 Effect 所依赖的值上对 React “撒谎”。</p>
<hr>
<p><mark>移除非必需的依赖</mark>：每当你调整 Effect 的依赖以适配代码时，请注意一下当前的依赖。当这些依赖发生变化时，让 Effect 重新运行是否有意义？有时，答案是“不”：</p>
<ul>
<li>你可能想在不同的条件下重新执行 Effect 的 <strong>不同部分</strong>。</li>
<li>你可能想只读取某个依赖的 <strong>最新值</strong>，而不是对其变化做出“反应”。</li>
<li>依赖可能会因为它的类型是对象或函数而 <strong>无意间</strong> 改变太频繁。</li>
</ul>
<p>为了找到正确的解决方案，你需要回答关于 Effect 的几个问题。让我们来看看这些问题。</p>
<p>你应该考虑的第一件事是，这段代码是否应该成为 Effect。</p>
<p>想象一个表单，在提交时你将 <code>submitted</code> 状态变量设置为 <code>true</code>，并在 <code>submitted</code> 为 <code>true</code> 时，需要发送 POST 请求并显示通知。你把这个逻辑放在 Effect 内，并根据 <code>submitted</code> 为 <code>true</code> “反应”。</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-wn8c7elqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-wn8c7elqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Form</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [submitted, setSubmitted] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (submitted) &#123;<br>      <span class="hljs-comment">// 🔴 避免: Effect 中有特定事件的逻辑</span><br>      <span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/api/register&#x27;</span>);<br>      <span class="hljs-title function_">showNotification</span>(<span class="hljs-string">&#x27;Successfully registered!&#x27;</span>);<br>    &#125;<br>  &#125;, [submitted]);<br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleSubmit</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">setSubmitted</span>(<span class="hljs-literal">true</span>);<br>  &#125;<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>后来，你想通过读取当前的主题值来调整通知信息的样式。因为 <code>theme</code> 是在组件中声明的，所以它是响应式值，你决定把它作为依赖加入：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-m0bhjalqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-m0bhjalqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Form</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [submitted, setSubmitted] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);<br>  <span class="hljs-keyword">const</span> theme = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">ThemeContext</span>);<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (submitted) &#123;<br>      <span class="hljs-comment">// 🔴 避免: Effect 中有特定事件的逻辑</span><br>      <span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/api/register&#x27;</span>);<br>      <span class="hljs-title function_">showNotification</span>(<span class="hljs-string">&#x27;Successfully registered!&#x27;</span>, theme);<br>    &#125;<br>  &#125;, [submitted, theme]); <span class="hljs-comment">// ✅ 所有依赖已声明</span><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleSubmit</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">setSubmitted</span>(<span class="hljs-literal">true</span>);<br>  &#125;  <br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>如果这么做，你将引入一个错误。想象一下，你先提交表单，然后切换暗亮主题。当 <code>theme</code> 改变后，Effect 重新运行，这将导致显示两次相同的通知！</p>
<p><strong>首先，这里的问题是，代码不应该以 Effect 实现</strong>。你想发送这个 POST 请求，并在 <strong>提交表单时显示通知</strong>，这是一个特定的交互。特定的交互请将该逻辑直接放到相应的事件处理程序中：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-oc1hi5lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-oc1hi5lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Form</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> theme = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">ThemeContext</span>);<br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleSubmit</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-comment">// ✅ 好：从事件处理程序调用特定于事件的逻辑</span><br>    <span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/api/register&#x27;</span>);<br>    <span class="hljs-title function_">showNotification</span>(<span class="hljs-string">&#x27;Successfully registered!&#x27;</span>, theme);<br>  &#125; <br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>现在，代码在事件处理程序中，它不是响应式的 —— 所以它只在用户提交表单时运行。阅读更多关于 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/separating-events-from-effects#reactive-values-and-reactive-logic">在事件处理程序和 Effect 之间做出选择</a> 和 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/you-might-not-need-an-effect">如何删除不必要的 Effect</a>。</p>
<p>下一个应该问自己的问题是，Effect 是否在做几件不相关的事情。</p>
<p>如下例子，你正在实现运输表单，用户需要选择他们的城市和地区。你根据所选的“国家”从服务器上获取“城市”列表，然后在下拉菜单中显示：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-lungeklqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-lungeklqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ShippingForm</span>(<span class="hljs-params">&#123; country &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> [cities, setCities] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);<br>  <span class="hljs-keyword">const</span> [city, setCity] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">let</span> ignore = <span class="hljs-literal">false</span>;<br>    <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/cities?country=<span class="hljs-subst">$&#123;country&#125;</span>`</span>)<br>      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> response.<span class="hljs-title function_">json</span>())<br>      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">json</span> =&gt;</span> &#123;<br>        <span class="hljs-keyword">if</span> (!ignore) &#123;<br>          <span class="hljs-title function_">setCities</span>(json);<br>        &#125;<br>      &#125;);<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> &#123;<br>      ignore = <span class="hljs-literal">true</span>;<br>    &#125;;<br>  &#125;, [country]); <span class="hljs-comment">// ✅ 所有依赖已声明</span><br>  <span class="hljs-comment">// ...</span><br></code></pre></td></tr></table></div></figure>

<p>这是一个 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/you-might-not-need-an-effect#fetching-data">在Effect中获取数据</a> 的好例子：<code>cities</code> state 通过网络和 <code>country</code> props 进行“同步”。但你不能在事件处理程序中这样做，因为你需要在 <code>ShippingForm</code> 显示时和 <code>country</code> 发生变化时（不管是哪个交互导致的）立即获取。</p>
<p>现在我们假设你要为城市区域添加第二个选择框，它应该获取当前选择的 <code>city</code> 的 <code>areas</code>。你也许会在同一个 Effect 中添加第二个 <code>fetch</code> 调用来获取地区列表：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-3cr4j9lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-3cr4j9lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ShippingForm</span>(<span class="hljs-params">&#123; country &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> [cities, setCities] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);<br>  <span class="hljs-keyword">const</span> [city, setCity] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);<br>  <span class="hljs-keyword">const</span> [areas, setAreas] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">let</span> ignore = <span class="hljs-literal">false</span>;<br>    <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/cities?country=<span class="hljs-subst">$&#123;country&#125;</span>`</span>)<br>      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> response.<span class="hljs-title function_">json</span>())<br>      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">json</span> =&gt;</span> &#123;<br>        <span class="hljs-keyword">if</span> (!ignore) &#123;<br>          <span class="hljs-title function_">setCities</span>(json);<br>        &#125;<br>      &#125;);<br>    <span class="hljs-comment">// 🔴 避免: 单个 Effect 同步两个独立逻辑处理</span><br>    <span class="hljs-keyword">if</span> (city) &#123;<br>      <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/areas?city=<span class="hljs-subst">$&#123;city&#125;</span>`</span>)<br>        .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> response.<span class="hljs-title function_">json</span>())<br>        .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">json</span> =&gt;</span> &#123;<br>          <span class="hljs-keyword">if</span> (!ignore) &#123;<br>            <span class="hljs-title function_">setAreas</span>(json);<br>          &#125;<br>        &#125;);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> &#123;<br>      ignore = <span class="hljs-literal">true</span>;<br>    &#125;;<br>  &#125;, [country, city]); <span class="hljs-comment">// ✅ 所有依赖已声明</span><br>  <span class="hljs-comment">// ...</span><br></code></pre></td></tr></table></div></figure>

<p>然而，由于 Effect 现在使用 <code>city</code> state 变量，你不得不把 <code>city</code> 加入到依赖中。这又带来一个问题：当用户选择不同的城市时，Effect 将重新运行并调用 <code>fetchCities(country)</code>。这将导致不必要地多次获取城市列表。</p>
<p><strong>这段代码的问题在于，你在同步两个不同的、不相关的东西</strong>：</p>
<ol>
<li>你想要根据 <code>country</code> props 通过网络同步 <code>city</code> state</li>
<li>你想要根据 <code>city</code> 状态通过网络同步 <code>areas</code> state</li>
</ol>
<p>将逻辑分到 2 个 Effect 中，每个 Effect 仅响应其需要同步响应的 props：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-x1cedmlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-x1cedmlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ShippingForm</span>(<span class="hljs-params">&#123; country &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> [cities, setCities] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">let</span> ignore = <span class="hljs-literal">false</span>;<br>    <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/cities?country=<span class="hljs-subst">$&#123;country&#125;</span>`</span>)<br>      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> response.<span class="hljs-title function_">json</span>())<br>      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">json</span> =&gt;</span> &#123;<br>        <span class="hljs-keyword">if</span> (!ignore) &#123;<br>          <span class="hljs-title function_">setCities</span>(json);<br>        &#125;<br>      &#125;);<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> &#123;<br>      ignore = <span class="hljs-literal">true</span>;<br>    &#125;;<br>  &#125;, [country]); <span class="hljs-comment">// ✅ 所有依赖已声明</span><br>  <span class="hljs-keyword">const</span> [city, setCity] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);<br>  <span class="hljs-keyword">const</span> [areas, setAreas] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (city) &#123;<br>      <span class="hljs-keyword">let</span> ignore = <span class="hljs-literal">false</span>;<br>      <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/areas?city=<span class="hljs-subst">$&#123;city&#125;</span>`</span>)<br>        .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> response.<span class="hljs-title function_">json</span>())<br>        .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">json</span> =&gt;</span> &#123;<br>          <span class="hljs-keyword">if</span> (!ignore) &#123;<br>            <span class="hljs-title function_">setAreas</span>(json);<br>          &#125;<br>        &#125;);<br>      <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> &#123;<br>        ignore = <span class="hljs-literal">true</span>;<br>      &#125;;<br>    &#125;<br>  &#125;, [city]); <span class="hljs-comment">// ✅ 所有依赖已声明</span><br>  <span class="hljs-comment">// ...</span><br></code></pre></td></tr></table></div></figure>

<p>现在，第一个 Effect 只在 <code>country</code> 改变时重新运行，而第二个 Effect 在 <code>city</code> 改变时重新运行。你已经按目的把它们分开了：两件不同的事情由两个独立的 Effect 来同步。两个独立的 Effect 有两个独立的依赖，所以它们不会在无意中相互触发。</p>
<p>最终完成的代码比最初的要长，但是拆分这些 Effect 是非常正确的。<a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/lifecycle-of-reactive-effects#each-effect-represents-a-separate-synchronization-process">每个 Effect 应该代表一个独立的同步过程</a>。在这个例子中，删除一个 Effect 并不会影响到另一个 Effect 的逻辑。这意味着他们 <strong>同步不同的事情</strong>，分开他们处理是一件好事。如果你担心重复代码的问题，你可以通过 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/reusing-logic-with-custom-hooks#when-to-use-custom-hooks">提取相同逻辑到自定义 Hook</a> 来提升代码质量。</p>
<hr>
<p><mark>是否在读取一些状态来计算下一个状态？ </mark>：每次有新的消息到达时，这个 Effect 会用新创建的数组更新 <code>messages</code> state：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-hei3hclqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-hei3hclqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatRoom</span>(<span class="hljs-params">&#123; roomId &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> [messages, setMessages] = <span class="hljs-title function_">useState</span>([]);<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> connection = <span class="hljs-title function_">createConnection</span>();<br>    connection.<span class="hljs-title function_">connect</span>();<br>    connection.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;message&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">receivedMessage</span>) =&gt;</span> &#123;<br>      <span class="hljs-title function_">setMessages</span>([...messages, receivedMessage]);<br>    &#125;);<br>    <span class="hljs-comment">// ...</span><br></code></pre></td></tr></table></div></figure>

<p>它使用 <code>messages</code> 变量来 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/updating-arrays-in-state">创建一个新的数组</a>：从所有现有的消息开始，并在最后添加新的消息。然而，由于 <code>messages</code> 是一个由 Effect 读取的响应式值，它必须是一个依赖：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-n0os5nlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-n0os5nlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatRoom</span>(<span class="hljs-params">&#123; roomId &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> [messages, setMessages] = <span class="hljs-title function_">useState</span>([]);<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> connection = <span class="hljs-title function_">createConnection</span>();<br>    connection.<span class="hljs-title function_">connect</span>();<br>    connection.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;message&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">receivedMessage</span>) =&gt;</span> &#123;<br>      <span class="hljs-title function_">setMessages</span>([...messages, receivedMessage]);<br>    &#125;);<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> connection.<span class="hljs-title function_">disconnect</span>();<br>  &#125;, [roomId, messages]); <span class="hljs-comment">// ✅ 所有依赖已声明</span><br>  <span class="hljs-comment">// ...</span><br></code></pre></td></tr></table></div></figure>

<p>而让 <code>messages</code> 成为依赖会带来问题。</p>
<p>每当你收到一条消息，<code>setMessages()</code> 就会使该组件重新渲染一个新的 <code>messages</code> 数组，其中包括收到的消息。然而，由于该 Effect 现在依赖于 <code>messages</code>，这 <strong>也将</strong> 重新同步该 Effect。所以每条新消息都会使聊天重新连接。用户不会喜欢这样！</p>
<p>为了解决这个问题，不要在 Effect 里面读取 <code>messages</code>。相反，应该将一个 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/reference/react/useState#updating-state-based-the-previous-state">state 更新函数</a> 传递给 <code>setMessages</code>：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-z6n6pslqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-z6n6pslqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatRoom</span>(<span class="hljs-params">&#123; roomId &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> [messages, setMessages] = <span class="hljs-title function_">useState</span>([]);<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> connection = <span class="hljs-title function_">createConnection</span>();<br>    connection.<span class="hljs-title function_">connect</span>();<br>    connection.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;message&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">receivedMessage</span>) =&gt;</span> &#123;<br>      <span class="hljs-title function_">setMessages</span>(<span class="hljs-function"><span class="hljs-params">msgs</span> =&gt;</span> [...msgs, receivedMessage]);<br>    &#125;);<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> connection.<span class="hljs-title function_">disconnect</span>();<br>  &#125;, [roomId]); <span class="hljs-comment">// ✅ 所有依赖已声明</span><br>  <span class="hljs-comment">// ...</span><br></code></pre></td></tr></table></div></figure>

<p><strong>注意 Effect 现在根本不读取 <code>messages</code> 变量</strong>。你只需要传递一个更新函数，比如 <code>msgs =&gt; [...msgs, receivedMessage]</code>。React <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/queueing-a-series-of-state-updates">将更新程序函数放入队列</a> 并将在下一次渲染期间向其提供 <code>msgs</code> 参数。这就是 Effect 本身不再需要依赖 <code>messages</code> 的原因。修复后，接收聊天消息将不再使聊天重新连接。</p>
<h2 id="8-使用自定义-Hook-复用逻辑"><a href="#8-使用自定义-Hook-复用逻辑" class="headerlink" title="8.使用自定义 Hook 复用逻辑"></a>8.使用自定义 Hook 复用逻辑</h2><p>React 有一些内置 Hook，例如 <code>useState</code>，<code>useContext</code> 和 <code>useEffect</code>。有时你需要一个用途更特殊的 Hook：例如获取数据，记录用户是否在线或者连接聊天室。虽然 React 中可能没有这些 Hook，但是你可以根据应用需求创建自己的 Hook。</p>
<hr>
<p><mark>自定义 Hook：组件间共享逻辑 </mark>：假设你正在开发一款重度依赖网络的应用（和大多数应用一样）。当用户使用应用时网络意外断开，你需要提醒他。你会怎么处理呢？看上去组件需要两个东西：</p>
<ol>
<li>一个追踪网络是否在线的 state。</li>
<li>一个订阅全局 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/online_event"><code>online</code></a> 和 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/offline_event"><code>offline</code></a> 事件并更新上述 state 的 Effect。</li>
</ol>
<p>这会让组件与网络状态保持 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/synchronizing-with-effects">同步</a>。你也许可以像这样开始：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-glpiiwlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-glpiiwlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState, useEffect &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">StatusBar</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [isOnline, setIsOnline] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>);<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleOnline</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-title function_">setIsOnline</span>(<span class="hljs-literal">true</span>);<br>    &#125;<br>    <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleOffline</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-title function_">setIsOnline</span>(<span class="hljs-literal">false</span>);<br>    &#125;<br>    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;online&#x27;</span>, handleOnline);<br>    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;offline&#x27;</span>, handleOffline);<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">&#x27;online&#x27;</span>, handleOnline);<br>      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">&#x27;offline&#x27;</span>, handleOffline);<br>    &#125;;<br>  &#125;, []);<br><br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>&#123;isOnline ? &#x27;✅ Online&#x27; : &#x27;❌ Disconnected&#x27;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>;<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>试着开启和关闭网络，注意观察 <code>StatusBar</code> 组件应对你的行为是如何更新的。</p>
<p>假设现在你想在另一个不同的组件里 <strong>也</strong> 使用同样的逻辑。你希望实现一个保存按钮，每当网络断开这个按钮就会不可用并且显示“Reconnecting…”而不是“Save progress”。</p>
<p>你可以从复制粘贴 <code>isOnline</code> state 和 Effect 到 <code>SaveButton</code> 组件开始：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-o13ws8lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-o13ws8lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState, useEffect &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">SaveButton</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [isOnline, setIsOnline] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>);<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleOnline</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-title function_">setIsOnline</span>(<span class="hljs-literal">true</span>);<br>    &#125;<br>    <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleOffline</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-title function_">setIsOnline</span>(<span class="hljs-literal">false</span>);<br>    &#125;<br>    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;online&#x27;</span>, handleOnline);<br>    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;offline&#x27;</span>, handleOffline);<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">&#x27;online&#x27;</span>, handleOnline);<br>      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">&#x27;offline&#x27;</span>, handleOffline);<br>    &#125;;<br>  &#125;, []);<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleSaveClick</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;✅ Progress saved&#x27;</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">disabled</span>=<span class="hljs-string">&#123;!isOnline&#125;</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handleSaveClick&#125;</span>&gt;</span></span><br><span class="language-xml">      &#123;isOnline ? &#x27;Save progress&#x27; : &#x27;Reconnecting...&#x27;&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>如果你关闭网络，可以发现这个按钮的外观变了。</p>
<p>这两个组件都能很好地工作，但不幸的是他们的逻辑重复了。他们看上去有不同的 <strong>视觉外观</strong>，但你依然想复用他们的逻辑。</p>
<hr>
<p><mark>从组件中提取自定义 Hook </mark>：假设有一个内置 Hook <code>useOnlineStatus</code>，它与 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/reference/react/useState"><code>useState</code></a> 和 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/reference/react/useEffect"><code>useEffect</code></a> 相似。那么你就可以简化这两个组件并移除他们之间的重复部分：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-31w86zlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-31w86zlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">StatusBar</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> isOnline = <span class="hljs-title function_">useOnlineStatus</span>();<br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>&#123;isOnline ? &#x27;✅ Online&#x27; : &#x27;❌ Disconnected&#x27;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>;<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">SaveButton</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> isOnline = <span class="hljs-title function_">useOnlineStatus</span>();<br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleSaveClick</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;✅ Progress saved&#x27;</span>);<br>  &#125;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">disabled</span>=<span class="hljs-string">&#123;!isOnline&#125;</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handleSaveClick&#125;</span>&gt;</span></span><br><span class="language-xml">      &#123;isOnline ? &#x27;Save progress&#x27; : &#x27;Reconnecting...&#x27;&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>尽管目前还没有这样的内置 Hook，但是你可以自己写。声明一个 <code>useOnlineStatus</code> 函数，并把组件里早前写的所有重复代码移入该函数：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-shfkzvlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-shfkzvlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">useOnlineStatus</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [isOnline, setIsOnline] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>);<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleOnline</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-title function_">setIsOnline</span>(<span class="hljs-literal">true</span>);<br>    &#125;<br>    <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleOffline</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-title function_">setIsOnline</span>(<span class="hljs-literal">false</span>);<br>    &#125;<br>    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;online&#x27;</span>, handleOnline);<br>    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;offline&#x27;</span>, handleOffline);<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">&#x27;online&#x27;</span>, handleOnline);<br>      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">&#x27;offline&#x27;</span>, handleOffline);<br>    &#125;;<br>  &#125;, []);<br>  <span class="hljs-keyword">return</span> isOnline;<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>在函数结尾处返回 <code>isOnline</code>。这可以让组件读取到该值：</p>
<p>App.js</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-5cs6l9lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-5cs6l9lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useOnlineStatus &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./ueOnlineStatus.js&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">StatusBar</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> isOnline = <span class="hljs-title function_">useOnlineStatus</span>();<br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>&#123;isOnline ? &#x27;✅ Online&#x27; : &#x27;❌ Disconnected&#x27;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>;<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">SaveButton</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> isOnline = <span class="hljs-title function_">useOnlineStatus</span>();<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleSaveClick</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;✅ Progress saved&#x27;</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">disabled</span>=<span class="hljs-string">&#123;!isOnline&#125;</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handleSaveClick&#125;</span>&gt;</span></span><br><span class="language-xml">      &#123;isOnline ? &#x27;Save progress&#x27; : &#x27;Reconnecting...&#x27;&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">SaveButton</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">StatusBar</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>useOnlineStatus.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-zs1tlflqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-zs1tlflqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState, useEffect &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useOnlineStatus</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [isOnline, setIsOnline] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>);<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleOnline</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-title function_">setIsOnline</span>(<span class="hljs-literal">true</span>);<br>    &#125;<br>    <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleOffline</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-title function_">setIsOnline</span>(<span class="hljs-literal">false</span>);<br>    &#125;<br>    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;online&#x27;</span>, handleOnline);<br>    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;offline&#x27;</span>, handleOffline);<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">&#x27;online&#x27;</span>, handleOnline);<br>      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">&#x27;offline&#x27;</span>, handleOffline);<br>    &#125;;<br>  &#125;, []);<br>  <span class="hljs-keyword">return</span> isOnline;<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>切换网络状态验证一下是否会同时更新两个组件。</p>
<p>现在组件里没有那么多的重复逻辑了。<strong>更重要的是，组件内部的代码描述的是想要做什么（使用在线状态！），而不是怎么做（通过订阅浏览器事件完成）</strong>。</p>
<p>当提取逻辑到自定义 Hook 时，你可以隐藏如何处理外部系统或者浏览器 API 这些乱七八糟的细节。组件内部的代码表达的是目标而不是具体实现。</p>
<hr>
<p><mark>Hook 的名称必须永远以 <code>use</code> 开头 </mark>：React 应用是由组件构成，而组件由内置或自定义 Hook 构成。可能你经常使用别人写的自定义 Hook，但偶尔也要自己写！</p>
<p>你必须遵循以下这些命名公约：</p>
<ol>
<li><strong>React 组件名称必须以大写字母开头</strong>，比如 <code>StatusBar</code> 和 <code>SaveButton</code>。React 组件还需要返回一些 React 能够显示的内容，比如一段 JSX。</li>
<li><strong>Hook 的名称必须以 <code>use</code> 开头，然后紧跟一个大写字母</strong>，就像内置的 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/reference/react/useState"><code>useState</code></a> 或者本文早前的自定义 <code>useOnlineStatus</code> 一样。Hook 可以返回任意值。</li>
</ol>
<p>这个公约保证你始终能一眼识别出组件并且知道它的 state，Effect 以及其他的 React 特性可能“隐藏”在哪里。例如如果你在组件内部看见 <code>getColor()</code> 函数调用，就可以确定它里面不可能包含 React state，因为它的名称没有以 <code>use</code> 开头。但是像 <code>useOnlineStatus()</code> 这样的函数调用就很可能包含对内部其他 Hook 的调用！</p>
<p>如果你为 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/editor-setup#linting">React 配置了</a> 代码检查工具，它会强制执行这个命名公约。现在滑动到上面的 sandbox，并将 <code>useOnlineStatus</code> 重命名为 <code>getOnlineStatus</code>。注意此时代码检查工具将不会再允许你在其内部调用 <code>useState</code> 或者 <code>useEffect</code>。只有 Hook 和组件可以调用其他 Hook！</p>
<hr>
<p><mark>渲染期间调用的所有函数都应该以 use 前缀开头么？ </mark>：不。没有 <strong>调用</strong> Hook 的函数不需要 <strong>变成</strong> Hook。</p>
<p>如果函数没有调用任何 Hook，请避免使用 <code>use</code> 前缀。 而是 <strong>不带</strong> <code>use</code> 前缀把它当成常规函数去写。例如下面的 <code>useSorted</code>  没有调用 Hook，所以叫它 <code>getSorted</code>：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-ybehgglqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-ybehgglqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-comment">// 🔴 Avoid: 没有调用其他Hook的Hook</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">useSorted</span>(<span class="hljs-params">items</span>) &#123;<br>  <span class="hljs-keyword">return</span> items.<span class="hljs-title function_">slice</span>().<span class="hljs-title function_">sort</span>();<br>&#125;<br><span class="hljs-comment">// ✅ Good: 没有使用Hook的常规函数</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">getSorted</span>(<span class="hljs-params">items</span>) &#123;<br>  <span class="hljs-keyword">return</span> items.<span class="hljs-title function_">slice</span>().<span class="hljs-title function_">sort</span>();<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>这保证你的代码可以在包含条件语句在内的任何地方调用这个常规函数：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-34azs5lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-34azs5lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">List</span>(<span class="hljs-params">&#123; items, shouldSort &#125;</span>) &#123;<br>  <span class="hljs-keyword">let</span> displayedItems = items;<br>  <span class="hljs-keyword">if</span> (shouldSort) &#123;<br>    <span class="hljs-comment">// ✅ 在条件分支里调用getSorted()是没问题的，因为它不是Hook</span><br>    displayedItems = <span class="hljs-title function_">getSorted</span>(items);<br>  &#125;<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>哪怕内部只使用了一个 Hook，你也应该给这个函数加 <code>use</code> 前缀（让它成为一个 Hook）：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-shd51blqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-shd51blqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-comment">// ✅ Good: 一个使用了其他Hook的Hook</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">useAuth</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">Auth</span>);<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>技术上 React 对此并不强制要求。原则上你可以写出不调用其他 Hook 的 Hook。但这常常会难以理解且受限，所以最好避免这种方式。但是它在极少数场景下可能是有益的。例如函数目前也许并没有使用任何 Hook，但是你计划未来在该函数内部添加一些 Hook 调用。那么使用 <code>use</code> 前缀命名就很有意义：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-7ykcnqlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-7ykcnqlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-comment">// ✅ Good: 之后可能使用其他Hook的Hook</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">useAuth</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> 当认证功能实现以后，替换这一行：</span><br>  <span class="hljs-comment">// 返回 useContext(Auth)；</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-variable constant_">TEST_USER</span>;<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>接下来组件就不能在条件语句里调用这个函数。当你在内部实际添加了 Hook 调用时，这一点将变得很重要。如果你（现在或者之后）没有计划在内部使用 Hook，请不要让它变成 Hook。</p>
<hr>
<p><mark>自定义 Hook 共享的是状态逻辑，而不是状态本身</mark>：之前的例子里，当你开启或关闭网络时，两个组件一起更新了。但是两个组件共享 state 变量 <code>isOnline</code> 这种想法是错的。看这段代码：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-6dqk6slqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-6dqk6slqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">StatusBar</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> isOnline = <span class="hljs-title function_">useOnlineStatus</span>();<br>  <span class="hljs-comment">// ...</span><br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">SaveButton</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> isOnline = <span class="hljs-title function_">useOnlineStatus</span>();<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>它的工作方式和你之前提取的重复代码一模一样：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-ihrjvvlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-ihrjvvlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">StatusBar</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [isOnline, setIsOnline] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>);<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-comment">// ...</span><br>  &#125;, []);<br>  <span class="hljs-comment">// ...</span><br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">SaveButton</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [isOnline, setIsOnline] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>);<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-comment">// ...</span><br>  &#125;, []);<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>这是完全独立的两个 state 变量和 Effect！只是碰巧同一时间值一样，因为你使用了相同的外部值同步两个组件（无论网络是否开启）。</p>
<p>为了更好的说明这一点，我们需要一个不同的示例。看下面的 <code>Form</code> 组件：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-tah2gclqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-tah2gclqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Form</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [firstName, setFirstName] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;Mary&#x27;</span>);<br>  <span class="hljs-keyword">const</span> [lastName, setLastName] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;Poppins&#x27;</span>);<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleFirstNameChange</span>(<span class="hljs-params">e</span>) &#123;<br>    <span class="hljs-title function_">setFirstName</span>(e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleLastNameChange</span>(<span class="hljs-params">e</span>) &#123;<br>    <span class="hljs-title function_">setLastName</span>(e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">        First name:</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;firstName&#125;</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;handleFirstNameChange&#125;</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">        Last name:</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;lastName&#125;</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;handleLastNameChange&#125;</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">b</span>&gt;</span>Good morning, &#123;firstName&#125; &#123;lastName&#125;.<span class="hljs-tag">&lt;/<span class="hljs-name">b</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>每个表单域都有一部分重复的逻辑：</p>
<ol>
<li>都有一个 state（<code>firstName</code> 和 <code>lastName</code>）。</li>
<li>都有 change 事件的处理函数（<code>handleFirstNameChange</code> 和 <code>handleLastNameChange</code>）。</li>
<li>都有为输入框指定 <code>value</code> 和 <code>onChange</code> 属性的 JSX。</li>
</ol>
<p>你可以提取重复的逻辑到自定义 Hook <code>useFormInput</code>：</p>
<p>useFormInput.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-jqc4ozlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-jqc4ozlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useFormInput</span>(<span class="hljs-params">initialValue</span>) &#123;<br>  <span class="hljs-keyword">const</span> [value, setValue] = <span class="hljs-title function_">useState</span>(initialValue);<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleChange</span>(<span class="hljs-params">e</span>) &#123;<br>    <span class="hljs-title function_">setValue</span>(e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">const</span> inputProps = &#123;<br>    <span class="hljs-attr">value</span>: value,<br>    <span class="hljs-attr">onChange</span>: handleChange<br>  &#125;;<br><br>  <span class="hljs-keyword">return</span> inputProps;<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>App.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-u8faoulqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-u8faoulqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useFormInput &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./useFormInput.js&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Form</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> firstNameProps = <span class="hljs-title function_">useFormInput</span>(<span class="hljs-string">&#x27;Mary&#x27;</span>);<br>  <span class="hljs-keyword">const</span> lastNameProps = <span class="hljs-title function_">useFormInput</span>(<span class="hljs-string">&#x27;Poppins&#x27;</span>);<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">        First name:</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> &#123;<span class="hljs-attr">...firstNameProps</span>&#125; /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">        Last name:</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> &#123;<span class="hljs-attr">...lastNameProps</span>&#125; /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">b</span>&gt;</span>Good morning, &#123;firstNameProps.value&#125; &#123;lastNameProps.value&#125;.<span class="hljs-tag">&lt;/<span class="hljs-name">b</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>注意它只声明了 <strong>一个</strong> state 变量，叫做 <code>value</code>。</p>
<p>但 <code>Form</code> 组件调用了 <strong>两次</strong> <code>useFormInput</code>：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-kabeollqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-kabeollqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Form</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> firstNameProps = <span class="hljs-title function_">useFormInput</span>(<span class="hljs-string">&#x27;Mary&#x27;</span>);<br>  <span class="hljs-keyword">const</span> lastNameProps = <span class="hljs-title function_">useFormInput</span>(<span class="hljs-string">&#x27;Poppins&#x27;</span>);<br>  <span class="hljs-comment">// ...</span><br></code></pre></td></tr></table></div></figure>

<p>这就是为什么它工作的时候像声明了两个单独的 state 变量！</p>
<p><strong>自定义 Hook 共享的只是状态逻辑而不是状态本身。对 Hook 的每个调用完全独立于对同一个 Hook 的其他调用</strong>。这就是上面两个 sandbox 结果完全相同的原因。如果愿意，你可以划上去进行比较。提取自定义 Hook 前后组件的行为是一致的。</p>
<p>当你需要在多个组件之间共享 state 本身时，需要 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/sharing-state-between-components">将变量提升并传递下去</a>。</p>
<hr>
<p><mark>在 Hook 之间传递响应值</mark>：每当组件重新渲染，自定义 Hook 中的代码就会重新运行。这就是组件和自定义 Hook 都 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/keeping-components-pure">需要是纯函数</a> 的原因。我们应该把自定义 Hook 的代码看作组件主体的一部分。</p>
<p>由于自定义 Hook 会随着组件一起重新渲染，所以组件可以一直接收到最新的 props 和 state。想知道这意味着什么，那就看看这个聊天室的示例。修改 ServeUrl 或者 roomID：</p>
<p>notifications.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-k14qgelqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-k14qgelqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Toastify</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;toastify-js&#x27;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;toastify-js/src/toastify.css&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">showNotification</span>(<span class="hljs-params">message, theme = <span class="hljs-string">&#x27;dark&#x27;</span></span>) &#123;<br>  <span class="hljs-title class_">Toastify</span>(&#123;<br>    <span class="hljs-attr">text</span>: message,<br>    <span class="hljs-attr">duration</span>: <span class="hljs-number">2000</span>,<br>    <span class="hljs-attr">gravity</span>: <span class="hljs-string">&#x27;top&#x27;</span>,<br>    <span class="hljs-attr">position</span>: <span class="hljs-string">&#x27;right&#x27;</span>,<br>    <span class="hljs-attr">style</span>: &#123;<br>      <span class="hljs-attr">background</span>: theme === <span class="hljs-string">&#x27;dark&#x27;</span> ? <span class="hljs-string">&#x27;black&#x27;</span> : <span class="hljs-string">&#x27;white&#x27;</span>,<br>      <span class="hljs-attr">color</span>: theme === <span class="hljs-string">&#x27;dark&#x27;</span> ? <span class="hljs-string">&#x27;white&#x27;</span> : <span class="hljs-string">&#x27;black&#x27;</span>,<br>    &#125;,<br>  &#125;).<span class="hljs-title function_">showToast</span>();<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>chat.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-tdjb6xlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-tdjb6xlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createConnection</span>(<span class="hljs-params">&#123; serverUrl, roomId &#125;</span>) &#123;<br>  <span class="hljs-comment">// 真正的实现会实际连接到服务器</span><br>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> serverUrl !== <span class="hljs-string">&#x27;string&#x27;</span>) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;Expected serverUrl to be a string. Received: &#x27;</span> + serverUrl);<br>  &#125;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> roomId !== <span class="hljs-string">&#x27;string&#x27;</span>) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;Expected roomId to be a string. Received: &#x27;</span> + roomId);<br>  &#125;<br>  <span class="hljs-keyword">let</span> intervalId;<br>  <span class="hljs-keyword">let</span> messageCallback;<br>  <span class="hljs-keyword">return</span> &#123;<br>    <span class="hljs-title function_">connect</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;✅ Connecting to &quot;&#x27;</span> + roomId + <span class="hljs-string">&#x27;&quot; room at &#x27;</span> + serverUrl + <span class="hljs-string">&#x27;...&#x27;</span>);<br>      <span class="hljs-built_in">clearInterval</span>(intervalId);<br>      intervalId = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>        <span class="hljs-keyword">if</span> (messageCallback) &#123;<br>          <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() &gt; <span class="hljs-number">0.5</span>) &#123;<br>            <span class="hljs-title function_">messageCallback</span>(<span class="hljs-string">&#x27;hey&#x27;</span>)<br>          &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-title function_">messageCallback</span>(<span class="hljs-string">&#x27;lol&#x27;</span>);<br>          &#125;<br>        &#125;<br>      &#125;, <span class="hljs-number">3000</span>);<br>    &#125;,<br>    <span class="hljs-title function_">disconnect</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-built_in">clearInterval</span>(intervalId);<br>      messageCallback = <span class="hljs-literal">null</span>;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;❌ Disconnected from &quot;&#x27;</span> + roomId + <span class="hljs-string">&#x27;&quot; room at &#x27;</span> + serverUrl + <span class="hljs-string">&#x27;&#x27;</span>);<br>    &#125;,<br>    <span class="hljs-title function_">on</span>(<span class="hljs-params">event, callback</span>) &#123;<br>      <span class="hljs-keyword">if</span> (messageCallback) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;Cannot add the handler twice.&#x27;</span>);<br>      &#125;<br>      <span class="hljs-keyword">if</span> (event !== <span class="hljs-string">&#x27;message&#x27;</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;Only &quot;message&quot; event is supported.&#x27;</span>);<br>      &#125;<br>      messageCallback = callback;<br>    &#125;,<br>  &#125;;<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>ChatRoom.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-ojm8zwlqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-ojm8zwlqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState, useEffect &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; createConnection &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./chat.js&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; showNotification &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./notifications.js&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatRoom</span>(<span class="hljs-params">&#123; roomId &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> [serverUrl, setServerUrl] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;https://localhost:1234&#x27;</span>);<br><br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> options = &#123;<br>      <span class="hljs-attr">serverUrl</span>: serverUrl,<br>      <span class="hljs-attr">roomId</span>: roomId<br>    &#125;;<br>    <span class="hljs-keyword">const</span> connection = <span class="hljs-title function_">createConnection</span>(options);<br>    connection.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;message&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">msg</span>) =&gt;</span> &#123;<br>      <span class="hljs-title function_">showNotification</span>(<span class="hljs-string">&#x27;New message: &#x27;</span> + msg);<br>    &#125;);<br>    connection.<span class="hljs-title function_">connect</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> connection.<span class="hljs-title function_">disconnect</span>();<br>  &#125;, [roomId, serverUrl]);<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">        Server URL:</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;serverUrl&#125;</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> setServerUrl(e.target.value)&#125; /&gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Welcome to the &#123;roomId&#125; room!<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>App.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-ovz58glqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-ovz58glqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-title class_">ChatRoom</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./ChatRoom.js&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [roomId, setRoomId] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;general&#x27;</span>);<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">        Choose the chat room:&#123;&#x27; &#x27;&#125;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">select</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;roomId&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> setRoomId(e.target.value)&#125;</span><br><span class="language-xml">        &gt;</span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;general&quot;</span>&gt;</span>general<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;travel&quot;</span>&gt;</span>travel<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;music&quot;</span>&gt;</span>music<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">hr</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ChatRoom</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">roomId</span>=<span class="hljs-string">&#123;roomId&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>当你修改 <code>serverUrl</code> 或者 <code>roomId</code> 时，Effect 会对 <a target="_blank" rel="noopener" href="https://zh-hans.react.dev/learn/lifecycle-of-reactive-effects#effects-react-to-reactive-values">你的修改做出“响应”</a> 并重新同步。你可以通过每次修改 Effect 依赖项时聊天室重连的控制台消息来区分。</p>
<p>现在将 Effect 代码移入自定义 Hook：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-kdnkbclqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-kdnkbclqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useChatRoom</span>(<span class="hljs-params">&#123; serverUrl, roomId &#125;</span>) &#123;<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> options = &#123;<br>      <span class="hljs-attr">serverUrl</span>: serverUrl,<br>      <span class="hljs-attr">roomId</span>: roomId<br>    &#125;;<br>    <span class="hljs-keyword">const</span> connection = <span class="hljs-title function_">createConnection</span>(options);<br>    connection.<span class="hljs-title function_">connect</span>();<br>    connection.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;message&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">msg</span>) =&gt;</span> &#123;<br>      <span class="hljs-title function_">showNotification</span>(<span class="hljs-string">&#x27;New message: &#x27;</span> + msg);<br>    &#125;);<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> connection.<span class="hljs-title function_">disconnect</span>();<br>  &#125;, [roomId, serverUrl]);<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>这让 <code>ChatRoom</code> 组件调用自定义 Hook，而不需要担心内部怎么工作：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-adgs6slqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-adgs6slqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatRoom</span>(<span class="hljs-params">&#123; roomId &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> [serverUrl, setServerUrl] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;https://localhost:1234&#x27;</span>);<br>  <span class="hljs-title function_">useChatRoom</span>(&#123;<br>    <span class="hljs-attr">roomId</span>: roomId,<br>    <span class="hljs-attr">serverUrl</span>: serverUrl<br>  &#125;);<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">        Server URL:</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;serverUrl&#125;</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> setServerUrl(e.target.value)&#125; /&gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Welcome to the &#123;roomId&#125; room!<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>这看上去简洁多了（但是它做的是同一件事）！</p>
<p>注意逻辑 <strong>仍然响应</strong> props 和 state 的变化。尝试编辑 server URL 或选中的房间：</p>
<p>ChatRoom.js：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-fat8a2lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-fat8a2lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; useChatRoom &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./useChatRoom.js&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatRoom</span>(<span class="hljs-params">&#123; roomId &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> [serverUrl, setServerUrl] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;https://localhost:1234&#x27;</span>);<br><br>  <span class="hljs-title function_">useChatRoom</span>(&#123;<br>    <span class="hljs-attr">roomId</span>: roomId,<br>    <span class="hljs-attr">serverUrl</span>: serverUrl<br>  &#125;);<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">        Server URL:</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;serverUrl&#125;</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> setServerUrl(e.target.value)&#125; /&gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Welcome to the &#123;roomId&#125; room!<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></div></figure>

<p>注意你如何获取 Hook 的返回值：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-0ppj06lqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-0ppj06lqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatRoom</span>(<span class="hljs-params">&#123; roomId &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> [serverUrl, setServerUrl] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;https://localhost:1234&#x27;</span>);<br>  <span class="hljs-title function_">useChatRoom</span>(&#123;<br>    <span class="hljs-attr">roomId</span>: roomId,<br>    <span class="hljs-attr">serverUrl</span>: serverUrl<br>  &#125;);<br>  <span class="hljs-comment">// ...</span><br></code></pre></td></tr></table></div></figure>

<p>并把它作为输入传给另一个 Hook：</p>
<figure class="highlight jsx"><i class="iconfont icon-window-down" type="button" data-toggle="collapse" data-target="#collapse-282jpylqadar0s" style="font-size:1.5em;"></i><div class="collapse show" id="collapse-282jpylqadar0s"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatRoom</span>(<span class="hljs-params">&#123; roomId &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> [serverUrl, setServerUrl] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;https://localhost:1234&#x27;</span>);<br>  <span class="hljs-title function_">useChatRoom</span>(&#123;<br>    <span class="hljs-attr">roomId</span>: roomId,<br>    <span class="hljs-attr">serverUrl</span>: serverUrl<br>  &#125;);<br>  <span class="hljs-comment">// ...</span><br></code></pre></td></tr></table></div></figure>

<p>每次 <code>ChatRoom</code> 组件重新渲染，它就会传最新的 <code>roomId</code> 和 <code>serverUrl</code> 到你的 Hook。这就是每当重新渲染后他们的值不一样时你的 Effect 会重连聊天室的原因。（如果你曾经使用过音视频处理软件，像这样的 Hook 链也许会让你想起音视频效果链。好似 <code>useState</code> 的输出作为 <code>useChatRoom</code> 的输入）。</p>
 
            </div>
            
            <hr />
            <!-- 添加打赏模块 -->
            <div class="reward-container">
              
              <button id="rewardBtn" class="reward-btn">
                
                <i class="iconfont icon-qiandai"></i>
                打赏 
              </button>
              <p class="tea">觉得不错的话，给个打赏吧O(∩_∩)O~</p>
              <div id="rewardImgContainer" class="reward-img-container">
                <div class="singleImgContainer">
                  <img
                    id="wechatImg"
                    class="reward-img"
                    src="/img/wechatpay.png" srcset="/img/loading.gif" lazyload
                    alt="微信二维码"
                  />
                  <p class="wechatPay">微信支付</p>
                </div>
                <div class="singleImgContainer">
                  <img
                    id="alipayImg"
                    class="reward-img"
                    src="/img/alipay.jpg" srcset="/img/loading.gif" lazyload
                    alt="支付宝二维码"
                  />
                  <p class="aliPay">支付宝支付</p>
                </div>
              </div>
              
            </div>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-2"  style="font-size: 1.5em;"></i>
      

<span class="category-chains" style="color: darkturquoise;">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E5%89%8D%E7%AB%AF/" class="category-chain-item">前端</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags-fill"></i>
      
        <a href="/tags/React/" class="print-no-link">#React</a>
      
        <a href="/tags/TypeScript/" class="print-no-link">#TypeScript</a>
      
    </div>
  
</div>
 
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>六.React教程</div>
      <div>https://lan720.github.io/lan-blog/2023/11/01/React教程/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>lan720</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年11月1日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>

 
              <div class="post-prevnext my-3">
                <article class="post-prev col-6">
                   
                  <a href="/2023/11/20/React%E5%8F%82%E8%80%83/" title="七.React参考">
                    <i class="iconfont icon-arrowleft"></i>
                    <span class="hidden-mobile">七.React参考</span>
                    <span class="visible-mobile"
                      >上一篇</span
                    >
                  </a>
                  
                </article>
                <article class="post-next col-6">
                   
                  <a href="/2023/10/16/Typora%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/" title="五.Typora使用指南">
                    <span class="hidden-mobile">五.Typora使用指南</span>
                    <span class="visible-mobile"
                      >下一篇</span
                    >
                    <i class="iconfont icon-arrowright"></i>
                  </a>
                  
                </article>
              </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <script type="text/javascript">
    Fluid.utils.loadComments('#comments', function() {
      var light = 'github-light';
      var dark = 'github-dark';
      var schema = document.documentElement.getAttribute('data-user-color-scheme');
      if (schema === 'dark') {
        schema = dark;
      } else {
        schema = light;
      }
      window.UtterancesThemeLight = light;
      window.UtterancesThemeDark = dark;
      var s = document.createElement('script');
      s.setAttribute('src', 'https://utteranc.es/client.js');
      s.setAttribute('repo', 'lan720/hexo-comment');
      s.setAttribute('issue-term', 'pathname');
      
      s.setAttribute('label', 'utterances');
      
      s.setAttribute('theme', schema);
      s.setAttribute('crossorigin', 'anonymous');
      document.getElementById('comments').appendChild(s);
    })
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div style="display: block !important; width: 4.5rem">
      

    </div>
  </div>
</div>





  



  



  



  



  



 
<script src="/js/mouse.js"></script>
<script src="/js/reward.js"></script>

    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-aixin"></i> <span>世界和平</span> 
      <br/>
      <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span>
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>
<script>
  var now = new Date(); 
  function createtime() { //月、日、年，小时、分、秒
    var grt= new Date("08/24/2023 10:30:00");//此处修改你的建站时间或者网站上线时间 
    now.setTime(now.getTime()+250); 
    days = (now - grt ) / 1000 / 60 / 60 / 24; 
    dnum = Math.floor(days); 
    hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); 
    hnum = Math.floor(hours); 
    if(String(hnum).length ==1 ){
      hnum = "0" + hnum;
    } 
    minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum); 
    mnum = Math.floor(minutes); 
    if(String(mnum).length ==1 ){
      mnum = "0" + mnum;
    } 
    seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum); 
    snum = Math.round(seconds); 
    <!-- 加判断条件避免出现60秒的情况 -->
    if(snum==60){
      snum=0;
    }
    if(String(snum).length ==1 ){
      snum = "0" + snum;
    } 
    document.getElementById("timeDate").innerHTML = "本站已安全运行 "+dnum+" 天 "; 
    document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒"; 
  } 
  setInterval("createtime()",250);
</script>
</script>


  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
<script src="/js/sakura.js"></script>
<script src="https://cdn.jsdelivr.net/npm/highlightjs"></script>
<script src="https://cdn.jsdelivr.net/npm/highlightjs-vue"></script>
<script>
  hljs.registerLanguage("vue", window.hljsDefineVue);
  hljs.initHighlightingOnLoad();
</script>
<!-- hexo injector body_end start -->
  <script data-pjax src="https://cdn.jsdelivr.net/gh/Zfour/hexo-github-calendar@1.21/hexo_githubcalendar.js"></script>
  <script data-pjax>
        function GithubCalendarConfig(){
            var git_githubapiurl ="https://python-github-calendar-api.vercel.app/api?lan720";
            var git_color =['#ebedf0', '#f0fff4', '#dcffe4', '#bef5cb', '#85e89d', '#34d058', '#28a745', '#22863a', '#176f2c', '#165c26', '#144620'];
            var git_user ="lan720";
            var parent_div_git = document.getElementsByClassName('container')[1];
            var git_div_html = '<div id="github-calendar" style="width:100%;height:auto;padding:10px;margin-bottom:20px"><div id="github_loading" style="width:10%;height:100%;margin:0 auto;display: block"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"  viewBox="0 0 50 50" style="enable-background:new 0 0 50 50" xml:space="preserve"><path fill="#d0d0d0" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z" transform="rotate(275.098 25 25)"><animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"></animateTransform></path></svg></div><div id="github_container"></div></div>';
            if(parent_div_git && location.pathname =='/archives/'){
                console.log('已挂载github calendar')
                // parent_div_git.innerHTML=git_div_html+parent_div_git.innerHTML // 无报错，但不影响使用(支持pjax跳转)
                parent_div_git.insertAdjacentHTML("afterbegin",git_div_html) // 有报错，但不影响使用(支持pjax跳转)
            };
            GithubCalendar(git_githubapiurl,git_color,git_user)
        }
        if(document.getElementsByClassName('container')[1]){
            GithubCalendarConfig()
        }
    </script>
    <style>#github_container{min-height:200px}@media screen and (max-width:650px) {#github_container{background-image:;min-height:0px}}</style>
    <style>#github_container > .position-relative > .border{border:0!important}#github-calendar{position: relative;margin-top: -2rem;background-color: var(--board-bg-color);transition: background-color 0.2s ease-in-out;border-radius: 0.5rem;z-index: 3;-webkit-box-shadow: 0 12px 15px 0 rgb(0 0 0 / 24%), 0 17px 50px 0 rgb(0 0 0 / 19%);box-shadow: 0 12px 15px 0 rgb(0 0 0 / 24%), 0 17px 50px 0 rgb(0 0 0 / 19%);}</style><!-- hexo injector body_end end --></body>
</html>

